<!DOCTYPE html>
<html lang="zh" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>阅读Spring源码 | Qian&#39;s Blog</title>
<meta name="keywords" content="spring">
<meta name="description" content="Spring 什么是Spring框架 Spring是一种轻量级框架，旨在提高开发人员的开发效率和系统的可维护性。 我们一般说的Spring框架就是SPrin">
<meta name="author" content="
作者:&nbsp;ShengQian">
<link rel="canonical" href="https://csqread.top/posts/tech/%E9%98%85%E8%AF%BBspring%E6%BA%90%E7%A0%81/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.d056c2d8b86c8da0db95897f49066a3a22d796d21ff6173ef98b613234e402fe.css" integrity="" rel="preload stylesheet" as="style">
<script defer crossorigin="anonymous" src="/assets/js/highlight.acb54fd32bbc1982428b8850317e45d076b95012730a5936667e6bc21777692a.js" integrity=""
    onload="hljs.initHighlightingOnLoad();"></script>
<link rel="icon" href="https://csqread.top/img/Q.gif">
<link rel="icon" type="image/png" sizes="16x16" href="https://csqread.top/img/%21.jpg">
<link rel="icon" type="image/png" sizes="32x32" href="https://csqread.top/img/%21.jpg">
<link rel="apple-touch-icon" href="https://csqread.top/%21.jpg">
<link rel="mask-icon" href="https://csqread.top/%21.jpg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --hljs-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript><meta property="og:title" content="阅读Spring源码" />
<meta property="og:description" content="Spring 什么是Spring框架 Spring是一种轻量级框架，旨在提高开发人员的开发效率和系统的可维护性。 我们一般说的Spring框架就是SPrin" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://csqread.top/posts/tech/%E9%98%85%E8%AF%BBspring%E6%BA%90%E7%A0%81/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2024-04-12T21:13:28+08:00" />
<meta property="article:modified_time" content="2024-04-12T21:13:28+08:00" />

<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="阅读Spring源码"/>
<meta name="twitter:description" content="Spring 什么是Spring框架 Spring是一种轻量级框架，旨在提高开发人员的开发效率和系统的可维护性。 我们一般说的Spring框架就是SPrin"/>


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "Posts",
      "item": "https://csqread.top/posts/"
    }, 
    {
      "@type": "ListItem",
      "position":  3 ,
      "name": "技术",
      "item": "https://csqread.top/posts/tech/"
    }, 
    {
      "@type": "ListItem",
      "position":  4 ,
      "name": "阅读Spring源码",
      "item": "https://csqread.top/posts/tech/%E9%98%85%E8%AF%BBspring%E6%BA%90%E7%A0%81/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "阅读Spring源码",
  "name": "阅读Spring源码",
  "description": "Spring 什么是Spring框架 Spring是一种轻量级框架，旨在提高开发人员的开发效率和系统的可维护性。 我们一般说的Spring框架就是SPrin",
  "keywords": [
    "spring"
  ],
  "articleBody": "Spring 什么是Spring框架 Spring是一种轻量级框架，旨在提高开发人员的开发效率和系统的可维护性。 我们一般说的Spring框架就是SPring Framework，他是很多模块的集合，使用这些模块可以很方便的协助我们进行开发。这些模块是核心容器、数据访问/集成、web、aop、工具、消息和测试模块。比如Core Container中的Core组件是Spring所有组件的核心，Beans组件和Context组件是实现IOC和DI的基础，AOP组件用来实现面向切面编程。\nSpring官网列出来的Spring的6个特征:\n核心技术：依赖注入，aop，事件，资源，i18n，验证，数据绑定，类型转换，SpEL 测试：模拟对象，TestContext框架，SPringMVC测试，WebTestClient 数据访问:事务，DAO支持，JDBC，ORM，编组XML Web支持:Spring MVC和SPring WebFlux Web框架 集成:远程处理，JMS，JCA，JMX，电子邮件，任务，调度，缓存 语言：Kotlin，Groovy，动态语言 Spring中的单例bean的线程安全问题了解吗？ 大部分我们并没有在系统中使用多线程，所以很少有人会关注这个问题。单例bean存在线程问题，主要是因为当多个线程操作同一个对象的时候，对这个对象的非静态成员变量的写操作会存在线程安全问题。\n有两种常见解决方案： 1、在bean对象中尽量避免定义可变的成员变量。 2、在类中定义一个ThreadLocal成员变量，将需要的可变的成员变量保存在ThreadLocal中。\nSpring中的bean生命周期？ Bean的完整生命周期经历了各种方法调用，这些方法可以划分为以下几类：\nBean自身的方法：这个包括了Bean本身调用的方法和通过配置文件中的init-method和destroy-method指定的方法 Bean级生命周期接口方法：这个包括了BeanNameAware、BeanFactoryAware、ApplicationContext;当然也包括InitializingBean和DiposableBean这些接口的方法 容器级生命周期接口方法：这个包括了InstantiationAwareBeanPostProcessor和BeanPostProcessor这两个接口实现，一般称它们的实现类为“后处理器” 工厂后处理器接口方法：这个包括了AspectJWeavingEnabler,ConfigurationClassPostProcessor,CustomAutowireConfigurer等等非常有用的工厂后处理接口的方法。工厂后处理器也是容器级的。在应用上下文装配配置文件之后立即调用。 如何将Bean从XML配置中解析后放到IoC容器中得？ 初始化的入口 对于xml配置的Spring应用，在main()方法中实例化ClasspathXmlApplication即可创建一个IoC容器。我们可以从这个构造方法开始，探究一下IoC容器的初始化过程。\n1 2 // create and configure beans ApplicationContext context = new ClassPathXmlApplicationContext(\"aspects.xml\", \"daos.xml\", \"services.xml\"); 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 public ClassPathXmlApplicationContext(String... configLocations) throws BeansException { this(configLocations, true, (ApplicationContext)null); } public ClassPathXmlApplicationContext(String[] configLocations, boolean refresh, @Nullable ApplicationContext parent) throws BeansException { // 设置Bean资源加载器 super(parent); // 设置配置路径 this.setConfigLocations(configLocations); // 初始化容器 if (refresh) { this.refresh(); } } 设置资源解析器和环境 调用父类容器AbstractApplicationContext的构造方法(super(parent)方法)为容器设置好Bean资源加载器\n1 2 3 4 5 6 7 public AbstractApplicationContext(@Nullable ApplicationContext parent) { // 默认构造函数初始化容器id, name, 状态 以及 资源解析器 this(); // 将父容器的Environment合并到当前容器 this.setParent(parent); } 通过AbstractApplicationContext默认构造器初始化容器id,name,状态以及资源解析器\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 public AbstractApplicationContext() { this.logger = LogFactory.getLog(this.getClass()); this.id = ObjectUtils.identityToString(this); this.displayName = ObjectUtils.identityToString(this); this.beanFactoryPostProcessors = new ArrayList(); this.active = new AtomicBoolean(); this.closed = new AtomicBoolean(); this.startupShutdownMonitor = new Object(); this.applicationStartup = ApplicationStartup.DEFAULT; this.applicationListeners = new LinkedHashSet(); this.resourcePatternResolver = this.getResourcePatternResolver(); } // Spring资源加载器 protected ResourcePatternResolver getResourcePatternResolver() { return new PathMatchingResourcePatternResolver(this); } 通过AbstractApplicationContext的setParent(parent)方法将父容器的Enviroment合并到当前容器\n1 2 3 4 5 6 7 8 9 public void setParent(@Nullable ApplicationContext parent) { this.parent = parent; if (parent != null) { Environment parentEnvironment = parent.getEnvironment(); if (parentEnvironment instanceof ConfigurableEnvironment) { this.getEnvironment().merge((ConfigurableEnvironment)parentEnvironment); } } } 设置配置路径 在设置容器的资源加载器之后，接下来FileSystemXmlApplicationContent执行setConfigLocations方法通过调用其父类AbstractRefreshableConfigApplicationContext的方法进行对Bean定义资源文件的定位。\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 public void setConfigLocations(@Nullable String... locations) { if (locations != null) { Assert.noNullElements(locations, \"Config locations must not be null\"); this.configLocations = new String[locations.length]; for(int i = 0; i \u003c locations.length; ++i) { // 解析配置路径 this.configLocations[i] = this.resolvePath(locations[i]).trim(); } } else { this.configLocations = null; } } protected String resolvePath(String path) { // 从上一步Environment中解析 return this.getEnvironment().resolveRequiredPlaceholders(path); } 初始化的主体流程 Spring IoC容器对Bean定义资源的加载是从refresh()函数开始的，refresh()是一个模板方法，refresh()方法的作用是：在创建IoC容器前，如果已经有容器存在，则需要把已有的容器销毁和关闭，以保证在refresh()之后使用的是新建立起来的IoC容器。refresh的作用类似于对IoC容器的重启，在新建立好的容器中对容器进行初始化，对Bean定义资源进行载入。\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 @Override public void refresh() throws BeansException, IllegalStateException { synchronized (this.startupShutdownMonitor) { StartupStep contextRefresh = this.applicationStartup.start(\"spring.context.refresh\"); // Prepare this context for refreshing. prepareRefresh(); // Tell the subclass to refresh the internal bean factory. ConfigurableListableBeanFactory beanFactory = obtainFreshBeanFactory(); // Prepare the bean factory for use in this context. prepareBeanFactory(beanFactory); try { // Allows post-processing of the bean factory in context subclasses. postProcessBeanFactory(beanFactory); StartupStep beanPostProcess = this.applicationStartup.start(\"spring.context.beans.post-process\"); // Invoke factory processors registered as beans in the context. invokeBeanFactoryPostProcessors(beanFactory); // Register bean processors that intercept bean creation. registerBeanPostProcessors(beanFactory); beanPostProcess.end(); // Initialize message source for this context. initMessageSource(); // Initialize event multicaster for this context. initApplicationEventMulticaster(); // Initialize other special beans in specific context subclasses. onRefresh(); // Check for listener beans and register them. registerListeners(); // Instantiate all remaining (non-lazy-init) singletons. finishBeanFactoryInitialization(beanFactory); // Last step: publish corresponding event. finishRefresh(); } catch (BeansException ex) { if (logger.isWarnEnabled()) { logger.warn(\"Exception encountered during context initialization - \" + \"cancelling refresh attempt: \" + ex); } // Destroy already created singletons to avoid dangling resources. destroyBeans(); // Reset 'active' flag. cancelRefresh(ex); // Propagate exception to caller. throw ex; } finally { // Reset common introspection caches in Spring's core, since we // might not ever need metadata for singleton beans anymore... resetCommonCaches(); contextRefresh.end(); } } } 这里的设计上是一个非常典型的资源类加载处理型的思路\n模板方法设计模式，模板方法中使用典型的钩子方法 将具体的初始化加载方法插入到钩子方法之间 将初始化的阶段封装，用来记录当前初始化到什么阶段；常见的设计是xxxPhase/xxxStage 资源加载初始化有失败等处理，必然是try/catch/finally 初始化BeanFactory之obtainFreshBeanFactory AbstractApplicationContext的obtainFreshBeanFactory()方法调用子类容器的refreshBeanFactory()方法，启动容器载入Bean定义资源文件的过程，代码如下\n1 2 3 4 5 protected ConfigurableListableBeanFactory obtainFreshBeanFactory() { // 这里使用了委派设计模式，父类定义了抽象的refreshBeanFactory()方法，具体实现调用子类容器的refreshBeanFactory()方法 refreshBeanFactory(); return getBeanFactory(); } AbstractApplicationCOntext类中只抽象定义了refreshBeanFactory()方法，容器真正调用的是子类的AbstractRefreshableApplicationContext实现的refreshBeanFactory（）方法留在创建IoC容器之前，如果已经有容器存在，则需要把已有的容器销毁和关闭，以保证在refresh之后使用的是新建立起来的IoC容器。方法源码如下:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 protected final void refreshBeanFactory() throws BeansException { // 如果已经有容器存在，则需要把已有的容器销毁和关闭，以保证在refresh之后使用的是新建立起来的IoC容器 if (hasBeanFactory()) { destroyBeans(); closeBeanFactory(); } try { // 创建DefaultListableBeanFactory，并调用loadBeanDefinitions(beanFactory)装载bean定义 DefaultListableBeanFactory beanFactory = createBeanFactory(); beanFactory.setSerializationId(getId()); customizeBeanFactory(beanFactory); // 对IoC容器进行定制化，如设置启动参数，开启注解的自动装配等 loadBeanDefinitions(beanFactory); // 调用载入Bean定义的方法，主要这里又使用了一个委派模式，在当前类中只定义了抽象的loadBeanDefinitions方法，具体的实现调用子类容器 this.beanFactory = beanFactory; } catch (IOException ex) { throw new ApplicationContextException(\"I/O error parsing bean definition source for \" + getDisplayName(), ex); } } 初始化BeanFactory之loadBeanDefinitions AbstractRefreshableApplicationContext中只定义了抽象的loadBeanDefinitions方法，容器真正调用的是其子类的AbstractXmlApplicationContext对该方法的实现，AbstractXmlApplicationContext的主要源码如下：\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 protected void loadBeanDefinitions(DefaultListableBeanFactory beanFactory) throws BeansException, IOException { // 创建XmlBeanDefinitionReader，即创建Bean读取器，并通过回调设置到容器中去，容器使用该读取器读取Bean定义资源 XmlBeanDefinitionReader beanDefinitionReader = new XmlBeanDefinitionReader(beanFactory); // 配置上下文的环境，资源加载器、解析器 beanDefinitionReader.setEnvironment(this.getEnvironment()); beanDefinitionReader.setResourceLoader(this); beanDefinitionReader.setEntityResolver(new ResourceEntityResolver(this)); // 为Bean读取器设置SAX xml解析器 // 允许子类自行初始化（比如校验机制），并提供真正的加载方法 initBeanDefinitionReader(beanDefinitionReader); // 当Bean读取器读取Bean定义的Xml资源文件时，启用Xml的校验机制 loadBeanDefinitions(beanDefinitionReader); } protected void loadBeanDefinitions(XmlBeanDefinitionReader reader) throws BeansException, IOException { // 加载XML配置方式里的Bean定义的资源 Resource[] configResources = getConfigResources(); if (configResources != null) { reader.loadBeanDefinitions(configResources); } // 加载构造函数里配置的Bean配置文件，即{\"aspects.xml\", \"daos.xml\", \"services.xml\"} String[] configLocations = getConfigLocations(); if (configLocations != null) { reader.loadBeanDefinitions(configLocations); } } Xml Bean读取器(XmBeanDefinitionReader)调用其父类AbstractBeanDefinitionReader的reader.loadBeanDefinitions方法读取bean定义资源\n由于我们使用ClassPathXmlApplicationCOntext作为例子分析，因此getConfigResources的返回值为null，因此程序执行reader,loadBeanDefinitions(configLocations)分支。\nAbstractBeanDefinitionReader读取Bean定义资源 AbstractBeanDifinitionReader的loadBeanDefinitions方法源码如下:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 @Override public int loadBeanDefinitions(String location) throws BeanDefinitionStoreException { return loadBeanDefinitions(location, null); } public int loadBeanDefinitions(String location, @Nullable Set actualResources) throws BeanDefinitionStoreException { ResourceLoader resourceLoader = getResourceLoader(); if (resourceLoader == null) { throw new BeanDefinitionStoreException( \"Cannot load bean definitions from location [\" + location + \"]: no ResourceLoader available\"); } // 模式匹配类型的解析器，这种方式是加载多个满足匹配条件的资源 if (resourceLoader instanceof ResourcePatternResolver) { try { // 获取到要加载的资源 Resource[] resources = ((ResourcePatternResolver) resourceLoader).getResources(location); int count = loadBeanDefinitions(resources); // 委派调用其子类XmlBeanDefinitionReader的方法，实现加载功能 if (actualResources != null) { Collections.addAll(actualResources, resources); } if (logger.isTraceEnabled()) { logger.trace(\"Loaded \" + count + \" bean definitions from location pattern [\" + location + \"]\"); } return count; } catch (IOException ex) { throw new BeanDefinitionStoreException( \"Could not resolve bean definition resource pattern [\" + location + \"]\", ex); } } else { // 只能通过绝对路径URL加载单个资源. Resource resource = resourceLoader.getResource(location); int count = loadBeanDefinitions(resource); if (actualResources != null) { actualResources.add(resource); } if (logger.isTraceEnabled()) { logger.trace(\"Loaded \" + count + \" bean definitions from location [\" + location + \"]\"); } return count; } } 从对AbstractBeanDefinitionReader的loadBeanDefinitions方法源码分析可以看出该方法做了以下两件事:\n1、首先，调用资源加载器的获取资源方法resourceLoader.getResource(location)，获取到要加载的资源。 2、其次，真正执行加载功能的是其子类XmlBeanDefinitionReader的loadBeanDefinitions方法\nXmlBeanDefinitionReader加载Bean定义资源 继续看子类XmlBeanDefinitionReader的loadBeanDefinitions(Resource…)方法看到代表bean文件的资源定义以后的载入过程。\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 /** * 本质上是加载XML配置的Bean。 * @param inputSource the SAX InputSource to read from * @param resource the resource descriptor for the XML file */ protected int doLoadBeanDefinitions(InputSource inputSource, Resource resource) throws BeanDefinitionStoreException { try { Document doc = doLoadDocument(inputSource, resource); // 将Bean定义资源转换成Document对象 int count = registerBeanDefinitions(doc, resource); if (logger.isDebugEnabled()) { logger.debug(\"Loaded \" + count + \" bean definitions from \" + resource); } return count; } catch (BeanDefinitionStoreException ex) { throw ex; } catch (SAXParseException ex) { throw new XmlBeanDefinitionStoreException(resource.getDescription(), \"Line \" + ex.getLineNumber() + \" in XML document from \" + resource + \" is invalid\", ex); } catch (SAXException ex) { throw new XmlBeanDefinitionStoreException(resource.getDescription(), \"XML document from \" + resource + \" is invalid\", ex); } catch (ParserConfigurationException ex) { throw new BeanDefinitionStoreException(resource.getDescription(), \"Parser configuration exception parsing XML from \" + resource, ex); } catch (IOException ex) { throw new BeanDefinitionStoreException(resource.getDescription(), \"IOException parsing XML document from \" + resource, ex); } catch (Throwable ex) { throw new BeanDefinitionStoreException(resource.getDescription(), \"Unexpected exception parsing XML document from \" + resource, ex); } } // 使用配置的DocumentLoader加载XML定义文件为Document. protected Document doLoadDocument(InputSource inputSource, Resource resource) throws Exception { return this.documentLoader.loadDocument(inputSource, getEntityResolver(), this.errorHandler, getValidationModeForResource(resource), isNamespaceAware()); } 通过源码分析，载入Bean定义资源文件的最后一步是将Bean定义资源转换为Document对象，该过程由documentLoader实现\nDocumentLoader将Bean定义资源转换为Document对象 DocumentLoader将Bean定义资源转换为Document对象的源码如下:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 // 使用标准的JAXP将载入的Bean定义资源转换成document对象 @Override public Document loadDocument(InputSource inputSource, EntityResolver entityResolver, ErrorHandler errorHandler, int validationMode, boolean namespaceAware) throws Exception { // 创建文件解析器工厂 DocumentBuilderFactory factory = createDocumentBuilderFactory(validationMode, namespaceAware); if (logger.isTraceEnabled()) { logger.trace(\"Using JAXP provider [\" + factory.getClass().getName() + \"]\"); } // 创建文档解析器 DocumentBuilder builder = createDocumentBuilder(factory, entityResolver, errorHandler); return builder.parse(inputSource); // 解析 } protected DocumentBuilderFactory createDocumentBuilderFactory(int validationMode, boolean namespaceAware) throws ParserConfigurationException { DocumentBuilderFactory factory = DocumentBuilderFactory.newInstance(); factory.setNamespaceAware(namespaceAware); // 设置解析XML的校验 if (validationMode != XmlValidationModeDetector.VALIDATION_NONE) { factory.setValidating(true); if (validationMode == XmlValidationModeDetector.VALIDATION_XSD) { // Enforce namespace aware for XSD... factory.setNamespaceAware(true); try { factory.setAttribute(SCHEMA_LANGUAGE_ATTRIBUTE, XSD_SCHEMA_LANGUAGE); } catch (IllegalArgumentException ex) { ParserConfigurationException pcex = new ParserConfigurationException( \"Unable to validate using XSD: Your JAXP provider [\" + factory + \"] does not support XML Schema. Are you running on Java 1.4 with Apache Crimson? \" + \"Upgrade to Apache Xerces (or Java 1.5) for full XSD support.\"); pcex.initCause(ex); throw pcex; } } } return factory; } 该解析过程调用JavaEE标准的JAXP标准进行处理。\n至此Spring IoC容器根据定位的Bean定义资源文件，将其加载读入并转换成为Document对象过程完成。\n接下来我们继续分析Spring IoC容器将载入的Bean定义资源文件转换为Document对象之后，是如何将其解析为Spring IoC管理的Bean对象，并将其注册到容器中的。\nXmlBeanDefinitionReader解析载入的Bean定义资源文件 XmlBeanDefinitionReader类中的doLoadBeanDefinitions方法是从特定的XML文件中实际载入Bean定义资源的方法，该方法在载入Bean定义资源之后将其转换为Document对象，接下来调用registerBeanDefinitions启动Spring IoC容器对Bean定义的解析过程，registerBeanDefinition方法源码如下:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 // 按照Spring的Bean语义要求将Bean定义资源解析并转换为容器内部数据结构 public int registerBeanDefinitions(Document doc, Resource resource) throws BeanDefinitionStoreException { BeanDefinitionDocumentReader documentReader = createBeanDefinitionDocumentReader(); int countBefore = getRegistry().getBeanDefinitionCount(); // 解析过程入口，这里使用了委派模式，具体的解析实现过程有实现类DefaultBeanDefinitionDocumentReader完成 documentReader.registerBeanDefinitions(doc, createReaderContext(resource)); return getRegistry().getBeanDefinitionCount() - countBefore; // 返回此次解析了多少个对象 } // 创建BeanDefinitionDocumentReader对象，解析Document对象 protected BeanDefinitionDocumentReader createBeanDefinitionDocumentReader() { return BeanUtils.instantiateClass(this.documentReaderClass); } /** * Create the {@link XmlReaderContext} to pass over to the document reader. */ public XmlReaderContext createReaderContext(Resource resource) { return new XmlReaderContext(resource, this.problemReporter, this.eventListener, this.sourceExtractor, this, getNamespaceHandlerResolver()); } Bean定义资源的载入解析分为以下两个过程:\n1、首先，通过调用XML解析器将Bean定义资源文件转换得到Document对象，但是这些Document对象并没有按照Spring的Bean规则进行解析。这一部是载入的过程 2、其次，在完成通用的XML解析之后，按照Spring的Bean规则对Document对象进行解析。\n按照Spring的Bean规则对Document对象解析的过程是在接口BeanDifinitionDocumentReader的实现类DefaultBeanDefinitionDocumentReader中实现的。\nDefaultBeanDefinitionDocumentReader对bean定义的Document对象解析 BeanDefinitionDocumentReader接口通过registerBeanDefinitions方法调用其实现类DefaultBeanDefinitionDocumentReader对Document对象进行解析，解析代码如下:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 @Override public void registerBeanDefinitions(Document doc, XmlReaderContext readerContext) { this.readerContext = readerContext; doRegisterBeanDefinitions(doc.getDocumentElement()); } // 注册配置的Beans @SuppressWarnings(\"deprecation\") // for Environment.acceptsProfiles(String...) protected void doRegisterBeanDefinitions(Element root) { // Any nested elements will cause recursion in this method. In // order to propagate and preserve default-* attributes correctly, // keep track of the current (parent) delegate, which may be null. Create // the new (child) delegate with a reference to the parent for fallback purposes, // then ultimately reset this.delegate back to its original (parent) reference. // this behavior emulates a stack of delegates without actually necessitating one. BeanDefinitionParserDelegate parent = this.delegate; this.delegate = createDelegate(getReaderContext(), root, parent); if (this.delegate.isDefaultNamespace(root)) { String profileSpec = root.getAttribute(PROFILE_ATTRIBUTE); if (StringUtils.hasText(profileSpec)) { String[] specifiedProfiles = StringUtils.tokenizeToStringArray( profileSpec, BeanDefinitionParserDelegate.MULTI_VALUE_ATTRIBUTE_DELIMITERS); // We cannot use Profiles.of(...) since profile expressions are not supported // in XML config. See SPR-12458 for details. if (!getReaderContext().getEnvironment().acceptsProfiles(specifiedProfiles)) { if (logger.isDebugEnabled()) { logger.debug(\"Skipped XML bean definition file due to specified profiles [\" + profileSpec + \"] not matching: \" + getReaderContext().getResource()); } return; } } } preProcessXml(root); parseBeanDefinitions(root, this.delegate); // 从Document的根元素开始进行Bean定义的Document对象 postProcessXml(root); this.delegate = parent; } BeanDefinitionParserDelegate 解析Bean定义资源文件生成BeanDefinition 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 /** * Parse the elements at the root level in the document: * \"import\", \"alias\", \"bean\". * @param root the DOM root element of the document */ protected void parseBeanDefinitions(Element root, BeanDefinitionParserDelegate delegate) { if (delegate.isDefaultNamespace(root)) { NodeList nl = root.getChildNodes(); for (int i = 0; i \u003c nl.getLength(); i++) { Node node = nl.item(i); if (node instanceof Element) { Element ele = (Element) node; if (delegate.isDefaultNamespace(ele)) { parseDefaultElement(ele, delegate); } else { delegate.parseCustomElement(ele); } } } } else { delegate.parseCustomElement(root); } } private void parseDefaultElement(Element ele, BeanDefinitionParserDelegate delegate) { // 如果元素节点是导入元素，进行导入解析 if (delegate.nodeNameEquals(ele, IMPORT_ELEMENT)) { importBeanDefinitionResource(ele); } // 如果元素节点是别名元素，进行别名解析 else if (delegate.nodeNameEquals(ele, ALIAS_ELEMENT)) { processAliasRegistration(ele); } // 如果元素节点元素, 按照Spring的Bean规则解析元素 else if (delegate.nodeNameEquals(ele, BEAN_ELEMENT)) { processBeanDefinition(ele, delegate); } // 如果元素节点元素，即它是嵌套类型的 else if (delegate.nodeNameEquals(ele, NESTED_BEANS_ELEMENT)) { // 递归解析 doRegisterBeanDefinitions(ele); } } 解析Bean生成BeanDefinitionHolder的方法\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 /** * Process the given bean element, parsing the bean definition * and registering it with the registry. */ protected void processBeanDefinition(Element ele, BeanDefinitionParserDelegate delegate) { BeanDefinitionHolder bdHolder = delegate.parseBeanDefinitionElement(ele); if (bdHolder != null) { bdHolder = delegate.decorateBeanDefinitionIfRequired(ele, bdHolder); try { // 注册最终的装饰实例 BeanDefinitionReaderUtils.registerBeanDefinition(bdHolder, getReaderContext().getRegistry()); } catch (BeanDefinitionStoreException ex) { getReaderContext().error(\"Failed to register bean definition with name '\" + bdHolder.getBeanName() + \"'\", ele, ex); } // Send registration event. getReaderContext().fireComponentRegistered(new BeanComponentDefinition(bdHolder)); } } 解析过后的BeanDefinition在IoC容器中注册 Document对象的解析后得到封装BeanDefinition的BeanDifinitionHold对象，然后调用BeanDefinitionReaderUtils的registerBeanDefinition方法向IoC容器注册解析的Bean，BeanDefinitionReaderUtils的注册的源码如下:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 // 通过BeanDefinitionRegistry将BeanDefinitionHolder注册到BeanFactory public static void registerBeanDefinition( BeanDefinitionHolder definitionHolder, BeanDefinitionRegistry registry) throws BeanDefinitionStoreException { // Register bean definition under primary name. String beanName = definitionHolder.getBeanName(); registry.registerBeanDefinition(beanName, definitionHolder.getBeanDefinition()); // Register aliases for bean name, if any. String[] aliases = definitionHolder.getAliases(); if (aliases != null) { for (String alias : aliases) { registry.registerAlias(beanName, alias); } } } 当调用BeanDefinitionReaderUtils向IoC容器注册解析的BeanDefinition时，真正完成注册功能的是DefaultListableBeanFactory.\nDefaultListableBeanFactory 向IoC容器注册解析后的BeanDefinition IoC容器本质上就是一个beanDefinitionMap，注册即将BeanDefinition put 到map中。\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 /** Map of bean definition objects, keyed by bean name. */ private final Map beanDefinitionMap = new ConcurrentHashMap\u003c\u003e(256); /** Map from bean name to merged BeanDefinitionHolder. */ private final Map mergedBeanDefinitionHolders = new ConcurrentHashMap\u003c\u003e(256); @Override public void registerBeanDefinition(String beanName, BeanDefinition beanDefinition) throws BeanDefinitionStoreException { Assert.hasText(beanName, \"Bean name must not be empty\"); Assert.notNull(beanDefinition, \"BeanDefinition must not be null\"); if (beanDefinition instanceof AbstractBeanDefinition) { try { ((AbstractBeanDefinition) beanDefinition).validate(); } catch (BeanDefinitionValidationException ex) { throw new BeanDefinitionStoreException(beanDefinition.getResourceDescription(), beanName, \"Validation of bean definition failed\", ex); } } BeanDefinition existingDefinition = this.beanDefinitionMap.get(beanName); // 如果已经注册 if (existingDefinition != null) { // 检查是否可以覆盖 if (!isAllowBeanDefinitionOverriding()) { throw new BeanDefinitionOverrideException(beanName, beanDefinition, existingDefinition); } else if (existingDefinition.getRole() \u003c beanDefinition.getRole()) { // e.g. was ROLE_APPLICATION, now overriding with ROLE_SUPPORT or ROLE_INFRASTRUCTURE if (logger.isInfoEnabled()) { logger.info(\"Overriding user-defined bean definition for bean '\" + beanName + \"' with a framework-generated bean definition: replacing [\" + existingDefinition + \"] with [\" + beanDefinition + \"]\"); } } else if (!beanDefinition.equals(existingDefinition)) { if (logger.isDebugEnabled()) { logger.debug(\"Overriding bean definition for bean '\" + beanName + \"' with a different definition: replacing [\" + existingDefinition + \"] with [\" + beanDefinition + \"]\"); } } else { if (logger.isTraceEnabled()) { logger.trace(\"Overriding bean definition for bean '\" + beanName + \"' with an equivalent definition: replacing [\" + existingDefinition + \"] with [\" + beanDefinition + \"]\"); } } // 覆盖 this.beanDefinitionMap.put(beanName, beanDefinition); } else { if (hasBeanCreationStarted()) { // Cannot modify startup-time collection elements anymore (for stable iteration) synchronized (this.beanDefinitionMap) { this.beanDefinitionMap.put(beanName, beanDefinition); List updatedDefinitions = new ArrayList\u003c\u003e(this.beanDefinitionNames.size() + 1); updatedDefinitions.addAll(this.beanDefinitionNames); updatedDefinitions.add(beanName); this.beanDefinitionNames = updatedDefinitions; removeManualSingletonName(beanName); } } else { // Still in startup registration phase this.beanDefinitionMap.put(beanName, beanDefinition); this.beanDefinitionNames.add(beanName); removeManualSingletonName(beanName); } //重置所有已经注册过的BeanDefinition的缓存 this.frozenBeanDefinitionNames = null; } if (existingDefinition != null || containsSingleton(beanName)) { resetBeanDefinition(beanName); } else if (isConfigurationFrozen()) { clearByTypeCache(); } } 至此，Bean定义资源文件中配置的Bean被解析过后，已经注册到IoC容器中，被容器管理起来，真正完成了IoC容器初始化所做的全部工作。现在IoC容器中已经建立了整个Bean的配置信息，这些BeanDefinition信息已经可以使用，并且可以被检索，IoC容器的作用就是对这些注册的Bean定义信息进行处理和维护。这些的注册的Bean定义信息是IoC容器控制反转的基础，正是有了这些注册的数据，容器才可以进行依赖注入。\n总结 现在通过上面的代码，总结一下IoC容器初始化的基本步骤：\n初始化的入口在容器实现中的refresh()调用来完成 对bean定义载入IoC容器使用的方法是loadBeanDefinition，其中大致过程如下：\n1、通过ResourceLoader来完成资源文件位置的定位，DefaultResourceLoader是默认的实现，同时上下文本身就给出了ResourceLoader的实现，可以从类路径，文件系统，URL等方式来定义为资源位置。如果是XmlBeanFactory作为IOC容器，那么需要为它指定bean定义的资源，也就是说bean定义文件时通过抽象成Resource来被IOC容器处理的。 2、通过BeanDefinitionReader来完成定义信息的解析和Bean信息的注册，往往使用的是XmlBeanDefinitionReader来解析bean的xml定义文件-实际的处理过程是委托给BeanDefinitionParserDelegate来完成的，从而得到bean的定义信息，这些信息在Spring中使用BeanDefinition对象来表示-这个名字可以让我们想到loadBeanDefinition,RegisterBeanDefinition这些相关方法-他们都是为处理BeanDefinitin服务的。 3、容器解析得到BeanDefinition以后，需要把它在IOC容器中注册，这由IOC实现BeanDefinitionRegister接口来实现。注册过程就是在IOC容器内部维护一个HashMap来保存得到的BeanDefinition的过程。这个HashMap是IoC容器持有bean信息的场所，以后对bean的操作都是围绕这个HashMap来实现的。\n然后我们就可以通过BeanFactory和ApplicationCOntext来享受到SPring IOC的服务了，在使用IoC容器的时候，我们注意到除了少量粘合代码，绝大多数以正确IoC风格编写的应用程序代码完全不用关心如何到达工厂，因为容器将把这些对象与容器管理的其他对象钩在一起。基本的策略是把工厂放到已知的地方，最好是放在对预期使用的上下文有意义的地方，以及代码将实际需要访问工厂的地方。Spring本身提供了对声明式载入Web应用程序用法的应用程序上下文，并将其存储在ServletContext中的框架实现。 Spring中getBean的主体思路 BeanFactory实现getBean方法在AbstractBeanFactory中，这个方法重载都是调用doGetBean方法进行实现的:\n1 2 3 4 5 6 7 8 9 10 11 12 13 public Object getBean(String name) throws BeansException { return doGetBean(name, null, null, false); } public T getBean(String name, Class requiredType) throws BeansException { return doGetBean(name, requiredType, null, false); } public Object getBean(String name, Object... args) throws BeansException { return doGetBean(name, null, args, false); } public T getBean(String name, @Nullable Class requiredType, @Nullable Object... args) throws BeansException { return doGetBean(name, requiredType, args, false); } 接下来看下doGetBean方法(这个方法很长，我们主要看它的整体思路和设计要点):\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 139 140 141 142 143 144 145 146 147 // 参数typeCheckOnly：bean实例是否包含一个类型检查 protected T doGetBean( String name, @Nullable Class requiredType, @Nullable Object[] args, boolean typeCheckOnly) throws BeansException { // 解析bean的真正name，如果bean是工厂类，name前缀会加\u0026，需要去掉 String beanName = transformedBeanName(name); Object beanInstance; // Eagerly check singleton cache for manually registered singletons. Object sharedInstance = getSingleton(beanName); if (sharedInstance != null \u0026\u0026 args == null) { // 无参单例从缓存中获取 beanInstance = getObjectForBeanInstance(sharedInstance, name, beanName, null); } else { // 如果bean实例还在创建中，则直接抛出异常 if (isPrototypeCurrentlyInCreation(beanName)) { throw new BeanCurrentlyInCreationException(beanName); } // 如果 bean definition 存在于父的bean工厂中，委派给父Bean工厂获取 BeanFactory parentBeanFactory = getParentBeanFactory(); if (parentBeanFactory != null \u0026\u0026 !containsBeanDefinition(beanName)) { // Not found -\u003e check parent. String nameToLookup = originalBeanName(name); if (parentBeanFactory instanceof AbstractBeanFactory) { return ((AbstractBeanFactory) parentBeanFactory).doGetBean( nameToLookup, requiredType, args, typeCheckOnly); } else if (args != null) { // Delegation to parent with explicit args. return (T) parentBeanFactory.getBean(nameToLookup, args); } else if (requiredType != null) { // No args -\u003e delegate to standard getBean method. return parentBeanFactory.getBean(nameToLookup, requiredType); } else { return (T) parentBeanFactory.getBean(nameToLookup); } } if (!typeCheckOnly) { // 将当前bean实例放入alreadyCreated集合里，标识这个bean准备创建了 markBeanAsCreated(beanName); } StartupStep beanCreation = this.applicationStartup.start(\"spring.beans.instantiate\") .tag(\"beanName\", name); try { if (requiredType != null) { beanCreation.tag(\"beanType\", requiredType::toString); } RootBeanDefinition mbd = getMergedLocalBeanDefinition(beanName); checkMergedBeanDefinition(mbd, beanName, args); // 确保它的依赖也被初始化了. String[] dependsOn = mbd.getDependsOn(); if (dependsOn != null) { for (String dep : dependsOn) { if (isDependent(beanName, dep)) { throw new BeanCreationException(mbd.getResourceDescription(), beanName, \"Circular depends-on relationship between '\" + beanName + \"' and '\" + dep + \"'\"); } registerDependentBean(dep, beanName); try { getBean(dep); // 初始化它依赖的Bean } catch (NoSuchBeanDefinitionException ex) { throw new BeanCreationException(mbd.getResourceDescription(), beanName, \"'\" + beanName + \"' depends on missing bean '\" + dep + \"'\", ex); } } } // 创建Bean实例：单例 if (mbd.isSingleton()) { sharedInstance = getSingleton(beanName, () -\u003e { try { // 真正创建bean的方法 return createBean(beanName, mbd, args); } catch (BeansException ex) { // Explicitly remove instance from singleton cache: It might have been put there // eagerly by the creation process, to allow for circular reference resolution. // Also remove any beans that received a temporary reference to the bean. destroySingleton(beanName); throw ex; } }); beanInstance = getObjectForBeanInstance(sharedInstance, name, beanName, mbd); } // 创建Bean实例：原型 else if (mbd.isPrototype()) { // It's a prototype -\u003e create a new instance. Object prototypeInstance = null; try { beforePrototypeCreation(beanName); prototypeInstance = createBean(beanName, mbd, args); } finally { afterPrototypeCreation(beanName); } beanInstance = getObjectForBeanInstance(prototypeInstance, name, beanName, mbd); } // 创建Bean实例：根据bean的scope创建 else { String scopeName = mbd.getScope(); if (!StringUtils.hasLength(scopeName)) { throw new IllegalStateException(\"No scope name defined for bean ´\" + beanName + \"'\"); } Scope scope = this.scopes.get(scopeName); if (scope == null) { throw new IllegalStateException(\"No Scope registered for scope name '\" + scopeName + \"'\"); } try { Object scopedInstance = scope.get(beanName, () -\u003e { beforePrototypeCreation(beanName); try { return createBean(beanName, mbd, args); } finally { afterPrototypeCreation(beanName); } }); beanInstance = getObjectForBeanInstance(scopedInstance, name, beanName, mbd); } catch (IllegalStateException ex) { throw new ScopeNotActiveException(beanName, scopeName, ex); } } } catch (BeansException ex) { beanCreation.tag(\"exception\", ex.getClass().toString()); beanCreation.tag(\"message\", String.valueOf(ex.getMessage())); cleanupAfterBeanCreationFailure(beanName); throw ex; } finally { beanCreation.end(); } } return adaptBeanInstance(name, beanInstance, requiredType); } 上述代码主要看中文注释即可:\n解析bean的真正name，如果bean是工厂类，name前缀会加\u0026，需要去掉 无参单例先从缓存中获取 如果bean实例还在创建中，则直接抛出异常 如果bean definition存在于的bean工厂中，委派给父Bean工厂获取 标记这个beanName的实例正在创建 确保它的依赖也被初始化 真正创建:\n1. 单例时\n2. 原型时\n3. 根据bean的scope创建 重点: SPring如何解决循环依赖问题 首先我们需要声明，Spring只是解决了单例模式下属性依赖的循环问题；Spring为了解决单例的循环依赖问题，使用了三级缓存。\nSpring单例模式下的属性依赖 先来看下这三级缓存\n1 2 3 4 5 6 7 8 /** Cache of singleton objects: bean name --\u003e bean instance */ private final Map singletonObjects = new ConcurrentHashMap(256); /** Cache of early singleton objects: bean name --\u003e bean instance */ private final Map earlySingletonObjects = new HashMap(16); /** Cache of singleton factories: bean name --\u003e ObjectFactory */ private final Map",
  "wordCount" : "15112",
  "inLanguage": "zh",
  "datePublished": "2024-04-12T21:13:28+08:00",
  "dateModified": "2024-04-12T21:13:28+08:00",
  "author":[{
    "@type": "Person",
    "name": "ShengQian"
  }],
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://csqread.top/posts/tech/%E9%98%85%E8%AF%BBspring%E6%BA%90%E7%A0%81/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "Qian's Blog",
    "logo": {
      "@type": "ImageObject",
      "url": "https://csqread.top/img/Q.gif"
    }
  }
}
</script>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="https://csqread.top" accesskey="h" title="Qian&#39;s Blog (Alt + H)">
                <img src="https://csqread.top/img/%21.jpg" alt="" aria-label="logo"
                    height="35">Qian&#39;s Blog</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="https://csqread.top/search" title="🔍搜索">
                    <span>🔍搜索</span>
                </a>
            </li>
            <li>
                <a href="https://csqread.top/" title="🏠主页">
                    <span>🏠主页</span>
                </a>
            </li>
            <li>
                <a href="https://csqread.top/posts" title="📚文章">
                    <span>📚文章</span>
                </a>
            </li>
            <li>
                <a href="https://csqread.top/archives/" title="⏱时间轴">
                    <span>⏱时间轴</span>
                </a>
            </li>
            <li>
                <a href="https://csqread.top/tags" title="🔖标签">
                    <span>🔖标签</span>
                </a>
            </li>
            <li>
                <a href="https://csqread.top/about" title="🙋🏻‍♂️关于">
                    <span>🙋🏻‍♂️关于</span>
                </a>
            </li>
            <li>
                <a href="https://csqread.top/links" title="🤝友链">
                    <span>🤝友链</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    <div class="breadcrumbs"><a href="https://csqread.top">主页</a>&nbsp;»&nbsp;<a href="https://csqread.top/posts/">Posts</a>&nbsp;»&nbsp;<a href="https://csqread.top/posts/tech/">技术</a></div>
    <h1 class="post-title">
      阅读Spring源码
    </h1>
    <div class="post-meta">










创建:&nbsp;<span title='2024-04-12 21:13:28 +0800 CST'>2024-04-12</span>&nbsp;|&nbsp;更新:&nbsp;2024-04-12&nbsp;|&nbsp;字数:&nbsp;15112字&nbsp;|&nbsp;时长: 31分钟&nbsp;|&nbsp;
作者:&nbsp;ShengQian


    &nbsp;|&nbsp;标签: &nbsp;
    <ul class="post-tags-meta">
        <a href="https://csqread.top/tags/spring/">spring</a>
    </ul>

    
    
    
    
    <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    <span id="busuanzi_container_page_pv">
        &nbsp;| 访问: <span id="busuanzi_value_page_pv"></span>
    </span>

    
    
    
    
    <script src="https://cdn.staticfile.org/twikoo/1.4.11/twikoo.all.min.js">
    </script>
    <script>
        let url = document.documentURI
        
        let dnsUrl = "https://csqread.top"
        let urlSplit = url.split(dnsUrl)
        let finalUrl = urlSplit[1]
        if (finalUrl[0] !== '/') {
            finalUrl = '/'+finalUrl
        }
        twikoo.getCommentsCount({
            envId:  null ,
            region:  null ,
            urls: [
                finalUrl,
            ],
            includeReply: false 
        }).then(function (res) {
            let count = res[0].count
            const obj = document.getElementById("comment_count");
            obj.innerText = count
            
            
            
        }).catch(function (err) {
            
            console.error(err);
        });
    </script>
    &nbsp;| 评论: &nbsp; <span id="comment_count"></span>

</div>
  </header> <aside id="toc-container" class="toc-container wide">
    <div class="toc">
        <details  open>
            <summary accesskey="c" title="(Alt + C)">
                <span class="details">目录</span>
            </summary>

            <div class="inner"><ul>
                    <li>
                        <a href="#spring" aria-label="Spring">Spring</a><ul>
                            
                    <li>
                        <a href="#%e4%bb%80%e4%b9%88%e6%98%afspring%e6%a1%86%e6%9e%b6" aria-label="什么是Spring框架">什么是Spring框架</a></li>
                    <li>
                        <a href="#spring%e4%b8%ad%e7%9a%84%e5%8d%95%e4%be%8bbean%e7%9a%84%e7%ba%bf%e7%a8%8b%e5%ae%89%e5%85%a8%e9%97%ae%e9%a2%98%e4%ba%86%e8%a7%a3%e5%90%97" aria-label="Spring中的单例bean的线程安全问题了解吗？">Spring中的单例bean的线程安全问题了解吗？</a></li>
                    <li>
                        <a href="#spring%e4%b8%ad%e7%9a%84bean%e7%94%9f%e5%91%bd%e5%91%a8%e6%9c%9f" aria-label="Spring中的bean生命周期？">Spring中的bean生命周期？</a></li>
                    <li>
                        <a href="#%e5%a6%82%e4%bd%95%e5%b0%86bean%e4%bb%8exml%e9%85%8d%e7%bd%ae%e4%b8%ad%e8%a7%a3%e6%9e%90%e5%90%8e%e6%94%be%e5%88%b0ioc%e5%ae%b9%e5%99%a8%e4%b8%ad%e5%be%97" aria-label="如何将Bean从XML配置中解析后放到IoC容器中得？">如何将Bean从XML配置中解析后放到IoC容器中得？</a></li>
                    <li>
                        <a href="#%e5%88%9d%e5%a7%8b%e5%8c%96%e7%9a%84%e5%85%a5%e5%8f%a3" aria-label="初始化的入口">初始化的入口</a></li>
                    <li>
                        <a href="#%e8%ae%be%e7%bd%ae%e8%b5%84%e6%ba%90%e8%a7%a3%e6%9e%90%e5%99%a8%e5%92%8c%e7%8e%af%e5%a2%83" aria-label="设置资源解析器和环境">设置资源解析器和环境</a></li>
                    <li>
                        <a href="#%e8%ae%be%e7%bd%ae%e9%85%8d%e7%bd%ae%e8%b7%af%e5%be%84" aria-label="设置配置路径">设置配置路径</a></li>
                    <li>
                        <a href="#%e5%88%9d%e5%a7%8b%e5%8c%96%e7%9a%84%e4%b8%bb%e4%bd%93%e6%b5%81%e7%a8%8b" aria-label="初始化的主体流程">初始化的主体流程</a></li>
                    <li>
                        <a href="#%e5%88%9d%e5%a7%8b%e5%8c%96beanfactory%e4%b9%8bobtainfreshbeanfactory" aria-label="初始化BeanFactory之obtainFreshBeanFactory">初始化BeanFactory之obtainFreshBeanFactory</a></li>
                    <li>
                        <a href="#%e5%88%9d%e5%a7%8b%e5%8c%96beanfactory%e4%b9%8bloadbeandefinitions" aria-label="初始化BeanFactory之loadBeanDefinitions">初始化BeanFactory之loadBeanDefinitions</a></li>
                    <li>
                        <a href="#abstractbeandefinitionreader%e8%af%bb%e5%8f%96bean%e5%ae%9a%e4%b9%89%e8%b5%84%e6%ba%90" aria-label="AbstractBeanDefinitionReader读取Bean定义资源">AbstractBeanDefinitionReader读取Bean定义资源</a></li>
                    <li>
                        <a href="#xmlbeandefinitionreader%e5%8a%a0%e8%bd%bdbean%e5%ae%9a%e4%b9%89%e8%b5%84%e6%ba%90" aria-label="XmlBeanDefinitionReader加载Bean定义资源">XmlBeanDefinitionReader加载Bean定义资源</a></li>
                    <li>
                        <a href="#documentloader%e5%b0%86bean%e5%ae%9a%e4%b9%89%e8%b5%84%e6%ba%90%e8%bd%ac%e6%8d%a2%e4%b8%badocument%e5%af%b9%e8%b1%a1" aria-label="DocumentLoader将Bean定义资源转换为Document对象">DocumentLoader将Bean定义资源转换为Document对象</a></li>
                    <li>
                        <a href="#xmlbeandefinitionreader%e8%a7%a3%e6%9e%90%e8%bd%bd%e5%85%a5%e7%9a%84bean%e5%ae%9a%e4%b9%89%e8%b5%84%e6%ba%90%e6%96%87%e4%bb%b6" aria-label="XmlBeanDefinitionReader解析载入的Bean定义资源文件">XmlBeanDefinitionReader解析载入的Bean定义资源文件</a></li>
                    <li>
                        <a href="#defaultbeandefinitiondocumentreader%e5%af%b9bean%e5%ae%9a%e4%b9%89%e7%9a%84document%e5%af%b9%e8%b1%a1%e8%a7%a3%e6%9e%90" aria-label="DefaultBeanDefinitionDocumentReader对bean定义的Document对象解析">DefaultBeanDefinitionDocumentReader对bean定义的Document对象解析</a></li>
                    <li>
                        <a href="#beandefinitionparserdelegate-%e8%a7%a3%e6%9e%90bean%e5%ae%9a%e4%b9%89%e8%b5%84%e6%ba%90%e6%96%87%e4%bb%b6%e7%94%9f%e6%88%90beandefinition" aria-label="BeanDefinitionParserDelegate 解析Bean定义资源文件生成BeanDefinition">BeanDefinitionParserDelegate 解析Bean定义资源文件生成BeanDefinition</a></li>
                    <li>
                        <a href="#%e8%a7%a3%e6%9e%90%e8%bf%87%e5%90%8e%e7%9a%84beandefinition%e5%9c%a8ioc%e5%ae%b9%e5%99%a8%e4%b8%ad%e6%b3%a8%e5%86%8c" aria-label="解析过后的BeanDefinition在IoC容器中注册">解析过后的BeanDefinition在IoC容器中注册</a></li>
                    <li>
                        <a href="#defaultlistablebeanfactory-%e5%90%91ioc%e5%ae%b9%e5%99%a8%e6%b3%a8%e5%86%8c%e8%a7%a3%e6%9e%90%e5%90%8e%e7%9a%84beandefinition" aria-label="DefaultListableBeanFactory 向IoC容器注册解析后的BeanDefinition">DefaultListableBeanFactory 向IoC容器注册解析后的BeanDefinition</a></li>
                    <li>
                        <a href="#%e6%80%bb%e7%bb%93" aria-label="总结">总结</a></li>
                    <li>
                        <a href="#spring%e4%b8%adgetbean%e7%9a%84%e4%b8%bb%e4%bd%93%e6%80%9d%e8%b7%af" aria-label="Spring中getBean的主体思路">Spring中getBean的主体思路</a></li>
                    <li>
                        <a href="#%e9%87%8d%e7%82%b9-spring%e5%a6%82%e4%bd%95%e8%a7%a3%e5%86%b3%e5%be%aa%e7%8e%af%e4%be%9d%e8%b5%96%e9%97%ae%e9%a2%98" aria-label="重点: SPring如何解决循环依赖问题">重点: SPring如何解决循环依赖问题</a></li>
                    <li>
                        <a href="#spring%e5%8d%95%e4%be%8b%e6%a8%a1%e5%bc%8f%e4%b8%8b%e7%9a%84%e5%b1%9e%e6%80%a7%e4%be%9d%e8%b5%96" aria-label="Spring单例模式下的属性依赖">Spring单例模式下的属性依赖</a></li>
                    <li>
                        <a href="#spring%e4%b8%ba%e4%bd%95%e4%b8%8d%e8%83%bd%e8%a7%a3%e5%86%b3%e9%9d%9e%e5%8d%95%e4%be%8b%e5%b1%9e%e6%80%a7%e4%b9%8b%e5%a4%96%e7%9a%84%e5%be%aa%e7%8e%af%e4%be%9d%e8%b5%96" aria-label="Spring为何不能解决非单例属性之外的循环依赖？">Spring为何不能解决非单例属性之外的循环依赖？</a><ul>
                            
                    <li>
                        <a href="#spring%e4%b8%ba%e4%bb%80%e4%b9%88%e4%b8%8d%e8%83%bd%e8%a7%a3%e5%86%b3%e6%9e%84%e9%80%a0%e5%99%a8%e7%9a%84%e5%be%aa%e7%8e%af%e4%be%9d%e8%b5%96" aria-label="Spring为什么不能解决构造器的循环依赖">Spring为什么不能解决构造器的循环依赖</a></li>
                    <li>
                        <a href="#spring%e4%b8%ba%e4%bb%80%e4%b9%88%e4%b8%8d%e8%83%bd%e8%a7%a3%e5%86%b3prototype%e4%bd%9c%e7%94%a8%e5%9f%9f%e5%be%aa%e7%8e%af%e4%be%9d%e8%b5%96" aria-label="Spring为什么不能解决prototype作用域循环依赖">Spring为什么不能解决prototype作用域循环依赖</a></li>
                    <li>
                        <a href="#spring%e4%b8%ba%e4%bb%80%e4%b9%88%e4%b8%8d%e8%83%bd%e8%a7%a3%e5%86%b3%e5%a4%9a%e4%be%8b%e7%9a%84%e5%be%aa%e7%8e%af%e4%be%9d%e8%b5%96" aria-label="Spring为什么不能解决多例的循环依赖？">Spring为什么不能解决多例的循环依赖？</a></li></ul>
                    </li>
                    <li>
                        <a href="#%e9%82%a3%e4%b9%88%e5%85%b6%e4%bb%96%e5%be%aa%e7%8e%af%e4%be%9d%e8%b5%96%e5%a6%82%e4%bd%95%e8%a7%a3%e5%86%b3" aria-label="那么其他循环依赖如何解决？">那么其他循环依赖如何解决？</a></li>
                    <li>
                        <a href="#%e9%87%8d%e7%82%b9-spring%e4%b8%adbean%e7%9a%84%e7%94%9f%e5%91%bd%e5%91%a8%e6%9c%9f" aria-label="重点: Spring中Bean的生命周期">重点: Spring中Bean的生命周期</a>
                    </li>
                </ul>
                </li>
                </ul>
            </div>
        </details>
    </div>
</aside>
<script>
    let activeElement;
    let elements;
    window.addEventListener('DOMContentLoaded', function (event) {
        checkTocPosition();

        elements = document.querySelectorAll('h1[id],h2[id],h3[id],h4[id],h5[id],h6[id]');
         
         activeElement = elements[0];
         const id = encodeURI(activeElement.getAttribute('id')).toLowerCase();
         document.querySelector(`.inner ul li a[href="#${id}"]`).classList.add('active');
     }, false);

    window.addEventListener('resize', function(event) {
        checkTocPosition();
    }, false);

    window.addEventListener('scroll', () => {
        
        activeElement = Array.from(elements).find((element) => {
            if ((getOffsetTop(element) - window.pageYOffset) > 0 && 
                (getOffsetTop(element) - window.pageYOffset) < window.innerHeight/2) {
                return element;
            }
        }) || activeElement

        elements.forEach(element => {
             const id = encodeURI(element.getAttribute('id')).toLowerCase();
             if (element === activeElement){
                 document.querySelector(`.inner ul li a[href="#${id}"]`).classList.add('active');
             } else {
                 document.querySelector(`.inner ul li a[href="#${id}"]`).classList.remove('active');
             }
         })
     }, false);

    const main = parseInt(getComputedStyle(document.body).getPropertyValue('--article-width'), 10);
    const toc = parseInt(getComputedStyle(document.body).getPropertyValue('--toc-width'), 10);
    const gap = parseInt(getComputedStyle(document.body).getPropertyValue('--gap'), 10);

    function checkTocPosition() {
        const width = document.body.scrollWidth;

        if (width - main - (toc * 2) - (gap * 4) > 0) {
            document.getElementById("toc-container").classList.add("wide");
        } else {
            document.getElementById("toc-container").classList.remove("wide");
        }
    }

    function getOffsetTop(element) {
        if (!element.getClientRects().length) {
            return 0;
        }
        let rect = element.getBoundingClientRect();
        let win = element.ownerDocument.defaultView;
        return rect.top + win.pageYOffset;   
    }
</script>
  <div class="post-content"><h1 id="spring">Spring<a hidden class="anchor" aria-hidden="true" href="#spring">#</a></h1>
<h2 id="什么是spring框架">什么是Spring框架<a hidden class="anchor" aria-hidden="true" href="#什么是spring框架">#</a></h2>
<p>Spring是一种轻量级框架，旨在提高开发人员的开发效率和系统的可维护性。
我们一般说的Spring框架就是SPring Framework，他是很多模块的集合，使用这些模块可以很方便的协助我们进行开发。这些模块是核心容器、数据访问/集成、web、aop、工具、消息和测试模块。比如Core Container中的Core组件是Spring所有组件的核心，Beans组件和Context组件是实现IOC和DI的基础，AOP组件用来实现面向切面编程。</p>
<p>Spring官网列出来的Spring的6个特征:</p>
<li>核心技术：依赖注入，aop，事件，资源，i18n，验证，数据绑定，类型转换，SpEL</li>
<li>测试：模拟对象，TestContext框架，SPringMVC测试，WebTestClient</li>
<li>数据访问:事务，DAO支持，JDBC，ORM，编组XML</li>
<li>Web支持:Spring MVC和SPring WebFlux Web框架</li>
<li>集成:远程处理，JMS，JCA，JMX，电子邮件，任务，调度，缓存</li>
<li>语言：Kotlin，Groovy，动态语言</li>
<h2 id="spring中的单例bean的线程安全问题了解吗">Spring中的单例bean的线程安全问题了解吗？<a hidden class="anchor" aria-hidden="true" href="#spring中的单例bean的线程安全问题了解吗">#</a></h2>
<p>大部分我们并没有在系统中使用多线程，所以很少有人会关注这个问题。单例bean存在线程问题，主要是因为当多个线程操作同一个对象的时候，对这个对象的非静态成员变量的写操作会存在线程安全问题。</p>
<p>有两种常见解决方案：
1、在bean对象中尽量避免定义可变的成员变量。
2、在类中定义一个ThreadLocal成员变量，将需要的可变的成员变量保存在ThreadLocal中。</p>
<h2 id="spring中的bean生命周期">Spring中的bean生命周期？<a hidden class="anchor" aria-hidden="true" href="#spring中的bean生命周期">#</a></h2>
<p>Bean的完整生命周期经历了各种方法调用，这些方法可以划分为以下几类：</p>
<li>Bean自身的方法：这个包括了Bean本身调用的方法和通过配置文件中<bean>的init-method和destroy-method指定的方法</li>
<li>Bean级生命周期接口方法：这个包括了BeanNameAware、BeanFactoryAware、ApplicationContext;当然也包括InitializingBean和DiposableBean这些接口的方法</li>
<li>容器级生命周期接口方法：这个包括了InstantiationAwareBeanPostProcessor和BeanPostProcessor这两个接口实现，一般称它们的实现类为“后处理器”</li>
<li>工厂后处理器接口方法：这个包括了AspectJWeavingEnabler,ConfigurationClassPostProcessor,CustomAutowireConfigurer等等非常有用的工厂后处理接口的方法。工厂后处理器也是容器级的。在应用上下文装配配置文件之后立即调用。</li>
<h2 id="如何将bean从xml配置中解析后放到ioc容器中得">如何将Bean从XML配置中解析后放到IoC容器中得？<a hidden class="anchor" aria-hidden="true" href="#如何将bean从xml配置中解析后放到ioc容器中得">#</a></h2>
<h2 id="初始化的入口">初始化的入口<a hidden class="anchor" aria-hidden="true" href="#初始化的入口">#</a></h2>
<p>对于xml配置的Spring应用，在main()方法中实例化ClasspathXmlApplication即可创建一个IoC容器。我们可以从这个构造方法开始，探究一下IoC容器的初始化过程。</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span> <span style="color:#007f7f">// create and configure beans
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>ApplicationContext context = <span style="color:#fff;font-weight:bold">new</span> ClassPathXmlApplicationContext(<span style="color:#0ff;font-weight:bold">&#34;aspects.xml&#34;</span>, <span style="color:#0ff;font-weight:bold">&#34;daos.xml&#34;</span>, <span style="color:#0ff;font-weight:bold">&#34;services.xml&#34;</span>);
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> ClassPathXmlApplicationContext(String... configLocations) <span style="color:#fff;font-weight:bold">throws</span> BeansException {
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">this</span>(configLocations, <span style="color:#fff;font-weight:bold">true</span>, (ApplicationContext)<span style="color:#fff;font-weight:bold">null</span>);
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> ClassPathXmlApplicationContext(String[] configLocations, <span style="color:#fff;font-weight:bold">boolean</span> refresh, @Nullable ApplicationContext parent) <span style="color:#fff;font-weight:bold">throws</span> BeansException {
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// 设置Bean资源加载器
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    <span style="color:#fff;font-weight:bold">super</span>(parent);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// 设置配置路径
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">setConfigLocations</span>(configLocations);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// 初始化容器
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    <span style="color:#fff;font-weight:bold">if</span> (refresh) {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">refresh</span>();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="设置资源解析器和环境">设置资源解析器和环境<a hidden class="anchor" aria-hidden="true" href="#设置资源解析器和环境">#</a></h2>
<p>调用父类容器AbstractApplicationContext的构造方法(super(parent)方法)为容器设置好Bean资源加载器</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">7
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> AbstractApplicationContext(@Nullable ApplicationContext parent) {
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// 默认构造函数初始化容器id, name, 状态 以及 资源解析器
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    <span style="color:#fff;font-weight:bold">this</span>();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// 将父容器的Environment合并到当前容器
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">setParent</span>(parent);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>通过AbstractApplicationContext默认构造器初始化容器id,name,状态以及资源解析器</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> AbstractApplicationContext() {
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">logger</span> = LogFactory.<span style="color:#007f7f">getLog</span>(<span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">getClass</span>());
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">id</span> = ObjectUtils.<span style="color:#007f7f">identityToString</span>(<span style="color:#fff;font-weight:bold">this</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">displayName</span> = ObjectUtils.<span style="color:#007f7f">identityToString</span>(<span style="color:#fff;font-weight:bold">this</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">beanFactoryPostProcessors</span> = <span style="color:#fff;font-weight:bold">new</span> ArrayList();
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">active</span> = <span style="color:#fff;font-weight:bold">new</span> AtomicBoolean();
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">closed</span> = <span style="color:#fff;font-weight:bold">new</span> AtomicBoolean();
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">startupShutdownMonitor</span> = <span style="color:#fff;font-weight:bold">new</span> Object();
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">applicationStartup</span> = ApplicationStartup.<span style="color:#007f7f">DEFAULT</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">applicationListeners</span> = <span style="color:#fff;font-weight:bold">new</span> LinkedHashSet();
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">resourcePatternResolver</span> = <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">getResourcePatternResolver</span>();
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#007f7f">// Spring资源加载器
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span><span style="color:#fff;font-weight:bold">protected</span> ResourcePatternResolver getResourcePatternResolver() {
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">return</span> <span style="color:#fff;font-weight:bold">new</span> PathMatchingResourcePatternResolver(<span style="color:#fff;font-weight:bold">this</span>);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>通过AbstractApplicationContext的setParent(parent)方法将父容器的Enviroment合并到当前容器</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">8
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">9
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">void</span> setParent(@Nullable ApplicationContext parent) {
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">parent</span> = parent;
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">if</span> (parent != <span style="color:#fff;font-weight:bold">null</span>) {
</span></span><span style="display:flex;"><span>        Environment parentEnvironment = parent.<span style="color:#007f7f">getEnvironment</span>();
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">if</span> (parentEnvironment <span style="color:#fff;font-weight:bold">instanceof</span> ConfigurableEnvironment) {
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">getEnvironment</span>().<span style="color:#007f7f">merge</span>((ConfigurableEnvironment)parentEnvironment);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="设置配置路径">设置配置路径<a hidden class="anchor" aria-hidden="true" href="#设置配置路径">#</a></h2>
<p>在设置容器的资源加载器之后，接下来FileSystemXmlApplicationContent执行setConfigLocations方法通过调用其父类AbstractRefreshableConfigApplicationContext的方法进行对Bean定义资源文件的定位。</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">void</span> setConfigLocations(@Nullable String... locations) {
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">if</span> (locations != <span style="color:#fff;font-weight:bold">null</span>) {
</span></span><span style="display:flex;"><span>        Assert.<span style="color:#007f7f">noNullElements</span>(locations, <span style="color:#0ff;font-weight:bold">&#34;Config locations must not be null&#34;</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">configLocations</span> = <span style="color:#fff;font-weight:bold">new</span> String[locations.<span style="color:#007f7f">length</span>];
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">for</span>(<span style="color:#fff;font-weight:bold">int</span> i = <span style="color:#ff0;font-weight:bold">0</span>; i &lt; locations.<span style="color:#007f7f">length</span>; ++i) {
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">// 解析配置路径
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>            <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">configLocations</span>[i] = <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">resolvePath</span>(locations[i]).<span style="color:#007f7f">trim</span>();
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    } <span style="color:#fff;font-weight:bold">else</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">configLocations</span> = <span style="color:#fff;font-weight:bold">null</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">protected</span> String resolvePath(String path) {
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// 从上一步Environment中解析
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    <span style="color:#fff;font-weight:bold">return</span> <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">getEnvironment</span>().<span style="color:#007f7f">resolveRequiredPlaceholders</span>(path);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="初始化的主体流程">初始化的主体流程<a hidden class="anchor" aria-hidden="true" href="#初始化的主体流程">#</a></h2>
<p>Spring IoC容器对Bean定义资源的加载是从refresh()函数开始的，refresh()是一个模板方法，refresh()方法的作用是：在创建IoC容器前，如果已经有容器存在，则需要把已有的容器销毁和关闭，以保证在refresh()之后使用的是新建立起来的IoC容器。refresh的作用类似于对IoC容器的重启，在新建立好的容器中对容器进行初始化，对Bean定义资源进行载入。</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">27
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">28
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">29
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">30
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">31
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">32
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">33
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">34
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">35
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">36
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">37
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">38
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">39
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">40
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">41
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">42
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">43
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">44
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">45
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">46
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">47
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">48
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">49
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">50
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">51
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">52
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">53
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">54
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">55
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">56
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">57
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">58
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">59
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">60
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">61
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">62
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">63
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">64
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">65
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">66
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">67
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">68
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">69
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>@Override
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">void</span> refresh() <span style="color:#fff;font-weight:bold">throws</span> BeansException, IllegalStateException {
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">synchronized</span> (<span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">startupShutdownMonitor</span>) {
</span></span><span style="display:flex;"><span>        StartupStep contextRefresh = <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">applicationStartup</span>.<span style="color:#007f7f">start</span>(<span style="color:#0ff;font-weight:bold">&#34;spring.context.refresh&#34;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">// Prepare this context for refreshing.
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        prepareRefresh();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">// Tell the subclass to refresh the internal bean factory.
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        ConfigurableListableBeanFactory beanFactory = obtainFreshBeanFactory();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">// Prepare the bean factory for use in this context.
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        prepareBeanFactory(beanFactory);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">try</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">// Allows post-processing of the bean factory in context subclasses.
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>            postProcessBeanFactory(beanFactory);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            StartupStep beanPostProcess = <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">applicationStartup</span>.<span style="color:#007f7f">start</span>(<span style="color:#0ff;font-weight:bold">&#34;spring.context.beans.post-process&#34;</span>);
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">// Invoke factory processors registered as beans in the context.
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>            invokeBeanFactoryPostProcessors(beanFactory);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">// Register bean processors that intercept bean creation.
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>            registerBeanPostProcessors(beanFactory);
</span></span><span style="display:flex;"><span>            beanPostProcess.<span style="color:#007f7f">end</span>();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">// Initialize message source for this context.
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>            initMessageSource();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">// Initialize event multicaster for this context.
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>            initApplicationEventMulticaster();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">// Initialize other special beans in specific context subclasses.
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>            onRefresh();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">// Check for listener beans and register them.
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>            registerListeners();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">// Instantiate all remaining (non-lazy-init) singletons.
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>            finishBeanFactoryInitialization(beanFactory);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">// Last step: publish corresponding event.
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>            finishRefresh();
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">catch</span> (BeansException ex) {
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">if</span> (logger.<span style="color:#007f7f">isWarnEnabled</span>()) {
</span></span><span style="display:flex;"><span>                logger.<span style="color:#007f7f">warn</span>(<span style="color:#0ff;font-weight:bold">&#34;Exception encountered during context initialization - &#34;</span> +
</span></span><span style="display:flex;"><span>                        <span style="color:#0ff;font-weight:bold">&#34;cancelling refresh attempt: &#34;</span> + ex);
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">// Destroy already created singletons to avoid dangling resources.
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>            destroyBeans();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">// Reset &#39;active&#39; flag.
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>            cancelRefresh(ex);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">// Propagate exception to caller.
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>            <span style="color:#fff;font-weight:bold">throw</span> ex;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">finally</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">// Reset common introspection caches in Spring&#39;s core, since we
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>            <span style="color:#007f7f">// might not ever need metadata for singleton beans anymore...
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>            resetCommonCaches();
</span></span><span style="display:flex;"><span>            contextRefresh.<span style="color:#007f7f">end</span>();
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p><b>这里的设计上是一个非常典型的资源类加载处理型的思路</b></p>
<li>模板方法设计模式，模板方法中使用典型的钩子方法</li>
<li>将具体的初始化加载方法插入到钩子方法之间</li>
<li>将初始化的阶段封装，用来记录当前初始化到什么阶段；常见的设计是xxxPhase/xxxStage</li>
<li>资源加载初始化有失败等处理，必然是try/catch/finally</li>
<h2 id="初始化beanfactory之obtainfreshbeanfactory">初始化BeanFactory之obtainFreshBeanFactory<a hidden class="anchor" aria-hidden="true" href="#初始化beanfactory之obtainfreshbeanfactory">#</a></h2>
<p>AbstractApplicationContext的obtainFreshBeanFactory()方法调用子类容器的refreshBeanFactory()方法，启动容器载入Bean定义资源文件的过程，代码如下</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">5
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">protected</span> ConfigurableListableBeanFactory obtainFreshBeanFactory() {
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// 这里使用了委派设计模式，父类定义了抽象的refreshBeanFactory()方法，具体实现调用子类容器的refreshBeanFactory()方法
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    refreshBeanFactory();
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">return</span> getBeanFactory();
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>AbstractApplicationCOntext类中只抽象定义了refreshBeanFactory()方法，容器真正调用的是子类的AbstractRefreshableApplicationContext实现的refreshBeanFactory（）方法留在创建IoC容器之前，如果已经有容器存在，则需要把已有的容器销毁和关闭，以保证在refresh之后使用的是新建立起来的IoC容器。方法源码如下:</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">protected</span> <span style="color:#fff;font-weight:bold">final</span> <span style="color:#fff;font-weight:bold">void</span> refreshBeanFactory() <span style="color:#fff;font-weight:bold">throws</span> BeansException {
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// 如果已经有容器存在，则需要把已有的容器销毁和关闭，以保证在refresh之后使用的是新建立起来的IoC容器
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    <span style="color:#fff;font-weight:bold">if</span> (hasBeanFactory()) {
</span></span><span style="display:flex;"><span>        destroyBeans();
</span></span><span style="display:flex;"><span>        closeBeanFactory();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">try</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">// 创建DefaultListableBeanFactory，并调用loadBeanDefinitions(beanFactory)装载bean定义
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        DefaultListableBeanFactory beanFactory = createBeanFactory();
</span></span><span style="display:flex;"><span>        beanFactory.<span style="color:#007f7f">setSerializationId</span>(getId());
</span></span><span style="display:flex;"><span>        customizeBeanFactory(beanFactory); <span style="color:#007f7f">// 对IoC容器进行定制化，如设置启动参数，开启注解的自动装配等 
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        loadBeanDefinitions(beanFactory); <span style="color:#007f7f">// 调用载入Bean定义的方法，主要这里又使用了一个委派模式，在当前类中只定义了抽象的loadBeanDefinitions方法，具体的实现调用子类容器  
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">beanFactory</span> = beanFactory;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">catch</span> (IOException ex) {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">throw</span> <span style="color:#fff;font-weight:bold">new</span> ApplicationContextException(<span style="color:#0ff;font-weight:bold">&#34;I/O error parsing bean definition source for &#34;</span> + getDisplayName(), ex);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="初始化beanfactory之loadbeandefinitions">初始化BeanFactory之loadBeanDefinitions<a hidden class="anchor" aria-hidden="true" href="#初始化beanfactory之loadbeandefinitions">#</a></h2>
<p>AbstractRefreshableApplicationContext中只定义了抽象的loadBeanDefinitions方法，容器真正调用的是其子类的AbstractXmlApplicationContext对该方法的实现，AbstractXmlApplicationContext的主要源码如下：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">protected</span> <span style="color:#fff;font-weight:bold">void</span> loadBeanDefinitions(DefaultListableBeanFactory beanFactory) <span style="color:#fff;font-weight:bold">throws</span> BeansException, IOException {
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// 创建XmlBeanDefinitionReader，即创建Bean读取器，并通过回调设置到容器中去，容器使用该读取器读取Bean定义资源  
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    XmlBeanDefinitionReader beanDefinitionReader = <span style="color:#fff;font-weight:bold">new</span> XmlBeanDefinitionReader(beanFactory);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// 配置上下文的环境，资源加载器、解析器
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    beanDefinitionReader.<span style="color:#007f7f">setEnvironment</span>(<span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">getEnvironment</span>());
</span></span><span style="display:flex;"><span>    beanDefinitionReader.<span style="color:#007f7f">setResourceLoader</span>(<span style="color:#fff;font-weight:bold">this</span>);
</span></span><span style="display:flex;"><span>    beanDefinitionReader.<span style="color:#007f7f">setEntityResolver</span>(<span style="color:#fff;font-weight:bold">new</span> ResourceEntityResolver(<span style="color:#fff;font-weight:bold">this</span>)); <span style="color:#007f7f">// 为Bean读取器设置SAX xml解析器
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// 允许子类自行初始化（比如校验机制），并提供真正的加载方法
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    initBeanDefinitionReader(beanDefinitionReader); <span style="color:#007f7f">// 当Bean读取器读取Bean定义的Xml资源文件时，启用Xml的校验机制  
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    loadBeanDefinitions(beanDefinitionReader);
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">protected</span> <span style="color:#fff;font-weight:bold">void</span> loadBeanDefinitions(XmlBeanDefinitionReader reader) <span style="color:#fff;font-weight:bold">throws</span> BeansException, IOException {
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// 加载XML配置方式里的Bean定义的资源
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    Resource[] configResources = getConfigResources();
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">if</span> (configResources != <span style="color:#fff;font-weight:bold">null</span>) {
</span></span><span style="display:flex;"><span>        reader.<span style="color:#007f7f">loadBeanDefinitions</span>(configResources);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// 加载构造函数里配置的Bean配置文件，即{&#34;aspects.xml&#34;, &#34;daos.xml&#34;, &#34;services.xml&#34;}
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    String[] configLocations = getConfigLocations();
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">if</span> (configLocations != <span style="color:#fff;font-weight:bold">null</span>) {
</span></span><span style="display:flex;"><span>        reader.<span style="color:#007f7f">loadBeanDefinitions</span>(configLocations);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>Xml Bean读取器(XmBeanDefinitionReader)调用其父类AbstractBeanDefinitionReader的reader.loadBeanDefinitions方法读取bean定义资源</p>
<p>由于我们使用ClassPathXmlApplicationCOntext作为例子分析，因此getConfigResources的返回值为null，因此程序执行reader,loadBeanDefinitions(configLocations)分支。</p>
<h2 id="abstractbeandefinitionreader读取bean定义资源">AbstractBeanDefinitionReader读取Bean定义资源<a hidden class="anchor" aria-hidden="true" href="#abstractbeandefinitionreader读取bean定义资源">#</a></h2>
<p>AbstractBeanDifinitionReader的loadBeanDefinitions方法源码如下:</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">27
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">28
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">29
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">30
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">31
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">32
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">33
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">34
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">35
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">36
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">37
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">38
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">39
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">40
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">41
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">42
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">43
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">44
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>@Override
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">int</span> loadBeanDefinitions(String location) <span style="color:#fff;font-weight:bold">throws</span> BeanDefinitionStoreException {
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">return</span> loadBeanDefinitions(location, <span style="color:#fff;font-weight:bold">null</span>);
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">int</span> loadBeanDefinitions(String location, @Nullable Set&lt;Resource&gt; actualResources) <span style="color:#fff;font-weight:bold">throws</span> BeanDefinitionStoreException {
</span></span><span style="display:flex;"><span>    ResourceLoader resourceLoader = getResourceLoader();
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">if</span> (resourceLoader == <span style="color:#fff;font-weight:bold">null</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">throw</span> <span style="color:#fff;font-weight:bold">new</span> BeanDefinitionStoreException(
</span></span><span style="display:flex;"><span>                <span style="color:#0ff;font-weight:bold">&#34;Cannot load bean definitions from location [&#34;</span> + location + <span style="color:#0ff;font-weight:bold">&#34;]: no ResourceLoader available&#34;</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// 模式匹配类型的解析器，这种方式是加载多个满足匹配条件的资源
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    <span style="color:#fff;font-weight:bold">if</span> (resourceLoader <span style="color:#fff;font-weight:bold">instanceof</span> ResourcePatternResolver) {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">try</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">// 获取到要加载的资源
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>            Resource[] resources = ((ResourcePatternResolver) resourceLoader).<span style="color:#007f7f">getResources</span>(location);
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">int</span> count = loadBeanDefinitions(resources); <span style="color:#007f7f">// 委派调用其子类XmlBeanDefinitionReader的方法，实现加载功能  
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>            <span style="color:#fff;font-weight:bold">if</span> (actualResources != <span style="color:#fff;font-weight:bold">null</span>) {
</span></span><span style="display:flex;"><span>                Collections.<span style="color:#007f7f">addAll</span>(actualResources, resources);
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">if</span> (logger.<span style="color:#007f7f">isTraceEnabled</span>()) {
</span></span><span style="display:flex;"><span>                logger.<span style="color:#007f7f">trace</span>(<span style="color:#0ff;font-weight:bold">&#34;Loaded &#34;</span> + count + <span style="color:#0ff;font-weight:bold">&#34; bean definitions from location pattern [&#34;</span> + location + <span style="color:#0ff;font-weight:bold">&#34;]&#34;</span>);
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">return</span> count;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">catch</span> (IOException ex) {
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">throw</span> <span style="color:#fff;font-weight:bold">new</span> BeanDefinitionStoreException(
</span></span><span style="display:flex;"><span>                    <span style="color:#0ff;font-weight:bold">&#34;Could not resolve bean definition resource pattern [&#34;</span> + location + <span style="color:#0ff;font-weight:bold">&#34;]&#34;</span>, ex);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">else</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">// 只能通过绝对路径URL加载单个资源.
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        Resource resource = resourceLoader.<span style="color:#007f7f">getResource</span>(location);
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">int</span> count = loadBeanDefinitions(resource);
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">if</span> (actualResources != <span style="color:#fff;font-weight:bold">null</span>) {
</span></span><span style="display:flex;"><span>            actualResources.<span style="color:#007f7f">add</span>(resource);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">if</span> (logger.<span style="color:#007f7f">isTraceEnabled</span>()) {
</span></span><span style="display:flex;"><span>            logger.<span style="color:#007f7f">trace</span>(<span style="color:#0ff;font-weight:bold">&#34;Loaded &#34;</span> + count + <span style="color:#0ff;font-weight:bold">&#34; bean definitions from location [&#34;</span> + location + <span style="color:#0ff;font-weight:bold">&#34;]&#34;</span>);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> count;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>从对AbstractBeanDefinitionReader的loadBeanDefinitions方法源码分析可以看出该方法做了以下两件事:</p>
<p>1、首先，调用资源加载器的获取资源方法resourceLoader.getResource(location)，获取到要加载的资源。
2、其次，真正执行加载功能的是其子类XmlBeanDefinitionReader的loadBeanDefinitions方法</p>
<h2 id="xmlbeandefinitionreader加载bean定义资源">XmlBeanDefinitionReader加载Bean定义资源<a hidden class="anchor" aria-hidden="true" href="#xmlbeandefinitionreader加载bean定义资源">#</a></h2>
<p>继续看子类XmlBeanDefinitionReader的loadBeanDefinitions(Resource&hellip;)方法看到代表bean文件的资源定义以后的载入过程。</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">27
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">28
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">29
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">30
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">31
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">32
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">33
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">34
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">35
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">36
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">37
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">38
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">39
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">40
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">41
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">42
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">43
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">44
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">45
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">46
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007f7f">/**
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">    * 本质上是加载XML配置的Bean。
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">    * @param inputSource the SAX InputSource to read from
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">    * @param resource the resource descriptor for the XML file
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">    */</span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">protected</span> <span style="color:#fff;font-weight:bold">int</span> doLoadBeanDefinitions(InputSource inputSource, Resource resource)
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">throws</span> BeanDefinitionStoreException {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">try</span> {
</span></span><span style="display:flex;"><span>        Document doc = doLoadDocument(inputSource, resource); <span style="color:#007f7f">// 将Bean定义资源转换成Document对象
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        <span style="color:#fff;font-weight:bold">int</span> count = registerBeanDefinitions(doc, resource);
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">if</span> (logger.<span style="color:#007f7f">isDebugEnabled</span>()) {
</span></span><span style="display:flex;"><span>            logger.<span style="color:#007f7f">debug</span>(<span style="color:#0ff;font-weight:bold">&#34;Loaded &#34;</span> + count + <span style="color:#0ff;font-weight:bold">&#34; bean definitions from &#34;</span> + resource);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> count;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">catch</span> (BeanDefinitionStoreException ex) {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">throw</span> ex;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">catch</span> (SAXParseException ex) {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">throw</span> <span style="color:#fff;font-weight:bold">new</span> XmlBeanDefinitionStoreException(resource.<span style="color:#007f7f">getDescription</span>(),
</span></span><span style="display:flex;"><span>                <span style="color:#0ff;font-weight:bold">&#34;Line &#34;</span> + ex.<span style="color:#007f7f">getLineNumber</span>() + <span style="color:#0ff;font-weight:bold">&#34; in XML document from &#34;</span> + resource + <span style="color:#0ff;font-weight:bold">&#34; is invalid&#34;</span>, ex);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">catch</span> (SAXException ex) {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">throw</span> <span style="color:#fff;font-weight:bold">new</span> XmlBeanDefinitionStoreException(resource.<span style="color:#007f7f">getDescription</span>(),
</span></span><span style="display:flex;"><span>                <span style="color:#0ff;font-weight:bold">&#34;XML document from &#34;</span> + resource + <span style="color:#0ff;font-weight:bold">&#34; is invalid&#34;</span>, ex);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">catch</span> (ParserConfigurationException ex) {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">throw</span> <span style="color:#fff;font-weight:bold">new</span> BeanDefinitionStoreException(resource.<span style="color:#007f7f">getDescription</span>(),
</span></span><span style="display:flex;"><span>                <span style="color:#0ff;font-weight:bold">&#34;Parser configuration exception parsing XML from &#34;</span> + resource, ex);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">catch</span> (IOException ex) {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">throw</span> <span style="color:#fff;font-weight:bold">new</span> BeanDefinitionStoreException(resource.<span style="color:#007f7f">getDescription</span>(),
</span></span><span style="display:flex;"><span>                <span style="color:#0ff;font-weight:bold">&#34;IOException parsing XML document from &#34;</span> + resource, ex);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">catch</span> (Throwable ex) {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">throw</span> <span style="color:#fff;font-weight:bold">new</span> BeanDefinitionStoreException(resource.<span style="color:#007f7f">getDescription</span>(),
</span></span><span style="display:flex;"><span>                <span style="color:#0ff;font-weight:bold">&#34;Unexpected exception parsing XML document from &#34;</span> + resource, ex);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f">// 使用配置的DocumentLoader加载XML定义文件为Document.
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span><span style="color:#fff;font-weight:bold">protected</span> Document doLoadDocument(InputSource inputSource, Resource resource) <span style="color:#fff;font-weight:bold">throws</span> Exception {
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">return</span> <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">documentLoader</span>.<span style="color:#007f7f">loadDocument</span>(inputSource, getEntityResolver(), <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">errorHandler</span>,
</span></span><span style="display:flex;"><span>            getValidationModeForResource(resource), isNamespaceAware());
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>通过源码分析，载入Bean定义资源文件的最后一步是将Bean定义资源转换为Document对象，该过程由documentLoader实现</p>
<h2 id="documentloader将bean定义资源转换为document对象">DocumentLoader将Bean定义资源转换为Document对象<a hidden class="anchor" aria-hidden="true" href="#documentloader将bean定义资源转换为document对象">#</a></h2>
<p>DocumentLoader将Bean定义资源转换为Document对象的源码如下:</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">27
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">28
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">29
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">30
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">31
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">32
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">33
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">34
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">35
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">36
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">37
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">38
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">39
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">40
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">41
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">42
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">43
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007f7f">// 使用标准的JAXP将载入的Bean定义资源转换成document对象
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>@Override
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> Document loadDocument(InputSource inputSource, EntityResolver entityResolver,
</span></span><span style="display:flex;"><span>        ErrorHandler errorHandler, <span style="color:#fff;font-weight:bold">int</span> validationMode, <span style="color:#fff;font-weight:bold">boolean</span> namespaceAware) <span style="color:#fff;font-weight:bold">throws</span> Exception {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// 创建文件解析器工厂
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    DocumentBuilderFactory factory = createDocumentBuilderFactory(validationMode, namespaceAware);
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">if</span> (logger.<span style="color:#007f7f">isTraceEnabled</span>()) {
</span></span><span style="display:flex;"><span>        logger.<span style="color:#007f7f">trace</span>(<span style="color:#0ff;font-weight:bold">&#34;Using JAXP provider [&#34;</span> + factory.<span style="color:#007f7f">getClass</span>().<span style="color:#007f7f">getName</span>() + <span style="color:#0ff;font-weight:bold">&#34;]&#34;</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// 创建文档解析器
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    DocumentBuilder builder = createDocumentBuilder(factory, entityResolver, errorHandler);
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">return</span> builder.<span style="color:#007f7f">parse</span>(inputSource); <span style="color:#007f7f">// 解析
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">protected</span> DocumentBuilderFactory createDocumentBuilderFactory(<span style="color:#fff;font-weight:bold">int</span> validationMode, <span style="color:#fff;font-weight:bold">boolean</span> namespaceAware)
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">throws</span> ParserConfigurationException {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    DocumentBuilderFactory factory = DocumentBuilderFactory.<span style="color:#007f7f">newInstance</span>();
</span></span><span style="display:flex;"><span>    factory.<span style="color:#007f7f">setNamespaceAware</span>(namespaceAware);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// 设置解析XML的校验
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    <span style="color:#fff;font-weight:bold">if</span> (validationMode != XmlValidationModeDetector.<span style="color:#007f7f">VALIDATION_NONE</span>) {
</span></span><span style="display:flex;"><span>        factory.<span style="color:#007f7f">setValidating</span>(<span style="color:#fff;font-weight:bold">true</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">if</span> (validationMode == XmlValidationModeDetector.<span style="color:#007f7f">VALIDATION_XSD</span>) {
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">// Enforce namespace aware for XSD...
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>            factory.<span style="color:#007f7f">setNamespaceAware</span>(<span style="color:#fff;font-weight:bold">true</span>);
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">try</span> {
</span></span><span style="display:flex;"><span>                factory.<span style="color:#007f7f">setAttribute</span>(SCHEMA_LANGUAGE_ATTRIBUTE, XSD_SCHEMA_LANGUAGE);
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">catch</span> (IllegalArgumentException ex) {
</span></span><span style="display:flex;"><span>                ParserConfigurationException pcex = <span style="color:#fff;font-weight:bold">new</span> ParserConfigurationException(
</span></span><span style="display:flex;"><span>                        <span style="color:#0ff;font-weight:bold">&#34;Unable to validate using XSD: Your JAXP provider [&#34;</span> + factory +
</span></span><span style="display:flex;"><span>                        <span style="color:#0ff;font-weight:bold">&#34;] does not support XML Schema. Are you running on Java 1.4 with Apache Crimson? &#34;</span> +
</span></span><span style="display:flex;"><span>                        <span style="color:#0ff;font-weight:bold">&#34;Upgrade to Apache Xerces (or Java 1.5) for full XSD support.&#34;</span>);
</span></span><span style="display:flex;"><span>                pcex.<span style="color:#007f7f">initCause</span>(ex);
</span></span><span style="display:flex;"><span>                <span style="color:#fff;font-weight:bold">throw</span> pcex;
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">return</span> factory;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>该解析过程调用JavaEE标准的JAXP标准进行处理。</p>
<p>至此Spring IoC容器根据定位的Bean定义资源文件，将其加载读入并转换成为Document对象过程完成。</p>
<p>接下来我们继续分析Spring IoC容器将载入的Bean定义资源文件转换为Document对象之后，是如何将其解析为Spring IoC管理的Bean对象，并将其注册到容器中的。</p>
<h2 id="xmlbeandefinitionreader解析载入的bean定义资源文件">XmlBeanDefinitionReader解析载入的Bean定义资源文件<a hidden class="anchor" aria-hidden="true" href="#xmlbeandefinitionreader解析载入的bean定义资源文件">#</a></h2>
<p>XmlBeanDefinitionReader类中的doLoadBeanDefinitions方法是从特定的XML文件中实际载入Bean定义资源的方法，该方法在载入Bean定义资源之后将其转换为Document对象，接下来调用registerBeanDefinitions启动Spring IoC容器对Bean定义的解析过程，registerBeanDefinition方法源码如下:</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007f7f">// 按照Spring的Bean语义要求将Bean定义资源解析并转换为容器内部数据结构 
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">int</span> registerBeanDefinitions(Document doc, Resource resource) <span style="color:#fff;font-weight:bold">throws</span> BeanDefinitionStoreException {
</span></span><span style="display:flex;"><span>    BeanDefinitionDocumentReader documentReader = createBeanDefinitionDocumentReader();
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">int</span> countBefore = getRegistry().<span style="color:#007f7f">getBeanDefinitionCount</span>();
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// 解析过程入口，这里使用了委派模式，具体的解析实现过程有实现类DefaultBeanDefinitionDocumentReader完成  
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    documentReader.<span style="color:#007f7f">registerBeanDefinitions</span>(doc, createReaderContext(resource));
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">return</span> getRegistry().<span style="color:#007f7f">getBeanDefinitionCount</span>() - countBefore;  <span style="color:#007f7f">// 返回此次解析了多少个对象
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f">// 创建BeanDefinitionDocumentReader对象，解析Document对象  
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span><span style="color:#fff;font-weight:bold">protected</span> BeanDefinitionDocumentReader createBeanDefinitionDocumentReader() {
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">return</span> BeanUtils.<span style="color:#007f7f">instantiateClass</span>(<span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">documentReaderClass</span>);
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f">/**
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">    * Create the {@link XmlReaderContext} to pass over to the document reader.
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">    */</span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> XmlReaderContext createReaderContext(Resource resource) {
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">return</span> <span style="color:#fff;font-weight:bold">new</span> XmlReaderContext(resource, <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">problemReporter</span>, <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">eventListener</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">sourceExtractor</span>, <span style="color:#fff;font-weight:bold">this</span>, getNamespaceHandlerResolver());
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>Bean定义资源的载入解析分为以下两个过程:</p>
<p>1、首先，通过调用XML解析器将Bean定义资源文件转换得到Document对象，但是这些Document对象并没有按照Spring的Bean规则进行解析。这一部是载入的过程
2、其次，在完成通用的XML解析之后，按照Spring的Bean规则对Document对象进行解析。</p>
<p>按照Spring的Bean规则对Document对象解析的过程是在接口BeanDifinitionDocumentReader的实现类DefaultBeanDefinitionDocumentReader中实现的。</p>
<h2 id="defaultbeandefinitiondocumentreader对bean定义的document对象解析">DefaultBeanDefinitionDocumentReader对bean定义的Document对象解析<a hidden class="anchor" aria-hidden="true" href="#defaultbeandefinitiondocumentreader对bean定义的document对象解析">#</a></h2>
<p>BeanDefinitionDocumentReader接口通过registerBeanDefinitions方法调用其实现类DefaultBeanDefinitionDocumentReader对Document对象进行解析，解析代码如下:</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">27
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">28
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">29
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">30
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">31
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">32
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">33
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">34
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">35
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">36
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">37
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">38
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">39
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">40
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">41
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>@Override
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">void</span> registerBeanDefinitions(Document doc, XmlReaderContext readerContext) {
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">readerContext</span> = readerContext;
</span></span><span style="display:flex;"><span>    doRegisterBeanDefinitions(doc.<span style="color:#007f7f">getDocumentElement</span>());
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f">// 注册&lt;beans/&gt;配置的Beans
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>@SuppressWarnings(<span style="color:#0ff;font-weight:bold">&#34;deprecation&#34;</span>)  <span style="color:#007f7f">// for Environment.acceptsProfiles(String...)
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span><span style="color:#fff;font-weight:bold">protected</span> <span style="color:#fff;font-weight:bold">void</span> doRegisterBeanDefinitions(Element root) {
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// Any nested &lt;beans&gt; elements will cause recursion in this method. In
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    <span style="color:#007f7f">// order to propagate and preserve &lt;beans&gt; default-* attributes correctly,
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    <span style="color:#007f7f">// keep track of the current (parent) delegate, which may be null. Create
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    <span style="color:#007f7f">// the new (child) delegate with a reference to the parent for fallback purposes,
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    <span style="color:#007f7f">// then ultimately reset this.delegate back to its original (parent) reference.
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    <span style="color:#007f7f">// this behavior emulates a stack of delegates without actually necessitating one.
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    BeanDefinitionParserDelegate parent = <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">delegate</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">delegate</span> = createDelegate(getReaderContext(), root, parent);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">if</span> (<span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">delegate</span>.<span style="color:#007f7f">isDefaultNamespace</span>(root)) {
</span></span><span style="display:flex;"><span>        String profileSpec = root.<span style="color:#007f7f">getAttribute</span>(PROFILE_ATTRIBUTE);
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">if</span> (StringUtils.<span style="color:#007f7f">hasText</span>(profileSpec)) {
</span></span><span style="display:flex;"><span>            String[] specifiedProfiles = StringUtils.<span style="color:#007f7f">tokenizeToStringArray</span>(
</span></span><span style="display:flex;"><span>                    profileSpec, BeanDefinitionParserDelegate.<span style="color:#007f7f">MULTI_VALUE_ATTRIBUTE_DELIMITERS</span>);
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">// We cannot use Profiles.of(...) since profile expressions are not supported
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>            <span style="color:#007f7f">// in XML config. See SPR-12458 for details.
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>            <span style="color:#fff;font-weight:bold">if</span> (!getReaderContext().<span style="color:#007f7f">getEnvironment</span>().<span style="color:#007f7f">acceptsProfiles</span>(specifiedProfiles)) {
</span></span><span style="display:flex;"><span>                <span style="color:#fff;font-weight:bold">if</span> (logger.<span style="color:#007f7f">isDebugEnabled</span>()) {
</span></span><span style="display:flex;"><span>                    logger.<span style="color:#007f7f">debug</span>(<span style="color:#0ff;font-weight:bold">&#34;Skipped XML bean definition file due to specified profiles [&#34;</span> + profileSpec +
</span></span><span style="display:flex;"><span>                            <span style="color:#0ff;font-weight:bold">&#34;] not matching: &#34;</span> + getReaderContext().<span style="color:#007f7f">getResource</span>());
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>                <span style="color:#fff;font-weight:bold">return</span>;
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    preProcessXml(root);
</span></span><span style="display:flex;"><span>    parseBeanDefinitions(root, <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">delegate</span>); <span style="color:#007f7f">// 从Document的根元素开始进行Bean定义的Document对象  
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    postProcessXml(root);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">delegate</span> = parent;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="beandefinitionparserdelegate-解析bean定义资源文件生成beandefinition">BeanDefinitionParserDelegate 解析Bean定义资源文件生成BeanDefinition<a hidden class="anchor" aria-hidden="true" href="#beandefinitionparserdelegate-解析bean定义资源文件生成beandefinition">#</a></h2>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">27
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">28
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">29
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">30
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">31
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">32
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">33
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">34
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">35
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">36
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">37
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">38
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">39
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">40
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">41
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">42
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">43
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">44
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">45
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">46
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007f7f">/**
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">    * Parse the elements at the root level in the document:
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">    * &#34;import&#34;, &#34;alias&#34;, &#34;bean&#34;.
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">    * @param root the DOM root element of the document
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">    */</span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">protected</span> <span style="color:#fff;font-weight:bold">void</span> parseBeanDefinitions(Element root, BeanDefinitionParserDelegate delegate) {
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">if</span> (delegate.<span style="color:#007f7f">isDefaultNamespace</span>(root)) {
</span></span><span style="display:flex;"><span>        NodeList nl = root.<span style="color:#007f7f">getChildNodes</span>();
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">for</span> (<span style="color:#fff;font-weight:bold">int</span> i = <span style="color:#ff0;font-weight:bold">0</span>; i &lt; nl.<span style="color:#007f7f">getLength</span>(); i++) {
</span></span><span style="display:flex;"><span>            Node node = nl.<span style="color:#007f7f">item</span>(i);
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">if</span> (node <span style="color:#fff;font-weight:bold">instanceof</span> Element) {
</span></span><span style="display:flex;"><span>                Element ele = (Element) node;
</span></span><span style="display:flex;"><span>                <span style="color:#fff;font-weight:bold">if</span> (delegate.<span style="color:#007f7f">isDefaultNamespace</span>(ele)) {
</span></span><span style="display:flex;"><span>                    parseDefaultElement(ele, delegate);
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>                <span style="color:#fff;font-weight:bold">else</span> {
</span></span><span style="display:flex;"><span>                    delegate.<span style="color:#007f7f">parseCustomElement</span>(ele);
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">else</span> {
</span></span><span style="display:flex;"><span>        delegate.<span style="color:#007f7f">parseCustomElement</span>(root);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">private</span> <span style="color:#fff;font-weight:bold">void</span> parseDefaultElement(Element ele, BeanDefinitionParserDelegate delegate) {
</span></span><span style="display:flex;"><span>      
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// 如果元素节点是&lt;Import&gt;导入元素，进行导入解析
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    <span style="color:#fff;font-weight:bold">if</span> (delegate.<span style="color:#007f7f">nodeNameEquals</span>(ele, IMPORT_ELEMENT)) {
</span></span><span style="display:flex;"><span>        importBeanDefinitionResource(ele);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// 如果元素节点是&lt;Alias&gt;别名元素，进行别名解析 
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    <span style="color:#fff;font-weight:bold">else</span> <span style="color:#fff;font-weight:bold">if</span> (delegate.<span style="color:#007f7f">nodeNameEquals</span>(ele, ALIAS_ELEMENT)) {
</span></span><span style="display:flex;"><span>        processAliasRegistration(ele);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// 如果元素节点&lt;Bean&gt;元素, 按照Spring的Bean规则解析元素  
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    <span style="color:#fff;font-weight:bold">else</span> <span style="color:#fff;font-weight:bold">if</span> (delegate.<span style="color:#007f7f">nodeNameEquals</span>(ele, BEAN_ELEMENT)) {
</span></span><span style="display:flex;"><span>        processBeanDefinition(ele, delegate);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// 如果元素节点&lt;Beans&gt;元素，即它是嵌套类型的
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    <span style="color:#fff;font-weight:bold">else</span> <span style="color:#fff;font-weight:bold">if</span> (delegate.<span style="color:#007f7f">nodeNameEquals</span>(ele, NESTED_BEANS_ELEMENT)) {
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">// 递归解析
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        doRegisterBeanDefinitions(ele);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>解析Bean生成BeanDefinitionHolder的方法</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007f7f">/**
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">    * Process the given bean element, parsing the bean definition
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">    * and registering it with the registry.
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">    */</span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">protected</span> <span style="color:#fff;font-weight:bold">void</span> processBeanDefinition(Element ele, BeanDefinitionParserDelegate delegate) {
</span></span><span style="display:flex;"><span>    BeanDefinitionHolder bdHolder = delegate.<span style="color:#007f7f">parseBeanDefinitionElement</span>(ele);
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">if</span> (bdHolder != <span style="color:#fff;font-weight:bold">null</span>) {
</span></span><span style="display:flex;"><span>        bdHolder = delegate.<span style="color:#007f7f">decorateBeanDefinitionIfRequired</span>(ele, bdHolder);
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">try</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">// 注册最终的装饰实例
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>            BeanDefinitionReaderUtils.<span style="color:#007f7f">registerBeanDefinition</span>(bdHolder, getReaderContext().<span style="color:#007f7f">getRegistry</span>());
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">catch</span> (BeanDefinitionStoreException ex) {
</span></span><span style="display:flex;"><span>            getReaderContext().<span style="color:#007f7f">error</span>(<span style="color:#0ff;font-weight:bold">&#34;Failed to register bean definition with name &#39;&#34;</span> +
</span></span><span style="display:flex;"><span>                    bdHolder.<span style="color:#007f7f">getBeanName</span>() + <span style="color:#0ff;font-weight:bold">&#34;&#39;&#34;</span>, ele, ex);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">// Send registration event.
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        getReaderContext().<span style="color:#007f7f">fireComponentRegistered</span>(<span style="color:#fff;font-weight:bold">new</span> BeanComponentDefinition(bdHolder));
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="解析过后的beandefinition在ioc容器中注册">解析过后的BeanDefinition在IoC容器中注册<a hidden class="anchor" aria-hidden="true" href="#解析过后的beandefinition在ioc容器中注册">#</a></h2>
<p>Document对象的解析后得到封装BeanDefinition的BeanDifinitionHold对象，然后调用BeanDefinitionReaderUtils的registerBeanDefinition方法向IoC容器注册解析的Bean，BeanDefinitionReaderUtils的注册的源码如下:</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007f7f">// 通过BeanDefinitionRegistry将BeanDefinitionHolder注册到BeanFactory
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">static</span> <span style="color:#fff;font-weight:bold">void</span> registerBeanDefinition(
</span></span><span style="display:flex;"><span>        BeanDefinitionHolder definitionHolder, BeanDefinitionRegistry registry)
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">throws</span> BeanDefinitionStoreException {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// Register bean definition under primary name.
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    String beanName = definitionHolder.<span style="color:#007f7f">getBeanName</span>();
</span></span><span style="display:flex;"><span>    registry.<span style="color:#007f7f">registerBeanDefinition</span>(beanName, definitionHolder.<span style="color:#007f7f">getBeanDefinition</span>());
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// Register aliases for bean name, if any.
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    String[] aliases = definitionHolder.<span style="color:#007f7f">getAliases</span>();
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">if</span> (aliases != <span style="color:#fff;font-weight:bold">null</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">for</span> (String alias : aliases) {
</span></span><span style="display:flex;"><span>            registry.<span style="color:#007f7f">registerAlias</span>(beanName, alias);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>当调用BeanDefinitionReaderUtils向IoC容器注册解析的BeanDefinition时，真正完成注册功能的是DefaultListableBeanFactory.</p>
<h2 id="defaultlistablebeanfactory-向ioc容器注册解析后的beandefinition">DefaultListableBeanFactory 向IoC容器注册解析后的BeanDefinition<a hidden class="anchor" aria-hidden="true" href="#defaultlistablebeanfactory-向ioc容器注册解析后的beandefinition">#</a></h2>
<p>IoC容器本质上就是一个beanDefinitionMap，注册即将BeanDefinition put 到map中。</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">27
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">28
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">29
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">30
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">31
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">32
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">33
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">34
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">35
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">36
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">37
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">38
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">39
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">40
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">41
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">42
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">43
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">44
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">45
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">46
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">47
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">48
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">49
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">50
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">51
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">52
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">53
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">54
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">55
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">56
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">57
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">58
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">59
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">60
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">61
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">62
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">63
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">64
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">65
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">66
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">67
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">68
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">69
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">70
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">71
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">72
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">73
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">74
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">75
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">76
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">77
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">78
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">79
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">80
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">81
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">82
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">83
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">84
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">85
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007f7f">/** Map of bean definition objects, keyed by bean name. */</span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">private</span> <span style="color:#fff;font-weight:bold">final</span> Map&lt;String, BeanDefinition&gt; beanDefinitionMap = <span style="color:#fff;font-weight:bold">new</span> ConcurrentHashMap&lt;&gt;(<span style="color:#ff0;font-weight:bold">256</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f">/** Map from bean name to merged BeanDefinitionHolder. */</span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">private</span> <span style="color:#fff;font-weight:bold">final</span> Map&lt;String, BeanDefinitionHolder&gt; mergedBeanDefinitionHolders = <span style="color:#fff;font-weight:bold">new</span> ConcurrentHashMap&lt;&gt;(<span style="color:#ff0;font-weight:bold">256</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>@Override
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">void</span> registerBeanDefinition(String beanName, BeanDefinition beanDefinition)
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">throws</span> BeanDefinitionStoreException {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    Assert.<span style="color:#007f7f">hasText</span>(beanName, <span style="color:#0ff;font-weight:bold">&#34;Bean name must not be empty&#34;</span>);
</span></span><span style="display:flex;"><span>    Assert.<span style="color:#007f7f">notNull</span>(beanDefinition, <span style="color:#0ff;font-weight:bold">&#34;BeanDefinition must not be null&#34;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">if</span> (beanDefinition <span style="color:#fff;font-weight:bold">instanceof</span> AbstractBeanDefinition) {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">try</span> {
</span></span><span style="display:flex;"><span>            ((AbstractBeanDefinition) beanDefinition).<span style="color:#007f7f">validate</span>();
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">catch</span> (BeanDefinitionValidationException ex) {
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">throw</span> <span style="color:#fff;font-weight:bold">new</span> BeanDefinitionStoreException(beanDefinition.<span style="color:#007f7f">getResourceDescription</span>(), beanName,
</span></span><span style="display:flex;"><span>                    <span style="color:#0ff;font-weight:bold">&#34;Validation of bean definition failed&#34;</span>, ex);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    BeanDefinition existingDefinition = <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">beanDefinitionMap</span>.<span style="color:#007f7f">get</span>(beanName);
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// 如果已经注册
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    <span style="color:#fff;font-weight:bold">if</span> (existingDefinition != <span style="color:#fff;font-weight:bold">null</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">// 检查是否可以覆盖
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        <span style="color:#fff;font-weight:bold">if</span> (!isAllowBeanDefinitionOverriding()) {
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">throw</span> <span style="color:#fff;font-weight:bold">new</span> BeanDefinitionOverrideException(beanName, beanDefinition, existingDefinition);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">else</span> <span style="color:#fff;font-weight:bold">if</span> (existingDefinition.<span style="color:#007f7f">getRole</span>() &lt; beanDefinition.<span style="color:#007f7f">getRole</span>()) {
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">// e.g. was ROLE_APPLICATION, now overriding with ROLE_SUPPORT or ROLE_INFRASTRUCTURE
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>            <span style="color:#fff;font-weight:bold">if</span> (logger.<span style="color:#007f7f">isInfoEnabled</span>()) {
</span></span><span style="display:flex;"><span>                logger.<span style="color:#007f7f">info</span>(<span style="color:#0ff;font-weight:bold">&#34;Overriding user-defined bean definition for bean &#39;&#34;</span> + beanName +
</span></span><span style="display:flex;"><span>                        <span style="color:#0ff;font-weight:bold">&#34;&#39; with a framework-generated bean definition: replacing [&#34;</span> +
</span></span><span style="display:flex;"><span>                        existingDefinition + <span style="color:#0ff;font-weight:bold">&#34;] with [&#34;</span> + beanDefinition + <span style="color:#0ff;font-weight:bold">&#34;]&#34;</span>);
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">else</span> <span style="color:#fff;font-weight:bold">if</span> (!beanDefinition.<span style="color:#007f7f">equals</span>(existingDefinition)) {
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">if</span> (logger.<span style="color:#007f7f">isDebugEnabled</span>()) {
</span></span><span style="display:flex;"><span>                logger.<span style="color:#007f7f">debug</span>(<span style="color:#0ff;font-weight:bold">&#34;Overriding bean definition for bean &#39;&#34;</span> + beanName +
</span></span><span style="display:flex;"><span>                        <span style="color:#0ff;font-weight:bold">&#34;&#39; with a different definition: replacing [&#34;</span> + existingDefinition +
</span></span><span style="display:flex;"><span>                        <span style="color:#0ff;font-weight:bold">&#34;] with [&#34;</span> + beanDefinition + <span style="color:#0ff;font-weight:bold">&#34;]&#34;</span>);
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">else</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">if</span> (logger.<span style="color:#007f7f">isTraceEnabled</span>()) {
</span></span><span style="display:flex;"><span>                logger.<span style="color:#007f7f">trace</span>(<span style="color:#0ff;font-weight:bold">&#34;Overriding bean definition for bean &#39;&#34;</span> + beanName +
</span></span><span style="display:flex;"><span>                        <span style="color:#0ff;font-weight:bold">&#34;&#39; with an equivalent definition: replacing [&#34;</span> + existingDefinition +
</span></span><span style="display:flex;"><span>                        <span style="color:#0ff;font-weight:bold">&#34;] with [&#34;</span> + beanDefinition + <span style="color:#0ff;font-weight:bold">&#34;]&#34;</span>);
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">// 覆盖
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">beanDefinitionMap</span>.<span style="color:#007f7f">put</span>(beanName, beanDefinition);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">else</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">if</span> (hasBeanCreationStarted()) {
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">// Cannot modify startup-time collection elements anymore (for stable iteration)
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>            <span style="color:#fff;font-weight:bold">synchronized</span> (<span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">beanDefinitionMap</span>) {
</span></span><span style="display:flex;"><span>                <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">beanDefinitionMap</span>.<span style="color:#007f7f">put</span>(beanName, beanDefinition);
</span></span><span style="display:flex;"><span>                List&lt;String&gt; updatedDefinitions = <span style="color:#fff;font-weight:bold">new</span> ArrayList&lt;&gt;(<span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">beanDefinitionNames</span>.<span style="color:#007f7f">size</span>() + <span style="color:#ff0;font-weight:bold">1</span>);
</span></span><span style="display:flex;"><span>                updatedDefinitions.<span style="color:#007f7f">addAll</span>(<span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">beanDefinitionNames</span>);
</span></span><span style="display:flex;"><span>                updatedDefinitions.<span style="color:#007f7f">add</span>(beanName);
</span></span><span style="display:flex;"><span>                <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">beanDefinitionNames</span> = updatedDefinitions;
</span></span><span style="display:flex;"><span>                removeManualSingletonName(beanName);
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">else</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">// Still in startup registration phase
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>            <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">beanDefinitionMap</span>.<span style="color:#007f7f">put</span>(beanName, beanDefinition);
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">beanDefinitionNames</span>.<span style="color:#007f7f">add</span>(beanName);
</span></span><span style="display:flex;"><span>            removeManualSingletonName(beanName);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//重置所有已经注册过的BeanDefinition的缓存  
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">frozenBeanDefinitionNames</span> = <span style="color:#fff;font-weight:bold">null</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">if</span> (existingDefinition != <span style="color:#fff;font-weight:bold">null</span> || containsSingleton(beanName)) {
</span></span><span style="display:flex;"><span>        resetBeanDefinition(beanName);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">else</span> <span style="color:#fff;font-weight:bold">if</span> (isConfigurationFrozen()) {
</span></span><span style="display:flex;"><span>        clearByTypeCache();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>至此，Bean定义资源文件中配置的Bean被解析过后，已经注册到IoC容器中，被容器管理起来，真正完成了IoC容器初始化所做的全部工作。现在IoC容器中已经建立了整个Bean的配置信息，这些BeanDefinition信息已经可以使用，并且可以被检索，IoC容器的作用就是对这些注册的Bean定义信息进行处理和维护。这些的注册的Bean定义信息是IoC容器控制反转的基础，正是有了这些注册的数据，容器才可以进行依赖注入。</p>
<h2 id="总结">总结<a hidden class="anchor" aria-hidden="true" href="#总结">#</a></h2>
<p>现在通过上面的代码，总结一下IoC容器初始化的基本步骤：</p>
<li>初始化的入口在容器实现中的refresh()调用来完成</li>
<li>对bean定义载入IoC容器使用的方法是loadBeanDefinition，其中大致过程如下：<br>
1、通过ResourceLoader来完成资源文件位置的定位，DefaultResourceLoader是默认的实现，同时上下文本身就给出了ResourceLoader的实现，可以从类路径，文件系统，URL等方式来定义为资源位置。如果是XmlBeanFactory作为IOC容器，那么需要为它指定bean定义的资源，也就是说bean定义文件时通过抽象成Resource来被IOC容器处理的。
<p>2、通过BeanDefinitionReader来完成定义信息的解析和Bean信息的注册，往往使用的是XmlBeanDefinitionReader来解析bean的xml定义文件-实际的处理过程是委托给BeanDefinitionParserDelegate来完成的，从而得到bean的定义信息，这些信息在Spring中使用BeanDefinition对象来表示-这个名字可以让我们想到loadBeanDefinition,RegisterBeanDefinition这些相关方法-他们都是为处理BeanDefinitin服务的。
3、容器解析得到BeanDefinition以后，需要把它在IOC容器中注册，这由IOC实现BeanDefinitionRegister接口来实现。注册过程就是在IOC容器内部维护一个HashMap来保存得到的BeanDefinition的过程。这个HashMap是IoC容器持有bean信息的场所，以后对bean的操作都是围绕这个HashMap来实现的。</p>
</li>
<li>然后我们就可以通过BeanFactory和ApplicationCOntext来享受到SPring IOC的服务了，在使用IoC容器的时候，我们注意到除了少量粘合代码，绝大多数以正确IoC风格编写的应用程序代码完全不用关心如何到达工厂，因为容器将把这些对象与容器管理的其他对象钩在一起。基本的策略是把工厂放到已知的地方，最好是放在对预期使用的上下文有意义的地方，以及代码将实际需要访问工厂的地方。Spring本身提供了对声明式载入Web应用程序用法的应用程序上下文，并将其存储在ServletContext中的框架实现。</li>
<h2 id="spring中getbean的主体思路">Spring中getBean的主体思路<a hidden class="anchor" aria-hidden="true" href="#spring中getbean的主体思路">#</a></h2>
<p>BeanFactory实现getBean方法在AbstractBeanFactory中，这个方法重载都是调用doGetBean方法进行实现的:</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> Object getBean(String name) <span style="color:#fff;font-weight:bold">throws</span> BeansException {
</span></span><span style="display:flex;"><span>  <span style="color:#fff;font-weight:bold">return</span> doGetBean(name, <span style="color:#fff;font-weight:bold">null</span>, <span style="color:#fff;font-weight:bold">null</span>, <span style="color:#fff;font-weight:bold">false</span>);
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> &lt;T&gt; T getBean(String name, Class&lt;T&gt; requiredType) <span style="color:#fff;font-weight:bold">throws</span> BeansException {
</span></span><span style="display:flex;"><span>  <span style="color:#fff;font-weight:bold">return</span> doGetBean(name, requiredType, <span style="color:#fff;font-weight:bold">null</span>, <span style="color:#fff;font-weight:bold">false</span>);
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> Object getBean(String name, Object... args) <span style="color:#fff;font-weight:bold">throws</span> BeansException {
</span></span><span style="display:flex;"><span>  <span style="color:#fff;font-weight:bold">return</span> doGetBean(name, <span style="color:#fff;font-weight:bold">null</span>, args, <span style="color:#fff;font-weight:bold">false</span>);
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> &lt;T&gt; T getBean(String name, @Nullable Class&lt;T&gt; requiredType, @Nullable Object... args)
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">throws</span> BeansException {
</span></span><span style="display:flex;"><span>  <span style="color:#fff;font-weight:bold">return</span> doGetBean(name, requiredType, args, <span style="color:#fff;font-weight:bold">false</span>);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>接下来看下doGetBean方法(这个方法很长，我们主要看它的整体思路和设计要点):</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">  1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">  2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">  3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">  4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">  5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">  6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">  7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">  8
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">  9
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 10
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 11
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 12
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 13
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 14
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 15
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 16
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 17
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 18
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 19
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 20
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 21
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 22
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 23
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 24
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 25
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 26
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 27
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 28
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 29
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 30
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 31
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 32
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 33
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 34
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 35
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 36
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 37
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 38
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 39
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 40
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 41
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 42
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 43
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 44
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 45
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 46
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 47
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 48
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 49
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 50
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 51
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 52
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 53
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 54
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 55
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 56
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 57
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 58
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 59
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 60
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 61
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 62
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 63
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 64
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 65
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 66
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 67
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 68
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 69
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 70
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 71
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 72
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 73
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 74
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 75
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 76
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 77
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 78
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 79
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 80
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 81
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 82
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 83
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 84
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 85
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 86
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 87
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 88
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 89
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 90
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 91
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 92
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 93
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 94
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 95
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 96
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 97
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 98
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 99
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">100
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">101
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">102
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">103
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">104
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">105
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">106
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">107
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">108
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">109
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">110
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">111
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">112
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">113
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">114
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">115
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">116
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">117
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">118
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">119
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">120
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">121
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">122
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">123
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">124
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">125
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">126
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">127
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">128
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">129
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">130
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">131
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">132
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">133
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">134
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">135
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">136
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">137
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">138
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">139
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">140
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">141
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">142
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">143
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">144
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">145
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">146
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">147
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007f7f">// 参数typeCheckOnly：bean实例是否包含一个类型检查
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span><span style="color:#fff;font-weight:bold">protected</span> &lt;T&gt; T doGetBean(
</span></span><span style="display:flex;"><span>			String name, @Nullable Class&lt;T&gt; requiredType, @Nullable Object[] args, <span style="color:#fff;font-weight:bold">boolean</span> typeCheckOnly)
</span></span><span style="display:flex;"><span>			<span style="color:#fff;font-weight:bold">throws</span> BeansException {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#007f7f">// 解析bean的真正name，如果bean是工厂类，name前缀会加&amp;，需要去掉
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>  String beanName = transformedBeanName(name);
</span></span><span style="display:flex;"><span>  Object beanInstance;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#007f7f">// Eagerly check singleton cache for manually registered singletons.
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>  Object sharedInstance = getSingleton(beanName);
</span></span><span style="display:flex;"><span>  <span style="color:#fff;font-weight:bold">if</span> (sharedInstance != <span style="color:#fff;font-weight:bold">null</span> &amp;&amp; args == <span style="color:#fff;font-weight:bold">null</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// 无参单例从缓存中获取
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    beanInstance = getObjectForBeanInstance(sharedInstance, name, beanName, <span style="color:#fff;font-weight:bold">null</span>);
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#fff;font-weight:bold">else</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// 如果bean实例还在创建中，则直接抛出异常
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    <span style="color:#fff;font-weight:bold">if</span> (isPrototypeCurrentlyInCreation(beanName)) {
</span></span><span style="display:flex;"><span>      <span style="color:#fff;font-weight:bold">throw</span> <span style="color:#fff;font-weight:bold">new</span> BeanCurrentlyInCreationException(beanName);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// 如果 bean definition 存在于父的bean工厂中，委派给父Bean工厂获取
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    BeanFactory parentBeanFactory = getParentBeanFactory();
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">if</span> (parentBeanFactory != <span style="color:#fff;font-weight:bold">null</span> &amp;&amp; !containsBeanDefinition(beanName)) {
</span></span><span style="display:flex;"><span>      <span style="color:#007f7f">// Not found -&gt; check parent.
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>      String nameToLookup = originalBeanName(name);
</span></span><span style="display:flex;"><span>      <span style="color:#fff;font-weight:bold">if</span> (parentBeanFactory <span style="color:#fff;font-weight:bold">instanceof</span> AbstractBeanFactory) {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> ((AbstractBeanFactory) parentBeanFactory).<span style="color:#007f7f">doGetBean</span>(
</span></span><span style="display:flex;"><span>            nameToLookup, requiredType, args, typeCheckOnly);
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>      <span style="color:#fff;font-weight:bold">else</span> <span style="color:#fff;font-weight:bold">if</span> (args != <span style="color:#fff;font-weight:bold">null</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">// Delegation to parent with explicit args.
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        <span style="color:#fff;font-weight:bold">return</span> (T) parentBeanFactory.<span style="color:#007f7f">getBean</span>(nameToLookup, args);
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>      <span style="color:#fff;font-weight:bold">else</span> <span style="color:#fff;font-weight:bold">if</span> (requiredType != <span style="color:#fff;font-weight:bold">null</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">// No args -&gt; delegate to standard getBean method.
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        <span style="color:#fff;font-weight:bold">return</span> parentBeanFactory.<span style="color:#007f7f">getBean</span>(nameToLookup, requiredType);
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>      <span style="color:#fff;font-weight:bold">else</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> (T) parentBeanFactory.<span style="color:#007f7f">getBean</span>(nameToLookup);
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">if</span> (!typeCheckOnly) {
</span></span><span style="display:flex;"><span>      <span style="color:#007f7f">// 将当前bean实例放入alreadyCreated集合里，标识这个bean准备创建了
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>      markBeanAsCreated(beanName);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    StartupStep beanCreation = <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">applicationStartup</span>.<span style="color:#007f7f">start</span>(<span style="color:#0ff;font-weight:bold">&#34;spring.beans.instantiate&#34;</span>)
</span></span><span style="display:flex;"><span>        .<span style="color:#007f7f">tag</span>(<span style="color:#0ff;font-weight:bold">&#34;beanName&#34;</span>, name);
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">try</span> {
</span></span><span style="display:flex;"><span>      <span style="color:#fff;font-weight:bold">if</span> (requiredType != <span style="color:#fff;font-weight:bold">null</span>) {
</span></span><span style="display:flex;"><span>        beanCreation.<span style="color:#007f7f">tag</span>(<span style="color:#0ff;font-weight:bold">&#34;beanType&#34;</span>, requiredType::toString);
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>      RootBeanDefinition mbd = getMergedLocalBeanDefinition(beanName);
</span></span><span style="display:flex;"><span>      checkMergedBeanDefinition(mbd, beanName, args);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>      <span style="color:#007f7f">// 确保它的依赖也被初始化了.
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>      String[] dependsOn = mbd.<span style="color:#007f7f">getDependsOn</span>();
</span></span><span style="display:flex;"><span>      <span style="color:#fff;font-weight:bold">if</span> (dependsOn != <span style="color:#fff;font-weight:bold">null</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">for</span> (String dep : dependsOn) {
</span></span><span style="display:flex;"><span>          <span style="color:#fff;font-weight:bold">if</span> (isDependent(beanName, dep)) {
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">throw</span> <span style="color:#fff;font-weight:bold">new</span> BeanCreationException(mbd.<span style="color:#007f7f">getResourceDescription</span>(), beanName,
</span></span><span style="display:flex;"><span>                <span style="color:#0ff;font-weight:bold">&#34;Circular depends-on relationship between &#39;&#34;</span> + beanName + <span style="color:#0ff;font-weight:bold">&#34;&#39; and &#39;&#34;</span> + dep + <span style="color:#0ff;font-weight:bold">&#34;&#39;&#34;</span>);
</span></span><span style="display:flex;"><span>          }
</span></span><span style="display:flex;"><span>          registerDependentBean(dep, beanName);
</span></span><span style="display:flex;"><span>          <span style="color:#fff;font-weight:bold">try</span> {
</span></span><span style="display:flex;"><span>            getBean(dep); <span style="color:#007f7f">// 初始化它依赖的Bean
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>          }
</span></span><span style="display:flex;"><span>          <span style="color:#fff;font-weight:bold">catch</span> (NoSuchBeanDefinitionException ex) {
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">throw</span> <span style="color:#fff;font-weight:bold">new</span> BeanCreationException(mbd.<span style="color:#007f7f">getResourceDescription</span>(), beanName,
</span></span><span style="display:flex;"><span>                <span style="color:#0ff;font-weight:bold">&#34;&#39;&#34;</span> + beanName + <span style="color:#0ff;font-weight:bold">&#34;&#39; depends on missing bean &#39;&#34;</span> + dep + <span style="color:#0ff;font-weight:bold">&#34;&#39;&#34;</span>, ex);
</span></span><span style="display:flex;"><span>          }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>      <span style="color:#007f7f">// 创建Bean实例：单例
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>      <span style="color:#fff;font-weight:bold">if</span> (mbd.<span style="color:#007f7f">isSingleton</span>()) {
</span></span><span style="display:flex;"><span>        sharedInstance = getSingleton(beanName, () -&gt; {
</span></span><span style="display:flex;"><span>          <span style="color:#fff;font-weight:bold">try</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">// 真正创建bean的方法
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>            <span style="color:#fff;font-weight:bold">return</span> createBean(beanName, mbd, args);
</span></span><span style="display:flex;"><span>          }
</span></span><span style="display:flex;"><span>          <span style="color:#fff;font-weight:bold">catch</span> (BeansException ex) {
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">// Explicitly remove instance from singleton cache: It might have been put there
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>            <span style="color:#007f7f">// eagerly by the creation process, to allow for circular reference resolution.
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>            <span style="color:#007f7f">// Also remove any beans that received a temporary reference to the bean.
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>            destroySingleton(beanName);
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">throw</span> ex;
</span></span><span style="display:flex;"><span>          }
</span></span><span style="display:flex;"><span>        });
</span></span><span style="display:flex;"><span>        beanInstance = getObjectForBeanInstance(sharedInstance, name, beanName, mbd);
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>      <span style="color:#007f7f">// 创建Bean实例：原型
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>      <span style="color:#fff;font-weight:bold">else</span> <span style="color:#fff;font-weight:bold">if</span> (mbd.<span style="color:#007f7f">isPrototype</span>()) {
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">// It&#39;s a prototype -&gt; create a new instance.
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        Object prototypeInstance = <span style="color:#fff;font-weight:bold">null</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">try</span> {
</span></span><span style="display:flex;"><span>          beforePrototypeCreation(beanName);
</span></span><span style="display:flex;"><span>          prototypeInstance = createBean(beanName, mbd, args);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">finally</span> {
</span></span><span style="display:flex;"><span>          afterPrototypeCreation(beanName);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        beanInstance = getObjectForBeanInstance(prototypeInstance, name, beanName, mbd);
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>      <span style="color:#007f7f">// 创建Bean实例：根据bean的scope创建
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>      <span style="color:#fff;font-weight:bold">else</span> {
</span></span><span style="display:flex;"><span>        String scopeName = mbd.<span style="color:#007f7f">getScope</span>();
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">if</span> (!StringUtils.<span style="color:#007f7f">hasLength</span>(scopeName)) {
</span></span><span style="display:flex;"><span>          <span style="color:#fff;font-weight:bold">throw</span> <span style="color:#fff;font-weight:bold">new</span> IllegalStateException(<span style="color:#0ff;font-weight:bold">&#34;No scope name defined for bean ´&#34;</span> + beanName + <span style="color:#0ff;font-weight:bold">&#34;&#39;&#34;</span>);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        Scope scope = <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">scopes</span>.<span style="color:#007f7f">get</span>(scopeName);
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">if</span> (scope == <span style="color:#fff;font-weight:bold">null</span>) {
</span></span><span style="display:flex;"><span>          <span style="color:#fff;font-weight:bold">throw</span> <span style="color:#fff;font-weight:bold">new</span> IllegalStateException(<span style="color:#0ff;font-weight:bold">&#34;No Scope registered for scope name &#39;&#34;</span> + scopeName + <span style="color:#0ff;font-weight:bold">&#34;&#39;&#34;</span>);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">try</span> {
</span></span><span style="display:flex;"><span>          Object scopedInstance = scope.<span style="color:#007f7f">get</span>(beanName, () -&gt; {
</span></span><span style="display:flex;"><span>            beforePrototypeCreation(beanName);
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">try</span> {
</span></span><span style="display:flex;"><span>              <span style="color:#fff;font-weight:bold">return</span> createBean(beanName, mbd, args);
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">finally</span> {
</span></span><span style="display:flex;"><span>              afterPrototypeCreation(beanName);
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>          });
</span></span><span style="display:flex;"><span>          beanInstance = getObjectForBeanInstance(scopedInstance, name, beanName, mbd);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">catch</span> (IllegalStateException ex) {
</span></span><span style="display:flex;"><span>          <span style="color:#fff;font-weight:bold">throw</span> <span style="color:#fff;font-weight:bold">new</span> ScopeNotActiveException(beanName, scopeName, ex);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">catch</span> (BeansException ex) {
</span></span><span style="display:flex;"><span>      beanCreation.<span style="color:#007f7f">tag</span>(<span style="color:#0ff;font-weight:bold">&#34;exception&#34;</span>, ex.<span style="color:#007f7f">getClass</span>().<span style="color:#007f7f">toString</span>());
</span></span><span style="display:flex;"><span>      beanCreation.<span style="color:#007f7f">tag</span>(<span style="color:#0ff;font-weight:bold">&#34;message&#34;</span>, String.<span style="color:#007f7f">valueOf</span>(ex.<span style="color:#007f7f">getMessage</span>()));
</span></span><span style="display:flex;"><span>      cleanupAfterBeanCreationFailure(beanName);
</span></span><span style="display:flex;"><span>      <span style="color:#fff;font-weight:bold">throw</span> ex;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">finally</span> {
</span></span><span style="display:flex;"><span>      beanCreation.<span style="color:#007f7f">end</span>();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#fff;font-weight:bold">return</span> adaptBeanInstance(name, beanInstance, requiredType);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>上述代码主要看中文注释即可:</p>
<li>解析bean的真正name，如果bean是工厂类，name前缀会加&，需要去掉</li>
<li>无参单例先从缓存中获取</li>
<li>如果bean实例还在创建中，则直接抛出异常</li>
<li>如果bean definition存在于的bean工厂中，委派给父Bean工厂获取</li>
<li>标记这个beanName的实例正在创建</li>
<li>确保它的依赖也被初始化</li>
<li>真正创建:<br>
1. 单例时<br>
2. 原型时<br>
3. 根据bean的scope创建
</li>
<h2 id="重点-spring如何解决循环依赖问题">重点: SPring如何解决循环依赖问题<a hidden class="anchor" aria-hidden="true" href="#重点-spring如何解决循环依赖问题">#</a></h2>
<p><b>首先我们需要声明，Spring只是解决了单例模式下属性依赖的循环问题；Spring为了解决单例的循环依赖问题，使用了三级缓存。</b></p>
<h2 id="spring单例模式下的属性依赖">Spring单例模式下的属性依赖<a hidden class="anchor" aria-hidden="true" href="#spring单例模式下的属性依赖">#</a></h2>
<p>先来看下这三级缓存</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">8
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007f7f">/** Cache of singleton objects: bean name --&gt; bean instance */</span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">private</span> <span style="color:#fff;font-weight:bold">final</span> Map&lt;String, Object&gt; singletonObjects = <span style="color:#fff;font-weight:bold">new</span> ConcurrentHashMap&lt;String, Object&gt;(<span style="color:#ff0;font-weight:bold">256</span>);
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span><span style="color:#007f7f">/** Cache of early singleton objects: bean name --&gt; bean instance */</span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">private</span> <span style="color:#fff;font-weight:bold">final</span> Map&lt;String, Object&gt; earlySingletonObjects = <span style="color:#fff;font-weight:bold">new</span> HashMap&lt;String, Object&gt;(<span style="color:#ff0;font-weight:bold">16</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f">/** Cache of singleton factories: bean name --&gt; ObjectFactory */</span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">private</span> <span style="color:#fff;font-weight:bold">final</span> Map&lt;String, ObjectFactory&lt;?&gt;&gt; singletonFactories = <span style="color:#fff;font-weight:bold">new</span> HashMap&lt;String, ObjectFactory&lt;?&gt;&gt;(<span style="color:#ff0;font-weight:bold">16</span>);
</span></span></code></pre></td></tr></table>
</div>
</div><li>第一级缓存(singletonObjects): 单例对象缓存池，已经实例化并且属性赋值，这里的对象是成熟对象</li>
<li>第二层缓存(earlySingletonObjects): 单例对象缓存池，已经实例化但尚未属性赋值，这里的对象是半成品对象</li>
<li>第三层缓存(singletonFactories): 单例工厂的缓存</li>
<p>如下是获取单例中:</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">protected</span> Object getSingleton(String beanName, <span style="color:#fff;font-weight:bold">boolean</span> allowEarlyReference) {
</span></span><span style="display:flex;"><span>  <span style="color:#007f7f">// Spring首先从singletonObjects（一级缓存）中尝试获取
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>  Object singletonObject = <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">singletonObjects</span>.<span style="color:#007f7f">get</span>(beanName);
</span></span><span style="display:flex;"><span>  <span style="color:#007f7f">// 若是获取不到而且对象在建立中，则尝试从earlySingletonObjects(二级缓存)中获取
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>  <span style="color:#fff;font-weight:bold">if</span> (singletonObject == <span style="color:#fff;font-weight:bold">null</span> &amp;&amp; isSingletonCurrentlyInCreation(beanName)) {
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">synchronized</span> (<span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">singletonObjects</span>) {
</span></span><span style="display:flex;"><span>        singletonObject = <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">earlySingletonObjects</span>.<span style="color:#007f7f">get</span>(beanName);
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">if</span> (singletonObject == <span style="color:#fff;font-weight:bold">null</span> &amp;&amp; allowEarlyReference) {
</span></span><span style="display:flex;"><span>          ObjectFactory&lt;?&gt; singletonFactory = <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">singletonFactories</span>.<span style="color:#007f7f">get</span>(beanName);
</span></span><span style="display:flex;"><span>          <span style="color:#fff;font-weight:bold">if</span> (singletonFactory != <span style="color:#fff;font-weight:bold">null</span>) {
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">//若是仍是获取不到而且容许从singletonFactories经过getObject获取，则经过singletonFactory.getObject()(三级缓存)获取
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>              singletonObject = singletonFactory.<span style="color:#007f7f">getObject</span>();
</span></span><span style="display:flex;"><span>              <span style="color:#007f7f">//若是获取到了则将singletonObject放入到earlySingletonObjects,也就是将三级缓存提高到二级缓存中
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>              <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">earlySingletonObjects</span>.<span style="color:#007f7f">put</span>(beanName, singletonObject);
</span></span><span style="display:flex;"><span>              <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">singletonFactories</span>.<span style="color:#007f7f">remove</span>(beanName);
</span></span><span style="display:flex;"><span>          }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#fff;font-weight:bold">return</span> (singletonObject != NULL_OBJECT ? singletonObject : <span style="color:#fff;font-weight:bold">null</span>);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>补充一些方法和参数</p>
<li>isSingletonCurrentlyIncreation(): 判断当前单例bean是否正在建立中，也就是没有初始化完成(好比A的构造器依赖了B对象因此得先去建立B对象，或则在A得populateBean过程当中依赖了B对象，得先去建立B对象，这时得A就是处于建立中的状态。)</li>
<li>allowEarlyRefrence: 是否容许从singletonFactories中经过getObject拿到对象</li>
<p>分析getSinflwton()整个过程，Spring首先从一级缓存singletonObjects中获取。若是获取不到，而且对象正在建立中，就再从二级缓存earlySingletonObjects中获取。若是仍是获取不到且容许singletonFactories经过getObject()获取，就从三级缓存singlwtonFactory.getObject()(三级缓存)获取，若是获取到了则从三级缓存移动到了二级缓存。</p>
<p>从上面三级缓存的分析，咱们能够知道，Spring解决循环依赖的诀窍就在于singletonFactories这个三级cache。这个cache的类型是ObjectFactory,定义以下:</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">interface</span> ObjectFactory&lt;T&gt; {
</span></span><span style="display:flex;"><span>    T getObject() <span style="color:#fff;font-weight:bold">throws</span> BeansException;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>在bean建立过程当中，有两处比较重要的匿名内部类实现了该接口。一处是Spring利用其建立bean的时候，另外一处就是:</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>addSingletonFactory(beanName, <span style="color:#fff;font-weight:bold">new</span> ObjectFactory&lt;Object&gt;() {
</span></span><span style="display:flex;"><span>   @Override   <span style="color:#fff;font-weight:bold">public</span> Object getObject() <span style="color:#fff;font-weight:bold">throws</span> BeansException {
</span></span><span style="display:flex;"><span>      <span style="color:#fff;font-weight:bold">return</span> getEarlyBeanReference(beanName, mbd, bean);
</span></span><span style="display:flex;"><span>   }});
</span></span></code></pre></td></tr></table>
</div>
</div><p>此处就是解决循环依赖的关键，这段代码发生在createBeanInstance以后，也就是说单例对象此时已经被建立出来的。这个对象已经被生产出来了，虽然还不完美(尚未进行初始化的第二步和第三步)，可是已经能被人认出来了(根据对象引用能定位到堆中的对象)，因此Spring此时将这个对象提早曝光出来让你们认识，让你们使用。</p>
<h2 id="spring为何不能解决非单例属性之外的循环依赖">Spring为何不能解决非单例属性之外的循环依赖？<a hidden class="anchor" aria-hidden="true" href="#spring为何不能解决非单例属性之外的循环依赖">#</a></h2>
<h3 id="spring为什么不能解决构造器的循环依赖">Spring为什么不能解决构造器的循环依赖<a hidden class="anchor" aria-hidden="true" href="#spring为什么不能解决构造器的循环依赖">#</a></h3>
<p>构造器注入形成的循环依赖: 也就是BeanB需要在beanA的构造函数中完成初始化，beanA也需要2在beanB的构造函数中完成初始化，这种情况的结果就是两个bean都不能完成初始化，循环依赖难以解决。</p>
<p>Spring解决循环依赖主要是依赖三级缓存，但是得在调用构造方法之前还未将其放入三级缓存之中，因此后续得依赖调用构造方法的时候并不能从三级缓存中获取到依赖的Bean，因此不能解决。</p>
<h3 id="spring为什么不能解决prototype作用域循环依赖">Spring为什么不能解决prototype作用域循环依赖<a hidden class="anchor" aria-hidden="true" href="#spring为什么不能解决prototype作用域循环依赖">#</a></h3>
<p>这种循环依赖同样无法解决，因为Spring不会缓存prototype作用域的bean，而spring中循环依赖的解决正是通过缓存来实现的。</p>
<h3 id="spring为什么不能解决多例的循环依赖">Spring为什么不能解决多例的循环依赖？<a hidden class="anchor" aria-hidden="true" href="#spring为什么不能解决多例的循环依赖">#</a></h3>
<p>多实例Bean是每次调用一次getBean都会执行一次构造方法并且给属性赋值，根本没有三级缓存，因此不能解决循环依赖。</p>
<h2 id="那么其他循环依赖如何解决">那么其他循环依赖如何解决？<a hidden class="anchor" aria-hidden="true" href="#那么其他循环依赖如何解决">#</a></h2>
<p>在实际开发中，类似的依赖是如何解决？</p>
<li>生成代理对象产生的循环依赖</li>
<p>这类循环依赖解决方法有很多，主要有：</p>
<p>1、使用@Lazy注解，延迟加载</p>
<p>2、使用@DependsOn注解，指定加载先后关系</p>
<p>3、修改文件名称，改变循环依赖类的加载顺序</p>
<li>使用@DependsOn产生的循环依赖</li>
这类循环依赖问题要找到@DependsOn注解循环依赖的地方，迫使它不循环依赖就可以解决问题。
<li>多例循环依赖</li>
这类循环依赖问题可以通过把bean改成单例的解决
<li>构造器循环依赖</li>
这类循环依赖问题可以通过使用@Lazy注解解决。
<h2 id="重点-spring中bean的生命周期">重点: Spring中Bean的生命周期<a hidden class="anchor" aria-hidden="true" href="#重点-spring中bean的生命周期">#</a></h2>
<p>Spring只帮我们管理单例模式Bean的完整的生命周期，对于prototype的bean，SPring在创建好交给使用者之后则不会再管理后续的生命周期。</p>
<p>Spring容器可以管理singleton作用域Bean的生命周期，在此作用域下，SPring能够精确地知道该Bean何时被创建，何时初始化完成，以及何时被销毁。</p>
<p>而对于prototype作用域的Bean,Spring只负责创建，当容器创建了Bean的实例后，Bean的实例就交给客户端代码管理，Spring容器就不再跟踪其生命周期。每次客户端请求prototype作用域的Bean时，SPring容器都会创建一个新的实例，并且不会管那些被配置成prototype作用域的Bean的生命周期。</p>
<p>了解SPring生命周期的意义就在于，<b>可以利用Bean在其存货期间的指定时刻完成一些相关操作。这种时刻可能有很多，但一般情况下，会在Bean被初始化后和被销毁前执行一些相关操作。</b></p>
<p>Spring Bean生命周期流程</p>
<p>在SPring中，Bean的生命周期是一个很复杂的执行过程，我们可以利用Spring提供的方法定制Bean的创建过程。</p>
<li>如果BeanFactoryPostProcessor和Bean关联，则调用postProcessBeanFactory方法.(即首先尝试从Bean工厂中获取Bean)</li>
<li>如果InstantiationAwareBeanPostProcessor和Bean关联，则调用postProcessBeforeInstantiation方法</li>
<li>根据配置情况调用Bean构造方法实例化Bean。</li>
<li>利用依赖注入完成Bean中所有属性值的配置注入。</li>
<li>如果InstantiationAwareBeanPostProcessor和Bean关联，则调用postProcessAfterInstantition方法和postProcessProperties</li>
<li>调用xxxAware接口(上图只是给了几个例子)<br>
1、如果bean实现了BeanNameAware接口，则Spring调用Bean的setBeanName()方法传入当前Bean的id值。<br>
2、如果Bean实现了BeanClassLoaderAware接口，则Spring调用setBeanClassLoader()方法传入classLoader的引用。<br>
3、如果Bean实现了BeanFactoryAware接口，则Spring调用setBeanFactory()方法传入当前工厂实例的引用。
</li>
<li>第二类Aware接口<br>
1、如果Bean实现了EnvironmentAware接口，则Spring调用setEnviroment()方法传入当前Enviroment实例的引用。<br>
2、如果Bean实现了EmbeddedValueResolverAware接口，则Spring调用setEmbeddedValueResolver()方法传入当前StringValueResolver实例的引用。<br>
3、如果Bean实现了ApplicationContextAware接口，则Spring调用setApplicationContext()方法传入当前ApplicationContext实例的引用。
</li>
<li>如果BeanPostProcessor和Bean关联，则SPring将调用该接口的预初始化方法postProcessBeforeInitialzation()对Bean进行加工操作，此处非常重要，SPring的AOP就是利用它实现的</li>
<li>如果Bean实现了InitializingBean接口，则SPring将调用afterPropertiesSet()方法。(或者有执行@PostConstruct注解的方法)</li>
<li>如果在配置文件中通过init-method属性指定了初始化方法，则调用该初始化方法</li>
<li>如果BeanPostProcessor和Bean关联，则Spring将调用该接口的初始化方法postProcesasAfterInitialization()。此时，Bean已经可以被应用系统使用了。</li>
<li>如果在bean中指定了该Bean的作用范围为scope="singleton"，则将该Bean放入Spring IoC的缓存池中，将触发Spring对该Bean的生命周期管理;如果在bean中指定了该Bean的作用范围为scope="prototype"，则将该Bean交给调用者，调用者管理该Bean的生命周期，Spring不再管理该Bean.</li>
<li>如果Bean实现了DisposableBean接口，则Spring会调用destory()方法将SPring中的Bean销毁；</li>
<li>如果在配置文件中通过destory-method属性指定了Bean的销毁方法，则Spring将调用该方法对Bean进行销毁。</li>
<p><b>Bean的完整生命周期经历了各种方法调用，这些方法可以划分为以下几类:</b></p>
<li><b>Bean自身的方法</b>: 这个包括了Bean本身调用的方法和通过配置文件中bean的init-method和destroy-method指定的方法</li>
<li><b>Bean级生命周期接口方法</b>: 这个包括了BeanNameAware、BeanFactoryAware、ApplicationContextAware；当然也包括InitializingBean和DiposableBean这些接口的方法(可以被@PostConstruct和@PreDestroy注解替代)</li>
<li><b>容器级生命周期接口方法:</b> 这个包括了AspectJWeavingEnable,ConfigurationClassPostProcessor,CustomAutowireConfigurer等的非常有用的工厂后处理接口的方法，工厂后处理器也是容器级的。在应用上下文装配文件之后立即调用。</li>


  </div>

  <footer class="post-footer">
    <ul class="post-tags">
      <li><a href="https://csqread.top/tags/spring/">spring</a></li>
    </ul>
<nav class="paginav">
  <a class="prev" href="https://csqread.top/posts/tech/nio%E8%AF%A6%E8%A7%A3/">
    <span class="title">« 上一页</span>
    <br>
    <span>NIO详解</span>
  </a>
  <a class="next" href="https://csqread.top/posts/tech/20240304%E5%8A%9B%E6%89%A3%E5%91%A8%E8%B5%9B/">
    <span class="title">下一页 »</span>
    <br>
    <span>20240304力扣周赛</span>
  </a>
</nav>

  </footer>
</article>
    </main>
    
<footer class="footer">
    <span>&copy; 2024 <a href="https://csqread.top">Qian&#39;s Blog</a></span>
    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://github.com/adityatelange/hugo-PaperMod/" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerHTML = '复制';

        function copyingDone() {
            copybutton.innerHTML = '已复制！';
            setTimeout(() => {
                copybutton.innerHTML = '复制';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                navigator.clipboard.writeText(codeblock.textContent);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) { };
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>
</body>

</html>
