<!DOCTYPE html>
<html lang="zh" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>é›¶æ‹·è´å®ç° | Qian&#39;s Blog</title>
<meta name="keywords" content="Java">
<meta name="description" content="Linuxä¸­çš„é›¶æ‹·è´ 1. æ•°æ®æ‹·è´åŸºç¡€è¿‡ç¨‹ åœ¨Linuxç³»ç»Ÿå†…éƒ¨ç¼“å­˜å’Œå†…å­˜å®¹é‡éƒ½æ˜¯æœ‰é™çš„ï¼Œæ›´å¤šçš„æ•°æ®éƒ½æ˜¯å­˜å‚¨åœ¨ç£ç›˜ä¸­ã€‚å¯¹äºWebæœåŠ¡å™¨æ¥è¯´ï¼Œç»å¸¸éœ€">
<meta name="author" content="
ä½œè€…:&nbsp;ShengQian">
<link rel="canonical" href="https://csqread.top/posts/tech/%E9%9B%B6%E6%8B%B7%E8%B4%9D%E5%AE%9E%E7%8E%B0/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.d056c2d8b86c8da0db95897f49066a3a22d796d21ff6173ef98b613234e402fe.css" integrity="" rel="preload stylesheet" as="style">
<script defer crossorigin="anonymous" src="/assets/js/highlight.acb54fd32bbc1982428b8850317e45d076b95012730a5936667e6bc21777692a.js" integrity=""
    onload="hljs.initHighlightingOnLoad();"></script>
<link rel="icon" href="https://csqread.top/img/Q.gif">
<link rel="icon" type="image/png" sizes="16x16" href="https://csqread.top/img/%21.jpg">
<link rel="icon" type="image/png" sizes="32x32" href="https://csqread.top/img/%21.jpg">
<link rel="apple-touch-icon" href="https://csqread.top/%21.jpg">
<link rel="mask-icon" href="https://csqread.top/%21.jpg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --hljs-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript><meta property="og:title" content="é›¶æ‹·è´å®ç°" />
<meta property="og:description" content="Linuxä¸­çš„é›¶æ‹·è´ 1. æ•°æ®æ‹·è´åŸºç¡€è¿‡ç¨‹ åœ¨Linuxç³»ç»Ÿå†…éƒ¨ç¼“å­˜å’Œå†…å­˜å®¹é‡éƒ½æ˜¯æœ‰é™çš„ï¼Œæ›´å¤šçš„æ•°æ®éƒ½æ˜¯å­˜å‚¨åœ¨ç£ç›˜ä¸­ã€‚å¯¹äºWebæœåŠ¡å™¨æ¥è¯´ï¼Œç»å¸¸éœ€" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://csqread.top/posts/tech/%E9%9B%B6%E6%8B%B7%E8%B4%9D%E5%AE%9E%E7%8E%B0/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2024-04-23T22:25:58+08:00" />
<meta property="article:modified_time" content="2024-04-23T22:25:58+08:00" />

<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="é›¶æ‹·è´å®ç°"/>
<meta name="twitter:description" content="Linuxä¸­çš„é›¶æ‹·è´ 1. æ•°æ®æ‹·è´åŸºç¡€è¿‡ç¨‹ åœ¨Linuxç³»ç»Ÿå†…éƒ¨ç¼“å­˜å’Œå†…å­˜å®¹é‡éƒ½æ˜¯æœ‰é™çš„ï¼Œæ›´å¤šçš„æ•°æ®éƒ½æ˜¯å­˜å‚¨åœ¨ç£ç›˜ä¸­ã€‚å¯¹äºWebæœåŠ¡å™¨æ¥è¯´ï¼Œç»å¸¸éœ€"/>


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "Posts",
      "item": "https://csqread.top/posts/"
    }, 
    {
      "@type": "ListItem",
      "position":  3 ,
      "name": "æŠ€æœ¯",
      "item": "https://csqread.top/posts/tech/"
    }, 
    {
      "@type": "ListItem",
      "position":  4 ,
      "name": "é›¶æ‹·è´å®ç°",
      "item": "https://csqread.top/posts/tech/%E9%9B%B6%E6%8B%B7%E8%B4%9D%E5%AE%9E%E7%8E%B0/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "é›¶æ‹·è´å®ç°",
  "name": "é›¶æ‹·è´å®ç°",
  "description": "Linuxä¸­çš„é›¶æ‹·è´ 1. æ•°æ®æ‹·è´åŸºç¡€è¿‡ç¨‹ åœ¨Linuxç³»ç»Ÿå†…éƒ¨ç¼“å­˜å’Œå†…å­˜å®¹é‡éƒ½æ˜¯æœ‰é™çš„ï¼Œæ›´å¤šçš„æ•°æ®éƒ½æ˜¯å­˜å‚¨åœ¨ç£ç›˜ä¸­ã€‚å¯¹äºWebæœåŠ¡å™¨æ¥è¯´ï¼Œç»å¸¸éœ€",
  "keywords": [
    "Java"
  ],
  "articleBody": "Linuxä¸­çš„é›¶æ‹·è´ 1. æ•°æ®æ‹·è´åŸºç¡€è¿‡ç¨‹ åœ¨Linuxç³»ç»Ÿå†…éƒ¨ç¼“å­˜å’Œå†…å­˜å®¹é‡éƒ½æ˜¯æœ‰é™çš„ï¼Œæ›´å¤šçš„æ•°æ®éƒ½æ˜¯å­˜å‚¨åœ¨ç£ç›˜ä¸­ã€‚å¯¹äºWebæœåŠ¡å™¨æ¥è¯´ï¼Œç»å¸¸éœ€è¦ä»ç£ç›˜ä¸­è¯»å–æ•°æ®çš„å†…å­˜ï¼Œç„¶åé€šè¿‡ç½‘å¡ä¼ è¾“ç»™ç”¨æˆ·\n1.1 ä»…CPUæ–¹å¼ å½“åº”ç”¨ç¨‹åºéœ€è¦è¯»å–ç£ç›˜æ•°æ®æ—¶ï¼Œè°ƒç”¨read()ä»ç”¨æˆ·æ€é™·å…¥å†…æ ¸æ€ï¼Œread()è¿™ä¸ªç³»ç»Ÿè°ƒç”¨æœ€ç»ˆç”±CPUæ¥å®Œæˆ CPUå‘ç£ç›˜å‘èµ·I/Oè¯·æ±‚ï¼Œç£ç›˜æ”¶åˆ°ä¹‹åå¼€å§‹å‡†å¤‡æ•°æ® ç£ç›˜å°†æ•°æ®æ”¾åˆ°ç£ç›˜ç¼“å†²åŒºä¹‹åï¼Œå‘CPUå‘èµ·I/Oä¸­æ–­ï¼Œå‘Šè¯‰CPUæ•°æ®å·²ç»readyäº† CPUæ”¶åˆ°ç£ç›˜æ§åˆ¶å™¨çš„I/Oä¸­æ–­ä¹‹åï¼Œå¼€å§‹æ‹·è´æ•°æ®ï¼Œå®Œæˆä¹‹åread()è¿”å›ï¼Œå†ä»å†…æ ¸æ€åˆ‡æ¢åˆ°ç”¨æˆ·æ€ 1.2 CPU\u0026DMAæ–¹å¼ CPUçš„æ—¶é—´å®è´µï¼Œè®©å®ƒåšæ‚æ´»å°±æ˜¯æµªè´¹èµ„æº\nç›´æ¥å†…å­˜è®¿é—®(Direct Memory Access)ï¼Œæ˜¯ä¸€ç§ç¡¬ä»¶è®¾å¤‡ç»•å¼€COUç‹¬ç«‹ç›´æ¥è®¿é—®å†…å­˜çš„æœºåˆ¶ã€‚æ‰€ä»¥DMAå†ä¸€å®šç¨‹åº¦ä¸Šè§£æ”¾äº†CPUï¼ŒæŠŠä¹‹å‰CPUçš„æ‚è´§è®©ç¡¬ä»¶ç›´æ¥è‡ªå·±åšäº†ï¼Œæé«˜äº†CPUæ•ˆç‡ã€‚\nç›®å‰æ”¯æŒDMAçš„ç¡¬ä»¶åŒ…æ‹¬:ç½‘å¡ã€å£°å¡ã€æ˜¾å¡ã€æ´—ç›˜æ§åˆ¶å™¨ç­‰ã€‚\næœ‰äº†DMAçš„å‚ä¸ä¹‹åçš„æµç¨‹å‘ç”Ÿäº†ä¸€äº›å˜åŒ–\næœ€ä¸»è¦çš„å˜åŒ–æ˜¯ï¼ŒCPUä¸å†å’Œç£ç›˜ç›´æ¥äº¤äº’ï¼Œè€Œæ˜¯DMAå’Œç£ç›˜äº¤äº’å¹¶ä¸”å°†æ•°æ®ä»ç£ç›˜ç¼“å†²åŒºæ‹·è´åˆ°å†…æ ¸ç¼“å†²åŒºï¼Œä¹‹åçš„è¿‡ç¨‹ç±»ä¼¼ã€‚\n1 æ— è®ºä»ä»…CPUçš„æ–¹å¼å’ŒDMA\u0026CPUçš„æ–¹å¼ï¼Œéƒ½å­˜åœ¨å¤šæ¬¡å†—ä½™æ•°æ®æ‹·è´å’Œå†…æ ¸æ€\u0026ç”¨æˆ·æ€çš„åˆ‡æ¢ã€‚ 2. æ™®é€šæ¨¡å¼æ•°æ®äº¤äº’ ä¸€æ¬¡å®Œæˆçš„æ•°æ®äº¤äº’åŒ…æ‹¬å‡ ä¸ªéƒ¨åˆ†:ç³»ç»Ÿè°ƒç”¨syscallã€CPUã€DMAã€ç½‘å¡ã€ç£ç›˜ç­‰\nç³»ç»Ÿè°ƒç”¨syscallæ˜¯åº”ç”¨ç¨‹åºå’Œå†…æ ¸äº¤äº’çš„æ¡¥æ¢ï¼Œæ¯æ¬¡è¿›è¡Œè°ƒç”¨/è¿”å›å°±ä¼šäº§ç”Ÿä¸¤æ¬¡åˆ‡æ¢:\nè°ƒç”¨syscallä»ç”¨æˆ·æ€åˆ‡æ¢åˆ°å†…æ ¸æ€ syscallè¿”å›ä»å†…æ ¸å°åˆ‡æ¢åˆ°ç”¨æˆ·æ€ ä¸‹å›¾æ˜¯å®Œæ•´çš„æ•°æ®æ‹·è´è¿‡ç¨‹ç®€å›¾:\nè¯»æ•°æ®è¿‡ç¨‹:\nåº”ç”¨ç¨‹åºè¦è¯»å–ç£ç›˜æ•°æ®ï¼Œè°ƒç”¨read()å‡½æ•°ä»è€Œå®ç°ç”¨æˆ·æ€åˆ‡æ¢å†…æ ¸æ€ï¼Œè¿™æ˜¯ç¬¬ä¸€æ¬¡åˆ‡æ¢ DMAæ§åˆ¶å™¨å°†æ•°æ®ä»ç£ç›˜æ‹·è´åˆ°å†…æ ¸ç¼“å†²åŒºï¼Œè¿™æ˜¯ç¬¬ä¸€æ¬¡DMAæ‹·è´ CPUå°†æ•°æ®ä»å†…æ ¸ç¼“å†²åŒºå¤åˆ¶åˆ°ç”¨æˆ·ç¼“å†²åŒºï¼Œè¿™æ˜¯ç¬¬ä¸€æ¬¡CPUæ‹·è´ CPUæ‹·è´å®Œæˆä¹‹åï¼Œread()å‡½æ•°è¿”å›å®ç°å†…æ ¸æ€åˆ‡æ¢ç”¨æˆ·æ€ï¼Œè¿™æ˜¯ç¬¬2æ¬¡çŠ¶æ€åˆ‡æ¢ å†™æ•°æ®è¿‡ç¨‹:\nåº”ç”¨ç¨‹åºè¦å‘ç½‘å¡å†™æ•°æ®ï¼Œè°ƒç”¨write()å‡½æ•°å®ç°ç”¨æˆ·æ€åˆ‡æ¢å†…æ ¸æ€ï¼Œè¿™æ˜¯ç¬¬ä¸€æ¬¡åˆ‡æ¢ CPUå°†ç”¨æˆ·ç¼“å†²åŒºæ•°æ®æ‹·è´åˆ°å†…æ ¸ç¼“å†²åŒºï¼Œè¿™æ˜¯ç¬¬ä¸€æ¬¡CPUæ‹·è´ DMAæ§åˆ¶å™¨å°†æ•°æ®ä»å†…æ ¸ç¼“å†²åŒºå¤åˆ¶åˆ°socketç¼“å†²åŒºï¼Œè¿™æ˜¯ç¬¬ä¸€æ¬¡DMAæ‹·è´ å®Œæˆæ‹·è´ä¹‹åï¼Œwrite()å‡½æ•°è¿”å›å®ç°å†…æ ¸æ€åˆ‡æ¢ç”¨æˆ·æ€ï¼Œè¿™æ˜¯ç¬¬äºŒæ¬¡åˆ‡æ¢ ç»¼ä¸Šæ‰€è¿°:\nè¯»è¿‡ç¨‹æ¶‰åŠ2æ¬¡ç©ºé—´åˆ‡æ¢ã€1æ¬¡DMAæ‹·è´ã€1æ¬¡CPUæ‹·è´ å†™è¿‡ç¨‹æ¶‰åŠ2æ¬¡ç©ºé—´åˆ‡æ¢ï¼Œ1æ¬¡DMAæ‹·è´ï¼Œ1æ¬¡CPUæ‹·è´ å¯è§ä¼ ç»Ÿæ¨¡å¼ä¸‹ï¼Œæ¶‰åŠå¤šæ¬¡ç©ºé—´åˆ‡æ¢å’Œæ•°æ®å†—ä½™æ‹·è´ï¼Œæ•ˆç‡å¹¶ä¸é«˜ï¼Œæ¥ä¸‹æ¥å°±è¯¥é›¶æ‹·è´æŠ€æœ¯å‡ºåœºäº†ã€‚\n3. é›¶æ‹·è´æŠ€æœ¯ 3.1 å‡ºç°åŸå›  å¯ä»¥çœ‹åˆ°ï¼Œå¦‚æœåº”ç”¨ç¨‹åºè¯»å–ç£ç›˜æ•°æ®ï¼Œä»å†…æ ¸ç¼“å†²åŒºåˆ°ç”¨æˆ·ç¼“å†²åŒºï¼Œå†ä»ç”¨æˆ·ç¼“å†²åŒºåˆ°å†…æ ¸ç¼“å†²åŒºã€‚ä¸¤æ¬¡æ•°æ®æ‹·è´éƒ½éœ€è¦CPUçš„å‚ä¸ï¼Œå¹¶ä¸”æ¶‰åŠç”¨æˆ·æ€ä¸å†…æ ¸æ€çš„å¤šæ¬¡åˆ‡æ¢ï¼ŒåŠ é‡äº†CPUè´Ÿæ‹…ã€‚éœ€è¦é™ä½å†—ä½™æ•°æ®æ‹·è´ï¼Œè§£æ”¾CPUï¼Œè¿™å°±æ˜¯é›¶æ‹·è´æŠ€æœ¯ã€‚\n3.2 è§£å†³æ€è·¯ ç›®å‰æ¥çœ‹ï¼Œé›¶æ‹·è´æŠ€æœ¯çš„å‡ ä¸ªå®ç°æ‰‹æ®µåŒ…æ‹¬: mmap+writeã€sendfileã€sendfile+DMAæ”¶é›†ã€spliceç­‰ã€‚\n3.2.1 mmapæ–¹å¼ mmapæ˜¯Linuxæä¾›çš„ä¸€ç§å†…å­˜æ˜ å°„æ–‡ä»¶çš„æœºåˆ¶ï¼Œå®ƒå®ç°äº†å°†å†…æ ¸ä¸­è¯»ç¼“å†²åŒºåœ°å€ä¸ç”¨æˆ·ç©ºé—´ç¼“å†²åŒºåœ°å€è¿›è¡Œæ˜ å°„ï¼Œä»è€Œå®ç°å†…æ ¸ç¼“å†²åŒºä¸ç”¨æˆ·ç¼“å†²åŒºçš„å…±äº«ã€‚\nè¿™æ ·å°±å‡å°‘äº†ä¸€æ¬¡ç”¨æˆ·æ€å’Œå†…æ ¸æ€çš„CPUæ‹·è´ï¼Œä½†æ˜¯åœ¨å†…æ ¸ç©ºé—´ä»æœ‰ä¸€æ¬¡CPUæ‹·è´\nmmapå¯¹å¤§æ–‡ä»¶ä¼ è¾“æœ‰ä¸€å®šä¼˜åŠ¿ï¼Œä½†æ˜¯å°æ–‡ä»¶å¯èƒ½å‡ºç°ç¢ç‰‡ï¼Œå¹¶ä¸”åœ¨å¤šä¸ªè¿›ç¨‹åŒæ—¶æ“ä½œæ–‡ä»¶æ—¶å¯èƒ½äº§ç”Ÿcoredumpçš„signalã€‚\n3.2.2 sendfileæ–¹å¼ mmap+writeæ–¹å¼æœ‰ä¸€å®šæ”¹è¿›ï¼Œä½†æ˜¯ç”±ç³»ç»Ÿè°ƒç”¨å¼•èµ·çš„çŠ¶æ€åˆ‡æ¢å¹¶æ²¡æœ‰å‡å°‘ã€‚\nsendfileç³»ç»Ÿè°ƒç”¨å®åœ¨Linuxå†…æ ¸2.1ç‰ˆæœ¬ä¸­è¢«å¼•å…¥ï¼Œå®ƒå»ºç«‹äº†ä¸¤ä¸ªæ–‡ä»¶ä¹‹é—´çš„ä¼ è¾“é€šé“ã€‚\nsendfileæ–¹å¼åªä½¿ç”¨ä¸€ä¸ªå‡½æ•°å°±å¯ä»¥å®Œæˆä¹‹å‰çš„read+writeå’Œmmap+writeçš„åŠŸèƒ½ï¼Œè¿™æ ·å°±å‡å°‘äº†2æ¬¡çŠ¶æ€åˆ‡æ¢ï¼Œç”±äºæ•°æ®ä¸ç»è¿‡ç”¨æˆ·ç¼“å†²åŒºï¼Œå› æ­¤è¯¥æ•°æ®æ— æ³•è¢«ä¿®æ”¹\n3.2.3 sendfile+DMAæ”¶é›† Linux2.4å†…æ ¸å¯¹ sendfileç³»ç»Ÿè°ƒç”¨è¿›è¡Œä¼˜åŒ–ï¼Œä½†æ˜¯éœ€è¦ç¡¬ä»¶DMAæ§åˆ¶å™¨çš„é…åˆã€‚\nå‡çº§ä¹‹åçš„sendfileå°†å†…æ ¸ç©ºé—´ç¼“å†²åŒºä¸­å¯¹åº”çš„æ•°æ®æè¿°ä¿¡æ¯è®°å½•åˆ°socketç¼“å†²åŒºä¸­ã€‚\nDMAæ§åˆ¶å™¨æ ¹æ®socketç¼“å†²åŒºä¸­çš„åœ°å€å’Œåç§»é‡å°†æ•°æ®ä»å†…æ ¸ç¼“å†²åŒºæ‹·è´åˆ°ç½‘å¡ä¸­ï¼Œä»è€Œçœå»äº†å†…æ ¸ç©ºé—´ä¸­ä»…å‰©çš„ä¸€æ¬¡CPUæ‹·è´\nè¿™ç§æ–¹å¼æœ‰2æ¬¡çŠ¶æ€åˆ‡æ¢ï¼Œ0æ¬¡CPUæ‹·è´ã€2æ¬¡DMAæ‹·è´ï¼Œä½†æ˜¯ä»ç„¶æ— æ³•å¯¹æ•°æ®è¿›è¡Œä¿®æ”¹ï¼Œå¹¶ä¸”éœ€è¦ç¡¬ä»¶å±‚é¢DMAçš„æ”¯æŒï¼Œå¹¶ä¸”sendfileåªèƒ½å°†æ–‡ä»¶çš„æ•°æ®æ‹·è´åˆ°socketæè¿°ç¬¦ä¸Šï¼Œæœ‰ä¸€å®šçš„å±€é™æ€§ã€‚\n3.2.4 spliceæ–¹å¼ spliceç³»ç»Ÿè°ƒç”¨æ˜¯Linuxåœ¨2.6ç‰ˆæœ¬å¼•å…¥çš„ï¼Œå…¶ä¸éœ€è¦ç¡¬ä»¶æ”¯æŒï¼Œå¹¶ä¸”ä¸å†é™å®šäºsocketä¸Šï¼Œå®ç°ä¸¤ä¸ªæ™®é€šæ–‡ä»¶ä¹‹é—´çš„æ•°æ®é›¶æ‹·è´ã€‚\nspliceç³»ç»Ÿè°ƒç”¨å¯ä»¥åœ¨å†…æ ¸ç¼“å†²åŒºå’Œsocketç¼“å†²åŒºä¹‹é—´å»ºç«‹ç®¡é“æ¥ä¼ è¾“æ•°æ®ï¼Œé¿å…äº†ä¸¤è€…ä¹‹é—´çš„CPUæ‹·è´æ“ä½œã€‚\nJAVA NIOé›¶æ‹·è´ åœ¨Java NIOä¸­çš„\né€šé“å°±ç›¸å½“äºæ“ä½œç³»ç»Ÿçš„å†…æ ¸ç©ºé—´çš„ç¼“å†²åŒºï¼Œè€Œç¼“å†²åŒºå¯¹åº”çš„ç›¸å½“äºæ“ä½œç³»ç»Ÿçš„ç”¨æˆ·ç©ºé—´ä¸­çš„ç”¨æˆ·ç¼“å†²åŒºã€‚\né€šé“æ˜¯å…¨åŒå·¥çš„(åŒå‘è¿è¾“)ï¼Œå®ƒæ—¢å¯èƒ½æ˜¯è¯»ç¼“å†²åŒºï¼Œä¹Ÿå¯èƒ½æ˜¯ç½‘ç»œç¼“å†²åŒº ç¼“å†²åŒºåˆ†ä¸ºå †å†…å­˜å’Œå †å¤–å†…å­˜ï¼Œè¿™æ˜¯é€šè¿‡mallocåˆ†é…å‡ºæ¥çš„ç”¨æˆ·æ€å†…å­˜ã€‚ å †å¤–å†…å­˜åœ¨ä½¿ç”¨åéœ€è¦åº”ç”¨ç¨‹åºæ‰‹åŠ¨å›æ”¶ï¼Œè€Œå †å†…å­˜åœ¨æ•°æ®GCæ—¶å¯èƒ½è¢«è‡ªåŠ¨å›æ”¶ã€‚å› æ­¤ï¼Œåœ¨ä½¿ç”¨HeapBufferè¯»å†™æ•°æ®æ—¶ï¼Œä¸ºäº†é¿å…ç¼“å†²åŒºæ•°æ®å› ä¸ºGCä¸¢å¤±ï¼ŒNIOä¼šå…ˆæŠŠHeapBufferå†…éƒ¨çš„æ•°æ®æ‹·è´åˆ°ä¸€ä¸ªä¸´æ—¶çš„DirectBufferä¸­çš„æœ¬åœ°å†…å­˜ï¼Œè¿™ä¸ªæ‹·è´æ¶‰åŠåˆ°sun.misc.Usafe.copyMemory()çš„è°ƒç”¨ï¼ŒèƒŒåçš„å®ç°åŸç†äºmemcpy()ç±»ä¼¼ã€‚æœ€åï¼Œå°†ä¸´æ—¶ç”Ÿæˆçš„DirectBufferå†…éƒ¨çš„æ•°æ®çš„å†…å­˜åœ°å€ä¼ ç»™I/Oè°ƒç”¨å‡½æ•°ï¼Œè¿™æ ·å°±é¿å…äº†å†å»è®¿é—®Javaå¯¹è±¡å¤„ç†I/Oè¯»å†™ã€‚\nMAppedByteBuffer MappedBytyBufferæ˜¯NIOåŸºäº\"å†…å­˜æ˜ å°„(mmap)â€œè¿™ç§é›¶æ‹·è´æ–¹å¼çš„æä¾›çš„ä¸€ç§å®ç°ï¼Œå®ƒç»§æ‰¿è‡ªByteBufferã€‚FileChannelå®šä¹‰äº†ä¸€ä¸ªmap()æ–¹æ³•ï¼Œå®ƒå¯ä»¥æŠŠä¸€ä¸ªæ–‡ä»¶ä»positionä½ç½®å¼€å§‹çš„sizeå¤§å°çš„åŒºåŸŸæ˜ å°„ä¸ºå†…å­˜æ˜ åƒæ–‡ä»¶ã€‚æŠ½è±¡æ–¹æ³•map()æ–¹æ³•åœ¨FileChannelä¸­çš„å®šä¹‰å¦‚ä¸‹:\n1 2 public abstract MappedByteBuffer map(MapMode mode, long position, long size) throws IOException; mode:é™å®šå†…å­˜æ˜ å°„åŒºåŸŸå¯¹å†…å­˜æ˜ åƒæ–‡ä»¶çš„è®¿é—®æ¨¡å¼ï¼ŒåŒ…æ‹¬åªå¯è¯»ã€å¯è¯»å¯å†™å’Œå†™æ—¶æ‹·è´ä¸‰ç§æ¨¡å¼ã€‚ position: æ–‡ä»¶æ˜ å°„çš„èµ·å§‹åœ°å€ï¼Œå¯¹åº”å†…å­˜æ˜ å°„åŒºåŸŸçš„é¦–åœ°å€ã€‚ size: æ–‡ä»¶æ˜ å°„çš„å­—èŠ‚é•¿åº¦ï¼Œä»positionå¾€åçš„å­—èŠ‚æ•°ï¼Œå¯¹åº”å†…å­˜æ˜ å°„åŒºåŸŸçš„å¤§å°ã€‚ MappedByteBufferç›¸æ¯”ByteBufferæ–°å¢äº†fore()ã€load()å’ŒisLoad()ä¸‰ä¸ªé‡è¦æ–¹æ³•:\nfore(): å¯¹äºå¤„äºREAD_WRITEæ¨¡å¼ä¸‹çš„ç¼“å†²åŒºï¼ŒæŠŠå¯¹ç¼“å†²åŒºå†…å®¹çš„ä¿®æ”¹å¼ºåˆ¶åˆ·æ–°åˆ°æœ¬åœ°æ–‡ä»¶ã€‚ load(): å°†ç¼“å†²åŒºçš„å†…å®¹è½½å…¥åˆ°ç‰©ç†å†…å­˜ä¸­ï¼Œå¹¶è¿”å›è¿™ä¸ªç¼“å†²åŒºçš„å¼•ç”¨ isLoad(): å¦‚æœç¼“å†²åŒºçš„å†…å®¹åœ¨ç‰©ç†å†…å­˜ä¸­ï¼Œåˆ™è¿”å›trueï¼Œå¦åˆ™è¿”å›falseã€‚ ä¸‹é¢ç»™å‡ºä¸€ä¸ªåˆ©ç”¨MappedByteBufferå¯¹æ–‡ä»¶è¿›è¡Œè¯»å†™çš„ä½¿ç”¨ç¤ºä¾‹:\n1 2 3 private final static String CONTENT = \"Zero copy implemented by MappedByteBuffer\"; private final static String FILE_NAME = \"/mmap.txt\"; private final static String CHARSET = \"UTF-8\"; å†™æ–‡ä»¶æ•°æ®:æ‰“å¼€æ–‡ä»¶é€šé“fileChannelå¹¶æä¾›è¯»æƒé™ã€å†™æƒé™å’Œæ•°æ®æ¸…ç©ºæƒé™ï¼Œé€šè¿‡fileChannelæ˜ å°„åˆ°ä¸€ä¸ªå¯å†™çš„å†…å­˜ç¼“å†²åŒºmappedByteBUfferï¼Œå°†ç›®æ ‡æ•°æ®å†™å…¥mappedByteBufferï¼Œé€šè¿‡force()æ–¹æ³•æŠŠç¼“å†²åŒºæ›´æ”¹çš„å†…å®¹å¼ºåˆ¶å†™å…¥æœ¬åœ°æ–‡ä»¶ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 @Test public void writeToFileByMappedByteBuffer() { Path path = Paths.get(getClass().getResource(FILE_NAME).getPath()); byte[] bytes = CONTENT.getBytes(Charset.forName(CHARSET)); try (FileChannel fileChannel = FileChannel.open(path, StandardOpenOption.READ, StandardOpenOption.WRITE, StandardOpenOption.TRUNCATE_EXISTING)) { MappedByteBuffer mappedByteBuffer = fileChannel.map(READ_WRITE, 0, bytes.length); if (mappedByteBuffer != null) { mappedByteBuffer.put(bytes); mappedByteBuffer.force(); } } catch (IOException e) { e.printStackTrace(); } } è¯»æ–‡ä»¶æ•°æ®:æ‰“å¼€æ–‡ä»¶é€šé“fileChannelå¹¶æä¾›åªè¯»æƒé™ï¼Œé€šè¿‡fileChannelæ˜ å°„åˆ°ä¸€ä¸ªåªå¯è¯»çš„å†…å­˜ç¼“å†²åŒºmappedByteBufferï¼Œè¯»å–mappedByteBufferä¸­çš„å­—èŠ‚æ•°ç»„å³å¯å¾—åˆ°æ–‡ä»¶æ•°æ®ã€‚ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 @Test public void readFromFileByMappedByteBuffer() { Path path = Paths.get(getClass().getResource(FILE_NAME).getPath()); int length = CONTENT.getBytes(Charset.forName(CHARSET)).length; try (FileChannel fileChannel = FileChannel.open(path, StandardOpenOption.READ)) { MappedByteBuffer mappedByteBuffer = fileChannel.map(READ_ONLY, 0, length); if (mappedByteBuffer != null) { byte[] bytes = new byte[length]; mappedByteBuffer.get(bytes); String content = new String(bytes, StandardCharsets.UTF_8); assertEquals(content, \"Zero copy implemented by MappedByteBuffer\"); } } catch (IOException e) { e.printStackTrace(); } } ä¸‹é¢ä»‹ç»map()æ–¹æ³•çš„åº•å±‚å®ç°åŸç†ã€‚map()æ–¹æ³•æ˜¯java.nio.channels.FileChannelçš„æŠ½è±¡æ–¹æ³•ï¼Œç”±å­ç±»sun.nio.ch.FIleChannelImpl.javaå®ç°ï¼Œä¸‹é¢æ˜¯å’Œå†…å­˜æ˜ å°„ç›¸å…³çš„æ ¸å¿ƒä»£ç :\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 public MappedByteBuffer map(MapMode mode, long position, long size) throws IOException { int pagePosition = (int)(position % allocationGranularity); long mapPosition = position - pagePosition; long mapSize = size + pagePosition; try { addr = map0(imode, mapPosition, mapSize); } catch (OutOfMemoryError x) { System.gc(); try { Thread.sleep(100); } catch (InterruptedException y) { Thread.currentThread().interrupt(); } try { addr = map0(imode, mapPosition, mapSize); } catch (OutOfMemoryError y) { throw new IOException(\"Map failed\", y); } } int isize = (int)size; Unmapper um = new Unmapper(addr, mapSize, isize, mfd); if ((!writable) || (imode == MAP_RO)) { return Util.newMappedByteBufferR(isize, addr + pagePosition, mfd, um); } else { return Util.newMappedByteBuffer(isize, addr + pagePosition, mfd, um); } } map()æ–¹æ³•é€šè¿‡æœ¬åœ°æ–¹æ³•map0()ä¸ºæ–‡ä»¶åˆ†é…ä¸€å—è™šæ‹Ÿå†…å­˜ï¼Œä½œä¸ºå®ƒçš„å†…å­˜æ˜ å°„åŒºåŸŸï¼Œç„¶åè¿”å›è¿™å—å†…å­˜æ˜ å°„åŒºåŸŸçš„èµ·å§‹åœ°å€ã€‚\næ–‡ä»¶æ˜ å°„éœ€è¦åœ¨Javaå †ä¸­åˆ›å»ºä¸€ä¸ªMappedByteBufferçš„å®ä¾‹ã€‚å¦‚æœç¬¬ä¸€æ¬¡æ–‡ä»¶æ˜ å°„å¯¼è‡´OOMï¼Œåˆ™æ‰‹åŠ¨è§¦å‘åƒåœ¾å›æ”¶ï¼Œä¼‘çœ 100msåå†æ¬¡å°è¯•æ˜ å°„ï¼Œå¦‚æœå¤±è´¥åˆ™æŠ›å‡ºå¼‚å¸¸ã€‚ é€šè¿‡Utilçš„newMappedByteBUfferæ–¹æ³•æˆ–è€…newMappedByteBufferRæ–¹æ³•åå°„åˆ›å»ºä¸€ä¸ªDirectByteBufferå®ä¾‹ï¼Œå…¶ä¸­DirectByteBufferæ˜¯MappedByteBUfferçš„å­ç±»ã€‚ map()æ–¹æ³•è¿”å›çš„æ˜¯å†…å­˜æ˜ å°„åŒºåŸŸçš„èµ·å§‹åœ°å€ï¼Œé€šè¿‡(èµ·å§‹åœ°å€+åç§»é‡)å°±å¯ä»¥è·å–æŒ‡å®šå†…å­˜çš„æ•°æ®ã€‚è¿™æ ·ä¸€å®šç¨‹åº¦ä¸Šæ›¿ä»£äº†readæˆ–write()æ–¹æ³•ï¼Œåº•å±‚ç›´æ¥é‡‡ç”¨sun.misc.Unsafeç±»çš„getByte()å’ŒputByte()æ–¹æ³•å¯¹æ•°æ®è¿›è¡Œè¯»å†™ã€‚\n1 private native long map0(int prot, long position, long mapSize) throws IOException; ä¸Šé¢æ˜¯æœ¬åœ°æ–¹æ³•map0çš„å®šä¹‰ï¼Œå®ƒé€šè¿‡JNIè°ƒç”¨åº•å±‚Cçš„å®ç°ï¼Œè¿™ä¸ªnativeå‡½æ•°çš„å®ç°ä½äºJDKæºç åŒ…ä¸‹ã€‚ native/sun/nio/ch/FileChannelImpl.cè¿™ä¸ªæºæ–‡ä»¶é‡Œ\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 JNIEXPORT jlong JNICALL Java_sun_nio_ch_FileChannelImpl_map0(JNIEnv *env, jobject this, jint prot, jlong off, jlong len) { void *mapAddress = 0; jobject fdo = (*env)-\u003eGetObjectField(env, this, chan_fd); jint fd = fdval(env, fdo); int protections = 0; int flags = 0; if (prot == sun_nio_ch_FileChannelImpl_MAP_RO) { protections = PROT_READ; flags = MAP_SHARED; } else if (prot == sun_nio_ch_FileChannelImpl_MAP_RW) { protections = PROT_WRITE | PROT_READ; flags = MAP_SHARED; } else if (prot == sun_nio_ch_FileChannelImpl_MAP_PV) { protections = PROT_WRITE | PROT_READ; flags = MAP_PRIVATE; } mapAddress = mmap64( 0, /* Let OS decide location */ len, /* Number of bytes to map */ protections, /* File permissions */ flags, /* Changes are shared */ fd, /* File descriptor of mapped file */ off); /* Offset into file */ if (mapAddress == MAP_FAILED) { if (errno == ENOMEM) { JNU_ThrowOutOfMemoryError(env, \"Map failed\"); return IOS_THROWN; } return handle(env, -1, \"Map failed\"); } return ((jlong) (unsigned long) mapAddress); } å¯ä»¥çœ‹å‡ºmap0()å‡½æ•°æœ€ç»ˆæ˜¯é€šè¿‡mmap65()è¿™ä¸ªå‡½æ•°å¯¹Linuxåº•å±‚å†…æ ¸å‘å‡ºçš„å†…å­˜æ˜ å°„è°ƒç”¨ï¼Œmmap64()å‡½æ•°çš„åŸå‹å¦‚ä¸‹:\n1 2 3 #include void *mmap64(void *addr, size_t len, int prot, int flags, int fd, off64_t offset); ä¸‹é¢è¯¦ç»†ä»‹ç»ä»¥ä¸‹mmap64()å‡½æ•°å„ä¸ªå‚æ•°çš„å«ä¹‰ä»¥åŠå‚æ•°å¯é€‰å€¼:\naddr: æ–‡ä»¶åœ¨ç”¨æˆ·è¿›ç¨‹ç©ºé—´çš„å†…å­˜æ˜ å°„åŒºä¸­çš„èµ·å§‹åœ°å€ï¼Œæ˜¯ä¸€ä¸ªå»ºè®®çš„å‚æ•°ï¼Œé€šå¸¸å¯è®¾ç½®ä¸º0æˆ–nullï¼Œæ­¤æ—¶ç”±å†…æ ¸å»å†³å®šçœŸå®çš„èµ·å§‹åœ°å€ã€‚å½“+flagä¸ºMAP_FIXEDæ—¶ï¼Œaddrå°±æ˜¯ä¸€ä¸ªå¿…é€‰çš„å‚æ•°ï¼Œå³éœ€è¦æä¾›ä¸€ä¸ªå­˜åœ¨çš„åœ°å€ã€‚ len:æ–‡ä»¶éœ€è¦è¿›è¡Œå†…å­˜æ˜ å°„çš„é•¿åº¦ prot:æ§åˆ¶ç”¨æˆ·è¿›ç¨‹å¯¹å†…å­˜æ˜ å°„åŒºçš„è®¿é—®æƒé™ã€‚ PROT_READ: è¯»æƒé™ PROT_WRITE: å†™æƒé™ PROT_EXEC: æ‰§è¡Œæƒé™ PROT_NONE: æ— æƒé™ flags: æ§åˆ¶å†…å­˜æ˜ å°„åŒºçš„ä¿®æ”¹æ˜¯å¦è¢«å¤šä¸ªè¿›ç¨‹å…±äº« MAP_PRIVATE: å¯¹å†…å­˜æ˜ å°„åŒºæ•°æ®çš„ä¿®æ”¹ä¸ä¼šåæ˜ åˆ°çœŸæ­£çš„æ–‡ä»¶ï¼Œæ•°æ®ä¿®æ”¹å‘ç”Ÿæ—¶é‡‡ç”¨å†™æ—¶å¤åˆ¶æœºåˆ¶ã€‚ MAP_SHARED: å¯¹å†…å­˜æ˜ å°„åŒºçš„ä¿®æ”¹ä¼šåŒæ­¥åˆ°çœŸæ­£çš„æ–‡ä»¶ï¼Œä¿®æ”¹å¯¹å…±äº«æ­¤å†…å­˜æ˜ å°„åŒºçš„è¿›ç¨‹æ˜¯å¯è§çš„ã€‚ MAP_FIXED: ä¸å»ºè®®ä½¿ç”¨ï¼Œè¿™ç§æ¨¡å¼ä¸‹addrå‚æ•°æŒ‡å®šçš„å¿…é¡»çš„æä¾›ä¸€ä¸ªå­˜åœ¨çš„addrå‚æ•°ã€‚ fd: æ–‡ä»¶æè¿°ç¬¦ã€‚æ¯æ¬¡Mapæ“ä½œä¼šå¯¼è‡´æ–‡ä»¶çš„å¼•ç”¨è®¡æ•°åŠ 1ï¼Œæ¯æ¬¡unmapæ“ä½œæˆ–è€…ç»“æŸè¿›ç¨‹ä¼šå¯¼è‡´å¼•ç”¨è®¡æ•°å‡1 offset: æ–‡ä»¶åç§»é‡ã€‚è¿›è¡Œæ˜ å°„çš„æ–‡ä»¶ä½ç½®ï¼Œä»æ–‡ä»¶èµ·å§‹åœ°å€å‘åçš„ä½ç§»é‡ ä¸‹é¢æ€»ç»“ä¸€ä¸‹MappedByteBufferçš„ç‰¹ç‚¹å’Œä¸è¶³ä¹‹å¤„:\nMappedByteBufferä½¿ç”¨æ˜¯å †å¤–çš„è™šæ‹Ÿå†…å­˜ï¼Œå› æ­¤åˆ†é…çš„å†…å­˜å¤§å°ä¸å—JVMçš„-Xmxå‚æ•°é™åˆ¶ï¼Œä½†æ˜¯ä¹Ÿæ˜¯æœ‰å¤§å°é™åˆ¶çš„ã€‚å¦‚æœå½“æ–‡ä»¶è¶…å‡ºInteger.MAX_VALUEå­—èŠ‚é™åˆ¶æ—¶ï¼Œå¯ä»¥é€šè¿‡positionå‚æ•°é‡æ–°mapæ–‡ä»¶åé¢çš„å†…å®¹ã€‚ MappedByteBufferåœ¨å¤„ç†å¤§æ–‡ä»¶æ—¶æ€§èƒ½çš„ç¡®å¾ˆé«˜ï¼Œä½†æ˜¯ä¹Ÿå­˜åœ¨å†…å­˜å ç”¨ï¼Œæ–‡ä»¶å…³é—­ä¸ç¡®å®šç­‰é—®é¢˜ï¼Œè¢«å…¶æ‰“å¼€çš„æ–‡ä»¶åªæœ‰åœ¨åƒåœ¾å›æ”¶çš„æ—¶å€™æ‰ä¼šè¢«å…³é—­ï¼Œè€Œä¸”è¿™ä¸ªæ—¶é—´ç‚¹æ˜¯ä¸ç¡®å®šçš„ã€‚ MappedByteBufferæä¾›äº†æ–‡ä»¶æ˜ å°„å†…å­˜çš„mmap()æ–¹æ³•ï¼Œä¹Ÿæä¾›äº†é‡Šæ”¾æ˜ å°„å†…å­˜çš„unmap()æ–¹æ³•ã€‚ç„¶è€Œunmap()æ˜¯FileChannelImplä¸­çš„ç§æœ‰æ–¹æ³•ï¼Œæ— æ³•ç›´æ¥æ˜¾ç¤ºè°ƒç”¨ã€‚å› æ­¤ï¼Œç”¨æˆ·ç¨‹åºéœ€è¦é€šè¿‡Javaåå°„çš„è°ƒç”¨sun.misc.Cleanerç±»çš„clean()æ–¹æ³•æ‰‹åŠ¨é‡Šæ”¾æ˜ å°„å ç”¨çš„å†…å­˜åŒºåŸŸã€‚ 1 2 3 4 5 6 7 8 9 10 11 12 public static void clean(final Object buffer) throws Exception { AccessController.doPrivileged((PrivilegedAction) () -\u003e { try { Method getCleanerMethod = buffer.getClass().getMethod(\"cleaner\", new Class[0]); getCleanerMethod.setAccessible(true); Cleaner cleaner = (Cleaner) getCleanerMethod.invoke(buffer, new Object[0]); cleaner.clean(); } catch(Exception e) { e.printStackTrace(); } }); } DirectByteBuffer DirectByteBUffer çš„å¯¹è±¡å¼•ç”¨ä½äºJava å†…å­˜æ¨¡å‹çš„å †é‡Œé¢ï¼ŒJVMå¯ä»¥å¯¹DirectByteBUfferçš„å¯¹è±¡è¿›è¡Œå†…å­˜åˆ†é…å’Œå›æ”¶ç®¡ç†ï¼Œä¸€èˆ¬ä½¿ç”¨DirectByteBufferçš„é™æ€æ–¹æ³•allocateDirect()åˆ›å»ºDIrectByteBufferå®ä¾‹å¹¶åˆ†é…å†…å­˜ã€‚\n1 2 3 public static ByteBuffer allocateDirect(int capacity) { return new DirectByteBuffer(capacity); } DirectByteBUfferå†…éƒ¨çš„å­—èŠ‚ç¼“å†²åŒºä½åœ¨äºå †å¤–çš„ç›´æ¥å†…å­˜ï¼Œå®ƒæ˜¯é€šè¿‡Unsafeçš„æœ¬åœ°æ–¹æ³•allocateMemory()è¿›è¡Œå†…å­˜åˆ†é…ï¼Œåº•å±‚è°ƒç”¨çš„æ˜¯æ“ä½œç³»ç»Ÿçš„malloc()å‡½æ•°ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 DirectByteBuffer(int cap) { super(-1, 0, cap, cap); boolean pa = VM.isDirectMemoryPageAligned(); int ps = Bits.pageSize(); long size = Math.max(1L, (long)cap + (pa ? ps : 0)); Bits.reserveMemory(size, cap); long base = 0; try { base = unsafe.allocateMemory(size); } catch (OutOfMemoryError x) { Bits.unreserveMemory(size, cap); throw x; } unsafe.setMemory(base, size, (byte) 0); if (pa \u0026\u0026 (base % ps != 0)) { address = base + ps - (base \u0026 (ps - 1)); } else { address = base; } cleaner = Cleaner.create(this, new Deallocator(base, size, cap)); att = null; } é™¤æ­¤ä¹‹å¤–ï¼Œåˆå§‹åŒ–DIrectByteBufferæ—¶è¿˜ä¼šåˆ›å»ºä¸€ä¸ªDeallocatorçº¿ç¨‹ï¼Œå¹¶é€šè¿‡Cleanerçš„freeMemory()æ–¹æ³•æ¥ç›´æ¥å¯¹å†…å­˜è¿›è¡Œå›æ”¶æ“ä½œï¼ŒfreeMemory()åº•å±‚è°ƒç”¨çš„æ˜¯æ“ä½œç³»ç»Ÿçš„free()å‡½æ•°ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 private static class Deallocator implements Runnable { private static Unsafe unsafe = Unsafe.getUnsafe(); private long address; private long size; private int capacity; private Deallocator(long address, long size, int capacity) { assert (address != 0); this.address = address; this.size = size; this.capacity = capacity; } public void run() { if (address == 0) { return; } unsafe.freeMemory(address); address = 0; Bits.unreserveMemory(size, capacity); } } ç”±äºä½¿ç”¨DirectByteBufferåˆ†é…çš„æ˜¯ç³»ç»Ÿæœ¬åœ°çš„å†…å­˜ï¼Œä¸åœ¨JVMçš„ç®¡æ§èŒƒå›´ä¹‹å†…ï¼Œå› æ­¤ç›´æ¥å†…å­˜çš„å›æ”¶å’Œå †å†…å­˜çš„å›æ”¶ä¸åŒï¼Œç›´æ¥å†…å­˜å¦‚æœä½¿ç”¨ä¸å½“ï¼Œå¾ˆå®¹æ˜“é€ æˆOutOfMemoryErrorã€‚\nè¯´äº†è¿™ä¹ˆå¤šï¼Œé‚£ä¹ˆDirectByteBufferå’Œé›¶æ‹·è´æœ‰ä»€ä¹ˆå…³ç³»ï¼Ÿå‰é¢æœ‰æåˆ°åœ¨MappedByteBufferè¿›è¡Œå†…å­˜æ˜ å°„æ—¶ï¼Œå®ƒçš„map()æ–¹æ³•ä¼šé€šè¿‡Util.newMappedByteBuffer()æ¥åˆ›å»ºä¸€ä¸ªç¼“å†²åŒºå®ä¾‹ï¼Œåˆå§‹åŒ–ä»£ç å¦‚ä¸‹:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 static MappedByteBuffer newMappedByteBuffer(int size, long addr, FileDescriptor fd, Runnable unmapper) { MappedByteBuffer dbb; if (directByteBufferConstructor == null) initDBBConstructor(); try { dbb = (MappedByteBuffer)directByteBufferConstructor.newInstance( new Object[] { new Integer(size), new Long(addr), fd, unmapper }); } catch (InstantiationException | IllegalAccessException | InvocationTargetException e) { throw new InternalError(e); } return dbb; } private static void initDBBRConstructor() { AccessController.doPrivileged(new PrivilegedAction() { public Void run() { try { Class\u003c?\u003e cl = Class.forName(\"java.nio.DirectByteBufferR\"); Constructor\u003c?\u003e ctor = cl.getDeclaredConstructor( new Class\u003c?\u003e[] { int.class, long.class, FileDescriptor.class, Runnable.class }); ctor.setAccessible(true); directByteBufferRConstructor = ctor; } catch (ClassNotFoundException | NoSuchMethodException | IllegalArgumentException | ClassCastException x) { throw new InternalError(x); } return null; }}); } DirectByteBufferæ˜¯MappedByteBufferçš„å…·ä½“å®ç°ç±»ã€‚å®é™…ä¸Šï¼ŒUtil.newMappedByteBUffer()æ–¹æ³•é€šè¿‡åå°„æœºåˆ¶è·å–DirectByteBufferçš„æ„é€ å™¨ï¼Œç„¶ååˆ›å»ºä¸€ä¸ªDirectByteBUfferçš„å®ä¾‹ï¼Œå¯¹åº”çš„æ˜¯ä¸€ä¸ªå•ç‹¬ç”¨äºå†…å­˜æ˜ å°„çš„æ„é€ æ–¹æ³•:\n1 2 3 4 5 6 protected DirectByteBuffer(int cap, long addr, FileDescriptor fd, Runnable unmapper) { super(-1, 0, cap, cap, fd); address = addr; cleaner = Cleaner.create(this, unmapper); att = null; } å› æ­¤é™¤äº†å…è®¸åˆ†é…æ“ä½œç³»ç»Ÿçš„ç›´æ¥å†…å­˜ä¹‹å¤–ï¼ŒDirectByteBufferæœ¬èº«ä¹Ÿå…·æœ‰æ–‡ä»¶æ˜ å°„çš„åŠŸèƒ½ï¼Œè¿™é‡Œä¸åšè¿‡å¤šè¯´æ˜ã€‚æˆ‘ä»¬éœ€è¦å…³æ³¨çš„æ˜¯ï¼ŒDirectByteBufferåœ¨MappedByteBufferçš„åŸºç¡€ä¸Šæä¾›äº†å†…å­˜æ˜ åƒæ–‡ä»¶çš„éšæœºè¯»å–get()å’Œå†™å…¥write()æ“ä½œã€‚\n1 2 3 4 5 6 7 public byte get() { return ((unsafe.getByte(ix(nextGetIndex())))); } public byte get(int i) { return ((unsafe.getByte(ix(checkIndex(i))))); } 1 2 3 4 5 6 7 8 9 public ByteBuffer put(byte x) { unsafe.putByte(ix(nextPutIndex()), ((x))); return this; } public ByteBuffer put(int i, byte x) { unsafe.putByte(ix(checkIndex(i)), ((x))); return this; } å†…å­˜æ˜ åƒæ–‡ä»¶çš„éšæœºè¯»å†™éƒ½æ˜¯å€ŸåŠ©ix()æ–¹æ³•å®ç°å®šä½çš„ï¼Œix()æ–¹æ³•é€šè¿‡å†…å­˜æ˜ å°„ç©ºé—´çš„å†…å­˜é¦–åœ°å€å’Œç»™å®šåç§»é‡iè®¡ç®—å‡ºæŒ‡é’ˆåœ°å€ï¼Œç„¶åç”±unsafeç±»çš„get()å’Œput()æ–¹æ³•å’Œå¯¹æŒ‡é’ˆæŒ‡å‘çš„æ•°æ®è¿›è¡Œè¯»å–æˆ–å†™å…¥ã€‚\n1 2 3 private long ix(int i) { return address + ((long)i \u003c\u003c 0); } FileChannel FileChannelæ˜¯ä¸€ä¸ªç”¨æˆ·æ–‡ä»¶è¯»å†™ï¼Œæ˜ å°„å’Œæ“ä½œçš„é€šé“ï¼ŒåŒæ—¶å®ƒåœ¨å¹¶å‘ç¯å¢ƒä¸‹æ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼ŒåŸºäºFileInputStreamã€FileOutputStreamæˆ–è€…RandomAccessFileçš„getChannel()æ–¹æ³•å¯ä»¥åˆ›å»ºå¹¶æ‰“å¼€ä¸€ä¸ªæ–‡ä»¶é€šé“ã€‚FIleChannelå®šä¹‰äº†transferFrom()å’ŒtransferTo()ä¸¤ä¸ªæŠ½è±¡æ–¹æ³•ï¼Œå®ƒé€šè¿‡åœ¨é€šé“å’Œé€šé“ä¹‹é—´å»ºç«‹è¿æ¥å®ç°æ•°æ®ä¼ è¾“çš„ã€‚\ntransferTo(): é€šè¿‡FileChannelæŠŠæ–‡ä»¶é‡Œé¢çš„æºæ•°æ®å†™å…¥ä¸€ä¸ªWritableByteChannelçš„ç›®çš„é€šé“ 1 2 public abstract long transferTo(long position, long count, WritableByteChannel target) throws IOException; transferFrom(): æŠŠä¸€ä¸ªæºé€šé“ReadableByteChannelä¸­çš„æ•°æ®è¯»å–åˆ°å½“å‰FIleChannelçš„æ–‡ä»¶é‡Œé¢ã€‚ 1 2 public abstract long transferFrom(ReadableByteChannel src, long position, long count) throws IOException; ä¸‹é¢ç»™å‡ºFileChannelåˆ©ç”¨transferTo()å’ŒtransferFrom()æ–¹æ³•è¿›è¡Œæ•°æ®ä¼ è¾“çš„ä½¿ç”¨ç¤ºä¾‹:\n1 2 3 4 private static final String CONTENT = \"Zero copy implemented by FileChannel\"; private static final String SOURCE_FILE = \"/source.txt\"; private static final String TARGET_FILE = \"/target.txt\"; private static final String CHARSET = \"UTF-8\"; é¦–å…ˆåœ¨ç±»åŠ è½½æ ¹è·¯å¾„ä¸‹åˆ›å»ºsource.txtå’Œtarget.txtä¸¤ä¸ªæ–‡ä»¶ï¼Œå¯¹æºæ–‡ä»¶source.txtæ–‡ä»¶å†™å…¥åˆå§‹åŒ–æ•°æ®ã€‚\n1 2 3 4 5 6 7 8 9 10 11 @Before public void setup() { Path source = Paths.get(getClassPath(SOURCE_FILE)); byte[] bytes = CONTENT.getBytes(Charset.forName(CHARSET)); try (FileChannel fromChannel = FileChannel.open(source, StandardOpenOption.READ, StandardOpenOption.WRITE, StandardOpenOption.TRUNCATE_EXISTING)) { fromChannel.write(ByteBuffer.wrap(bytes)); } catch (IOException e) { e.printStackTrace(); } } å¯¹äºtransferTo()æ–¹æ³•è€Œè¨€ï¼Œç›®çš„é€šé“toChannelå¯ä»¥æ˜¯ä»»æ„çš„å•å‘å­—èŠ‚é€šé“WritableByteChannel;è€Œå¯¹äºtransferFrom()æ–¹æ³•è€Œè¨€ï¼Œæºé€šé“fromChannelå¯ä»¥æ˜¯ä»»æ„çš„å•é¡¹å­—èŠ‚è¯»é€šé“ReadableByteChannelã€‚å…¶ä¸­ï¼ŒFileChannelã€SocketChannelå’ŒDatagramChannelç­‰é€šé“å®ç°äº†WriteByteChannelå’ŒReadableByteChannelæ¥å£ï¼Œéƒ½æ˜¯åŒæ—¶æ”¯æŒè¯»å†™çš„åŒå‘é€šé“ã€‚ä¸ºäº†æ–¹ä¾¿æµ‹è¯•ï¼Œä¸‹é¢ç»™å‡ºåŸºäºFileChannelå®Œæˆchannel-to-channelçš„æ•°æ®ä¼ è¾“ç¤ºä¾‹:\n1 2 3 4 5 6 7 8 9 10 11 @Test public void transferTo() throws Exception { try (FileChannel fromChannel = new RandomAccessFile( getClassPath(SOURCE_FILE), \"rw\").getChannel(); FileChannel toChannel = new RandomAccessFile( getClassPath(TARGET_FILE), \"rw\").getChannel()) { long position = 0L; long offset = fromChannel.size(); fromChannel.transferTo(position, offset, toChannel); } } é€šè¿‡transferFrom()å°†fromChannelä¸­çš„æ•°æ®æ‹·è´åˆ°toChannel:\n1 2 3 4 5 6 7 8 9 10 11 @Test public void transferFrom() throws Exception { try (FileChannel fromChannel = new RandomAccessFile( getClassPath(SOURCE_FILE), \"rw\").getChannel(); FileChannel toChannel = new RandomAccessFile( getClassPath(TARGET_FILE), \"rw\").getChannel()) { long position = 0L; long offset = fromChannel.size(); toChannel.transferFrom(fromChannel, position, offset); } } ä¸‹é¢ä»‹ç»transferTo()å’ŒtransferFrom()æ–¹æ³•çš„åº•å±‚å®ç°åŸç†ï¼Œè¿™ä¸¤ä¸ªæ–¹æ³•ä¹Ÿæ˜¯java.nio.channels.FIlwChannelçš„æŠ½è±¡æ–¹æ³•ï¼Œç”±å­ç±»sun.nio.ch.FileChannelImpl.javaå®ç°ã€‚transferTo()å’ŒtransferFrom()åº•å±‚éƒ½æ˜¯åŸºäºsendfileå®ç°æ•°æ®ä¼ è¾“çš„ï¼Œå…¶ä¸­FileChannelImpl.javaå®šä¹‰äº†3ä¸ªå¸¸é‡ï¼Œç”¨äºæ ‡ç¤ºå½“å‰æ“ä½œç³»ç»Ÿçš„å†…æ ¸æ˜¯å¦æ”¯æŒsendfileä»¥åŠsendfileçš„ç›¸å…³ç‰¹æ€§ã€‚\n1 2 3 private static volatile boolean transferSupported = true; private static volatile boolean pipeSupported = true; private static volatile boolean fileSupported = true; transferSupported:ç”¨äºæ ‡è®°å½“å‰çš„ç³»ç»Ÿå†…æ ¸æ˜¯å¦æ”¯æŒsendfile()è°ƒç”¨ï¼Œé»˜è®¤ä¸ºtrue. pipeSupported: ç”¨äºæ ‡è®°å½“å‰çš„ç³»ç»Ÿå†…æ ¸æ˜¯å¦æ”¯æŒæ–‡ä»¶æè¿°ç¬¦åŸºäºç®¡é“çš„sendfile()è°ƒç”¨ï¼Œé»˜è®¤ä¸ºtrueã€‚ fileSupported: ç”¨äºæ ‡è®°å½“å‰çš„ç³»ç»Ÿå†…æ ¸æ˜¯å¦æ”¯æŒæ–‡ä»¶æè¿°ç¬¦åŸºäºæ–‡ä»¶çš„sendfile()è°ƒç”¨ï¼Œé»˜è®¤ä¸ºtrue. ä¸‹é¢ä»¥transfer()çš„æºç å®ç°ä¸ºä¾‹ã€‚FIleChannelImplé¦–å…ˆæ‰§è¡ŒtransferToDirectly()æ–¹æ³•ï¼Œä»¥sendfileçš„é›¶æ‹·è´æ–¹å¼æ•°æ®æ‹·è´ã€‚å¦‚æœç³»ç»Ÿå†…æ ¸ä¸æ”¯æŒsendfileï¼Œè¿›ä¸€æ­¥æ‰§è¡ŒtransferToTrustedChannel()æ–¹æ³•ï¼Œä»¥mmap()çš„é›¶æ‹·è´æ–¹å¼è¿›è¡Œå†…å­˜æ˜ å°„ï¼Œè¿™ç§æƒ…å†µä¸‹ç›®çš„é€šé“å¿…é¡»æ˜¯FileChannelImplæˆ–è€…SelChImplç±»å‹ã€‚å¦‚æœä»¥ä¸Šä¸¤æ­¥éƒ½å¤±è´¥äº†ï¼Œåˆ™æ‰§è¡ŒtransferToArbitraryChannel()æ–¹æ³•ï¼ŒåŸºäºä¼ ç»Ÿçš„I/Oæ–¹å¼å®Œæˆè¯»å†™ï¼Œå…·ä½“æ­¥éª¤æ˜¯åˆå§‹åŒ–ä¸€ä¸ªä¸´æ—¶çš„DirectBufferï¼Œå°†æºé€šé“FileChannelçš„æ•°æ®è¯»å–åˆ°DirectBufferï¼Œå†å†™å…¥ç›®çš„é€šé“WritableByteChannelé‡Œé¢ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 public long transferTo(long position, long count, WritableByteChannel target) throws IOException { // è®¡ç®—æ–‡ä»¶çš„å¤§å° long sz = size(); // æ ¡éªŒèµ·å§‹ä½ç½® if (position \u003e sz) return 0; int icount = (int)Math.min(count, Integer.MAX_VALUE); // æ ¡éªŒåç§»é‡ if ((sz - position) \u003c icount) icount = (int)(sz - position); long n; if ((n = transferToDirectly(position, icount, target)) \u003e= 0) return n; if ((n = transferToTrustedChannel(position, icount, target)) \u003e= 0) return n; return transferToArbitraryChannel(position, icount, target); } æ¥ä¸‹æ¥é‡ç‚¹åˆ†æä¸€ä¸‹transferToDirectly()æ–¹æ³•çš„å®ç°ï¼Œä¹Ÿå°±æ˜¯transferTo()é€šè¿‡sendfileå®ç°é›¶æ‹·è´çš„ç²¾é«“æ‰€åœ¨ã€‚å¯ä»¥çœ‹åˆ°ï¼ŒtransferToDirectlyInternal()æ–¹æ³•å…ˆè·å–åˆ°ç›®çš„çš„é€šé“WritableByteChannelçš„æ–‡ä»¶æè¿°ç¬¦targetFDï¼Œè·å–åŒæ­¥é”ç„¶åæ‰§è¡ŒtransferToDirectlyInternal()æ–¹æ³•ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 private long transferToDirectly(long position, int icount, WritableByteChannel target) throws IOException { // çœç•¥ä»targetè·å–targetFDçš„è¿‡ç¨‹ if (nd.transferToDirectlyNeedsPositionLock()) { synchronized (positionLock) { long pos = position(); try { return transferToDirectlyInternal(position, icount, target, targetFD); } finally { position(pos); } } } else { return transferToDirectlyInternal(position, icount, target, targetFD); } } æœ€ç»ˆç”±transferToDirectlyInternal()è°ƒç”¨æœ¬åœ°æ–¹æ³•transferTo0()ï¼Œå°è¯•ä»¥sendfileçš„æ–¹å¼è¿›è¡Œæ•°æ®ä¼ è¾“ã€‚å¦‚æœç³»ç»Ÿå†…æ ¸å®Œå…¨ä¸æ”¯æŒsendfileï¼Œæ¯”å¦‚Windowsæ“ä½œç³»ç»Ÿï¼Œåˆ™è¿”å›UNSUPPORTEDå¹¶æŠŠtransferSupportedæ ‡è¯†ä¸ºfalseã€‚å¦‚æœç³»ç»Ÿå†…æ ¸ä¸æ”¯æŒsendfileçš„ä¸€äº›ç‰¹æ€§ï¼Œæ¯”å¦‚è¯´ä½ç‰ˆæœ¬çš„Linuxå†…æ ¸ä¸æ”¯æŒDMA gather copy æ“ä½œï¼Œåˆ™è¿”å› UNSUPPORTED_CASE å¹¶æŠŠpipeSupported æˆ–è€… fileSupportedæ ‡è¯†ä¸ºfalseã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 private long transferToDirectlyInternal(long position, int icount, WritableByteChannel target, FileDescriptor targetFD) throws IOException { assert !nd.transferToDirectlyNeedsPositionLock() || Thread.holdsLock(positionLock); long n = -1; int ti = -1; try { begin(); ti = threads.add(); if (!isOpen()) return -1; do { n = transferTo0(fd, position, icount, targetFD); } while ((n == IOStatus.INTERRUPTED) \u0026\u0026 isOpen()); if (n == IOStatus.UNSUPPORTED_CASE) { if (target instanceof SinkChannelImpl) pipeSupported = false; if (target instanceof FileChannelImpl) fileSupported = false; return IOStatus.UNSUPPORTED_CASE; } if (n == IOStatus.UNSUPPORTED) { transferSupported = false; return IOStatus.UNSUPPORTED; } return IOStatus.normalize(n); } finally { threads.remove(ti); end (n \u003e -1); } } æœ¬åœ°æ–¹æ³•transferTo0()é€šè¿‡JNIè°ƒç”¨åº•å±‚Cçš„å‡½æ•°ï¼Œè¿™ä¸ªnativeå‡½æ•°åŒæ ·ä½äºJDKæºç åŒ…ä¸‹çš„ native.sun/nio/ch/FileChannelImol.cæºæ–‡ä»¶é‡Œé¢ã€‚JNIå‡½æ•°java_sun_nio_ch_FileChannelImpl_transferTo0()åŸºäºæ¡ä»¶ç¼–è¯‘å¯¹ä¸åŒçš„ç³»ç»Ÿè¿›è¡Œé¢„ç¼–è¯‘ï¼Œä¸‹é¢æ˜¯JDKåŸºäºLinuxç³»ç»Ÿå†…æ ¸å¯¹transferTo()æä¾›çš„è°ƒç”¨å°è£…ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 #if defined(__linux__) || defined(__solaris__) #include #elif defined(_AIX) #include #elif defined(_ALLBSD_SOURCE) #include #include #include #define lseek64 lseek #define mmap64 mmap #endif JNIEXPORT jlong JNICALL Java_sun_nio_ch_FileChannelImpl_transferTo0(JNIEnv *env, jobject this, jobject srcFDO, jlong position, jlong count, jobject dstFDO) { jint srcFD = fdval(env, srcFDO); jint dstFD = fdval(env, dstFDO); #if defined(__linux__) off64_t offset = (off64_t)position; jlong n = sendfile64(dstFD, srcFD, \u0026offset, (size_t)count); return n; #elif defined(__solaris__) result = sendfilev64(dstFD, \u0026sfv, 1, \u0026numBytes); return result; #elif defined(__APPLE__) result = sendfile(srcFD, dstFD, position, \u0026numBytes, NULL, 0); return result; #endif } å¯¹Linuxã€Solarisä»¥åŠAppleç³»ç»Ÿè€Œè¨€ï¼ŒtransferTo0()å‡½æ•°åº•å±‚ä¼šæ‰§è¡Œsendfile64è¿™ä¸ªç³»ç»Ÿè°ƒç”¨å®Œæˆé›¶æ‹·è´æ“ä½œï¼Œsendfile64()å‡½æ•°åŸå‹å¦‚ä¸‹:\n1 2 3 #include ssize_t sendfile64(int out_fd, int in_fd, off_t *offset, size_t count); ä¸‹é¢ç®€å•ä»‹ç»ä¸€ä¸‹sendfile64()å‡½æ•°å„ä¸ªå‚æ•°çš„å«ä¹‰:\nout_fd: å¾…å†™å…¥çš„æ–‡ä»¶æè¿°ç¬¦ in_fd: å¾…è¯»å–çš„æ–‡ä»¶æè¿°ç¬¦ offset: æŒ‡å®šin_fdå¯¹åº”æ–‡ä»¶æµçš„è¯»å–ä½ç½®ï¼Œå¦‚æœä¸ºç©ºï¼Œåˆ™é»˜è®¤ä»èµ·å§‹ä½ç½®å¼€å§‹ countï¼š æŒ‡å®šåœ¨æ–‡ä»¶æè¿°ç¬¦in_fdå’Œout_fdä¹‹é—´ä¼ è¾“çš„å­—èŠ‚æ•°",
  "wordCount" : "9600",
  "inLanguage": "zh",
  "datePublished": "2024-04-23T22:25:58+08:00",
  "dateModified": "2024-04-23T22:25:58+08:00",
  "author":[{
    "@type": "Person",
    "name": "ShengQian"
  }],
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://csqread.top/posts/tech/%E9%9B%B6%E6%8B%B7%E8%B4%9D%E5%AE%9E%E7%8E%B0/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "Qian's Blog",
    "logo": {
      "@type": "ImageObject",
      "url": "https://csqread.top/img/Q.gif"
    }
  }
}
</script>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="https://csqread.top" accesskey="h" title="Qian&#39;s Blog (Alt + H)">
                <img src="https://csqread.top/img/%21.jpg" alt="" aria-label="logo"
                    height="35">Qian&#39;s Blog</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="https://csqread.top/search" title="ğŸ”æœç´¢">
                    <span>ğŸ”æœç´¢</span>
                </a>
            </li>
            <li>
                <a href="https://csqread.top/" title="ğŸ ä¸»é¡µ">
                    <span>ğŸ ä¸»é¡µ</span>
                </a>
            </li>
            <li>
                <a href="https://csqread.top/posts" title="ğŸ“šæ–‡ç« ">
                    <span>ğŸ“šæ–‡ç« </span>
                </a>
            </li>
            <li>
                <a href="https://csqread.top/archives/" title="â±æ—¶é—´è½´">
                    <span>â±æ—¶é—´è½´</span>
                </a>
            </li>
            <li>
                <a href="https://csqread.top/tags" title="ğŸ”–æ ‡ç­¾">
                    <span>ğŸ”–æ ‡ç­¾</span>
                </a>
            </li>
            <li>
                <a href="https://csqread.top/about" title="ğŸ™‹ğŸ»â€â™‚ï¸å…³äº">
                    <span>ğŸ™‹ğŸ»â€â™‚ï¸å…³äº</span>
                </a>
            </li>
            <li>
                <a href="https://csqread.top/links" title="ğŸ¤å‹é“¾">
                    <span>ğŸ¤å‹é“¾</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    <div class="breadcrumbs"><a href="https://csqread.top">ä¸»é¡µ</a>&nbsp;Â»&nbsp;<a href="https://csqread.top/posts/">Posts</a>&nbsp;Â»&nbsp;<a href="https://csqread.top/posts/tech/">æŠ€æœ¯</a></div>
    <h1 class="post-title">
      é›¶æ‹·è´å®ç°
    </h1>
    <div class="post-meta">










åˆ›å»º:&nbsp;<span title='2024-04-23 22:25:58 +0800 CST'>2024-04-23</span>&nbsp;|&nbsp;æ›´æ–°:&nbsp;2024-04-23&nbsp;|&nbsp;å­—æ•°:&nbsp;9600å­—&nbsp;|&nbsp;æ—¶é•¿: 20åˆ†é’Ÿ&nbsp;|&nbsp;
ä½œè€…:&nbsp;ShengQian


    &nbsp;|&nbsp;æ ‡ç­¾: &nbsp;
    <ul class="post-tags-meta">
        <a href="https://csqread.top/tags/java/">Java</a>
    </ul>

    
    
    
    
    <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    <span id="busuanzi_container_page_pv">
        &nbsp;| è®¿é—®: <span id="busuanzi_value_page_pv"></span>
    </span>

    
    
    
    
    <script src="https://cdn.staticfile.org/twikoo/1.4.11/twikoo.all.min.js">
    </script>
    <script>
        let url = document.documentURI
        
        let dnsUrl = "https://csqread.top"
        let urlSplit = url.split(dnsUrl)
        let finalUrl = urlSplit[1]
        if (finalUrl[0] !== '/') {
            finalUrl = '/'+finalUrl
        }
        twikoo.getCommentsCount({
            envId:  null ,
            region:  null ,
            urls: [
                finalUrl,
            ],
            includeReply: false 
        }).then(function (res) {
            let count = res[0].count
            const obj = document.getElementById("comment_count");
            obj.innerText = count
            
            
            
        }).catch(function (err) {
            
            console.error(err);
        });
    </script>
    &nbsp;| è¯„è®º: &nbsp; <span id="comment_count"></span>

</div>
  </header> <aside id="toc-container" class="toc-container wide">
    <div class="toc">
        <details  open>
            <summary accesskey="c" title="(Alt + C)">
                <span class="details">ç›®å½•</span>
            </summary>

            <div class="inner"><ul>
                    <li>
                        <a href="#linux%e4%b8%ad%e7%9a%84%e9%9b%b6%e6%8b%b7%e8%b4%9d" aria-label="Linuxä¸­çš„é›¶æ‹·è´">Linuxä¸­çš„é›¶æ‹·è´</a><ul>
                            
                    <li>
                        <a href="#1-%e6%95%b0%e6%8d%ae%e6%8b%b7%e8%b4%9d%e5%9f%ba%e7%a1%80%e8%bf%87%e7%a8%8b" aria-label="1. æ•°æ®æ‹·è´åŸºç¡€è¿‡ç¨‹">1. æ•°æ®æ‹·è´åŸºç¡€è¿‡ç¨‹</a><ul>
                            
                    <li>
                        <a href="#11-%e4%bb%85cpu%e6%96%b9%e5%bc%8f" aria-label="1.1 ä»…CPUæ–¹å¼">1.1 ä»…CPUæ–¹å¼</a></li>
                    <li>
                        <a href="#12-cpudma%e6%96%b9%e5%bc%8f" aria-label="1.2 CPU&amp;amp;DMAæ–¹å¼">1.2 CPU&amp;DMAæ–¹å¼</a></li></ul>
                    </li>
                    <li>
                        <a href="#2-%e6%99%ae%e9%80%9a%e6%a8%a1%e5%bc%8f%e6%95%b0%e6%8d%ae%e4%ba%a4%e4%ba%92" aria-label="2. æ™®é€šæ¨¡å¼æ•°æ®äº¤äº’">2. æ™®é€šæ¨¡å¼æ•°æ®äº¤äº’</a></li>
                    <li>
                        <a href="#3-%e9%9b%b6%e6%8b%b7%e8%b4%9d%e6%8a%80%e6%9c%af" aria-label="3. é›¶æ‹·è´æŠ€æœ¯">3. é›¶æ‹·è´æŠ€æœ¯</a><ul>
                            
                    <li>
                        <a href="#31-%e5%87%ba%e7%8e%b0%e5%8e%9f%e5%9b%a0" aria-label="3.1 å‡ºç°åŸå› ">3.1 å‡ºç°åŸå› </a></li>
                    <li>
                        <a href="#32-%e8%a7%a3%e5%86%b3%e6%80%9d%e8%b7%af" aria-label="3.2 è§£å†³æ€è·¯">3.2 è§£å†³æ€è·¯</a><ul>
                            
                    <li>
                        <a href="#321-mmap%e6%96%b9%e5%bc%8f" aria-label="3.2.1 mmapæ–¹å¼">3.2.1 mmapæ–¹å¼</a></li>
                    <li>
                        <a href="#322-sendfile%e6%96%b9%e5%bc%8f" aria-label="3.2.2 sendfileæ–¹å¼">3.2.2 sendfileæ–¹å¼</a></li>
                    <li>
                        <a href="#323-sendfiledma%e6%94%b6%e9%9b%86" aria-label="3.2.3 sendfile&#43;DMAæ”¶é›†">3.2.3 sendfile+DMAæ”¶é›†</a></li>
                    <li>
                        <a href="#324-splice%e6%96%b9%e5%bc%8f" aria-label="3.2.4 spliceæ–¹å¼">3.2.4 spliceæ–¹å¼</a></li></ul>
                    </li></ul>
                    </li></ul>
                    </li>
                    <li>
                        <a href="#java-nio%e9%9b%b6%e6%8b%b7%e8%b4%9d" aria-label="JAVA NIOé›¶æ‹·è´">JAVA NIOé›¶æ‹·è´</a></li>
                    <li>
                        <a href="#mappedbytebuffer" aria-label="MAppedByteBuffer">MAppedByteBuffer</a></li>
                    <li>
                        <a href="#directbytebuffer" aria-label="DirectByteBuffer">DirectByteBuffer</a></li>
                    <li>
                        <a href="#filechannel" aria-label="FileChannel">FileChannel</a>
                    </li>
                </ul>
            </div>
        </details>
    </div>
</aside>
<script>
    let activeElement;
    let elements;
    window.addEventListener('DOMContentLoaded', function (event) {
        checkTocPosition();

        elements = document.querySelectorAll('h1[id],h2[id],h3[id],h4[id],h5[id],h6[id]');
         
         activeElement = elements[0];
         const id = encodeURI(activeElement.getAttribute('id')).toLowerCase();
         document.querySelector(`.inner ul li a[href="#${id}"]`).classList.add('active');
     }, false);

    window.addEventListener('resize', function(event) {
        checkTocPosition();
    }, false);

    window.addEventListener('scroll', () => {
        
        activeElement = Array.from(elements).find((element) => {
            if ((getOffsetTop(element) - window.pageYOffset) > 0 && 
                (getOffsetTop(element) - window.pageYOffset) < window.innerHeight/2) {
                return element;
            }
        }) || activeElement

        elements.forEach(element => {
             const id = encodeURI(element.getAttribute('id')).toLowerCase();
             if (element === activeElement){
                 document.querySelector(`.inner ul li a[href="#${id}"]`).classList.add('active');
             } else {
                 document.querySelector(`.inner ul li a[href="#${id}"]`).classList.remove('active');
             }
         })
     }, false);

    const main = parseInt(getComputedStyle(document.body).getPropertyValue('--article-width'), 10);
    const toc = parseInt(getComputedStyle(document.body).getPropertyValue('--toc-width'), 10);
    const gap = parseInt(getComputedStyle(document.body).getPropertyValue('--gap'), 10);

    function checkTocPosition() {
        const width = document.body.scrollWidth;

        if (width - main - (toc * 2) - (gap * 4) > 0) {
            document.getElementById("toc-container").classList.add("wide");
        } else {
            document.getElementById("toc-container").classList.remove("wide");
        }
    }

    function getOffsetTop(element) {
        if (!element.getClientRects().length) {
            return 0;
        }
        let rect = element.getBoundingClientRect();
        let win = element.ownerDocument.defaultView;
        return rect.top + win.pageYOffset;   
    }
</script>
  <div class="post-content"><h2 id="linuxä¸­çš„é›¶æ‹·è´">Linuxä¸­çš„é›¶æ‹·è´<a hidden class="anchor" aria-hidden="true" href="#linuxä¸­çš„é›¶æ‹·è´">#</a></h2>
<h3 id="1-æ•°æ®æ‹·è´åŸºç¡€è¿‡ç¨‹">1. æ•°æ®æ‹·è´åŸºç¡€è¿‡ç¨‹<a hidden class="anchor" aria-hidden="true" href="#1-æ•°æ®æ‹·è´åŸºç¡€è¿‡ç¨‹">#</a></h3>
<p>åœ¨Linuxç³»ç»Ÿå†…éƒ¨ç¼“å­˜å’Œå†…å­˜å®¹é‡éƒ½æ˜¯æœ‰é™çš„ï¼Œæ›´å¤šçš„æ•°æ®éƒ½æ˜¯å­˜å‚¨åœ¨ç£ç›˜ä¸­ã€‚å¯¹äºWebæœåŠ¡å™¨æ¥è¯´ï¼Œç»å¸¸éœ€è¦ä»ç£ç›˜ä¸­è¯»å–æ•°æ®çš„å†…å­˜ï¼Œç„¶åé€šè¿‡ç½‘å¡ä¼ è¾“ç»™ç”¨æˆ·</p>
<p><img loading="lazy" src="https://s2.loli.net/2024/04/21/wpAEhHmgOQLBnYf.png" alt="127449894-80a158a7-c372-4fef-9466-29aab372762a.png"  />
</p>
<h4 id="11-ä»…cpuæ–¹å¼">1.1 ä»…CPUæ–¹å¼<a hidden class="anchor" aria-hidden="true" href="#11-ä»…cpuæ–¹å¼">#</a></h4>
<li>å½“åº”ç”¨ç¨‹åºéœ€è¦è¯»å–ç£ç›˜æ•°æ®æ—¶ï¼Œè°ƒç”¨read()ä»ç”¨æˆ·æ€é™·å…¥å†…æ ¸æ€ï¼Œread()è¿™ä¸ªç³»ç»Ÿè°ƒç”¨æœ€ç»ˆç”±CPUæ¥å®Œæˆ</li>
<li>CPUå‘ç£ç›˜å‘èµ·I/Oè¯·æ±‚ï¼Œç£ç›˜æ”¶åˆ°ä¹‹åå¼€å§‹å‡†å¤‡æ•°æ®</li>
<li>ç£ç›˜å°†æ•°æ®æ”¾åˆ°ç£ç›˜ç¼“å†²åŒºä¹‹åï¼Œå‘CPUå‘èµ·I/Oä¸­æ–­ï¼Œå‘Šè¯‰CPUæ•°æ®å·²ç»readyäº†</li>
<li>CPUæ”¶åˆ°ç£ç›˜æ§åˆ¶å™¨çš„I/Oä¸­æ–­ä¹‹åï¼Œå¼€å§‹æ‹·è´æ•°æ®ï¼Œå®Œæˆä¹‹åread()è¿”å›ï¼Œå†ä»å†…æ ¸æ€åˆ‡æ¢åˆ°ç”¨æˆ·æ€</li>
<p><img loading="lazy" src="https://s2.loli.net/2024/04/21/RZdBEX65VgjiTCU.png" alt="127450013-8ab8b3b6-e17c-4a23-88bf-50ca3d1f37df.png"  />
</p>
<h4 id="12-cpudmaæ–¹å¼">1.2 CPU&amp;DMAæ–¹å¼<a hidden class="anchor" aria-hidden="true" href="#12-cpudmaæ–¹å¼">#</a></h4>
<p>CPUçš„æ—¶é—´å®è´µï¼Œè®©å®ƒåšæ‚æ´»å°±æ˜¯æµªè´¹èµ„æº</p>
<p>ç›´æ¥å†…å­˜è®¿é—®(Direct Memory Access)ï¼Œæ˜¯ä¸€ç§ç¡¬ä»¶è®¾å¤‡ç»•å¼€COUç‹¬ç«‹ç›´æ¥è®¿é—®å†…å­˜çš„æœºåˆ¶ã€‚æ‰€ä»¥DMAå†ä¸€å®šç¨‹åº¦ä¸Šè§£æ”¾äº†CPUï¼ŒæŠŠä¹‹å‰CPUçš„æ‚è´§è®©ç¡¬ä»¶ç›´æ¥è‡ªå·±åšäº†ï¼Œæé«˜äº†CPUæ•ˆç‡ã€‚</p>
<p>ç›®å‰æ”¯æŒDMAçš„ç¡¬ä»¶åŒ…æ‹¬:ç½‘å¡ã€å£°å¡ã€æ˜¾å¡ã€æ´—ç›˜æ§åˆ¶å™¨ç­‰ã€‚</p>
<p>æœ‰äº†DMAçš„å‚ä¸ä¹‹åçš„æµç¨‹å‘ç”Ÿäº†ä¸€äº›å˜åŒ–</p>
<p>æœ€ä¸»è¦çš„å˜åŒ–æ˜¯ï¼ŒCPUä¸å†å’Œç£ç›˜ç›´æ¥äº¤äº’ï¼Œè€Œæ˜¯DMAå’Œç£ç›˜äº¤äº’å¹¶ä¸”å°†æ•°æ®ä»ç£ç›˜ç¼“å†²åŒºæ‹·è´åˆ°å†…æ ¸ç¼“å†²åŒºï¼Œä¹‹åçš„è¿‡ç¨‹ç±»ä¼¼ã€‚</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>æ— è®ºä»ä»…CPUçš„æ–¹å¼å’ŒDMA&amp;CPUçš„æ–¹å¼ï¼Œéƒ½å­˜åœ¨å¤šæ¬¡å†—ä½™æ•°æ®æ‹·è´å’Œå†…æ ¸æ€&amp;ç”¨æˆ·æ€çš„åˆ‡æ¢ã€‚
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="2-æ™®é€šæ¨¡å¼æ•°æ®äº¤äº’">2. æ™®é€šæ¨¡å¼æ•°æ®äº¤äº’<a hidden class="anchor" aria-hidden="true" href="#2-æ™®é€šæ¨¡å¼æ•°æ®äº¤äº’">#</a></h3>
<p>ä¸€æ¬¡å®Œæˆçš„æ•°æ®äº¤äº’åŒ…æ‹¬å‡ ä¸ªéƒ¨åˆ†:ç³»ç»Ÿè°ƒç”¨syscallã€CPUã€DMAã€ç½‘å¡ã€ç£ç›˜ç­‰</p>
<p><img loading="lazy" src="https://s2.loli.net/2024/04/21/JqjFiTUvpfMCOeu.png" alt="127450145-ec9cca4a-3aeb-4f55-9f50-e33980f94602.png"  />
</p>
<p>ç³»ç»Ÿè°ƒç”¨syscallæ˜¯åº”ç”¨ç¨‹åºå’Œå†…æ ¸äº¤äº’çš„æ¡¥æ¢ï¼Œæ¯æ¬¡è¿›è¡Œè°ƒç”¨/è¿”å›å°±ä¼šäº§ç”Ÿä¸¤æ¬¡åˆ‡æ¢:</p>
<li>è°ƒç”¨syscallä»ç”¨æˆ·æ€åˆ‡æ¢åˆ°å†…æ ¸æ€</li>
<li>syscallè¿”å›ä»å†…æ ¸å°åˆ‡æ¢åˆ°ç”¨æˆ·æ€</li>
<p><img loading="lazy" src="https://s2.loli.net/2024/04/21/MciHAhs8JpVDFQR.png" alt="127450184-5a82e639-f93d-4159-8a22-072dfb13b014.png"  />
</p>
<p>ä¸‹å›¾æ˜¯å®Œæ•´çš„æ•°æ®æ‹·è´è¿‡ç¨‹ç®€å›¾:</p>
<p><img loading="lazy" src="https://s2.loli.net/2024/04/21/tTVsUPMc1G4hIFb.png" alt="127450210-cdb1cdf3-b4e9-47e3-b83d-8c6e39a44240.png"  />
</p>
<p><br>è¯»æ•°æ®è¿‡ç¨‹:</br></p>
<li>åº”ç”¨ç¨‹åºè¦è¯»å–ç£ç›˜æ•°æ®ï¼Œè°ƒç”¨read()å‡½æ•°ä»è€Œå®ç°ç”¨æˆ·æ€åˆ‡æ¢å†…æ ¸æ€ï¼Œè¿™æ˜¯ç¬¬ä¸€æ¬¡åˆ‡æ¢</li>
<li>DMAæ§åˆ¶å™¨å°†æ•°æ®ä»ç£ç›˜æ‹·è´åˆ°å†…æ ¸ç¼“å†²åŒºï¼Œè¿™æ˜¯ç¬¬ä¸€æ¬¡DMAæ‹·è´</li>
<li>CPUå°†æ•°æ®ä»å†…æ ¸ç¼“å†²åŒºå¤åˆ¶åˆ°ç”¨æˆ·ç¼“å†²åŒºï¼Œè¿™æ˜¯ç¬¬ä¸€æ¬¡CPUæ‹·è´</li>
<li>CPUæ‹·è´å®Œæˆä¹‹åï¼Œread()å‡½æ•°è¿”å›å®ç°å†…æ ¸æ€åˆ‡æ¢ç”¨æˆ·æ€ï¼Œè¿™æ˜¯ç¬¬2æ¬¡çŠ¶æ€åˆ‡æ¢</li>
<p><br>å†™æ•°æ®è¿‡ç¨‹:</br></p>
<li>åº”ç”¨ç¨‹åºè¦å‘ç½‘å¡å†™æ•°æ®ï¼Œè°ƒç”¨write()å‡½æ•°å®ç°ç”¨æˆ·æ€åˆ‡æ¢å†…æ ¸æ€ï¼Œè¿™æ˜¯ç¬¬ä¸€æ¬¡åˆ‡æ¢</li>
<li>CPUå°†ç”¨æˆ·ç¼“å†²åŒºæ•°æ®æ‹·è´åˆ°å†…æ ¸ç¼“å†²åŒºï¼Œè¿™æ˜¯ç¬¬ä¸€æ¬¡CPUæ‹·è´</li>
<li>DMAæ§åˆ¶å™¨å°†æ•°æ®ä»å†…æ ¸ç¼“å†²åŒºå¤åˆ¶åˆ°socketç¼“å†²åŒºï¼Œè¿™æ˜¯ç¬¬ä¸€æ¬¡DMAæ‹·è´</li>
<li>å®Œæˆæ‹·è´ä¹‹åï¼Œwrite()å‡½æ•°è¿”å›å®ç°å†…æ ¸æ€åˆ‡æ¢ç”¨æˆ·æ€ï¼Œè¿™æ˜¯ç¬¬äºŒæ¬¡åˆ‡æ¢</li>
<p><br>ç»¼ä¸Šæ‰€è¿°:</br></p>
<li>è¯»è¿‡ç¨‹æ¶‰åŠ2æ¬¡ç©ºé—´åˆ‡æ¢ã€1æ¬¡DMAæ‹·è´ã€1æ¬¡CPUæ‹·è´</li>
<li>å†™è¿‡ç¨‹æ¶‰åŠ2æ¬¡ç©ºé—´åˆ‡æ¢ï¼Œ1æ¬¡DMAæ‹·è´ï¼Œ1æ¬¡CPUæ‹·è´</li>
<p>å¯è§ä¼ ç»Ÿæ¨¡å¼ä¸‹ï¼Œæ¶‰åŠå¤šæ¬¡ç©ºé—´åˆ‡æ¢å’Œæ•°æ®å†—ä½™æ‹·è´ï¼Œæ•ˆç‡å¹¶ä¸é«˜ï¼Œæ¥ä¸‹æ¥å°±è¯¥é›¶æ‹·è´æŠ€æœ¯å‡ºåœºäº†ã€‚</p>
<h3 id="3-é›¶æ‹·è´æŠ€æœ¯">3. é›¶æ‹·è´æŠ€æœ¯<a hidden class="anchor" aria-hidden="true" href="#3-é›¶æ‹·è´æŠ€æœ¯">#</a></h3>
<h4 id="31-å‡ºç°åŸå› ">3.1 å‡ºç°åŸå› <a hidden class="anchor" aria-hidden="true" href="#31-å‡ºç°åŸå› ">#</a></h4>
<p>å¯ä»¥çœ‹åˆ°ï¼Œå¦‚æœåº”ç”¨ç¨‹åºè¯»å–ç£ç›˜æ•°æ®ï¼Œä»å†…æ ¸ç¼“å†²åŒºåˆ°ç”¨æˆ·ç¼“å†²åŒºï¼Œå†ä»ç”¨æˆ·ç¼“å†²åŒºåˆ°å†…æ ¸ç¼“å†²åŒºã€‚ä¸¤æ¬¡æ•°æ®æ‹·è´éƒ½éœ€è¦CPUçš„å‚ä¸ï¼Œå¹¶ä¸”æ¶‰åŠç”¨æˆ·æ€ä¸å†…æ ¸æ€çš„å¤šæ¬¡åˆ‡æ¢ï¼ŒåŠ é‡äº†CPUè´Ÿæ‹…ã€‚éœ€è¦é™ä½å†—ä½™æ•°æ®æ‹·è´ï¼Œè§£æ”¾CPUï¼Œè¿™å°±æ˜¯é›¶æ‹·è´æŠ€æœ¯ã€‚</p>
<h4 id="32-è§£å†³æ€è·¯">3.2 è§£å†³æ€è·¯<a hidden class="anchor" aria-hidden="true" href="#32-è§£å†³æ€è·¯">#</a></h4>
<p>ç›®å‰æ¥çœ‹ï¼Œé›¶æ‹·è´æŠ€æœ¯çš„å‡ ä¸ªå®ç°æ‰‹æ®µåŒ…æ‹¬: mmap+writeã€sendfileã€sendfile+DMAæ”¶é›†ã€spliceç­‰ã€‚</p>
<h5 id="321-mmapæ–¹å¼">3.2.1 mmapæ–¹å¼<a hidden class="anchor" aria-hidden="true" href="#321-mmapæ–¹å¼">#</a></h5>
<p>mmapæ˜¯Linuxæä¾›çš„ä¸€ç§å†…å­˜æ˜ å°„æ–‡ä»¶çš„æœºåˆ¶ï¼Œå®ƒå®ç°äº†å°†å†…æ ¸ä¸­è¯»ç¼“å†²åŒºåœ°å€ä¸ç”¨æˆ·ç©ºé—´ç¼“å†²åŒºåœ°å€è¿›è¡Œæ˜ å°„ï¼Œä»è€Œå®ç°å†…æ ¸ç¼“å†²åŒºä¸ç”¨æˆ·ç¼“å†²åŒºçš„å…±äº«ã€‚</p>
<p>è¿™æ ·å°±å‡å°‘äº†ä¸€æ¬¡ç”¨æˆ·æ€å’Œå†…æ ¸æ€çš„CPUæ‹·è´ï¼Œä½†æ˜¯åœ¨å†…æ ¸ç©ºé—´ä»æœ‰ä¸€æ¬¡CPUæ‹·è´</p>
<p>mmapå¯¹å¤§æ–‡ä»¶ä¼ è¾“æœ‰ä¸€å®šä¼˜åŠ¿ï¼Œä½†æ˜¯å°æ–‡ä»¶å¯èƒ½å‡ºç°ç¢ç‰‡ï¼Œå¹¶ä¸”åœ¨å¤šä¸ªè¿›ç¨‹åŒæ—¶æ“ä½œæ–‡ä»¶æ—¶å¯èƒ½äº§ç”Ÿcoredumpçš„signalã€‚</p>
<p><img loading="lazy" src="https://s2.loli.net/2024/04/21/QdJ9OZfyU5suobW.png" alt="127450469-dc43f9d9-44c5-490f-b70e-69a161bdd45a.png"  />
</p>
<h5 id="322-sendfileæ–¹å¼">3.2.2 sendfileæ–¹å¼<a hidden class="anchor" aria-hidden="true" href="#322-sendfileæ–¹å¼">#</a></h5>
<p>mmap+writeæ–¹å¼æœ‰ä¸€å®šæ”¹è¿›ï¼Œä½†æ˜¯ç”±ç³»ç»Ÿè°ƒç”¨å¼•èµ·çš„çŠ¶æ€åˆ‡æ¢å¹¶æ²¡æœ‰å‡å°‘ã€‚</p>
<p>sendfileç³»ç»Ÿè°ƒç”¨å®åœ¨Linuxå†…æ ¸2.1ç‰ˆæœ¬ä¸­è¢«å¼•å…¥ï¼Œå®ƒå»ºç«‹äº†ä¸¤ä¸ªæ–‡ä»¶ä¹‹é—´çš„ä¼ è¾“é€šé“ã€‚</p>
<p>sendfileæ–¹å¼åªä½¿ç”¨ä¸€ä¸ªå‡½æ•°å°±å¯ä»¥å®Œæˆä¹‹å‰çš„read+writeå’Œmmap+writeçš„åŠŸèƒ½ï¼Œè¿™æ ·å°±å‡å°‘äº†2æ¬¡çŠ¶æ€åˆ‡æ¢ï¼Œç”±äºæ•°æ®ä¸ç»è¿‡ç”¨æˆ·ç¼“å†²åŒºï¼Œå› æ­¤è¯¥æ•°æ®æ— æ³•è¢«ä¿®æ”¹</p>
<p><img loading="lazy" src="https://s2.loli.net/2024/04/21/mODIoP54kARy3TC.png" alt="127450545-0a62516f-b836-43b6-aa45-6e95d190f5ca.png"  />
</p>
<h5 id="323-sendfiledmaæ”¶é›†">3.2.3 sendfile+DMAæ”¶é›†<a hidden class="anchor" aria-hidden="true" href="#323-sendfiledmaæ”¶é›†">#</a></h5>
<p>Linux2.4å†…æ ¸å¯¹ sendfileç³»ç»Ÿè°ƒç”¨è¿›è¡Œä¼˜åŒ–ï¼Œä½†æ˜¯éœ€è¦ç¡¬ä»¶DMAæ§åˆ¶å™¨çš„é…åˆã€‚</p>
<p>å‡çº§ä¹‹åçš„sendfileå°†å†…æ ¸ç©ºé—´ç¼“å†²åŒºä¸­å¯¹åº”çš„æ•°æ®æè¿°ä¿¡æ¯è®°å½•åˆ°socketç¼“å†²åŒºä¸­ã€‚</p>
<p>DMAæ§åˆ¶å™¨æ ¹æ®socketç¼“å†²åŒºä¸­çš„åœ°å€å’Œåç§»é‡å°†æ•°æ®ä»å†…æ ¸ç¼“å†²åŒºæ‹·è´åˆ°ç½‘å¡ä¸­ï¼Œä»è€Œçœå»äº†å†…æ ¸ç©ºé—´ä¸­ä»…å‰©çš„ä¸€æ¬¡CPUæ‹·è´</p>
<p>è¿™ç§æ–¹å¼æœ‰2æ¬¡çŠ¶æ€åˆ‡æ¢ï¼Œ0æ¬¡CPUæ‹·è´ã€2æ¬¡DMAæ‹·è´ï¼Œä½†æ˜¯ä»ç„¶æ— æ³•å¯¹æ•°æ®è¿›è¡Œä¿®æ”¹ï¼Œå¹¶ä¸”éœ€è¦ç¡¬ä»¶å±‚é¢DMAçš„æ”¯æŒï¼Œå¹¶ä¸”sendfileåªèƒ½å°†æ–‡ä»¶çš„æ•°æ®æ‹·è´åˆ°socketæè¿°ç¬¦ä¸Šï¼Œæœ‰ä¸€å®šçš„å±€é™æ€§ã€‚</p>
<p><img loading="lazy" src="https://s2.loli.net/2024/04/21/58H7dP9oslzuYEy.png" alt="127450590-70ca2ef8-075a-4866-bf5b-c38049656d98.png"  />
</p>
<h5 id="324-spliceæ–¹å¼">3.2.4 spliceæ–¹å¼<a hidden class="anchor" aria-hidden="true" href="#324-spliceæ–¹å¼">#</a></h5>
<p>spliceç³»ç»Ÿè°ƒç”¨æ˜¯Linuxåœ¨2.6ç‰ˆæœ¬å¼•å…¥çš„ï¼Œå…¶ä¸éœ€è¦ç¡¬ä»¶æ”¯æŒï¼Œå¹¶ä¸”ä¸å†é™å®šäºsocketä¸Šï¼Œå®ç°ä¸¤ä¸ªæ™®é€šæ–‡ä»¶ä¹‹é—´çš„æ•°æ®é›¶æ‹·è´ã€‚</p>
<p><img loading="lazy" src="https://s2.loli.net/2024/04/21/u9jJXqtQFPOxk1V.png" alt="127450662-6316fa68-a493-42e2-9de1-b2857794142d.png"  />
</p>
<p>spliceç³»ç»Ÿè°ƒç”¨å¯ä»¥åœ¨å†…æ ¸ç¼“å†²åŒºå’Œsocketç¼“å†²åŒºä¹‹é—´å»ºç«‹ç®¡é“æ¥ä¼ è¾“æ•°æ®ï¼Œé¿å…äº†ä¸¤è€…ä¹‹é—´çš„CPUæ‹·è´æ“ä½œã€‚</p>
<h2 id="java-nioé›¶æ‹·è´">JAVA NIOé›¶æ‹·è´<a hidden class="anchor" aria-hidden="true" href="#java-nioé›¶æ‹·è´">#</a></h2>
<p>åœ¨Java NIOä¸­çš„<br>é€šé“å°±ç›¸å½“äºæ“ä½œç³»ç»Ÿçš„å†…æ ¸ç©ºé—´</br>çš„ç¼“å†²åŒºï¼Œè€Œç¼“å†²åŒºå¯¹åº”çš„ç›¸å½“äºæ“ä½œç³»ç»Ÿçš„ç”¨æˆ·ç©ºé—´ä¸­çš„ç”¨æˆ·ç¼“å†²åŒºã€‚</p>
<li>é€šé“æ˜¯å…¨åŒå·¥çš„(åŒå‘è¿è¾“)ï¼Œå®ƒæ—¢å¯èƒ½æ˜¯è¯»ç¼“å†²åŒºï¼Œä¹Ÿå¯èƒ½æ˜¯ç½‘ç»œç¼“å†²åŒº</li>
<li>ç¼“å†²åŒºåˆ†ä¸ºå †å†…å­˜å’Œå †å¤–å†…å­˜ï¼Œè¿™æ˜¯é€šè¿‡mallocåˆ†é…å‡ºæ¥çš„ç”¨æˆ·æ€å†…å­˜ã€‚</li>
<p>å †å¤–å†…å­˜åœ¨ä½¿ç”¨åéœ€è¦åº”ç”¨ç¨‹åºæ‰‹åŠ¨å›æ”¶ï¼Œè€Œå †å†…å­˜åœ¨æ•°æ®GCæ—¶å¯èƒ½è¢«è‡ªåŠ¨å›æ”¶ã€‚å› æ­¤ï¼Œåœ¨ä½¿ç”¨HeapBufferè¯»å†™æ•°æ®æ—¶ï¼Œä¸ºäº†é¿å…ç¼“å†²åŒºæ•°æ®å› ä¸ºGCä¸¢å¤±ï¼ŒNIOä¼šå…ˆæŠŠHeapBufferå†…éƒ¨çš„æ•°æ®æ‹·è´åˆ°ä¸€ä¸ªä¸´æ—¶çš„DirectBufferä¸­çš„æœ¬åœ°å†…å­˜ï¼Œè¿™ä¸ªæ‹·è´æ¶‰åŠåˆ°sun.misc.Usafe.copyMemory()çš„è°ƒç”¨ï¼ŒèƒŒåçš„å®ç°åŸç†äºmemcpy()ç±»ä¼¼ã€‚æœ€åï¼Œå°†ä¸´æ—¶ç”Ÿæˆçš„DirectBufferå†…éƒ¨çš„æ•°æ®çš„å†…å­˜åœ°å€ä¼ ç»™I/Oè°ƒç”¨å‡½æ•°ï¼Œè¿™æ ·å°±é¿å…äº†å†å»è®¿é—®Javaå¯¹è±¡å¤„ç†I/Oè¯»å†™ã€‚</p>
<h2 id="mappedbytebuffer">MAppedByteBuffer<a hidden class="anchor" aria-hidden="true" href="#mappedbytebuffer">#</a></h2>
<p>MappedBytyBufferæ˜¯NIOåŸºäº&quot;å†…å­˜æ˜ å°„(mmap)&ldquo;è¿™ç§é›¶æ‹·è´æ–¹å¼çš„æä¾›çš„ä¸€ç§å®ç°ï¼Œå®ƒç»§æ‰¿è‡ªByteBufferã€‚FileChannelå®šä¹‰äº†ä¸€ä¸ªmap()æ–¹æ³•ï¼Œå®ƒå¯ä»¥æŠŠä¸€ä¸ªæ–‡ä»¶ä»positionä½ç½®å¼€å§‹çš„sizeå¤§å°çš„åŒºåŸŸæ˜ å°„ä¸ºå†…å­˜æ˜ åƒæ–‡ä»¶ã€‚æŠ½è±¡æ–¹æ³•map()æ–¹æ³•åœ¨FileChannelä¸­çš„å®šä¹‰å¦‚ä¸‹:</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">abstract</span> MappedByteBuffer map(MapMode mode, <span style="color:#fff;font-weight:bold">long</span> position, <span style="color:#fff;font-weight:bold">long</span> size)
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">throws</span> IOException;
</span></span></code></pre></td></tr></table>
</div>
</div><li>mode:é™å®šå†…å­˜æ˜ å°„åŒºåŸŸå¯¹å†…å­˜æ˜ åƒæ–‡ä»¶çš„è®¿é—®æ¨¡å¼ï¼ŒåŒ…æ‹¬åªå¯è¯»ã€å¯è¯»å¯å†™å’Œå†™æ—¶æ‹·è´ä¸‰ç§æ¨¡å¼ã€‚</li>
<li>position: æ–‡ä»¶æ˜ å°„çš„èµ·å§‹åœ°å€ï¼Œå¯¹åº”å†…å­˜æ˜ å°„åŒºåŸŸçš„é¦–åœ°å€ã€‚</li>
<li>size: æ–‡ä»¶æ˜ å°„çš„å­—èŠ‚é•¿åº¦ï¼Œä»positionå¾€åçš„å­—èŠ‚æ•°ï¼Œå¯¹åº”å†…å­˜æ˜ å°„åŒºåŸŸçš„å¤§å°ã€‚</li>
<p>MappedByteBufferç›¸æ¯”ByteBufferæ–°å¢äº†fore()ã€load()å’ŒisLoad()ä¸‰ä¸ªé‡è¦æ–¹æ³•:</p>
<li>fore(): å¯¹äºå¤„äºREAD_WRITEæ¨¡å¼ä¸‹çš„ç¼“å†²åŒºï¼ŒæŠŠå¯¹ç¼“å†²åŒºå†…å®¹çš„ä¿®æ”¹å¼ºåˆ¶åˆ·æ–°åˆ°æœ¬åœ°æ–‡ä»¶ã€‚</li>
<li>load(): å°†ç¼“å†²åŒºçš„å†…å®¹è½½å…¥åˆ°ç‰©ç†å†…å­˜ä¸­ï¼Œå¹¶è¿”å›è¿™ä¸ªç¼“å†²åŒºçš„å¼•ç”¨</li>
<li>isLoad(): å¦‚æœç¼“å†²åŒºçš„å†…å®¹åœ¨ç‰©ç†å†…å­˜ä¸­ï¼Œåˆ™è¿”å›trueï¼Œå¦åˆ™è¿”å›falseã€‚</li>
<p>ä¸‹é¢ç»™å‡ºä¸€ä¸ªåˆ©ç”¨MappedByteBufferå¯¹æ–‡ä»¶è¿›è¡Œè¯»å†™çš„ä½¿ç”¨ç¤ºä¾‹:</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">private</span> <span style="color:#fff;font-weight:bold">final</span> <span style="color:#fff;font-weight:bold">static</span> String CONTENT = <span style="color:#0ff;font-weight:bold">&#34;Zero copy implemented by MappedByteBuffer&#34;</span>;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">private</span> <span style="color:#fff;font-weight:bold">final</span> <span style="color:#fff;font-weight:bold">static</span> String FILE_NAME = <span style="color:#0ff;font-weight:bold">&#34;/mmap.txt&#34;</span>;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">private</span> <span style="color:#fff;font-weight:bold">final</span> <span style="color:#fff;font-weight:bold">static</span> String CHARSET = <span style="color:#0ff;font-weight:bold">&#34;UTF-8&#34;</span>;
</span></span></code></pre></td></tr></table>
</div>
</div><li>å†™æ–‡ä»¶æ•°æ®:æ‰“å¼€æ–‡ä»¶é€šé“fileChannelå¹¶æä¾›è¯»æƒé™ã€å†™æƒé™å’Œæ•°æ®æ¸…ç©ºæƒé™ï¼Œé€šè¿‡fileChannelæ˜ å°„åˆ°ä¸€ä¸ªå¯å†™çš„å†…å­˜ç¼“å†²åŒºmappedByteBUfferï¼Œå°†ç›®æ ‡æ•°æ®å†™å…¥mappedByteBufferï¼Œé€šè¿‡force()æ–¹æ³•æŠŠç¼“å†²åŒºæ›´æ”¹çš„å†…å®¹å¼ºåˆ¶å†™å…¥æœ¬åœ°æ–‡ä»¶</li>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>@Test
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">void</span> writeToFileByMappedByteBuffer() {
</span></span><span style="display:flex;"><span>    Path path = Paths.<span style="color:#007f7f">get</span>(getClass().<span style="color:#007f7f">getResource</span>(FILE_NAME).<span style="color:#007f7f">getPath</span>());
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">byte</span>[] bytes = CONTENT.<span style="color:#007f7f">getBytes</span>(Charset.<span style="color:#007f7f">forName</span>(CHARSET));
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">try</span> (FileChannel fileChannel = FileChannel.<span style="color:#007f7f">open</span>(path, StandardOpenOption.<span style="color:#007f7f">READ</span>,
</span></span><span style="display:flex;"><span>            StandardOpenOption.<span style="color:#007f7f">WRITE</span>, StandardOpenOption.<span style="color:#007f7f">TRUNCATE_EXISTING</span>)) {
</span></span><span style="display:flex;"><span>        MappedByteBuffer mappedByteBuffer = fileChannel.<span style="color:#007f7f">map</span>(READ_WRITE, <span style="color:#ff0;font-weight:bold">0</span>, bytes.<span style="color:#007f7f">length</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">if</span> (mappedByteBuffer != <span style="color:#fff;font-weight:bold">null</span>) {
</span></span><span style="display:flex;"><span>            mappedByteBuffer.<span style="color:#007f7f">put</span>(bytes);
</span></span><span style="display:flex;"><span>            mappedByteBuffer.<span style="color:#007f7f">force</span>();
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    } <span style="color:#fff;font-weight:bold">catch</span> (IOException e) {
</span></span><span style="display:flex;"><span>        e.<span style="color:#007f7f">printStackTrace</span>();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><li>è¯»æ–‡ä»¶æ•°æ®:æ‰“å¼€æ–‡ä»¶é€šé“fileChannelå¹¶æä¾›åªè¯»æƒé™ï¼Œé€šè¿‡fileChannelæ˜ å°„åˆ°ä¸€ä¸ªåªå¯è¯»çš„å†…å­˜ç¼“å†²åŒºmappedByteBufferï¼Œè¯»å–mappedByteBufferä¸­çš„å­—èŠ‚æ•°ç»„å³å¯å¾—åˆ°æ–‡ä»¶æ•°æ®ã€‚</li>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>@Test
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">void</span> readFromFileByMappedByteBuffer() {
</span></span><span style="display:flex;"><span>    Path path = Paths.<span style="color:#007f7f">get</span>(getClass().<span style="color:#007f7f">getResource</span>(FILE_NAME).<span style="color:#007f7f">getPath</span>());
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">int</span> length = CONTENT.<span style="color:#007f7f">getBytes</span>(Charset.<span style="color:#007f7f">forName</span>(CHARSET)).<span style="color:#007f7f">length</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">try</span> (FileChannel fileChannel = FileChannel.<span style="color:#007f7f">open</span>(path, StandardOpenOption.<span style="color:#007f7f">READ</span>)) {
</span></span><span style="display:flex;"><span>        MappedByteBuffer mappedByteBuffer = fileChannel.<span style="color:#007f7f">map</span>(READ_ONLY, <span style="color:#ff0;font-weight:bold">0</span>, length);
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">if</span> (mappedByteBuffer != <span style="color:#fff;font-weight:bold">null</span>) {
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">byte</span>[] bytes = <span style="color:#fff;font-weight:bold">new</span> <span style="color:#fff;font-weight:bold">byte</span>[length];
</span></span><span style="display:flex;"><span>            mappedByteBuffer.<span style="color:#007f7f">get</span>(bytes);
</span></span><span style="display:flex;"><span>            String content = <span style="color:#fff;font-weight:bold">new</span> String(bytes, StandardCharsets.<span style="color:#007f7f">UTF_8</span>);
</span></span><span style="display:flex;"><span>            assertEquals(content, <span style="color:#0ff;font-weight:bold">&#34;Zero copy implemented by MappedByteBuffer&#34;</span>);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    } <span style="color:#fff;font-weight:bold">catch</span> (IOException e) {
</span></span><span style="display:flex;"><span>        e.<span style="color:#007f7f">printStackTrace</span>();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>ä¸‹é¢ä»‹ç»map()æ–¹æ³•çš„åº•å±‚å®ç°åŸç†ã€‚map()æ–¹æ³•æ˜¯java.nio.channels.FileChannelçš„æŠ½è±¡æ–¹æ³•ï¼Œç”±å­ç±»sun.nio.ch.FIleChannelImpl.javaå®ç°ï¼Œä¸‹é¢æ˜¯å’Œå†…å­˜æ˜ å°„ç›¸å…³çš„æ ¸å¿ƒä»£ç :</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">27
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">28
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> MappedByteBuffer map(MapMode mode, <span style="color:#fff;font-weight:bold">long</span> position, <span style="color:#fff;font-weight:bold">long</span> size) <span style="color:#fff;font-weight:bold">throws</span> IOException {
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">int</span> pagePosition = (<span style="color:#fff;font-weight:bold">int</span>)(position % allocationGranularity);
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">long</span> mapPosition = position - pagePosition;
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">long</span> mapSize = size + pagePosition;
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">try</span> {
</span></span><span style="display:flex;"><span>        addr = map0(imode, mapPosition, mapSize);
</span></span><span style="display:flex;"><span>    } <span style="color:#fff;font-weight:bold">catch</span> (OutOfMemoryError x) {
</span></span><span style="display:flex;"><span>        System.<span style="color:#007f7f">gc</span>();
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">try</span> {
</span></span><span style="display:flex;"><span>            Thread.<span style="color:#007f7f">sleep</span>(<span style="color:#ff0;font-weight:bold">100</span>);
</span></span><span style="display:flex;"><span>        } <span style="color:#fff;font-weight:bold">catch</span> (InterruptedException y) {
</span></span><span style="display:flex;"><span>            Thread.<span style="color:#007f7f">currentThread</span>().<span style="color:#007f7f">interrupt</span>();
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">try</span> {
</span></span><span style="display:flex;"><span>            addr = map0(imode, mapPosition, mapSize);
</span></span><span style="display:flex;"><span>        } <span style="color:#fff;font-weight:bold">catch</span> (OutOfMemoryError y) {
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">throw</span> <span style="color:#fff;font-weight:bold">new</span> IOException(<span style="color:#0ff;font-weight:bold">&#34;Map failed&#34;</span>, y);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">int</span> isize = (<span style="color:#fff;font-weight:bold">int</span>)size;
</span></span><span style="display:flex;"><span>    Unmapper um = <span style="color:#fff;font-weight:bold">new</span> Unmapper(addr, mapSize, isize, mfd);
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">if</span> ((!writable) || (imode == MAP_RO)) {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> Util.<span style="color:#007f7f">newMappedByteBufferR</span>(isize, addr + pagePosition, mfd, um);
</span></span><span style="display:flex;"><span>    } <span style="color:#fff;font-weight:bold">else</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> Util.<span style="color:#007f7f">newMappedByteBuffer</span>(isize, addr + pagePosition, mfd, um);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>map()æ–¹æ³•é€šè¿‡æœ¬åœ°æ–¹æ³•map0()ä¸ºæ–‡ä»¶åˆ†é…ä¸€å—è™šæ‹Ÿå†…å­˜ï¼Œä½œä¸ºå®ƒçš„å†…å­˜æ˜ å°„åŒºåŸŸï¼Œç„¶åè¿”å›è¿™å—å†…å­˜æ˜ å°„åŒºåŸŸçš„èµ·å§‹åœ°å€ã€‚</p>
<li>æ–‡ä»¶æ˜ å°„éœ€è¦åœ¨Javaå †ä¸­åˆ›å»ºä¸€ä¸ªMappedByteBufferçš„å®ä¾‹ã€‚å¦‚æœç¬¬ä¸€æ¬¡æ–‡ä»¶æ˜ å°„å¯¼è‡´OOMï¼Œåˆ™æ‰‹åŠ¨è§¦å‘åƒåœ¾å›æ”¶ï¼Œä¼‘çœ 100msåå†æ¬¡å°è¯•æ˜ å°„ï¼Œå¦‚æœå¤±è´¥åˆ™æŠ›å‡ºå¼‚å¸¸ã€‚</li>
<li>é€šè¿‡Utilçš„newMappedByteBUfferæ–¹æ³•æˆ–è€…newMappedByteBufferRæ–¹æ³•åå°„åˆ›å»ºä¸€ä¸ªDirectByteBufferå®ä¾‹ï¼Œå…¶ä¸­DirectByteBufferæ˜¯MappedByteBUfferçš„å­ç±»ã€‚</li>
<p>map()æ–¹æ³•è¿”å›çš„æ˜¯å†…å­˜æ˜ å°„åŒºåŸŸçš„èµ·å§‹åœ°å€ï¼Œé€šè¿‡(èµ·å§‹åœ°å€+åç§»é‡)å°±å¯ä»¥è·å–æŒ‡å®šå†…å­˜çš„æ•°æ®ã€‚è¿™æ ·ä¸€å®šç¨‹åº¦ä¸Šæ›¿ä»£äº†readæˆ–write()æ–¹æ³•ï¼Œåº•å±‚ç›´æ¥é‡‡ç”¨sun.misc.Unsafeç±»çš„getByte()å’ŒputByte()æ–¹æ³•å¯¹æ•°æ®è¿›è¡Œè¯»å†™ã€‚</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">private</span> <span style="color:#fff;font-weight:bold">native</span> <span style="color:#fff;font-weight:bold">long</span> map0(<span style="color:#fff;font-weight:bold">int</span> prot, <span style="color:#fff;font-weight:bold">long</span> position, <span style="color:#fff;font-weight:bold">long</span> mapSize) <span style="color:#fff;font-weight:bold">throws</span> IOException;
</span></span></code></pre></td></tr></table>
</div>
</div><p>ä¸Šé¢æ˜¯æœ¬åœ°æ–¹æ³•map0çš„å®šä¹‰ï¼Œå®ƒé€šè¿‡JNIè°ƒç”¨åº•å±‚Cçš„å®ç°ï¼Œè¿™ä¸ªnativeå‡½æ•°çš„å®ç°ä½äºJDKæºç åŒ…ä¸‹ã€‚
native/sun/nio/ch/FileChannelImpl.cè¿™ä¸ªæºæ–‡ä»¶é‡Œ</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">27
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">28
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">29
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">30
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">31
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">32
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">33
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">34
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">35
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">36
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">37
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">38
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">39
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>JNIEXPORT jlong JNICALL
</span></span><span style="display:flex;"><span>Java_sun_nio_ch_FileChannelImpl_map0(JNIEnv *env, jobject this,
</span></span><span style="display:flex;"><span>                                     jint prot, jlong off, jlong len)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">void</span> *mapAddress = <span style="color:#ff0;font-weight:bold">0</span>;
</span></span><span style="display:flex;"><span>    jobject fdo = (*env)-&gt;GetObjectField(env, this, chan_fd);
</span></span><span style="display:flex;"><span>    jint fd = fdval(env, fdo);
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">int</span> protections = <span style="color:#ff0;font-weight:bold">0</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">int</span> flags = <span style="color:#ff0;font-weight:bold">0</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">if</span> (prot == sun_nio_ch_FileChannelImpl_MAP_RO) {
</span></span><span style="display:flex;"><span>        protections = PROT_READ;
</span></span><span style="display:flex;"><span>        flags = MAP_SHARED;
</span></span><span style="display:flex;"><span>    } <span style="color:#fff;font-weight:bold">else</span> <span style="color:#fff;font-weight:bold">if</span> (prot == sun_nio_ch_FileChannelImpl_MAP_RW) {
</span></span><span style="display:flex;"><span>        protections = PROT_WRITE | PROT_READ;
</span></span><span style="display:flex;"><span>        flags = MAP_SHARED;
</span></span><span style="display:flex;"><span>    } <span style="color:#fff;font-weight:bold">else</span> <span style="color:#fff;font-weight:bold">if</span> (prot == sun_nio_ch_FileChannelImpl_MAP_PV) {
</span></span><span style="display:flex;"><span>        protections =  PROT_WRITE | PROT_READ;
</span></span><span style="display:flex;"><span>        flags = MAP_PRIVATE;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    mapAddress = mmap64(
</span></span><span style="display:flex;"><span>        <span style="color:#ff0;font-weight:bold">0</span>,                    <span style="color:#007f7f">/* Let OS decide location */</span>
</span></span><span style="display:flex;"><span>        len,                  <span style="color:#007f7f">/* Number of bytes to map */</span>
</span></span><span style="display:flex;"><span>        protections,          <span style="color:#007f7f">/* File permissions */</span>
</span></span><span style="display:flex;"><span>        flags,                <span style="color:#007f7f">/* Changes are shared */</span>
</span></span><span style="display:flex;"><span>        fd,                   <span style="color:#007f7f">/* File descriptor of mapped file */</span>
</span></span><span style="display:flex;"><span>        off);                 <span style="color:#007f7f">/* Offset into file */</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">if</span> (mapAddress == MAP_FAILED) {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">if</span> (errno == ENOMEM) {
</span></span><span style="display:flex;"><span>            JNU_ThrowOutOfMemoryError(env, <span style="color:#0ff;font-weight:bold">&#34;Map failed&#34;</span>);
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">return</span> IOS_THROWN;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> handle(env, -<span style="color:#ff0;font-weight:bold">1</span>, <span style="color:#0ff;font-weight:bold">&#34;Map failed&#34;</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">return</span> ((jlong) (<span style="color:#fff;font-weight:bold">unsigned</span> <span style="color:#fff;font-weight:bold">long</span>) mapAddress);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>å¯ä»¥çœ‹å‡ºmap0()å‡½æ•°æœ€ç»ˆæ˜¯é€šè¿‡mmap65()è¿™ä¸ªå‡½æ•°å¯¹Linuxåº•å±‚å†…æ ¸å‘å‡ºçš„å†…å­˜æ˜ å°„è°ƒç”¨ï¼Œmmap64()å‡½æ•°çš„åŸå‹å¦‚ä¸‹:</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#0f0;font-weight:bold">#include</span> <span style="color:#0f0;font-weight:bold">&lt;sys/mman.h&gt;</span><span style="color:#0f0;font-weight:bold">
</span></span></span><span style="display:flex;"><span><span style="color:#0f0;font-weight:bold"></span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">void</span> *mmap64(<span style="color:#fff;font-weight:bold">void</span> *addr, <span style="color:#fff;font-weight:bold">size_t</span> len, <span style="color:#fff;font-weight:bold">int</span> prot, <span style="color:#fff;font-weight:bold">int</span> flags, <span style="color:#fff;font-weight:bold">int</span> fd, <span style="color:#fff;font-weight:bold">off64_t</span> offset);
</span></span></code></pre></td></tr></table>
</div>
</div><p>ä¸‹é¢è¯¦ç»†ä»‹ç»ä»¥ä¸‹mmap64()å‡½æ•°å„ä¸ªå‚æ•°çš„å«ä¹‰ä»¥åŠå‚æ•°å¯é€‰å€¼:</p>
<li>addr: æ–‡ä»¶åœ¨ç”¨æˆ·è¿›ç¨‹ç©ºé—´çš„å†…å­˜æ˜ å°„åŒºä¸­çš„èµ·å§‹åœ°å€ï¼Œæ˜¯ä¸€ä¸ªå»ºè®®çš„å‚æ•°ï¼Œé€šå¸¸å¯è®¾ç½®ä¸º0æˆ–nullï¼Œæ­¤æ—¶ç”±å†…æ ¸å»å†³å®šçœŸå®çš„èµ·å§‹åœ°å€ã€‚å½“+flagä¸ºMAP_FIXEDæ—¶ï¼Œaddrå°±æ˜¯ä¸€ä¸ªå¿…é€‰çš„å‚æ•°ï¼Œå³éœ€è¦æä¾›ä¸€ä¸ªå­˜åœ¨çš„åœ°å€ã€‚</li>
<li>len:æ–‡ä»¶éœ€è¦è¿›è¡Œå†…å­˜æ˜ å°„çš„é•¿åº¦</li>
<li>prot:æ§åˆ¶ç”¨æˆ·è¿›ç¨‹å¯¹å†…å­˜æ˜ å°„åŒºçš„è®¿é—®æƒé™ã€‚</li>
<ol>
<li>PROT_READ: è¯»æƒé™</li>
<li>PROT_WRITE: å†™æƒé™</li>
<li>PROT_EXEC: æ‰§è¡Œæƒé™</li>
<li>PROT_NONE: æ— æƒé™</li>
</ol>
<li>flags: æ§åˆ¶å†…å­˜æ˜ å°„åŒºçš„ä¿®æ”¹æ˜¯å¦è¢«å¤šä¸ªè¿›ç¨‹å…±äº«</li>
<ol>
<li>MAP_PRIVATE: å¯¹å†…å­˜æ˜ å°„åŒºæ•°æ®çš„ä¿®æ”¹ä¸ä¼šåæ˜ åˆ°çœŸæ­£çš„æ–‡ä»¶ï¼Œæ•°æ®ä¿®æ”¹å‘ç”Ÿæ—¶é‡‡ç”¨å†™æ—¶å¤åˆ¶æœºåˆ¶ã€‚</li>
<li>MAP_SHARED: å¯¹å†…å­˜æ˜ å°„åŒºçš„ä¿®æ”¹ä¼šåŒæ­¥åˆ°çœŸæ­£çš„æ–‡ä»¶ï¼Œä¿®æ”¹å¯¹å…±äº«æ­¤å†…å­˜æ˜ å°„åŒºçš„è¿›ç¨‹æ˜¯å¯è§çš„ã€‚</li>
<li>MAP_FIXED: ä¸å»ºè®®ä½¿ç”¨ï¼Œè¿™ç§æ¨¡å¼ä¸‹addrå‚æ•°æŒ‡å®šçš„å¿…é¡»çš„æä¾›ä¸€ä¸ªå­˜åœ¨çš„addrå‚æ•°ã€‚</li>
</ol>
<li>fd: æ–‡ä»¶æè¿°ç¬¦ã€‚æ¯æ¬¡Mapæ“ä½œä¼šå¯¼è‡´æ–‡ä»¶çš„å¼•ç”¨è®¡æ•°åŠ 1ï¼Œæ¯æ¬¡unmapæ“ä½œæˆ–è€…ç»“æŸè¿›ç¨‹ä¼šå¯¼è‡´å¼•ç”¨è®¡æ•°å‡1</li>
<li>offset: æ–‡ä»¶åç§»é‡ã€‚è¿›è¡Œæ˜ å°„çš„æ–‡ä»¶ä½ç½®ï¼Œä»æ–‡ä»¶èµ·å§‹åœ°å€å‘åçš„ä½ç§»é‡</li>
<p>ä¸‹é¢æ€»ç»“ä¸€ä¸‹MappedByteBufferçš„ç‰¹ç‚¹å’Œä¸è¶³ä¹‹å¤„:</p>
<li>MappedByteBufferä½¿ç”¨æ˜¯å †å¤–çš„è™šæ‹Ÿå†…å­˜ï¼Œå› æ­¤åˆ†é…çš„å†…å­˜å¤§å°ä¸å—JVMçš„-Xmxå‚æ•°é™åˆ¶ï¼Œä½†æ˜¯ä¹Ÿæ˜¯æœ‰å¤§å°é™åˆ¶çš„ã€‚å¦‚æœå½“æ–‡ä»¶è¶…å‡ºInteger.MAX_VALUEå­—èŠ‚é™åˆ¶æ—¶ï¼Œå¯ä»¥é€šè¿‡positionå‚æ•°é‡æ–°mapæ–‡ä»¶åé¢çš„å†…å®¹ã€‚</li>
<li>MappedByteBufferåœ¨å¤„ç†å¤§æ–‡ä»¶æ—¶æ€§èƒ½çš„ç¡®å¾ˆé«˜ï¼Œä½†æ˜¯ä¹Ÿå­˜åœ¨å†…å­˜å ç”¨ï¼Œæ–‡ä»¶å…³é—­ä¸ç¡®å®šç­‰é—®é¢˜ï¼Œè¢«å…¶æ‰“å¼€çš„æ–‡ä»¶åªæœ‰åœ¨åƒåœ¾å›æ”¶çš„æ—¶å€™æ‰ä¼šè¢«å…³é—­ï¼Œè€Œä¸”è¿™ä¸ªæ—¶é—´ç‚¹æ˜¯ä¸ç¡®å®šçš„ã€‚</li>
<li>MappedByteBufferæä¾›äº†æ–‡ä»¶æ˜ å°„å†…å­˜çš„mmap()æ–¹æ³•ï¼Œä¹Ÿæä¾›äº†é‡Šæ”¾æ˜ å°„å†…å­˜çš„unmap()æ–¹æ³•ã€‚ç„¶è€Œunmap()æ˜¯FileChannelImplä¸­çš„ç§æœ‰æ–¹æ³•ï¼Œæ— æ³•ç›´æ¥æ˜¾ç¤ºè°ƒç”¨ã€‚å› æ­¤ï¼Œç”¨æˆ·ç¨‹åºéœ€è¦é€šè¿‡Javaåå°„çš„è°ƒç”¨sun.misc.Cleanerç±»çš„clean()æ–¹æ³•æ‰‹åŠ¨é‡Šæ”¾æ˜ å°„å ç”¨çš„å†…å­˜åŒºåŸŸã€‚</li>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">static</span> <span style="color:#fff;font-weight:bold">void</span> clean(<span style="color:#fff;font-weight:bold">final</span> Object buffer) <span style="color:#fff;font-weight:bold">throws</span> Exception {
</span></span><span style="display:flex;"><span>    AccessController.<span style="color:#007f7f">doPrivileged</span>((PrivilegedAction&lt;Void&gt;) () -&gt; {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">try</span> {
</span></span><span style="display:flex;"><span>            Method getCleanerMethod = buffer.<span style="color:#007f7f">getClass</span>().<span style="color:#007f7f">getMethod</span>(<span style="color:#0ff;font-weight:bold">&#34;cleaner&#34;</span>, <span style="color:#fff;font-weight:bold">new</span> Class[<span style="color:#ff0;font-weight:bold">0</span>]);
</span></span><span style="display:flex;"><span>            getCleanerMethod.<span style="color:#007f7f">setAccessible</span>(<span style="color:#fff;font-weight:bold">true</span>);
</span></span><span style="display:flex;"><span>            Cleaner cleaner = (Cleaner) getCleanerMethod.<span style="color:#007f7f">invoke</span>(buffer, <span style="color:#fff;font-weight:bold">new</span> Object[<span style="color:#ff0;font-weight:bold">0</span>]);
</span></span><span style="display:flex;"><span>            cleaner.<span style="color:#007f7f">clean</span>();
</span></span><span style="display:flex;"><span>        } <span style="color:#fff;font-weight:bold">catch</span>(Exception e) {
</span></span><span style="display:flex;"><span>            e.<span style="color:#007f7f">printStackTrace</span>();
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    });
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="directbytebuffer">DirectByteBuffer<a hidden class="anchor" aria-hidden="true" href="#directbytebuffer">#</a></h2>
<p>DirectByteBUffer çš„å¯¹è±¡å¼•ç”¨ä½äºJava å†…å­˜æ¨¡å‹çš„å †é‡Œé¢ï¼ŒJVMå¯ä»¥å¯¹DirectByteBUfferçš„å¯¹è±¡è¿›è¡Œå†…å­˜åˆ†é…å’Œå›æ”¶ç®¡ç†ï¼Œä¸€èˆ¬ä½¿ç”¨DirectByteBufferçš„é™æ€æ–¹æ³•allocateDirect()åˆ›å»ºDIrectByteBufferå®ä¾‹å¹¶åˆ†é…å†…å­˜ã€‚</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">static</span> ByteBuffer allocateDirect(<span style="color:#fff;font-weight:bold">int</span> capacity) {
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">return</span> <span style="color:#fff;font-weight:bold">new</span> DirectByteBuffer(capacity);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>DirectByteBUfferå†…éƒ¨çš„å­—èŠ‚ç¼“å†²åŒºä½åœ¨äºå †å¤–çš„ç›´æ¥å†…å­˜ï¼Œå®ƒæ˜¯é€šè¿‡Unsafeçš„æœ¬åœ°æ–¹æ³•allocateMemory()è¿›è¡Œå†…å­˜åˆ†é…ï¼Œåº•å±‚è°ƒç”¨çš„æ˜¯æ“ä½œç³»ç»Ÿçš„malloc()å‡½æ•°ã€‚</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>DirectByteBuffer(<span style="color:#fff;font-weight:bold">int</span> cap) {
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">super</span>(-<span style="color:#ff0;font-weight:bold">1</span>, <span style="color:#ff0;font-weight:bold">0</span>, cap, cap);
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">boolean</span> pa = VM.<span style="color:#007f7f">isDirectMemoryPageAligned</span>();
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">int</span> ps = Bits.<span style="color:#007f7f">pageSize</span>();
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">long</span> size = Math.<span style="color:#007f7f">max</span>(<span style="color:#ff0;font-weight:bold">1L</span>, (<span style="color:#fff;font-weight:bold">long</span>)cap + (pa ? ps : <span style="color:#ff0;font-weight:bold">0</span>));
</span></span><span style="display:flex;"><span>    Bits.<span style="color:#007f7f">reserveMemory</span>(size, cap);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">long</span> base = <span style="color:#ff0;font-weight:bold">0</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">try</span> {
</span></span><span style="display:flex;"><span>        base = unsafe.<span style="color:#007f7f">allocateMemory</span>(size);
</span></span><span style="display:flex;"><span>    } <span style="color:#fff;font-weight:bold">catch</span> (OutOfMemoryError x) {
</span></span><span style="display:flex;"><span>        Bits.<span style="color:#007f7f">unreserveMemory</span>(size, cap);
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">throw</span> x;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    unsafe.<span style="color:#007f7f">setMemory</span>(base, size, (<span style="color:#fff;font-weight:bold">byte</span>) <span style="color:#ff0;font-weight:bold">0</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">if</span> (pa &amp;&amp; (base % ps != <span style="color:#ff0;font-weight:bold">0</span>)) {
</span></span><span style="display:flex;"><span>        address = base + ps - (base &amp; (ps - <span style="color:#ff0;font-weight:bold">1</span>));
</span></span><span style="display:flex;"><span>    } <span style="color:#fff;font-weight:bold">else</span> {
</span></span><span style="display:flex;"><span>        address = base;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    cleaner = Cleaner.<span style="color:#007f7f">create</span>(<span style="color:#fff;font-weight:bold">this</span>, <span style="color:#fff;font-weight:bold">new</span> Deallocator(base, size, cap));
</span></span><span style="display:flex;"><span>    att = <span style="color:#fff;font-weight:bold">null</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>é™¤æ­¤ä¹‹å¤–ï¼Œåˆå§‹åŒ–DIrectByteBufferæ—¶è¿˜ä¼šåˆ›å»ºä¸€ä¸ªDeallocatorçº¿ç¨‹ï¼Œå¹¶é€šè¿‡Cleanerçš„freeMemory()æ–¹æ³•æ¥ç›´æ¥å¯¹å†…å­˜è¿›è¡Œå›æ”¶æ“ä½œï¼ŒfreeMemory()åº•å±‚è°ƒç”¨çš„æ˜¯æ“ä½œç³»ç»Ÿçš„free()å‡½æ•°ã€‚</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">private</span> <span style="color:#fff;font-weight:bold">static</span> <span style="color:#fff;font-weight:bold">class</span> Deallocator <span style="color:#fff;font-weight:bold">implements</span> Runnable {
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> <span style="color:#fff;font-weight:bold">static</span> Unsafe unsafe = Unsafe.<span style="color:#007f7f">getUnsafe</span>();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> <span style="color:#fff;font-weight:bold">long</span> address;
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> <span style="color:#fff;font-weight:bold">long</span> size;
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> <span style="color:#fff;font-weight:bold">int</span> capacity;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> Deallocator(<span style="color:#fff;font-weight:bold">long</span> address, <span style="color:#fff;font-weight:bold">long</span> size, <span style="color:#fff;font-weight:bold">int</span> capacity) {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">assert</span> (address != <span style="color:#ff0;font-weight:bold">0</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">address</span> = address;
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">size</span> = size;
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">capacity</span> = capacity;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">void</span> run() {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">if</span> (address == <span style="color:#ff0;font-weight:bold">0</span>) {
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">return</span>;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        unsafe.<span style="color:#007f7f">freeMemory</span>(address);
</span></span><span style="display:flex;"><span>        address = <span style="color:#ff0;font-weight:bold">0</span>;
</span></span><span style="display:flex;"><span>        Bits.<span style="color:#007f7f">unreserveMemory</span>(size, capacity);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>ç”±äºä½¿ç”¨DirectByteBufferåˆ†é…çš„æ˜¯ç³»ç»Ÿæœ¬åœ°çš„å†…å­˜ï¼Œä¸åœ¨JVMçš„ç®¡æ§èŒƒå›´ä¹‹å†…ï¼Œå› æ­¤ç›´æ¥å†…å­˜çš„å›æ”¶å’Œå †å†…å­˜çš„å›æ”¶ä¸åŒï¼Œç›´æ¥å†…å­˜å¦‚æœä½¿ç”¨ä¸å½“ï¼Œå¾ˆå®¹æ˜“é€ æˆOutOfMemoryErrorã€‚</p>
<p>è¯´äº†è¿™ä¹ˆå¤šï¼Œé‚£ä¹ˆDirectByteBufferå’Œé›¶æ‹·è´æœ‰ä»€ä¹ˆå…³ç³»ï¼Ÿå‰é¢æœ‰æåˆ°åœ¨MappedByteBufferè¿›è¡Œå†…å­˜æ˜ å°„æ—¶ï¼Œå®ƒçš„map()æ–¹æ³•ä¼šé€šè¿‡Util.newMappedByteBuffer()æ¥åˆ›å»ºä¸€ä¸ªç¼“å†²åŒºå®ä¾‹ï¼Œåˆå§‹åŒ–ä»£ç å¦‚ä¸‹:</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">27
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">28
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">29
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">30
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">31
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">static</span> MappedByteBuffer newMappedByteBuffer(<span style="color:#fff;font-weight:bold">int</span> size, <span style="color:#fff;font-weight:bold">long</span> addr, FileDescriptor fd,
</span></span><span style="display:flex;"><span>                                            Runnable unmapper) {
</span></span><span style="display:flex;"><span>    MappedByteBuffer dbb;
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">if</span> (directByteBufferConstructor == <span style="color:#fff;font-weight:bold">null</span>)
</span></span><span style="display:flex;"><span>        initDBBConstructor();
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">try</span> {
</span></span><span style="display:flex;"><span>        dbb = (MappedByteBuffer)directByteBufferConstructor.<span style="color:#007f7f">newInstance</span>(
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">new</span> Object[] { <span style="color:#fff;font-weight:bold">new</span> Integer(size), <span style="color:#fff;font-weight:bold">new</span> Long(addr), fd, unmapper });
</span></span><span style="display:flex;"><span>    } <span style="color:#fff;font-weight:bold">catch</span> (InstantiationException | IllegalAccessException | InvocationTargetException e) {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">throw</span> <span style="color:#fff;font-weight:bold">new</span> InternalError(e);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">return</span> dbb;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">private</span> <span style="color:#fff;font-weight:bold">static</span> <span style="color:#fff;font-weight:bold">void</span> initDBBRConstructor() {
</span></span><span style="display:flex;"><span>    AccessController.<span style="color:#007f7f">doPrivileged</span>(<span style="color:#fff;font-weight:bold">new</span> PrivilegedAction&lt;Void&gt;() {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">public</span> Void run() {
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">try</span> {
</span></span><span style="display:flex;"><span>                Class&lt;?&gt; cl = Class.<span style="color:#007f7f">forName</span>(<span style="color:#0ff;font-weight:bold">&#34;java.nio.DirectByteBufferR&#34;</span>);
</span></span><span style="display:flex;"><span>                Constructor&lt;?&gt; ctor = cl.<span style="color:#007f7f">getDeclaredConstructor</span>(
</span></span><span style="display:flex;"><span>                    <span style="color:#fff;font-weight:bold">new</span> Class&lt;?&gt;[] { <span style="color:#fff;font-weight:bold">int</span>.<span style="color:#007f7f">class</span>, <span style="color:#fff;font-weight:bold">long</span>.<span style="color:#007f7f">class</span>, FileDescriptor.<span style="color:#007f7f">class</span>,
</span></span><span style="display:flex;"><span>                                    Runnable.<span style="color:#007f7f">class</span> });
</span></span><span style="display:flex;"><span>                ctor.<span style="color:#007f7f">setAccessible</span>(<span style="color:#fff;font-weight:bold">true</span>);
</span></span><span style="display:flex;"><span>                directByteBufferRConstructor = ctor;
</span></span><span style="display:flex;"><span>            } <span style="color:#fff;font-weight:bold">catch</span> (ClassNotFoundException | NoSuchMethodException |
</span></span><span style="display:flex;"><span>                     IllegalArgumentException | ClassCastException x) {
</span></span><span style="display:flex;"><span>                <span style="color:#fff;font-weight:bold">throw</span> <span style="color:#fff;font-weight:bold">new</span> InternalError(x);
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">return</span> <span style="color:#fff;font-weight:bold">null</span>;
</span></span><span style="display:flex;"><span>        }});
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>DirectByteBufferæ˜¯MappedByteBufferçš„å…·ä½“å®ç°ç±»ã€‚å®é™…ä¸Šï¼ŒUtil.newMappedByteBUffer()æ–¹æ³•é€šè¿‡åå°„æœºåˆ¶è·å–DirectByteBufferçš„æ„é€ å™¨ï¼Œç„¶ååˆ›å»ºä¸€ä¸ªDirectByteBUfferçš„å®ä¾‹ï¼Œå¯¹åº”çš„æ˜¯ä¸€ä¸ªå•ç‹¬ç”¨äºå†…å­˜æ˜ å°„çš„æ„é€ æ–¹æ³•:</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">6
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">protected</span> DirectByteBuffer(<span style="color:#fff;font-weight:bold">int</span> cap, <span style="color:#fff;font-weight:bold">long</span> addr, FileDescriptor fd, Runnable unmapper) {
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">super</span>(-<span style="color:#ff0;font-weight:bold">1</span>, <span style="color:#ff0;font-weight:bold">0</span>, cap, cap, fd);
</span></span><span style="display:flex;"><span>    address = addr;
</span></span><span style="display:flex;"><span>    cleaner = Cleaner.<span style="color:#007f7f">create</span>(<span style="color:#fff;font-weight:bold">this</span>, unmapper);
</span></span><span style="display:flex;"><span>    att = <span style="color:#fff;font-weight:bold">null</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>å› æ­¤é™¤äº†å…è®¸åˆ†é…æ“ä½œç³»ç»Ÿçš„ç›´æ¥å†…å­˜ä¹‹å¤–ï¼ŒDirectByteBufferæœ¬èº«ä¹Ÿå…·æœ‰æ–‡ä»¶æ˜ å°„çš„åŠŸèƒ½ï¼Œè¿™é‡Œä¸åšè¿‡å¤šè¯´æ˜ã€‚æˆ‘ä»¬éœ€è¦å…³æ³¨çš„æ˜¯ï¼ŒDirectByteBufferåœ¨MappedByteBufferçš„åŸºç¡€ä¸Šæä¾›äº†å†…å­˜æ˜ åƒæ–‡ä»¶çš„éšæœºè¯»å–get()å’Œå†™å…¥write()æ“ä½œã€‚</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">7
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">byte</span> get() {
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">return</span> ((unsafe.<span style="color:#007f7f">getByte</span>(ix(nextGetIndex()))));
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">byte</span> get(<span style="color:#fff;font-weight:bold">int</span> i) {
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">return</span> ((unsafe.<span style="color:#007f7f">getByte</span>(ix(checkIndex(i)))));
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">8
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">9
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> ByteBuffer put(<span style="color:#fff;font-weight:bold">byte</span> x) {
</span></span><span style="display:flex;"><span>    unsafe.<span style="color:#007f7f">putByte</span>(ix(nextPutIndex()), ((x)));
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">return</span> <span style="color:#fff;font-weight:bold">this</span>;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> ByteBuffer put(<span style="color:#fff;font-weight:bold">int</span> i, <span style="color:#fff;font-weight:bold">byte</span> x) {
</span></span><span style="display:flex;"><span>    unsafe.<span style="color:#007f7f">putByte</span>(ix(checkIndex(i)), ((x)));
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">return</span> <span style="color:#fff;font-weight:bold">this</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>å†…å­˜æ˜ åƒæ–‡ä»¶çš„éšæœºè¯»å†™éƒ½æ˜¯å€ŸåŠ©ix()æ–¹æ³•å®ç°å®šä½çš„ï¼Œix()æ–¹æ³•é€šè¿‡å†…å­˜æ˜ å°„ç©ºé—´çš„å†…å­˜é¦–åœ°å€å’Œç»™å®šåç§»é‡iè®¡ç®—å‡ºæŒ‡é’ˆåœ°å€ï¼Œç„¶åç”±unsafeç±»çš„get()å’Œput()æ–¹æ³•å’Œå¯¹æŒ‡é’ˆæŒ‡å‘çš„æ•°æ®è¿›è¡Œè¯»å–æˆ–å†™å…¥ã€‚</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">private</span> <span style="color:#fff;font-weight:bold">long</span> ix(<span style="color:#fff;font-weight:bold">int</span> i) {
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">return</span> address + ((<span style="color:#fff;font-weight:bold">long</span>)i &lt;&lt; <span style="color:#ff0;font-weight:bold">0</span>);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="filechannel">FileChannel<a hidden class="anchor" aria-hidden="true" href="#filechannel">#</a></h2>
<p>FileChannelæ˜¯ä¸€ä¸ªç”¨æˆ·æ–‡ä»¶è¯»å†™ï¼Œæ˜ å°„å’Œæ“ä½œçš„é€šé“ï¼ŒåŒæ—¶å®ƒåœ¨å¹¶å‘ç¯å¢ƒä¸‹æ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼ŒåŸºäºFileInputStreamã€FileOutputStreamæˆ–è€…RandomAccessFileçš„getChannel()æ–¹æ³•å¯ä»¥åˆ›å»ºå¹¶æ‰“å¼€ä¸€ä¸ªæ–‡ä»¶é€šé“ã€‚FIleChannelå®šä¹‰äº†transferFrom()å’ŒtransferTo()ä¸¤ä¸ªæŠ½è±¡æ–¹æ³•ï¼Œå®ƒé€šè¿‡åœ¨é€šé“å’Œé€šé“ä¹‹é—´å»ºç«‹è¿æ¥å®ç°æ•°æ®ä¼ è¾“çš„ã€‚</p>
<li>transferTo(): é€šè¿‡FileChannelæŠŠæ–‡ä»¶é‡Œé¢çš„æºæ•°æ®å†™å…¥ä¸€ä¸ªWritableByteChannelçš„ç›®çš„é€šé“</li>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">abstract</span> <span style="color:#fff;font-weight:bold">long</span> transferTo(<span style="color:#fff;font-weight:bold">long</span> position, <span style="color:#fff;font-weight:bold">long</span> count, WritableByteChannel target)
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">throws</span> IOException;
</span></span></code></pre></td></tr></table>
</div>
</div><li>transferFrom(): æŠŠä¸€ä¸ªæºé€šé“ReadableByteChannelä¸­çš„æ•°æ®è¯»å–åˆ°å½“å‰FIleChannelçš„æ–‡ä»¶é‡Œé¢ã€‚</li>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">abstract</span> <span style="color:#fff;font-weight:bold">long</span> transferFrom(ReadableByteChannel src, <span style="color:#fff;font-weight:bold">long</span> position, <span style="color:#fff;font-weight:bold">long</span> count)
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">throws</span> IOException;
</span></span></code></pre></td></tr></table>
</div>
</div><p>ä¸‹é¢ç»™å‡ºFileChannelåˆ©ç”¨transferTo()å’ŒtransferFrom()æ–¹æ³•è¿›è¡Œæ•°æ®ä¼ è¾“çš„ä½¿ç”¨ç¤ºä¾‹:</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">private</span> <span style="color:#fff;font-weight:bold">static</span> <span style="color:#fff;font-weight:bold">final</span> String CONTENT = <span style="color:#0ff;font-weight:bold">&#34;Zero copy implemented by FileChannel&#34;</span>;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">private</span> <span style="color:#fff;font-weight:bold">static</span> <span style="color:#fff;font-weight:bold">final</span> String SOURCE_FILE = <span style="color:#0ff;font-weight:bold">&#34;/source.txt&#34;</span>;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">private</span> <span style="color:#fff;font-weight:bold">static</span> <span style="color:#fff;font-weight:bold">final</span> String TARGET_FILE = <span style="color:#0ff;font-weight:bold">&#34;/target.txt&#34;</span>;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">private</span> <span style="color:#fff;font-weight:bold">static</span> <span style="color:#fff;font-weight:bold">final</span> String CHARSET = <span style="color:#0ff;font-weight:bold">&#34;UTF-8&#34;</span>;
</span></span></code></pre></td></tr></table>
</div>
</div><p>é¦–å…ˆåœ¨ç±»åŠ è½½æ ¹è·¯å¾„ä¸‹åˆ›å»ºsource.txtå’Œtarget.txtä¸¤ä¸ªæ–‡ä»¶ï¼Œå¯¹æºæ–‡ä»¶source.txtæ–‡ä»¶å†™å…¥åˆå§‹åŒ–æ•°æ®ã€‚</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>@Before
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">void</span> setup() {
</span></span><span style="display:flex;"><span>    Path source = Paths.<span style="color:#007f7f">get</span>(getClassPath(SOURCE_FILE));
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">byte</span>[] bytes = CONTENT.<span style="color:#007f7f">getBytes</span>(Charset.<span style="color:#007f7f">forName</span>(CHARSET));
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">try</span> (FileChannel fromChannel = FileChannel.<span style="color:#007f7f">open</span>(source, StandardOpenOption.<span style="color:#007f7f">READ</span>,
</span></span><span style="display:flex;"><span>            StandardOpenOption.<span style="color:#007f7f">WRITE</span>, StandardOpenOption.<span style="color:#007f7f">TRUNCATE_EXISTING</span>)) {
</span></span><span style="display:flex;"><span>        fromChannel.<span style="color:#007f7f">write</span>(ByteBuffer.<span style="color:#007f7f">wrap</span>(bytes));
</span></span><span style="display:flex;"><span>    } <span style="color:#fff;font-weight:bold">catch</span> (IOException e) {
</span></span><span style="display:flex;"><span>        e.<span style="color:#007f7f">printStackTrace</span>();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>å¯¹äºtransferTo()æ–¹æ³•è€Œè¨€ï¼Œç›®çš„é€šé“toChannelå¯ä»¥æ˜¯ä»»æ„çš„å•å‘å­—èŠ‚é€šé“WritableByteChannel;è€Œå¯¹äºtransferFrom()æ–¹æ³•è€Œè¨€ï¼Œæºé€šé“fromChannelå¯ä»¥æ˜¯ä»»æ„çš„å•é¡¹å­—èŠ‚è¯»é€šé“ReadableByteChannelã€‚å…¶ä¸­ï¼ŒFileChannelã€SocketChannelå’ŒDatagramChannelç­‰é€šé“å®ç°äº†WriteByteChannelå’ŒReadableByteChannelæ¥å£ï¼Œéƒ½æ˜¯åŒæ—¶æ”¯æŒè¯»å†™çš„åŒå‘é€šé“ã€‚ä¸ºäº†æ–¹ä¾¿æµ‹è¯•ï¼Œä¸‹é¢ç»™å‡ºåŸºäºFileChannelå®Œæˆchannel-to-channelçš„æ•°æ®ä¼ è¾“ç¤ºä¾‹:</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>@Test
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">void</span> transferTo() <span style="color:#fff;font-weight:bold">throws</span> Exception {
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">try</span> (FileChannel fromChannel = <span style="color:#fff;font-weight:bold">new</span> RandomAccessFile(
</span></span><span style="display:flex;"><span>             getClassPath(SOURCE_FILE), <span style="color:#0ff;font-weight:bold">&#34;rw&#34;</span>).<span style="color:#007f7f">getChannel</span>();
</span></span><span style="display:flex;"><span>         FileChannel toChannel = <span style="color:#fff;font-weight:bold">new</span> RandomAccessFile(
</span></span><span style="display:flex;"><span>             getClassPath(TARGET_FILE), <span style="color:#0ff;font-weight:bold">&#34;rw&#34;</span>).<span style="color:#007f7f">getChannel</span>()) {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">long</span> position = <span style="color:#ff0;font-weight:bold">0</span>L;
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">long</span> offset = fromChannel.<span style="color:#007f7f">size</span>();
</span></span><span style="display:flex;"><span>        fromChannel.<span style="color:#007f7f">transferTo</span>(position, offset, toChannel);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>é€šè¿‡transferFrom()å°†fromChannelä¸­çš„æ•°æ®æ‹·è´åˆ°toChannel:</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>@Test
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">void</span> transferFrom() <span style="color:#fff;font-weight:bold">throws</span> Exception {
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">try</span> (FileChannel fromChannel = <span style="color:#fff;font-weight:bold">new</span> RandomAccessFile(
</span></span><span style="display:flex;"><span>             getClassPath(SOURCE_FILE), <span style="color:#0ff;font-weight:bold">&#34;rw&#34;</span>).<span style="color:#007f7f">getChannel</span>();
</span></span><span style="display:flex;"><span>         FileChannel toChannel = <span style="color:#fff;font-weight:bold">new</span> RandomAccessFile(
</span></span><span style="display:flex;"><span>             getClassPath(TARGET_FILE), <span style="color:#0ff;font-weight:bold">&#34;rw&#34;</span>).<span style="color:#007f7f">getChannel</span>()) {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">long</span> position = <span style="color:#ff0;font-weight:bold">0</span>L;
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">long</span> offset = fromChannel.<span style="color:#007f7f">size</span>();
</span></span><span style="display:flex;"><span>        toChannel.<span style="color:#007f7f">transferFrom</span>(fromChannel, position, offset);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>ä¸‹é¢ä»‹ç»transferTo()å’ŒtransferFrom()æ–¹æ³•çš„åº•å±‚å®ç°åŸç†ï¼Œè¿™ä¸¤ä¸ªæ–¹æ³•ä¹Ÿæ˜¯java.nio.channels.FIlwChannelçš„æŠ½è±¡æ–¹æ³•ï¼Œç”±å­ç±»sun.nio.ch.FileChannelImpl.javaå®ç°ã€‚transferTo()å’ŒtransferFrom()åº•å±‚éƒ½æ˜¯åŸºäºsendfileå®ç°æ•°æ®ä¼ è¾“çš„ï¼Œå…¶ä¸­FileChannelImpl.javaå®šä¹‰äº†3ä¸ªå¸¸é‡ï¼Œç”¨äºæ ‡ç¤ºå½“å‰æ“ä½œç³»ç»Ÿçš„å†…æ ¸æ˜¯å¦æ”¯æŒsendfileä»¥åŠsendfileçš„ç›¸å…³ç‰¹æ€§ã€‚</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">private</span> <span style="color:#fff;font-weight:bold">static</span> <span style="color:#fff;font-weight:bold">volatile</span> <span style="color:#fff;font-weight:bold">boolean</span> transferSupported = <span style="color:#fff;font-weight:bold">true</span>;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">private</span> <span style="color:#fff;font-weight:bold">static</span> <span style="color:#fff;font-weight:bold">volatile</span> <span style="color:#fff;font-weight:bold">boolean</span> pipeSupported = <span style="color:#fff;font-weight:bold">true</span>;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">private</span> <span style="color:#fff;font-weight:bold">static</span> <span style="color:#fff;font-weight:bold">volatile</span> <span style="color:#fff;font-weight:bold">boolean</span> fileSupported = <span style="color:#fff;font-weight:bold">true</span>;
</span></span></code></pre></td></tr></table>
</div>
</div><li>transferSupported:ç”¨äºæ ‡è®°å½“å‰çš„ç³»ç»Ÿå†…æ ¸æ˜¯å¦æ”¯æŒsendfile()è°ƒç”¨ï¼Œé»˜è®¤ä¸ºtrue.</li>
<li>pipeSupported: ç”¨äºæ ‡è®°å½“å‰çš„ç³»ç»Ÿå†…æ ¸æ˜¯å¦æ”¯æŒæ–‡ä»¶æè¿°ç¬¦åŸºäºç®¡é“çš„sendfile()è°ƒç”¨ï¼Œé»˜è®¤ä¸ºtrueã€‚</li>
<li>fileSupported: ç”¨äºæ ‡è®°å½“å‰çš„ç³»ç»Ÿå†…æ ¸æ˜¯å¦æ”¯æŒæ–‡ä»¶æè¿°ç¬¦åŸºäºæ–‡ä»¶çš„sendfile()è°ƒç”¨ï¼Œé»˜è®¤ä¸ºtrue.</li>
<p>ä¸‹é¢ä»¥transfer()çš„æºç å®ç°ä¸ºä¾‹ã€‚FIleChannelImplé¦–å…ˆæ‰§è¡ŒtransferToDirectly()æ–¹æ³•ï¼Œä»¥sendfileçš„é›¶æ‹·è´æ–¹å¼æ•°æ®æ‹·è´ã€‚å¦‚æœç³»ç»Ÿå†…æ ¸ä¸æ”¯æŒsendfileï¼Œè¿›ä¸€æ­¥æ‰§è¡ŒtransferToTrustedChannel()æ–¹æ³•ï¼Œä»¥mmap()çš„é›¶æ‹·è´æ–¹å¼è¿›è¡Œå†…å­˜æ˜ å°„ï¼Œè¿™ç§æƒ…å†µä¸‹ç›®çš„é€šé“å¿…é¡»æ˜¯FileChannelImplæˆ–è€…SelChImplç±»å‹ã€‚å¦‚æœä»¥ä¸Šä¸¤æ­¥éƒ½å¤±è´¥äº†ï¼Œåˆ™æ‰§è¡ŒtransferToArbitraryChannel()æ–¹æ³•ï¼ŒåŸºäºä¼ ç»Ÿçš„I/Oæ–¹å¼å®Œæˆè¯»å†™ï¼Œå…·ä½“æ­¥éª¤æ˜¯åˆå§‹åŒ–ä¸€ä¸ªä¸´æ—¶çš„DirectBufferï¼Œå°†æºé€šé“FileChannelçš„æ•°æ®è¯»å–åˆ°DirectBufferï¼Œå†å†™å…¥ç›®çš„é€šé“WritableByteChannelé‡Œé¢ã€‚</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">long</span> transferTo(<span style="color:#fff;font-weight:bold">long</span> position, <span style="color:#fff;font-weight:bold">long</span> count, WritableByteChannel target)
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">throws</span> IOException {
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// è®¡ç®—æ–‡ä»¶çš„å¤§å°
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    <span style="color:#fff;font-weight:bold">long</span> sz = size();
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// æ ¡éªŒèµ·å§‹ä½ç½®
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    <span style="color:#fff;font-weight:bold">if</span> (position &gt; sz)
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> <span style="color:#ff0;font-weight:bold">0</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">int</span> icount = (<span style="color:#fff;font-weight:bold">int</span>)Math.<span style="color:#007f7f">min</span>(count, Integer.<span style="color:#007f7f">MAX_VALUE</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// æ ¡éªŒåç§»é‡
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    <span style="color:#fff;font-weight:bold">if</span> ((sz - position) &lt; icount)
</span></span><span style="display:flex;"><span>        icount = (<span style="color:#fff;font-weight:bold">int</span>)(sz - position);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">long</span> n;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">if</span> ((n = transferToDirectly(position, icount, target)) &gt;= <span style="color:#ff0;font-weight:bold">0</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> n;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">if</span> ((n = transferToTrustedChannel(position, icount, target)) &gt;= <span style="color:#ff0;font-weight:bold">0</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> n;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">return</span> transferToArbitraryChannel(position, icount, target);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>æ¥ä¸‹æ¥é‡ç‚¹åˆ†æä¸€ä¸‹transferToDirectly()æ–¹æ³•çš„å®ç°ï¼Œä¹Ÿå°±æ˜¯transferTo()é€šè¿‡sendfileå®ç°é›¶æ‹·è´çš„ç²¾é«“æ‰€åœ¨ã€‚å¯ä»¥çœ‹åˆ°ï¼ŒtransferToDirectlyInternal()æ–¹æ³•å…ˆè·å–åˆ°ç›®çš„çš„é€šé“WritableByteChannelçš„æ–‡ä»¶æè¿°ç¬¦targetFDï¼Œè·å–åŒæ­¥é”ç„¶åæ‰§è¡ŒtransferToDirectlyInternal()æ–¹æ³•ã€‚</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">private</span> <span style="color:#fff;font-weight:bold">long</span> transferToDirectly(<span style="color:#fff;font-weight:bold">long</span> position, <span style="color:#fff;font-weight:bold">int</span> icount, WritableByteChannel target)
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">throws</span> IOException {
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// çœç•¥ä»targetè·å–targetFDçš„è¿‡ç¨‹
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    <span style="color:#fff;font-weight:bold">if</span> (nd.<span style="color:#007f7f">transferToDirectlyNeedsPositionLock</span>()) {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">synchronized</span> (positionLock) {
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">long</span> pos = position();
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">try</span> {
</span></span><span style="display:flex;"><span>                <span style="color:#fff;font-weight:bold">return</span> transferToDirectlyInternal(position, icount,
</span></span><span style="display:flex;"><span>                        target, targetFD);
</span></span><span style="display:flex;"><span>            } <span style="color:#fff;font-weight:bold">finally</span> {
</span></span><span style="display:flex;"><span>                position(pos);
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    } <span style="color:#fff;font-weight:bold">else</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> transferToDirectlyInternal(position, icount, target, targetFD);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>æœ€ç»ˆç”±transferToDirectlyInternal()è°ƒç”¨æœ¬åœ°æ–¹æ³•transferTo0()ï¼Œå°è¯•ä»¥sendfileçš„æ–¹å¼è¿›è¡Œæ•°æ®ä¼ è¾“ã€‚å¦‚æœç³»ç»Ÿå†…æ ¸å®Œå…¨ä¸æ”¯æŒsendfileï¼Œæ¯”å¦‚Windowsæ“ä½œç³»ç»Ÿï¼Œåˆ™è¿”å›UNSUPPORTEDå¹¶æŠŠtransferSupportedæ ‡è¯†ä¸ºfalseã€‚å¦‚æœç³»ç»Ÿå†…æ ¸ä¸æ”¯æŒsendfileçš„ä¸€äº›ç‰¹æ€§ï¼Œæ¯”å¦‚è¯´ä½ç‰ˆæœ¬çš„Linuxå†…æ ¸ä¸æ”¯æŒDMA gather copy æ“ä½œï¼Œåˆ™è¿”å› UNSUPPORTED_CASE å¹¶æŠŠpipeSupported æˆ–è€… fileSupportedæ ‡è¯†ä¸ºfalseã€‚</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">27
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">28
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">29
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">30
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">31
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">32
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">33
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">private</span> <span style="color:#fff;font-weight:bold">long</span> transferToDirectlyInternal(<span style="color:#fff;font-weight:bold">long</span> position, <span style="color:#fff;font-weight:bold">int</span> icount,
</span></span><span style="display:flex;"><span>                                        WritableByteChannel target,
</span></span><span style="display:flex;"><span>                                        FileDescriptor targetFD) <span style="color:#fff;font-weight:bold">throws</span> IOException {
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">assert</span> !nd.<span style="color:#007f7f">transferToDirectlyNeedsPositionLock</span>() ||
</span></span><span style="display:flex;"><span>            Thread.<span style="color:#007f7f">holdsLock</span>(positionLock);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">long</span> n = -<span style="color:#ff0;font-weight:bold">1</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">int</span> ti = -<span style="color:#ff0;font-weight:bold">1</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">try</span> {
</span></span><span style="display:flex;"><span>        begin();
</span></span><span style="display:flex;"><span>        ti = threads.<span style="color:#007f7f">add</span>();
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">if</span> (!isOpen())
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">return</span> -<span style="color:#ff0;font-weight:bold">1</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">do</span> {
</span></span><span style="display:flex;"><span>            n = transferTo0(fd, position, icount, targetFD);
</span></span><span style="display:flex;"><span>        } <span style="color:#fff;font-weight:bold">while</span> ((n == IOStatus.<span style="color:#007f7f">INTERRUPTED</span>) &amp;&amp; isOpen());
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">if</span> (n == IOStatus.<span style="color:#007f7f">UNSUPPORTED_CASE</span>) {
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">if</span> (target <span style="color:#fff;font-weight:bold">instanceof</span> SinkChannelImpl)
</span></span><span style="display:flex;"><span>                pipeSupported = <span style="color:#fff;font-weight:bold">false</span>;
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">if</span> (target <span style="color:#fff;font-weight:bold">instanceof</span> FileChannelImpl)
</span></span><span style="display:flex;"><span>                fileSupported = <span style="color:#fff;font-weight:bold">false</span>;
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">return</span> IOStatus.<span style="color:#007f7f">UNSUPPORTED_CASE</span>;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">if</span> (n == IOStatus.<span style="color:#007f7f">UNSUPPORTED</span>) {
</span></span><span style="display:flex;"><span>            transferSupported = <span style="color:#fff;font-weight:bold">false</span>;
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">return</span> IOStatus.<span style="color:#007f7f">UNSUPPORTED</span>;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> IOStatus.<span style="color:#007f7f">normalize</span>(n);
</span></span><span style="display:flex;"><span>    } <span style="color:#fff;font-weight:bold">finally</span> {
</span></span><span style="display:flex;"><span>        threads.<span style="color:#007f7f">remove</span>(ti);
</span></span><span style="display:flex;"><span>        end (n &gt; -<span style="color:#ff0;font-weight:bold">1</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>æœ¬åœ°æ–¹æ³•transferTo0()é€šè¿‡JNIè°ƒç”¨åº•å±‚Cçš„å‡½æ•°ï¼Œè¿™ä¸ªnativeå‡½æ•°åŒæ ·ä½äºJDKæºç åŒ…ä¸‹çš„ native.sun/nio/ch/FileChannelImol.cæºæ–‡ä»¶é‡Œé¢ã€‚JNIå‡½æ•°java_sun_nio_ch_FileChannelImpl_transferTo0()åŸºäºæ¡ä»¶ç¼–è¯‘å¯¹ä¸åŒçš„ç³»ç»Ÿè¿›è¡Œé¢„ç¼–è¯‘ï¼Œä¸‹é¢æ˜¯JDKåŸºäºLinuxç³»ç»Ÿå†…æ ¸å¯¹transferTo()æä¾›çš„è°ƒç”¨å°è£…ã€‚</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">27
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">28
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">29
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">30
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">31
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">32
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">33
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">34
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#0f0;font-weight:bold">#if defined(__linux__) || defined(__solaris__)
</span></span></span><span style="display:flex;"><span><span style="color:#0f0;font-weight:bold">#include</span> <span style="color:#0f0;font-weight:bold">&lt;sys/sendfile.h&gt;</span><span style="color:#0f0;font-weight:bold">
</span></span></span><span style="display:flex;"><span><span style="color:#0f0;font-weight:bold">#elif defined(_AIX)
</span></span></span><span style="display:flex;"><span><span style="color:#0f0;font-weight:bold">#include</span> <span style="color:#0f0;font-weight:bold">&lt;sys/socket.h&gt;</span><span style="color:#0f0;font-weight:bold">
</span></span></span><span style="display:flex;"><span><span style="color:#0f0;font-weight:bold">#elif defined(_ALLBSD_SOURCE)
</span></span></span><span style="display:flex;"><span><span style="color:#0f0;font-weight:bold">#include</span> <span style="color:#0f0;font-weight:bold">&lt;sys/types.h&gt;</span><span style="color:#0f0;font-weight:bold">
</span></span></span><span style="display:flex;"><span><span style="color:#0f0;font-weight:bold">#include</span> <span style="color:#0f0;font-weight:bold">&lt;sys/socket.h&gt;</span><span style="color:#0f0;font-weight:bold">
</span></span></span><span style="display:flex;"><span><span style="color:#0f0;font-weight:bold">#include</span> <span style="color:#0f0;font-weight:bold">&lt;sys/uio.h&gt;</span><span style="color:#0f0;font-weight:bold">
</span></span></span><span style="display:flex;"><span><span style="color:#0f0;font-weight:bold"></span>
</span></span><span style="display:flex;"><span><span style="color:#0f0;font-weight:bold">#define lseek64 lseek
</span></span></span><span style="display:flex;"><span><span style="color:#0f0;font-weight:bold">#define mmap64 mmap
</span></span></span><span style="display:flex;"><span><span style="color:#0f0;font-weight:bold">#endif
</span></span></span><span style="display:flex;"><span><span style="color:#0f0;font-weight:bold"></span>
</span></span><span style="display:flex;"><span>JNIEXPORT jlong JNICALL
</span></span><span style="display:flex;"><span>Java_sun_nio_ch_FileChannelImpl_transferTo0(JNIEnv *env, jobject this,
</span></span><span style="display:flex;"><span>                                            jobject srcFDO,
</span></span><span style="display:flex;"><span>                                            jlong position, jlong count,
</span></span><span style="display:flex;"><span>                                            jobject dstFDO)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    jint srcFD = fdval(env, srcFDO);
</span></span><span style="display:flex;"><span>    jint dstFD = fdval(env, dstFDO);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#0f0;font-weight:bold">#if defined(__linux__)
</span></span></span><span style="display:flex;"><span><span style="color:#0f0;font-weight:bold"></span>    <span style="color:#fff;font-weight:bold">off64_t</span> offset = (<span style="color:#fff;font-weight:bold">off64_t</span>)position;
</span></span><span style="display:flex;"><span>    jlong n = sendfile64(dstFD, srcFD, &amp;offset, (<span style="color:#fff;font-weight:bold">size_t</span>)count);
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">return</span> n;
</span></span><span style="display:flex;"><span><span style="color:#0f0;font-weight:bold">#elif defined(__solaris__)
</span></span></span><span style="display:flex;"><span><span style="color:#0f0;font-weight:bold"></span>    result = sendfilev64(dstFD, &amp;sfv, <span style="color:#ff0;font-weight:bold">1</span>, &amp;numBytes);    
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">return</span> result;
</span></span><span style="display:flex;"><span><span style="color:#0f0;font-weight:bold">#elif defined(__APPLE__)
</span></span></span><span style="display:flex;"><span><span style="color:#0f0;font-weight:bold"></span>    result = sendfile(srcFD, dstFD, position, &amp;numBytes, <span style="color:#fff;font-weight:bold">NULL</span>, <span style="color:#ff0;font-weight:bold">0</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">return</span> result;
</span></span><span style="display:flex;"><span><span style="color:#0f0;font-weight:bold">#endif
</span></span></span><span style="display:flex;"><span><span style="color:#0f0;font-weight:bold"></span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>å¯¹Linuxã€Solarisä»¥åŠAppleç³»ç»Ÿè€Œè¨€ï¼ŒtransferTo0()å‡½æ•°åº•å±‚ä¼šæ‰§è¡Œsendfile64è¿™ä¸ªç³»ç»Ÿè°ƒç”¨å®Œæˆé›¶æ‹·è´æ“ä½œï¼Œsendfile64()å‡½æ•°åŸå‹å¦‚ä¸‹:</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#0f0;font-weight:bold">#include</span> <span style="color:#0f0;font-weight:bold">&lt;sys/sendfile.h&gt;</span><span style="color:#0f0;font-weight:bold">
</span></span></span><span style="display:flex;"><span><span style="color:#0f0;font-weight:bold"></span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">ssize_t</span> sendfile64(<span style="color:#fff;font-weight:bold">int</span> out_fd, <span style="color:#fff;font-weight:bold">int</span> in_fd, <span style="color:#fff;font-weight:bold">off_t</span> *offset, <span style="color:#fff;font-weight:bold">size_t</span> count);
</span></span></code></pre></td></tr></table>
</div>
</div><p>ä¸‹é¢ç®€å•ä»‹ç»ä¸€ä¸‹sendfile64()å‡½æ•°å„ä¸ªå‚æ•°çš„å«ä¹‰:</p>
<li>out_fd: å¾…å†™å…¥çš„æ–‡ä»¶æè¿°ç¬¦</li>
<li>in_fd: å¾…è¯»å–çš„æ–‡ä»¶æè¿°ç¬¦</li>
<li>offset: æŒ‡å®šin_fdå¯¹åº”æ–‡ä»¶æµçš„è¯»å–ä½ç½®ï¼Œå¦‚æœä¸ºç©ºï¼Œåˆ™é»˜è®¤ä»èµ·å§‹ä½ç½®å¼€å§‹</li>
<li>countï¼š æŒ‡å®šåœ¨æ–‡ä»¶æè¿°ç¬¦in_fdå’Œout_fdä¹‹é—´ä¼ è¾“çš„å­—èŠ‚æ•°</li>

  </div>

  <footer class="post-footer">
    <ul class="post-tags">
      <li><a href="https://csqread.top/tags/java/">Java</a></li>
    </ul>
<nav class="paginav">
  <a class="prev" href="https://csqread.top/posts/blog/hugo%E5%8D%9A%E5%AE%A2%E6%90%AD%E5%BB%BA/">
    <span class="title">Â« ä¸Šä¸€é¡µ</span>
    <br>
    <span>Hugoåšå®¢æ­å»º</span>
  </a>
  <a class="next" href="https://csqread.top/posts/tech/nio%E8%AF%A6%E8%A7%A3/">
    <span class="title">ä¸‹ä¸€é¡µ Â»</span>
    <br>
    <span>NIOè¯¦è§£</span>
  </a>
</nav>

  </footer>
</article>
    </main>
    
<footer class="footer">
    <span>&copy; 2024 <a href="https://csqread.top">Qian&#39;s Blog</a></span>
    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://github.com/adityatelange/hugo-PaperMod/" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerHTML = 'å¤åˆ¶';

        function copyingDone() {
            copybutton.innerHTML = 'å·²å¤åˆ¶ï¼';
            setTimeout(() => {
                copybutton.innerHTML = 'å¤åˆ¶';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                navigator.clipboard.writeText(codeblock.textContent);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) { };
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>
</body>

</html>
