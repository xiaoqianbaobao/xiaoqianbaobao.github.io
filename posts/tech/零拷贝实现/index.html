<!DOCTYPE html>
<html lang="zh" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>零拷贝实现 | Qian&#39;s Blog</title>
<meta name="keywords" content="Java">
<meta name="description" content="Linux中的零拷贝 1. 数据拷贝基础过程 在Linux系统内部缓存和内存容量都是有限的，更多的数据都是存储在磁盘中。对于Web服务器来说，经常需">
<meta name="author" content="
作者:&nbsp;ShengQian">
<link rel="canonical" href="https://csqread.top/posts/tech/%E9%9B%B6%E6%8B%B7%E8%B4%9D%E5%AE%9E%E7%8E%B0/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.d056c2d8b86c8da0db95897f49066a3a22d796d21ff6173ef98b613234e402fe.css" integrity="" rel="preload stylesheet" as="style">
<script defer crossorigin="anonymous" src="/assets/js/highlight.acb54fd32bbc1982428b8850317e45d076b95012730a5936667e6bc21777692a.js" integrity=""
    onload="hljs.initHighlightingOnLoad();"></script>
<link rel="icon" href="https://csqread.top/img/Q.gif">
<link rel="icon" type="image/png" sizes="16x16" href="https://csqread.top/img/%21.jpg">
<link rel="icon" type="image/png" sizes="32x32" href="https://csqread.top/img/%21.jpg">
<link rel="apple-touch-icon" href="https://csqread.top/%21.jpg">
<link rel="mask-icon" href="https://csqread.top/%21.jpg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --hljs-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript><meta property="og:title" content="零拷贝实现" />
<meta property="og:description" content="Linux中的零拷贝 1. 数据拷贝基础过程 在Linux系统内部缓存和内存容量都是有限的，更多的数据都是存储在磁盘中。对于Web服务器来说，经常需" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://csqread.top/posts/tech/%E9%9B%B6%E6%8B%B7%E8%B4%9D%E5%AE%9E%E7%8E%B0/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2024-04-23T22:25:58+08:00" />
<meta property="article:modified_time" content="2024-04-23T22:25:58+08:00" />

<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="零拷贝实现"/>
<meta name="twitter:description" content="Linux中的零拷贝 1. 数据拷贝基础过程 在Linux系统内部缓存和内存容量都是有限的，更多的数据都是存储在磁盘中。对于Web服务器来说，经常需"/>


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "Posts",
      "item": "https://csqread.top/posts/"
    }, 
    {
      "@type": "ListItem",
      "position":  3 ,
      "name": "技术",
      "item": "https://csqread.top/posts/tech/"
    }, 
    {
      "@type": "ListItem",
      "position":  4 ,
      "name": "零拷贝实现",
      "item": "https://csqread.top/posts/tech/%E9%9B%B6%E6%8B%B7%E8%B4%9D%E5%AE%9E%E7%8E%B0/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "零拷贝实现",
  "name": "零拷贝实现",
  "description": "Linux中的零拷贝 1. 数据拷贝基础过程 在Linux系统内部缓存和内存容量都是有限的，更多的数据都是存储在磁盘中。对于Web服务器来说，经常需",
  "keywords": [
    "Java"
  ],
  "articleBody": "Linux中的零拷贝 1. 数据拷贝基础过程 在Linux系统内部缓存和内存容量都是有限的，更多的数据都是存储在磁盘中。对于Web服务器来说，经常需要从磁盘中读取数据的内存，然后通过网卡传输给用户\n1.1 仅CPU方式 当应用程序需要读取磁盘数据时，调用read()从用户态陷入内核态，read()这个系统调用最终由CPU来完成 CPU向磁盘发起I/O请求，磁盘收到之后开始准备数据 磁盘将数据放到磁盘缓冲区之后，向CPU发起I/O中断，告诉CPU数据已经ready了 CPU收到磁盘控制器的I/O中断之后，开始拷贝数据，完成之后read()返回，再从内核态切换到用户态 1.2 CPU\u0026DMA方式 CPU的时间宝贵，让它做杂活就是浪费资源\n直接内存访问(Direct Memory Access)，是一种硬件设备绕开COU独立直接访问内存的机制。所以DMA再一定程度上解放了CPU，把之前CPU的杂货让硬件直接自己做了，提高了CPU效率。\n目前支持DMA的硬件包括:网卡、声卡、显卡、洗盘控制器等。\n有了DMA的参与之后的流程发生了一些变化\n最主要的变化是，CPU不再和磁盘直接交互，而是DMA和磁盘交互并且将数据从磁盘缓冲区拷贝到内核缓冲区，之后的过程类似。\n1 无论从仅CPU的方式和DMA\u0026CPU的方式，都存在多次冗余数据拷贝和内核态\u0026用户态的切换。 2. 普通模式数据交互 一次完成的数据交互包括几个部分:系统调用syscall、CPU、DMA、网卡、磁盘等\n系统调用syscall是应用程序和内核交互的桥梁，每次进行调用/返回就会产生两次切换:\n调用syscall从用户态切换到内核态 syscall返回从内核台切换到用户态 下图是完整的数据拷贝过程简图:\n读数据过程:\n应用程序要读取磁盘数据，调用read()函数从而实现用户态切换内核态，这是第一次切换 DMA控制器将数据从磁盘拷贝到内核缓冲区，这是第一次DMA拷贝 CPU将数据从内核缓冲区复制到用户缓冲区，这是第一次CPU拷贝 CPU拷贝完成之后，read()函数返回实现内核态切换用户态，这是第2次状态切换 写数据过程:\n应用程序要向网卡写数据，调用write()函数实现用户态切换内核态，这是第一次切换 CPU将用户缓冲区数据拷贝到内核缓冲区，这是第一次CPU拷贝 DMA控制器将数据从内核缓冲区复制到socket缓冲区，这是第一次DMA拷贝 完成拷贝之后，write()函数返回实现内核态切换用户态，这是第二次切换 综上所述:\n读过程涉及2次空间切换、1次DMA拷贝、1次CPU拷贝 写过程涉及2次空间切换，1次DMA拷贝，1次CPU拷贝 可见传统模式下，涉及多次空间切换和数据冗余拷贝，效率并不高，接下来就该零拷贝技术出场了。\n3. 零拷贝技术 3.1 出现原因 可以看到，如果应用程序读取磁盘数据，从内核缓冲区到用户缓冲区，再从用户缓冲区到内核缓冲区。两次数据拷贝都需要CPU的参与，并且涉及用户态与内核态的多次切换，加重了CPU负担。需要降低冗余数据拷贝，解放CPU，这就是零拷贝技术。\n3.2 解决思路 目前来看，零拷贝技术的几个实现手段包括: mmap+write、sendfile、sendfile+DMA收集、splice等。\n3.2.1 mmap方式 mmap是Linux提供的一种内存映射文件的机制，它实现了将内核中读缓冲区地址与用户空间缓冲区地址进行映射，从而实现内核缓冲区与用户缓冲区的共享。\n这样就减少了一次用户态和内核态的CPU拷贝，但是在内核空间仍有一次CPU拷贝\nmmap对大文件传输有一定优势，但是小文件可能出现碎片，并且在多个进程同时操作文件时可能产生coredump的signal。\n3.2.2 sendfile方式 mmap+write方式有一定改进，但是由系统调用引起的状态切换并没有减少。\nsendfile系统调用实在Linux内核2.1版本中被引入，它建立了两个文件之间的传输通道。\nsendfile方式只使用一个函数就可以完成之前的read+write和mmap+write的功能，这样就减少了2次状态切换，由于数据不经过用户缓冲区，因此该数据无法被修改\n3.2.3 sendfile+DMA收集 Linux2.4内核对 sendfile系统调用进行优化，但是需要硬件DMA控制器的配合。\n升级之后的sendfile将内核空间缓冲区中对应的数据描述信息记录到socket缓冲区中。\nDMA控制器根据socket缓冲区中的地址和偏移量将数据从内核缓冲区拷贝到网卡中，从而省去了内核空间中仅剩的一次CPU拷贝\n这种方式有2次状态切换，0次CPU拷贝、2次DMA拷贝，但是仍然无法对数据进行修改，并且需要硬件层面DMA的支持，并且sendfile只能将文件的数据拷贝到socket描述符上，有一定的局限性。\n3.2.4 splice方式 splice系统调用是Linux在2.6版本引入的，其不需要硬件支持，并且不再限定于socket上，实现两个普通文件之间的数据零拷贝。\nsplice系统调用可以在内核缓冲区和socket缓冲区之间建立管道来传输数据，避免了两者之间的CPU拷贝操作。\nJAVA NIO零拷贝 在Java NIO中的\n通道就相当于操作系统的内核空间的缓冲区，而缓冲区对应的相当于操作系统的用户空间中的用户缓冲区。\n通道是全双工的(双向运输)，它既可能是读缓冲区，也可能是网络缓冲区 缓冲区分为堆内存和堆外内存，这是通过malloc分配出来的用户态内存。 堆外内存在使用后需要应用程序手动回收，而堆内存在数据GC时可能被自动回收。因此，在使用HeapBuffer读写数据时，为了避免缓冲区数据因为GC丢失，NIO会先把HeapBuffer内部的数据拷贝到一个临时的DirectBuffer中的本地内存，这个拷贝涉及到sun.misc.Usafe.copyMemory()的调用，背后的实现原理于memcpy()类似。最后，将临时生成的DirectBuffer内部的数据的内存地址传给I/O调用函数，这样就避免了再去访问Java对象处理I/O读写。\nMAppedByteBuffer MappedBytyBuffer是NIO基于\"内存映射(mmap)“这种零拷贝方式的提供的一种实现，它继承自ByteBuffer。FileChannel定义了一个map()方法，它可以把一个文件从position位置开始的size大小的区域映射为内存映像文件。抽象方法map()方法在FileChannel中的定义如下:\n1 2 public abstract MappedByteBuffer map(MapMode mode, long position, long size) throws IOException; mode:限定内存映射区域对内存映像文件的访问模式，包括只可读、可读可写和写时拷贝三种模式。 position: 文件映射的起始地址，对应内存映射区域的首地址。 size: 文件映射的字节长度，从position往后的字节数，对应内存映射区域的大小。 MappedByteBuffer相比ByteBuffer新增了fore()、load()和isLoad()三个重要方法:\nfore(): 对于处于READ_WRITE模式下的缓冲区，把对缓冲区内容的修改强制刷新到本地文件。 load(): 将缓冲区的内容载入到物理内存中，并返回这个缓冲区的引用 isLoad(): 如果缓冲区的内容在物理内存中，则返回true，否则返回false。 下面给出一个利用MappedByteBuffer对文件进行读写的使用示例:\n1 2 3 private final static String CONTENT = \"Zero copy implemented by MappedByteBuffer\"; private final static String FILE_NAME = \"/mmap.txt\"; private final static String CHARSET = \"UTF-8\"; 写文件数据:打开文件通道fileChannel并提供读权限、写权限和数据清空权限，通过fileChannel映射到一个可写的内存缓冲区mappedByteBUffer，将目标数据写入mappedByteBuffer，通过force()方法把缓冲区更改的内容强制写入本地文件 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 @Test public void writeToFileByMappedByteBuffer() { Path path = Paths.get(getClass().getResource(FILE_NAME).getPath()); byte[] bytes = CONTENT.getBytes(Charset.forName(CHARSET)); try (FileChannel fileChannel = FileChannel.open(path, StandardOpenOption.READ, StandardOpenOption.WRITE, StandardOpenOption.TRUNCATE_EXISTING)) { MappedByteBuffer mappedByteBuffer = fileChannel.map(READ_WRITE, 0, bytes.length); if (mappedByteBuffer != null) { mappedByteBuffer.put(bytes); mappedByteBuffer.force(); } } catch (IOException e) { e.printStackTrace(); } } 读文件数据:打开文件通道fileChannel并提供只读权限，通过fileChannel映射到一个只可读的内存缓冲区mappedByteBuffer，读取mappedByteBuffer中的字节数组即可得到文件数据。 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 @Test public void readFromFileByMappedByteBuffer() { Path path = Paths.get(getClass().getResource(FILE_NAME).getPath()); int length = CONTENT.getBytes(Charset.forName(CHARSET)).length; try (FileChannel fileChannel = FileChannel.open(path, StandardOpenOption.READ)) { MappedByteBuffer mappedByteBuffer = fileChannel.map(READ_ONLY, 0, length); if (mappedByteBuffer != null) { byte[] bytes = new byte[length]; mappedByteBuffer.get(bytes); String content = new String(bytes, StandardCharsets.UTF_8); assertEquals(content, \"Zero copy implemented by MappedByteBuffer\"); } } catch (IOException e) { e.printStackTrace(); } } 下面介绍map()方法的底层实现原理。map()方法是java.nio.channels.FileChannel的抽象方法，由子类sun.nio.ch.FIleChannelImpl.java实现，下面是和内存映射相关的核心代码:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 public MappedByteBuffer map(MapMode mode, long position, long size) throws IOException { int pagePosition = (int)(position % allocationGranularity); long mapPosition = position - pagePosition; long mapSize = size + pagePosition; try { addr = map0(imode, mapPosition, mapSize); } catch (OutOfMemoryError x) { System.gc(); try { Thread.sleep(100); } catch (InterruptedException y) { Thread.currentThread().interrupt(); } try { addr = map0(imode, mapPosition, mapSize); } catch (OutOfMemoryError y) { throw new IOException(\"Map failed\", y); } } int isize = (int)size; Unmapper um = new Unmapper(addr, mapSize, isize, mfd); if ((!writable) || (imode == MAP_RO)) { return Util.newMappedByteBufferR(isize, addr + pagePosition, mfd, um); } else { return Util.newMappedByteBuffer(isize, addr + pagePosition, mfd, um); } } map()方法通过本地方法map0()为文件分配一块虚拟内存，作为它的内存映射区域，然后返回这块内存映射区域的起始地址。\n文件映射需要在Java堆中创建一个MappedByteBuffer的实例。如果第一次文件映射导致OOM，则手动触发垃圾回收，休眠100ms后再次尝试映射，如果失败则抛出异常。 通过Util的newMappedByteBUffer方法或者newMappedByteBufferR方法反射创建一个DirectByteBuffer实例，其中DirectByteBuffer是MappedByteBUffer的子类。 map()方法返回的是内存映射区域的起始地址，通过(起始地址+偏移量)就可以获取指定内存的数据。这样一定程度上替代了read或write()方法，底层直接采用sun.misc.Unsafe类的getByte()和putByte()方法对数据进行读写。\n1 private native long map0(int prot, long position, long mapSize) throws IOException; 上面是本地方法map0的定义，它通过JNI调用底层C的实现，这个native函数的实现位于JDK源码包下。 native/sun/nio/ch/FileChannelImpl.c这个源文件里\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 JNIEXPORT jlong JNICALL Java_sun_nio_ch_FileChannelImpl_map0(JNIEnv *env, jobject this, jint prot, jlong off, jlong len) { void *mapAddress = 0; jobject fdo = (*env)-\u003eGetObjectField(env, this, chan_fd); jint fd = fdval(env, fdo); int protections = 0; int flags = 0; if (prot == sun_nio_ch_FileChannelImpl_MAP_RO) { protections = PROT_READ; flags = MAP_SHARED; } else if (prot == sun_nio_ch_FileChannelImpl_MAP_RW) { protections = PROT_WRITE | PROT_READ; flags = MAP_SHARED; } else if (prot == sun_nio_ch_FileChannelImpl_MAP_PV) { protections = PROT_WRITE | PROT_READ; flags = MAP_PRIVATE; } mapAddress = mmap64( 0, /* Let OS decide location */ len, /* Number of bytes to map */ protections, /* File permissions */ flags, /* Changes are shared */ fd, /* File descriptor of mapped file */ off); /* Offset into file */ if (mapAddress == MAP_FAILED) { if (errno == ENOMEM) { JNU_ThrowOutOfMemoryError(env, \"Map failed\"); return IOS_THROWN; } return handle(env, -1, \"Map failed\"); } return ((jlong) (unsigned long) mapAddress); } 可以看出map0()函数最终是通过mmap65()这个函数对Linux底层内核发出的内存映射调用，mmap64()函数的原型如下:\n1 2 3 #include void *mmap64(void *addr, size_t len, int prot, int flags, int fd, off64_t offset); 下面详细介绍以下mmap64()函数各个参数的含义以及参数可选值:\naddr: 文件在用户进程空间的内存映射区中的起始地址，是一个建议的参数，通常可设置为0或null，此时由内核去决定真实的起始地址。当+flag为MAP_FIXED时，addr就是一个必选的参数，即需要提供一个存在的地址。 len:文件需要进行内存映射的长度 prot:控制用户进程对内存映射区的访问权限。 PROT_READ: 读权限 PROT_WRITE: 写权限 PROT_EXEC: 执行权限 PROT_NONE: 无权限 flags: 控制内存映射区的修改是否被多个进程共享 MAP_PRIVATE: 对内存映射区数据的修改不会反映到真正的文件，数据修改发生时采用写时复制机制。 MAP_SHARED: 对内存映射区的修改会同步到真正的文件，修改对共享此内存映射区的进程是可见的。 MAP_FIXED: 不建议使用，这种模式下addr参数指定的必须的提供一个存在的addr参数。 fd: 文件描述符。每次Map操作会导致文件的引用计数加1，每次unmap操作或者结束进程会导致引用计数减1 offset: 文件偏移量。进行映射的文件位置，从文件起始地址向后的位移量 下面总结一下MappedByteBuffer的特点和不足之处:\nMappedByteBuffer使用是堆外的虚拟内存，因此分配的内存大小不受JVM的-Xmx参数限制，但是也是有大小限制的。如果当文件超出Integer.MAX_VALUE字节限制时，可以通过position参数重新map文件后面的内容。 MappedByteBuffer在处理大文件时性能的确很高，但是也存在内存占用，文件关闭不确定等问题，被其打开的文件只有在垃圾回收的时候才会被关闭，而且这个时间点是不确定的。 MappedByteBuffer提供了文件映射内存的mmap()方法，也提供了释放映射内存的unmap()方法。然而unmap()是FileChannelImpl中的私有方法，无法直接显示调用。因此，用户程序需要通过Java反射的调用sun.misc.Cleaner类的clean()方法手动释放映射占用的内存区域。 1 2 3 4 5 6 7 8 9 10 11 12 public static void clean(final Object buffer) throws Exception { AccessController.doPrivileged((PrivilegedAction) () -\u003e { try { Method getCleanerMethod = buffer.getClass().getMethod(\"cleaner\", new Class[0]); getCleanerMethod.setAccessible(true); Cleaner cleaner = (Cleaner) getCleanerMethod.invoke(buffer, new Object[0]); cleaner.clean(); } catch(Exception e) { e.printStackTrace(); } }); } DirectByteBuffer DirectByteBUffer 的对象引用位于Java 内存模型的堆里面，JVM可以对DirectByteBUffer的对象进行内存分配和回收管理，一般使用DirectByteBuffer的静态方法allocateDirect()创建DIrectByteBuffer实例并分配内存。\n1 2 3 public static ByteBuffer allocateDirect(int capacity) { return new DirectByteBuffer(capacity); } DirectByteBUffer内部的字节缓冲区位在于堆外的直接内存，它是通过Unsafe的本地方法allocateMemory()进行内存分配，底层调用的是操作系统的malloc()函数。\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 DirectByteBuffer(int cap) { super(-1, 0, cap, cap); boolean pa = VM.isDirectMemoryPageAligned(); int ps = Bits.pageSize(); long size = Math.max(1L, (long)cap + (pa ? ps : 0)); Bits.reserveMemory(size, cap); long base = 0; try { base = unsafe.allocateMemory(size); } catch (OutOfMemoryError x) { Bits.unreserveMemory(size, cap); throw x; } unsafe.setMemory(base, size, (byte) 0); if (pa \u0026\u0026 (base % ps != 0)) { address = base + ps - (base \u0026 (ps - 1)); } else { address = base; } cleaner = Cleaner.create(this, new Deallocator(base, size, cap)); att = null; } 除此之外，初始化DIrectByteBuffer时还会创建一个Deallocator线程，并通过Cleaner的freeMemory()方法来直接对内存进行回收操作，freeMemory()底层调用的是操作系统的free()函数。\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 private static class Deallocator implements Runnable { private static Unsafe unsafe = Unsafe.getUnsafe(); private long address; private long size; private int capacity; private Deallocator(long address, long size, int capacity) { assert (address != 0); this.address = address; this.size = size; this.capacity = capacity; } public void run() { if (address == 0) { return; } unsafe.freeMemory(address); address = 0; Bits.unreserveMemory(size, capacity); } } 由于使用DirectByteBuffer分配的是系统本地的内存，不在JVM的管控范围之内，因此直接内存的回收和堆内存的回收不同，直接内存如果使用不当，很容易造成OutOfMemoryError。\n说了这么多，那么DirectByteBuffer和零拷贝有什么关系？前面有提到在MappedByteBuffer进行内存映射时，它的map()方法会通过Util.newMappedByteBuffer()来创建一个缓冲区实例，初始化代码如下:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 static MappedByteBuffer newMappedByteBuffer(int size, long addr, FileDescriptor fd, Runnable unmapper) { MappedByteBuffer dbb; if (directByteBufferConstructor == null) initDBBConstructor(); try { dbb = (MappedByteBuffer)directByteBufferConstructor.newInstance( new Object[] { new Integer(size), new Long(addr), fd, unmapper }); } catch (InstantiationException | IllegalAccessException | InvocationTargetException e) { throw new InternalError(e); } return dbb; } private static void initDBBRConstructor() { AccessController.doPrivileged(new PrivilegedAction() { public Void run() { try { Class\u003c?\u003e cl = Class.forName(\"java.nio.DirectByteBufferR\"); Constructor\u003c?\u003e ctor = cl.getDeclaredConstructor( new Class\u003c?\u003e[] { int.class, long.class, FileDescriptor.class, Runnable.class }); ctor.setAccessible(true); directByteBufferRConstructor = ctor; } catch (ClassNotFoundException | NoSuchMethodException | IllegalArgumentException | ClassCastException x) { throw new InternalError(x); } return null; }}); } DirectByteBuffer是MappedByteBuffer的具体实现类。实际上，Util.newMappedByteBUffer()方法通过反射机制获取DirectByteBuffer的构造器，然后创建一个DirectByteBUffer的实例，对应的是一个单独用于内存映射的构造方法:\n1 2 3 4 5 6 protected DirectByteBuffer(int cap, long addr, FileDescriptor fd, Runnable unmapper) { super(-1, 0, cap, cap, fd); address = addr; cleaner = Cleaner.create(this, unmapper); att = null; } 因此除了允许分配操作系统的直接内存之外，DirectByteBuffer本身也具有文件映射的功能，这里不做过多说明。我们需要关注的是，DirectByteBuffer在MappedByteBuffer的基础上提供了内存映像文件的随机读取get()和写入write()操作。\n1 2 3 4 5 6 7 public byte get() { return ((unsafe.getByte(ix(nextGetIndex())))); } public byte get(int i) { return ((unsafe.getByte(ix(checkIndex(i))))); } 1 2 3 4 5 6 7 8 9 public ByteBuffer put(byte x) { unsafe.putByte(ix(nextPutIndex()), ((x))); return this; } public ByteBuffer put(int i, byte x) { unsafe.putByte(ix(checkIndex(i)), ((x))); return this; } 内存映像文件的随机读写都是借助ix()方法实现定位的，ix()方法通过内存映射空间的内存首地址和给定偏移量i计算出指针地址，然后由unsafe类的get()和put()方法和对指针指向的数据进行读取或写入。\n1 2 3 private long ix(int i) { return address + ((long)i \u003c\u003c 0); } FileChannel FileChannel是一个用户文件读写，映射和操作的通道，同时它在并发环境下是线程安全的，基于FileInputStream、FileOutputStream或者RandomAccessFile的getChannel()方法可以创建并打开一个文件通道。FIleChannel定义了transferFrom()和transferTo()两个抽象方法，它通过在通道和通道之间建立连接实现数据传输的。\ntransferTo(): 通过FileChannel把文件里面的源数据写入一个WritableByteChannel的目的通道 1 2 public abstract long transferTo(long position, long count, WritableByteChannel target) throws IOException; transferFrom(): 把一个源通道ReadableByteChannel中的数据读取到当前FIleChannel的文件里面。 1 2 public abstract long transferFrom(ReadableByteChannel src, long position, long count) throws IOException; 下面给出FileChannel利用transferTo()和transferFrom()方法进行数据传输的使用示例:\n1 2 3 4 private static final String CONTENT = \"Zero copy implemented by FileChannel\"; private static final String SOURCE_FILE = \"/source.txt\"; private static final String TARGET_FILE = \"/target.txt\"; private static final String CHARSET = \"UTF-8\"; 首先在类加载根路径下创建source.txt和target.txt两个文件，对源文件source.txt文件写入初始化数据。\n1 2 3 4 5 6 7 8 9 10 11 @Before public void setup() { Path source = Paths.get(getClassPath(SOURCE_FILE)); byte[] bytes = CONTENT.getBytes(Charset.forName(CHARSET)); try (FileChannel fromChannel = FileChannel.open(source, StandardOpenOption.READ, StandardOpenOption.WRITE, StandardOpenOption.TRUNCATE_EXISTING)) { fromChannel.write(ByteBuffer.wrap(bytes)); } catch (IOException e) { e.printStackTrace(); } } 对于transferTo()方法而言，目的通道toChannel可以是任意的单向字节通道WritableByteChannel;而对于transferFrom()方法而言，源通道fromChannel可以是任意的单项字节读通道ReadableByteChannel。其中，FileChannel、SocketChannel和DatagramChannel等通道实现了WriteByteChannel和ReadableByteChannel接口，都是同时支持读写的双向通道。为了方便测试，下面给出基于FileChannel完成channel-to-channel的数据传输示例:\n1 2 3 4 5 6 7 8 9 10 11 @Test public void transferTo() throws Exception { try (FileChannel fromChannel = new RandomAccessFile( getClassPath(SOURCE_FILE), \"rw\").getChannel(); FileChannel toChannel = new RandomAccessFile( getClassPath(TARGET_FILE), \"rw\").getChannel()) { long position = 0L; long offset = fromChannel.size(); fromChannel.transferTo(position, offset, toChannel); } } 通过transferFrom()将fromChannel中的数据拷贝到toChannel:\n1 2 3 4 5 6 7 8 9 10 11 @Test public void transferFrom() throws Exception { try (FileChannel fromChannel = new RandomAccessFile( getClassPath(SOURCE_FILE), \"rw\").getChannel(); FileChannel toChannel = new RandomAccessFile( getClassPath(TARGET_FILE), \"rw\").getChannel()) { long position = 0L; long offset = fromChannel.size(); toChannel.transferFrom(fromChannel, position, offset); } } 下面介绍transferTo()和transferFrom()方法的底层实现原理，这两个方法也是java.nio.channels.FIlwChannel的抽象方法，由子类sun.nio.ch.FileChannelImpl.java实现。transferTo()和transferFrom()底层都是基于sendfile实现数据传输的，其中FileChannelImpl.java定义了3个常量，用于标示当前操作系统的内核是否支持sendfile以及sendfile的相关特性。\n1 2 3 private static volatile boolean transferSupported = true; private static volatile boolean pipeSupported = true; private static volatile boolean fileSupported = true; transferSupported:用于标记当前的系统内核是否支持sendfile()调用，默认为true. pipeSupported: 用于标记当前的系统内核是否支持文件描述符基于管道的sendfile()调用，默认为true。 fileSupported: 用于标记当前的系统内核是否支持文件描述符基于文件的sendfile()调用，默认为true. 下面以transfer()的源码实现为例。FIleChannelImpl首先执行transferToDirectly()方法，以sendfile的零拷贝方式数据拷贝。如果系统内核不支持sendfile，进一步执行transferToTrustedChannel()方法，以mmap()的零拷贝方式进行内存映射，这种情况下目的通道必须是FileChannelImpl或者SelChImpl类型。如果以上两步都失败了，则执行transferToArbitraryChannel()方法，基于传统的I/O方式完成读写，具体步骤是初始化一个临时的DirectBuffer，将源通道FileChannel的数据读取到DirectBuffer，再写入目的通道WritableByteChannel里面。\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 public long transferTo(long position, long count, WritableByteChannel target) throws IOException { // 计算文件的大小 long sz = size(); // 校验起始位置 if (position \u003e sz) return 0; int icount = (int)Math.min(count, Integer.MAX_VALUE); // 校验偏移量 if ((sz - position) \u003c icount) icount = (int)(sz - position); long n; if ((n = transferToDirectly(position, icount, target)) \u003e= 0) return n; if ((n = transferToTrustedChannel(position, icount, target)) \u003e= 0) return n; return transferToArbitraryChannel(position, icount, target); } 接下来重点分析一下transferToDirectly()方法的实现，也就是transferTo()通过sendfile实现零拷贝的精髓所在。可以看到，transferToDirectlyInternal()方法先获取到目的的通道WritableByteChannel的文件描述符targetFD，获取同步锁然后执行transferToDirectlyInternal()方法。\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 private long transferToDirectly(long position, int icount, WritableByteChannel target) throws IOException { // 省略从target获取targetFD的过程 if (nd.transferToDirectlyNeedsPositionLock()) { synchronized (positionLock) { long pos = position(); try { return transferToDirectlyInternal(position, icount, target, targetFD); } finally { position(pos); } } } else { return transferToDirectlyInternal(position, icount, target, targetFD); } } 最终由transferToDirectlyInternal()调用本地方法transferTo0()，尝试以sendfile的方式进行数据传输。如果系统内核完全不支持sendfile，比如Windows操作系统，则返回UNSUPPORTED并把transferSupported标识为false。如果系统内核不支持sendfile的一些特性，比如说低版本的Linux内核不支持DMA gather copy 操作，则返回 UNSUPPORTED_CASE 并把pipeSupported 或者 fileSupported标识为false。\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 private long transferToDirectlyInternal(long position, int icount, WritableByteChannel target, FileDescriptor targetFD) throws IOException { assert !nd.transferToDirectlyNeedsPositionLock() || Thread.holdsLock(positionLock); long n = -1; int ti = -1; try { begin(); ti = threads.add(); if (!isOpen()) return -1; do { n = transferTo0(fd, position, icount, targetFD); } while ((n == IOStatus.INTERRUPTED) \u0026\u0026 isOpen()); if (n == IOStatus.UNSUPPORTED_CASE) { if (target instanceof SinkChannelImpl) pipeSupported = false; if (target instanceof FileChannelImpl) fileSupported = false; return IOStatus.UNSUPPORTED_CASE; } if (n == IOStatus.UNSUPPORTED) { transferSupported = false; return IOStatus.UNSUPPORTED; } return IOStatus.normalize(n); } finally { threads.remove(ti); end (n \u003e -1); } } 本地方法transferTo0()通过JNI调用底层C的函数，这个native函数同样位于JDK源码包下的 native.sun/nio/ch/FileChannelImol.c源文件里面。JNI函数java_sun_nio_ch_FileChannelImpl_transferTo0()基于条件编译对不同的系统进行预编译，下面是JDK基于Linux系统内核对transferTo()提供的调用封装。\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 #if defined(__linux__) || defined(__solaris__) #include #elif defined(_AIX) #include #elif defined(_ALLBSD_SOURCE) #include #include #include #define lseek64 lseek #define mmap64 mmap #endif JNIEXPORT jlong JNICALL Java_sun_nio_ch_FileChannelImpl_transferTo0(JNIEnv *env, jobject this, jobject srcFDO, jlong position, jlong count, jobject dstFDO) { jint srcFD = fdval(env, srcFDO); jint dstFD = fdval(env, dstFDO); #if defined(__linux__) off64_t offset = (off64_t)position; jlong n = sendfile64(dstFD, srcFD, \u0026offset, (size_t)count); return n; #elif defined(__solaris__) result = sendfilev64(dstFD, \u0026sfv, 1, \u0026numBytes); return result; #elif defined(__APPLE__) result = sendfile(srcFD, dstFD, position, \u0026numBytes, NULL, 0); return result; #endif } 对Linux、Solaris以及Apple系统而言，transferTo0()函数底层会执行sendfile64这个系统调用完成零拷贝操作，sendfile64()函数原型如下:\n1 2 3 #include ssize_t sendfile64(int out_fd, int in_fd, off_t *offset, size_t count); 下面简单介绍一下sendfile64()函数各个参数的含义:\nout_fd: 待写入的文件描述符 in_fd: 待读取的文件描述符 offset: 指定in_fd对应文件流的读取位置，如果为空，则默认从起始位置开始 count： 指定在文件描述符in_fd和out_fd之间传输的字节数",
  "wordCount" : "9600",
  "inLanguage": "zh",
  "datePublished": "2024-04-23T22:25:58+08:00",
  "dateModified": "2024-04-23T22:25:58+08:00",
  "author":[{
    "@type": "Person",
    "name": "ShengQian"
  }],
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://csqread.top/posts/tech/%E9%9B%B6%E6%8B%B7%E8%B4%9D%E5%AE%9E%E7%8E%B0/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "Qian's Blog",
    "logo": {
      "@type": "ImageObject",
      "url": "https://csqread.top/img/Q.gif"
    }
  }
}
</script>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="https://csqread.top" accesskey="h" title="Qian&#39;s Blog (Alt + H)">
                <img src="https://csqread.top/img/%21.jpg" alt="" aria-label="logo"
                    height="35">Qian&#39;s Blog</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="https://csqread.top/search" title="🔍搜索">
                    <span>🔍搜索</span>
                </a>
            </li>
            <li>
                <a href="https://csqread.top/" title="🏠主页">
                    <span>🏠主页</span>
                </a>
            </li>
            <li>
                <a href="https://csqread.top/posts" title="📚文章">
                    <span>📚文章</span>
                </a>
            </li>
            <li>
                <a href="https://csqread.top/archives/" title="⏱时间轴">
                    <span>⏱时间轴</span>
                </a>
            </li>
            <li>
                <a href="https://csqread.top/tags" title="🔖标签">
                    <span>🔖标签</span>
                </a>
            </li>
            <li>
                <a href="https://csqread.top/about" title="🙋🏻‍♂️关于">
                    <span>🙋🏻‍♂️关于</span>
                </a>
            </li>
            <li>
                <a href="https://csqread.top/links" title="🤝友链">
                    <span>🤝友链</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    <div class="breadcrumbs"><a href="https://csqread.top">主页</a>&nbsp;»&nbsp;<a href="https://csqread.top/posts/">Posts</a>&nbsp;»&nbsp;<a href="https://csqread.top/posts/tech/">技术</a></div>
    <h1 class="post-title">
      零拷贝实现
    </h1>
    <div class="post-meta">










创建:&nbsp;<span title='2024-04-23 22:25:58 +0800 CST'>2024-04-23</span>&nbsp;|&nbsp;更新:&nbsp;2024-04-23&nbsp;|&nbsp;字数:&nbsp;9600字&nbsp;|&nbsp;时长: 20分钟&nbsp;|&nbsp;
作者:&nbsp;ShengQian


    &nbsp;|&nbsp;标签: &nbsp;
    <ul class="post-tags-meta">
        <a href="https://csqread.top/tags/java/">Java</a>
    </ul>

    
    
    
    
    <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    <span id="busuanzi_container_page_pv">
        &nbsp;| 访问: <span id="busuanzi_value_page_pv"></span>
    </span>

    
    
    
    
    <script src="https://cdn.staticfile.org/twikoo/1.4.11/twikoo.all.min.js">
    </script>
    <script>
        let url = document.documentURI
        
        let dnsUrl = "https://csqread.top"
        let urlSplit = url.split(dnsUrl)
        let finalUrl = urlSplit[1]
        if (finalUrl[0] !== '/') {
            finalUrl = '/'+finalUrl
        }
        twikoo.getCommentsCount({
            envId:  null ,
            region:  null ,
            urls: [
                finalUrl,
            ],
            includeReply: false 
        }).then(function (res) {
            let count = res[0].count
            const obj = document.getElementById("comment_count");
            obj.innerText = count
            
            
            
        }).catch(function (err) {
            
            console.error(err);
        });
    </script>
    &nbsp;| 评论: &nbsp; <span id="comment_count"></span>

</div>
  </header> <aside id="toc-container" class="toc-container wide">
    <div class="toc">
        <details  open>
            <summary accesskey="c" title="(Alt + C)">
                <span class="details">目录</span>
            </summary>

            <div class="inner"><ul>
                    <li>
                        <a href="#linux%e4%b8%ad%e7%9a%84%e9%9b%b6%e6%8b%b7%e8%b4%9d" aria-label="Linux中的零拷贝">Linux中的零拷贝</a><ul>
                            
                    <li>
                        <a href="#1-%e6%95%b0%e6%8d%ae%e6%8b%b7%e8%b4%9d%e5%9f%ba%e7%a1%80%e8%bf%87%e7%a8%8b" aria-label="1. 数据拷贝基础过程">1. 数据拷贝基础过程</a><ul>
                            
                    <li>
                        <a href="#11-%e4%bb%85cpu%e6%96%b9%e5%bc%8f" aria-label="1.1 仅CPU方式">1.1 仅CPU方式</a></li>
                    <li>
                        <a href="#12-cpudma%e6%96%b9%e5%bc%8f" aria-label="1.2 CPU&amp;amp;DMA方式">1.2 CPU&amp;DMA方式</a></li></ul>
                    </li>
                    <li>
                        <a href="#2-%e6%99%ae%e9%80%9a%e6%a8%a1%e5%bc%8f%e6%95%b0%e6%8d%ae%e4%ba%a4%e4%ba%92" aria-label="2. 普通模式数据交互">2. 普通模式数据交互</a></li>
                    <li>
                        <a href="#3-%e9%9b%b6%e6%8b%b7%e8%b4%9d%e6%8a%80%e6%9c%af" aria-label="3. 零拷贝技术">3. 零拷贝技术</a><ul>
                            
                    <li>
                        <a href="#31-%e5%87%ba%e7%8e%b0%e5%8e%9f%e5%9b%a0" aria-label="3.1 出现原因">3.1 出现原因</a></li>
                    <li>
                        <a href="#32-%e8%a7%a3%e5%86%b3%e6%80%9d%e8%b7%af" aria-label="3.2 解决思路">3.2 解决思路</a><ul>
                            
                    <li>
                        <a href="#321-mmap%e6%96%b9%e5%bc%8f" aria-label="3.2.1 mmap方式">3.2.1 mmap方式</a></li>
                    <li>
                        <a href="#322-sendfile%e6%96%b9%e5%bc%8f" aria-label="3.2.2 sendfile方式">3.2.2 sendfile方式</a></li>
                    <li>
                        <a href="#323-sendfiledma%e6%94%b6%e9%9b%86" aria-label="3.2.3 sendfile&#43;DMA收集">3.2.3 sendfile+DMA收集</a></li>
                    <li>
                        <a href="#324-splice%e6%96%b9%e5%bc%8f" aria-label="3.2.4 splice方式">3.2.4 splice方式</a></li></ul>
                    </li></ul>
                    </li></ul>
                    </li>
                    <li>
                        <a href="#java-nio%e9%9b%b6%e6%8b%b7%e8%b4%9d" aria-label="JAVA NIO零拷贝">JAVA NIO零拷贝</a></li>
                    <li>
                        <a href="#mappedbytebuffer" aria-label="MAppedByteBuffer">MAppedByteBuffer</a></li>
                    <li>
                        <a href="#directbytebuffer" aria-label="DirectByteBuffer">DirectByteBuffer</a></li>
                    <li>
                        <a href="#filechannel" aria-label="FileChannel">FileChannel</a>
                    </li>
                </ul>
            </div>
        </details>
    </div>
</aside>
<script>
    let activeElement;
    let elements;
    window.addEventListener('DOMContentLoaded', function (event) {
        checkTocPosition();

        elements = document.querySelectorAll('h1[id],h2[id],h3[id],h4[id],h5[id],h6[id]');
         
         activeElement = elements[0];
         const id = encodeURI(activeElement.getAttribute('id')).toLowerCase();
         document.querySelector(`.inner ul li a[href="#${id}"]`).classList.add('active');
     }, false);

    window.addEventListener('resize', function(event) {
        checkTocPosition();
    }, false);

    window.addEventListener('scroll', () => {
        
        activeElement = Array.from(elements).find((element) => {
            if ((getOffsetTop(element) - window.pageYOffset) > 0 && 
                (getOffsetTop(element) - window.pageYOffset) < window.innerHeight/2) {
                return element;
            }
        }) || activeElement

        elements.forEach(element => {
             const id = encodeURI(element.getAttribute('id')).toLowerCase();
             if (element === activeElement){
                 document.querySelector(`.inner ul li a[href="#${id}"]`).classList.add('active');
             } else {
                 document.querySelector(`.inner ul li a[href="#${id}"]`).classList.remove('active');
             }
         })
     }, false);

    const main = parseInt(getComputedStyle(document.body).getPropertyValue('--article-width'), 10);
    const toc = parseInt(getComputedStyle(document.body).getPropertyValue('--toc-width'), 10);
    const gap = parseInt(getComputedStyle(document.body).getPropertyValue('--gap'), 10);

    function checkTocPosition() {
        const width = document.body.scrollWidth;

        if (width - main - (toc * 2) - (gap * 4) > 0) {
            document.getElementById("toc-container").classList.add("wide");
        } else {
            document.getElementById("toc-container").classList.remove("wide");
        }
    }

    function getOffsetTop(element) {
        if (!element.getClientRects().length) {
            return 0;
        }
        let rect = element.getBoundingClientRect();
        let win = element.ownerDocument.defaultView;
        return rect.top + win.pageYOffset;   
    }
</script>
  <div class="post-content"><h2 id="linux中的零拷贝">Linux中的零拷贝<a hidden class="anchor" aria-hidden="true" href="#linux中的零拷贝">#</a></h2>
<h3 id="1-数据拷贝基础过程">1. 数据拷贝基础过程<a hidden class="anchor" aria-hidden="true" href="#1-数据拷贝基础过程">#</a></h3>
<p>在Linux系统内部缓存和内存容量都是有限的，更多的数据都是存储在磁盘中。对于Web服务器来说，经常需要从磁盘中读取数据的内存，然后通过网卡传输给用户</p>
<p><img loading="lazy" src="https://s2.loli.net/2024/04/21/wpAEhHmgOQLBnYf.png" alt="127449894-80a158a7-c372-4fef-9466-29aab372762a.png"  />
</p>
<h4 id="11-仅cpu方式">1.1 仅CPU方式<a hidden class="anchor" aria-hidden="true" href="#11-仅cpu方式">#</a></h4>
<li>当应用程序需要读取磁盘数据时，调用read()从用户态陷入内核态，read()这个系统调用最终由CPU来完成</li>
<li>CPU向磁盘发起I/O请求，磁盘收到之后开始准备数据</li>
<li>磁盘将数据放到磁盘缓冲区之后，向CPU发起I/O中断，告诉CPU数据已经ready了</li>
<li>CPU收到磁盘控制器的I/O中断之后，开始拷贝数据，完成之后read()返回，再从内核态切换到用户态</li>
<p><img loading="lazy" src="https://s2.loli.net/2024/04/21/RZdBEX65VgjiTCU.png" alt="127450013-8ab8b3b6-e17c-4a23-88bf-50ca3d1f37df.png"  />
</p>
<h4 id="12-cpudma方式">1.2 CPU&amp;DMA方式<a hidden class="anchor" aria-hidden="true" href="#12-cpudma方式">#</a></h4>
<p>CPU的时间宝贵，让它做杂活就是浪费资源</p>
<p>直接内存访问(Direct Memory Access)，是一种硬件设备绕开COU独立直接访问内存的机制。所以DMA再一定程度上解放了CPU，把之前CPU的杂货让硬件直接自己做了，提高了CPU效率。</p>
<p>目前支持DMA的硬件包括:网卡、声卡、显卡、洗盘控制器等。</p>
<p>有了DMA的参与之后的流程发生了一些变化</p>
<p>最主要的变化是，CPU不再和磁盘直接交互，而是DMA和磁盘交互并且将数据从磁盘缓冲区拷贝到内核缓冲区，之后的过程类似。</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>无论从仅CPU的方式和DMA&amp;CPU的方式，都存在多次冗余数据拷贝和内核态&amp;用户态的切换。
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="2-普通模式数据交互">2. 普通模式数据交互<a hidden class="anchor" aria-hidden="true" href="#2-普通模式数据交互">#</a></h3>
<p>一次完成的数据交互包括几个部分:系统调用syscall、CPU、DMA、网卡、磁盘等</p>
<p><img loading="lazy" src="https://s2.loli.net/2024/04/21/JqjFiTUvpfMCOeu.png" alt="127450145-ec9cca4a-3aeb-4f55-9f50-e33980f94602.png"  />
</p>
<p>系统调用syscall是应用程序和内核交互的桥梁，每次进行调用/返回就会产生两次切换:</p>
<li>调用syscall从用户态切换到内核态</li>
<li>syscall返回从内核台切换到用户态</li>
<p><img loading="lazy" src="https://s2.loli.net/2024/04/21/MciHAhs8JpVDFQR.png" alt="127450184-5a82e639-f93d-4159-8a22-072dfb13b014.png"  />
</p>
<p>下图是完整的数据拷贝过程简图:</p>
<p><img loading="lazy" src="https://s2.loli.net/2024/04/21/tTVsUPMc1G4hIFb.png" alt="127450210-cdb1cdf3-b4e9-47e3-b83d-8c6e39a44240.png"  />
</p>
<p><br>读数据过程:</br></p>
<li>应用程序要读取磁盘数据，调用read()函数从而实现用户态切换内核态，这是第一次切换</li>
<li>DMA控制器将数据从磁盘拷贝到内核缓冲区，这是第一次DMA拷贝</li>
<li>CPU将数据从内核缓冲区复制到用户缓冲区，这是第一次CPU拷贝</li>
<li>CPU拷贝完成之后，read()函数返回实现内核态切换用户态，这是第2次状态切换</li>
<p><br>写数据过程:</br></p>
<li>应用程序要向网卡写数据，调用write()函数实现用户态切换内核态，这是第一次切换</li>
<li>CPU将用户缓冲区数据拷贝到内核缓冲区，这是第一次CPU拷贝</li>
<li>DMA控制器将数据从内核缓冲区复制到socket缓冲区，这是第一次DMA拷贝</li>
<li>完成拷贝之后，write()函数返回实现内核态切换用户态，这是第二次切换</li>
<p><br>综上所述:</br></p>
<li>读过程涉及2次空间切换、1次DMA拷贝、1次CPU拷贝</li>
<li>写过程涉及2次空间切换，1次DMA拷贝，1次CPU拷贝</li>
<p>可见传统模式下，涉及多次空间切换和数据冗余拷贝，效率并不高，接下来就该零拷贝技术出场了。</p>
<h3 id="3-零拷贝技术">3. 零拷贝技术<a hidden class="anchor" aria-hidden="true" href="#3-零拷贝技术">#</a></h3>
<h4 id="31-出现原因">3.1 出现原因<a hidden class="anchor" aria-hidden="true" href="#31-出现原因">#</a></h4>
<p>可以看到，如果应用程序读取磁盘数据，从内核缓冲区到用户缓冲区，再从用户缓冲区到内核缓冲区。两次数据拷贝都需要CPU的参与，并且涉及用户态与内核态的多次切换，加重了CPU负担。需要降低冗余数据拷贝，解放CPU，这就是零拷贝技术。</p>
<h4 id="32-解决思路">3.2 解决思路<a hidden class="anchor" aria-hidden="true" href="#32-解决思路">#</a></h4>
<p>目前来看，零拷贝技术的几个实现手段包括: mmap+write、sendfile、sendfile+DMA收集、splice等。</p>
<h5 id="321-mmap方式">3.2.1 mmap方式<a hidden class="anchor" aria-hidden="true" href="#321-mmap方式">#</a></h5>
<p>mmap是Linux提供的一种内存映射文件的机制，它实现了将内核中读缓冲区地址与用户空间缓冲区地址进行映射，从而实现内核缓冲区与用户缓冲区的共享。</p>
<p>这样就减少了一次用户态和内核态的CPU拷贝，但是在内核空间仍有一次CPU拷贝</p>
<p>mmap对大文件传输有一定优势，但是小文件可能出现碎片，并且在多个进程同时操作文件时可能产生coredump的signal。</p>
<p><img loading="lazy" src="https://s2.loli.net/2024/04/21/QdJ9OZfyU5suobW.png" alt="127450469-dc43f9d9-44c5-490f-b70e-69a161bdd45a.png"  />
</p>
<h5 id="322-sendfile方式">3.2.2 sendfile方式<a hidden class="anchor" aria-hidden="true" href="#322-sendfile方式">#</a></h5>
<p>mmap+write方式有一定改进，但是由系统调用引起的状态切换并没有减少。</p>
<p>sendfile系统调用实在Linux内核2.1版本中被引入，它建立了两个文件之间的传输通道。</p>
<p>sendfile方式只使用一个函数就可以完成之前的read+write和mmap+write的功能，这样就减少了2次状态切换，由于数据不经过用户缓冲区，因此该数据无法被修改</p>
<p><img loading="lazy" src="https://s2.loli.net/2024/04/21/mODIoP54kARy3TC.png" alt="127450545-0a62516f-b836-43b6-aa45-6e95d190f5ca.png"  />
</p>
<h5 id="323-sendfiledma收集">3.2.3 sendfile+DMA收集<a hidden class="anchor" aria-hidden="true" href="#323-sendfiledma收集">#</a></h5>
<p>Linux2.4内核对 sendfile系统调用进行优化，但是需要硬件DMA控制器的配合。</p>
<p>升级之后的sendfile将内核空间缓冲区中对应的数据描述信息记录到socket缓冲区中。</p>
<p>DMA控制器根据socket缓冲区中的地址和偏移量将数据从内核缓冲区拷贝到网卡中，从而省去了内核空间中仅剩的一次CPU拷贝</p>
<p>这种方式有2次状态切换，0次CPU拷贝、2次DMA拷贝，但是仍然无法对数据进行修改，并且需要硬件层面DMA的支持，并且sendfile只能将文件的数据拷贝到socket描述符上，有一定的局限性。</p>
<p><img loading="lazy" src="https://s2.loli.net/2024/04/21/58H7dP9oslzuYEy.png" alt="127450590-70ca2ef8-075a-4866-bf5b-c38049656d98.png"  />
</p>
<h5 id="324-splice方式">3.2.4 splice方式<a hidden class="anchor" aria-hidden="true" href="#324-splice方式">#</a></h5>
<p>splice系统调用是Linux在2.6版本引入的，其不需要硬件支持，并且不再限定于socket上，实现两个普通文件之间的数据零拷贝。</p>
<p><img loading="lazy" src="https://s2.loli.net/2024/04/21/u9jJXqtQFPOxk1V.png" alt="127450662-6316fa68-a493-42e2-9de1-b2857794142d.png"  />
</p>
<p>splice系统调用可以在内核缓冲区和socket缓冲区之间建立管道来传输数据，避免了两者之间的CPU拷贝操作。</p>
<h2 id="java-nio零拷贝">JAVA NIO零拷贝<a hidden class="anchor" aria-hidden="true" href="#java-nio零拷贝">#</a></h2>
<p>在Java NIO中的<br>通道就相当于操作系统的内核空间</br>的缓冲区，而缓冲区对应的相当于操作系统的用户空间中的用户缓冲区。</p>
<li>通道是全双工的(双向运输)，它既可能是读缓冲区，也可能是网络缓冲区</li>
<li>缓冲区分为堆内存和堆外内存，这是通过malloc分配出来的用户态内存。</li>
<p>堆外内存在使用后需要应用程序手动回收，而堆内存在数据GC时可能被自动回收。因此，在使用HeapBuffer读写数据时，为了避免缓冲区数据因为GC丢失，NIO会先把HeapBuffer内部的数据拷贝到一个临时的DirectBuffer中的本地内存，这个拷贝涉及到sun.misc.Usafe.copyMemory()的调用，背后的实现原理于memcpy()类似。最后，将临时生成的DirectBuffer内部的数据的内存地址传给I/O调用函数，这样就避免了再去访问Java对象处理I/O读写。</p>
<h2 id="mappedbytebuffer">MAppedByteBuffer<a hidden class="anchor" aria-hidden="true" href="#mappedbytebuffer">#</a></h2>
<p>MappedBytyBuffer是NIO基于&quot;内存映射(mmap)&ldquo;这种零拷贝方式的提供的一种实现，它继承自ByteBuffer。FileChannel定义了一个map()方法，它可以把一个文件从position位置开始的size大小的区域映射为内存映像文件。抽象方法map()方法在FileChannel中的定义如下:</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">abstract</span> MappedByteBuffer map(MapMode mode, <span style="color:#fff;font-weight:bold">long</span> position, <span style="color:#fff;font-weight:bold">long</span> size)
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">throws</span> IOException;
</span></span></code></pre></td></tr></table>
</div>
</div><li>mode:限定内存映射区域对内存映像文件的访问模式，包括只可读、可读可写和写时拷贝三种模式。</li>
<li>position: 文件映射的起始地址，对应内存映射区域的首地址。</li>
<li>size: 文件映射的字节长度，从position往后的字节数，对应内存映射区域的大小。</li>
<p>MappedByteBuffer相比ByteBuffer新增了fore()、load()和isLoad()三个重要方法:</p>
<li>fore(): 对于处于READ_WRITE模式下的缓冲区，把对缓冲区内容的修改强制刷新到本地文件。</li>
<li>load(): 将缓冲区的内容载入到物理内存中，并返回这个缓冲区的引用</li>
<li>isLoad(): 如果缓冲区的内容在物理内存中，则返回true，否则返回false。</li>
<p>下面给出一个利用MappedByteBuffer对文件进行读写的使用示例:</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">private</span> <span style="color:#fff;font-weight:bold">final</span> <span style="color:#fff;font-weight:bold">static</span> String CONTENT = <span style="color:#0ff;font-weight:bold">&#34;Zero copy implemented by MappedByteBuffer&#34;</span>;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">private</span> <span style="color:#fff;font-weight:bold">final</span> <span style="color:#fff;font-weight:bold">static</span> String FILE_NAME = <span style="color:#0ff;font-weight:bold">&#34;/mmap.txt&#34;</span>;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">private</span> <span style="color:#fff;font-weight:bold">final</span> <span style="color:#fff;font-weight:bold">static</span> String CHARSET = <span style="color:#0ff;font-weight:bold">&#34;UTF-8&#34;</span>;
</span></span></code></pre></td></tr></table>
</div>
</div><li>写文件数据:打开文件通道fileChannel并提供读权限、写权限和数据清空权限，通过fileChannel映射到一个可写的内存缓冲区mappedByteBUffer，将目标数据写入mappedByteBuffer，通过force()方法把缓冲区更改的内容强制写入本地文件</li>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>@Test
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">void</span> writeToFileByMappedByteBuffer() {
</span></span><span style="display:flex;"><span>    Path path = Paths.<span style="color:#007f7f">get</span>(getClass().<span style="color:#007f7f">getResource</span>(FILE_NAME).<span style="color:#007f7f">getPath</span>());
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">byte</span>[] bytes = CONTENT.<span style="color:#007f7f">getBytes</span>(Charset.<span style="color:#007f7f">forName</span>(CHARSET));
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">try</span> (FileChannel fileChannel = FileChannel.<span style="color:#007f7f">open</span>(path, StandardOpenOption.<span style="color:#007f7f">READ</span>,
</span></span><span style="display:flex;"><span>            StandardOpenOption.<span style="color:#007f7f">WRITE</span>, StandardOpenOption.<span style="color:#007f7f">TRUNCATE_EXISTING</span>)) {
</span></span><span style="display:flex;"><span>        MappedByteBuffer mappedByteBuffer = fileChannel.<span style="color:#007f7f">map</span>(READ_WRITE, <span style="color:#ff0;font-weight:bold">0</span>, bytes.<span style="color:#007f7f">length</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">if</span> (mappedByteBuffer != <span style="color:#fff;font-weight:bold">null</span>) {
</span></span><span style="display:flex;"><span>            mappedByteBuffer.<span style="color:#007f7f">put</span>(bytes);
</span></span><span style="display:flex;"><span>            mappedByteBuffer.<span style="color:#007f7f">force</span>();
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    } <span style="color:#fff;font-weight:bold">catch</span> (IOException e) {
</span></span><span style="display:flex;"><span>        e.<span style="color:#007f7f">printStackTrace</span>();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><li>读文件数据:打开文件通道fileChannel并提供只读权限，通过fileChannel映射到一个只可读的内存缓冲区mappedByteBuffer，读取mappedByteBuffer中的字节数组即可得到文件数据。</li>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>@Test
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">void</span> readFromFileByMappedByteBuffer() {
</span></span><span style="display:flex;"><span>    Path path = Paths.<span style="color:#007f7f">get</span>(getClass().<span style="color:#007f7f">getResource</span>(FILE_NAME).<span style="color:#007f7f">getPath</span>());
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">int</span> length = CONTENT.<span style="color:#007f7f">getBytes</span>(Charset.<span style="color:#007f7f">forName</span>(CHARSET)).<span style="color:#007f7f">length</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">try</span> (FileChannel fileChannel = FileChannel.<span style="color:#007f7f">open</span>(path, StandardOpenOption.<span style="color:#007f7f">READ</span>)) {
</span></span><span style="display:flex;"><span>        MappedByteBuffer mappedByteBuffer = fileChannel.<span style="color:#007f7f">map</span>(READ_ONLY, <span style="color:#ff0;font-weight:bold">0</span>, length);
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">if</span> (mappedByteBuffer != <span style="color:#fff;font-weight:bold">null</span>) {
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">byte</span>[] bytes = <span style="color:#fff;font-weight:bold">new</span> <span style="color:#fff;font-weight:bold">byte</span>[length];
</span></span><span style="display:flex;"><span>            mappedByteBuffer.<span style="color:#007f7f">get</span>(bytes);
</span></span><span style="display:flex;"><span>            String content = <span style="color:#fff;font-weight:bold">new</span> String(bytes, StandardCharsets.<span style="color:#007f7f">UTF_8</span>);
</span></span><span style="display:flex;"><span>            assertEquals(content, <span style="color:#0ff;font-weight:bold">&#34;Zero copy implemented by MappedByteBuffer&#34;</span>);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    } <span style="color:#fff;font-weight:bold">catch</span> (IOException e) {
</span></span><span style="display:flex;"><span>        e.<span style="color:#007f7f">printStackTrace</span>();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>下面介绍map()方法的底层实现原理。map()方法是java.nio.channels.FileChannel的抽象方法，由子类sun.nio.ch.FIleChannelImpl.java实现，下面是和内存映射相关的核心代码:</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">27
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">28
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> MappedByteBuffer map(MapMode mode, <span style="color:#fff;font-weight:bold">long</span> position, <span style="color:#fff;font-weight:bold">long</span> size) <span style="color:#fff;font-weight:bold">throws</span> IOException {
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">int</span> pagePosition = (<span style="color:#fff;font-weight:bold">int</span>)(position % allocationGranularity);
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">long</span> mapPosition = position - pagePosition;
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">long</span> mapSize = size + pagePosition;
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">try</span> {
</span></span><span style="display:flex;"><span>        addr = map0(imode, mapPosition, mapSize);
</span></span><span style="display:flex;"><span>    } <span style="color:#fff;font-weight:bold">catch</span> (OutOfMemoryError x) {
</span></span><span style="display:flex;"><span>        System.<span style="color:#007f7f">gc</span>();
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">try</span> {
</span></span><span style="display:flex;"><span>            Thread.<span style="color:#007f7f">sleep</span>(<span style="color:#ff0;font-weight:bold">100</span>);
</span></span><span style="display:flex;"><span>        } <span style="color:#fff;font-weight:bold">catch</span> (InterruptedException y) {
</span></span><span style="display:flex;"><span>            Thread.<span style="color:#007f7f">currentThread</span>().<span style="color:#007f7f">interrupt</span>();
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">try</span> {
</span></span><span style="display:flex;"><span>            addr = map0(imode, mapPosition, mapSize);
</span></span><span style="display:flex;"><span>        } <span style="color:#fff;font-weight:bold">catch</span> (OutOfMemoryError y) {
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">throw</span> <span style="color:#fff;font-weight:bold">new</span> IOException(<span style="color:#0ff;font-weight:bold">&#34;Map failed&#34;</span>, y);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">int</span> isize = (<span style="color:#fff;font-weight:bold">int</span>)size;
</span></span><span style="display:flex;"><span>    Unmapper um = <span style="color:#fff;font-weight:bold">new</span> Unmapper(addr, mapSize, isize, mfd);
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">if</span> ((!writable) || (imode == MAP_RO)) {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> Util.<span style="color:#007f7f">newMappedByteBufferR</span>(isize, addr + pagePosition, mfd, um);
</span></span><span style="display:flex;"><span>    } <span style="color:#fff;font-weight:bold">else</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> Util.<span style="color:#007f7f">newMappedByteBuffer</span>(isize, addr + pagePosition, mfd, um);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>map()方法通过本地方法map0()为文件分配一块虚拟内存，作为它的内存映射区域，然后返回这块内存映射区域的起始地址。</p>
<li>文件映射需要在Java堆中创建一个MappedByteBuffer的实例。如果第一次文件映射导致OOM，则手动触发垃圾回收，休眠100ms后再次尝试映射，如果失败则抛出异常。</li>
<li>通过Util的newMappedByteBUffer方法或者newMappedByteBufferR方法反射创建一个DirectByteBuffer实例，其中DirectByteBuffer是MappedByteBUffer的子类。</li>
<p>map()方法返回的是内存映射区域的起始地址，通过(起始地址+偏移量)就可以获取指定内存的数据。这样一定程度上替代了read或write()方法，底层直接采用sun.misc.Unsafe类的getByte()和putByte()方法对数据进行读写。</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">private</span> <span style="color:#fff;font-weight:bold">native</span> <span style="color:#fff;font-weight:bold">long</span> map0(<span style="color:#fff;font-weight:bold">int</span> prot, <span style="color:#fff;font-weight:bold">long</span> position, <span style="color:#fff;font-weight:bold">long</span> mapSize) <span style="color:#fff;font-weight:bold">throws</span> IOException;
</span></span></code></pre></td></tr></table>
</div>
</div><p>上面是本地方法map0的定义，它通过JNI调用底层C的实现，这个native函数的实现位于JDK源码包下。
native/sun/nio/ch/FileChannelImpl.c这个源文件里</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">27
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">28
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">29
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">30
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">31
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">32
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">33
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">34
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">35
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">36
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">37
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">38
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">39
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>JNIEXPORT jlong JNICALL
</span></span><span style="display:flex;"><span>Java_sun_nio_ch_FileChannelImpl_map0(JNIEnv *env, jobject this,
</span></span><span style="display:flex;"><span>                                     jint prot, jlong off, jlong len)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">void</span> *mapAddress = <span style="color:#ff0;font-weight:bold">0</span>;
</span></span><span style="display:flex;"><span>    jobject fdo = (*env)-&gt;GetObjectField(env, this, chan_fd);
</span></span><span style="display:flex;"><span>    jint fd = fdval(env, fdo);
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">int</span> protections = <span style="color:#ff0;font-weight:bold">0</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">int</span> flags = <span style="color:#ff0;font-weight:bold">0</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">if</span> (prot == sun_nio_ch_FileChannelImpl_MAP_RO) {
</span></span><span style="display:flex;"><span>        protections = PROT_READ;
</span></span><span style="display:flex;"><span>        flags = MAP_SHARED;
</span></span><span style="display:flex;"><span>    } <span style="color:#fff;font-weight:bold">else</span> <span style="color:#fff;font-weight:bold">if</span> (prot == sun_nio_ch_FileChannelImpl_MAP_RW) {
</span></span><span style="display:flex;"><span>        protections = PROT_WRITE | PROT_READ;
</span></span><span style="display:flex;"><span>        flags = MAP_SHARED;
</span></span><span style="display:flex;"><span>    } <span style="color:#fff;font-weight:bold">else</span> <span style="color:#fff;font-weight:bold">if</span> (prot == sun_nio_ch_FileChannelImpl_MAP_PV) {
</span></span><span style="display:flex;"><span>        protections =  PROT_WRITE | PROT_READ;
</span></span><span style="display:flex;"><span>        flags = MAP_PRIVATE;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    mapAddress = mmap64(
</span></span><span style="display:flex;"><span>        <span style="color:#ff0;font-weight:bold">0</span>,                    <span style="color:#007f7f">/* Let OS decide location */</span>
</span></span><span style="display:flex;"><span>        len,                  <span style="color:#007f7f">/* Number of bytes to map */</span>
</span></span><span style="display:flex;"><span>        protections,          <span style="color:#007f7f">/* File permissions */</span>
</span></span><span style="display:flex;"><span>        flags,                <span style="color:#007f7f">/* Changes are shared */</span>
</span></span><span style="display:flex;"><span>        fd,                   <span style="color:#007f7f">/* File descriptor of mapped file */</span>
</span></span><span style="display:flex;"><span>        off);                 <span style="color:#007f7f">/* Offset into file */</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">if</span> (mapAddress == MAP_FAILED) {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">if</span> (errno == ENOMEM) {
</span></span><span style="display:flex;"><span>            JNU_ThrowOutOfMemoryError(env, <span style="color:#0ff;font-weight:bold">&#34;Map failed&#34;</span>);
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">return</span> IOS_THROWN;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> handle(env, -<span style="color:#ff0;font-weight:bold">1</span>, <span style="color:#0ff;font-weight:bold">&#34;Map failed&#34;</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">return</span> ((jlong) (<span style="color:#fff;font-weight:bold">unsigned</span> <span style="color:#fff;font-weight:bold">long</span>) mapAddress);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>可以看出map0()函数最终是通过mmap65()这个函数对Linux底层内核发出的内存映射调用，mmap64()函数的原型如下:</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#0f0;font-weight:bold">#include</span> <span style="color:#0f0;font-weight:bold">&lt;sys/mman.h&gt;</span><span style="color:#0f0;font-weight:bold">
</span></span></span><span style="display:flex;"><span><span style="color:#0f0;font-weight:bold"></span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">void</span> *mmap64(<span style="color:#fff;font-weight:bold">void</span> *addr, <span style="color:#fff;font-weight:bold">size_t</span> len, <span style="color:#fff;font-weight:bold">int</span> prot, <span style="color:#fff;font-weight:bold">int</span> flags, <span style="color:#fff;font-weight:bold">int</span> fd, <span style="color:#fff;font-weight:bold">off64_t</span> offset);
</span></span></code></pre></td></tr></table>
</div>
</div><p>下面详细介绍以下mmap64()函数各个参数的含义以及参数可选值:</p>
<li>addr: 文件在用户进程空间的内存映射区中的起始地址，是一个建议的参数，通常可设置为0或null，此时由内核去决定真实的起始地址。当+flag为MAP_FIXED时，addr就是一个必选的参数，即需要提供一个存在的地址。</li>
<li>len:文件需要进行内存映射的长度</li>
<li>prot:控制用户进程对内存映射区的访问权限。</li>
<ol>
<li>PROT_READ: 读权限</li>
<li>PROT_WRITE: 写权限</li>
<li>PROT_EXEC: 执行权限</li>
<li>PROT_NONE: 无权限</li>
</ol>
<li>flags: 控制内存映射区的修改是否被多个进程共享</li>
<ol>
<li>MAP_PRIVATE: 对内存映射区数据的修改不会反映到真正的文件，数据修改发生时采用写时复制机制。</li>
<li>MAP_SHARED: 对内存映射区的修改会同步到真正的文件，修改对共享此内存映射区的进程是可见的。</li>
<li>MAP_FIXED: 不建议使用，这种模式下addr参数指定的必须的提供一个存在的addr参数。</li>
</ol>
<li>fd: 文件描述符。每次Map操作会导致文件的引用计数加1，每次unmap操作或者结束进程会导致引用计数减1</li>
<li>offset: 文件偏移量。进行映射的文件位置，从文件起始地址向后的位移量</li>
<p>下面总结一下MappedByteBuffer的特点和不足之处:</p>
<li>MappedByteBuffer使用是堆外的虚拟内存，因此分配的内存大小不受JVM的-Xmx参数限制，但是也是有大小限制的。如果当文件超出Integer.MAX_VALUE字节限制时，可以通过position参数重新map文件后面的内容。</li>
<li>MappedByteBuffer在处理大文件时性能的确很高，但是也存在内存占用，文件关闭不确定等问题，被其打开的文件只有在垃圾回收的时候才会被关闭，而且这个时间点是不确定的。</li>
<li>MappedByteBuffer提供了文件映射内存的mmap()方法，也提供了释放映射内存的unmap()方法。然而unmap()是FileChannelImpl中的私有方法，无法直接显示调用。因此，用户程序需要通过Java反射的调用sun.misc.Cleaner类的clean()方法手动释放映射占用的内存区域。</li>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">static</span> <span style="color:#fff;font-weight:bold">void</span> clean(<span style="color:#fff;font-weight:bold">final</span> Object buffer) <span style="color:#fff;font-weight:bold">throws</span> Exception {
</span></span><span style="display:flex;"><span>    AccessController.<span style="color:#007f7f">doPrivileged</span>((PrivilegedAction&lt;Void&gt;) () -&gt; {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">try</span> {
</span></span><span style="display:flex;"><span>            Method getCleanerMethod = buffer.<span style="color:#007f7f">getClass</span>().<span style="color:#007f7f">getMethod</span>(<span style="color:#0ff;font-weight:bold">&#34;cleaner&#34;</span>, <span style="color:#fff;font-weight:bold">new</span> Class[<span style="color:#ff0;font-weight:bold">0</span>]);
</span></span><span style="display:flex;"><span>            getCleanerMethod.<span style="color:#007f7f">setAccessible</span>(<span style="color:#fff;font-weight:bold">true</span>);
</span></span><span style="display:flex;"><span>            Cleaner cleaner = (Cleaner) getCleanerMethod.<span style="color:#007f7f">invoke</span>(buffer, <span style="color:#fff;font-weight:bold">new</span> Object[<span style="color:#ff0;font-weight:bold">0</span>]);
</span></span><span style="display:flex;"><span>            cleaner.<span style="color:#007f7f">clean</span>();
</span></span><span style="display:flex;"><span>        } <span style="color:#fff;font-weight:bold">catch</span>(Exception e) {
</span></span><span style="display:flex;"><span>            e.<span style="color:#007f7f">printStackTrace</span>();
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    });
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="directbytebuffer">DirectByteBuffer<a hidden class="anchor" aria-hidden="true" href="#directbytebuffer">#</a></h2>
<p>DirectByteBUffer 的对象引用位于Java 内存模型的堆里面，JVM可以对DirectByteBUffer的对象进行内存分配和回收管理，一般使用DirectByteBuffer的静态方法allocateDirect()创建DIrectByteBuffer实例并分配内存。</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">static</span> ByteBuffer allocateDirect(<span style="color:#fff;font-weight:bold">int</span> capacity) {
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">return</span> <span style="color:#fff;font-weight:bold">new</span> DirectByteBuffer(capacity);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>DirectByteBUffer内部的字节缓冲区位在于堆外的直接内存，它是通过Unsafe的本地方法allocateMemory()进行内存分配，底层调用的是操作系统的malloc()函数。</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>DirectByteBuffer(<span style="color:#fff;font-weight:bold">int</span> cap) {
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">super</span>(-<span style="color:#ff0;font-weight:bold">1</span>, <span style="color:#ff0;font-weight:bold">0</span>, cap, cap);
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">boolean</span> pa = VM.<span style="color:#007f7f">isDirectMemoryPageAligned</span>();
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">int</span> ps = Bits.<span style="color:#007f7f">pageSize</span>();
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">long</span> size = Math.<span style="color:#007f7f">max</span>(<span style="color:#ff0;font-weight:bold">1L</span>, (<span style="color:#fff;font-weight:bold">long</span>)cap + (pa ? ps : <span style="color:#ff0;font-weight:bold">0</span>));
</span></span><span style="display:flex;"><span>    Bits.<span style="color:#007f7f">reserveMemory</span>(size, cap);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">long</span> base = <span style="color:#ff0;font-weight:bold">0</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">try</span> {
</span></span><span style="display:flex;"><span>        base = unsafe.<span style="color:#007f7f">allocateMemory</span>(size);
</span></span><span style="display:flex;"><span>    } <span style="color:#fff;font-weight:bold">catch</span> (OutOfMemoryError x) {
</span></span><span style="display:flex;"><span>        Bits.<span style="color:#007f7f">unreserveMemory</span>(size, cap);
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">throw</span> x;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    unsafe.<span style="color:#007f7f">setMemory</span>(base, size, (<span style="color:#fff;font-weight:bold">byte</span>) <span style="color:#ff0;font-weight:bold">0</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">if</span> (pa &amp;&amp; (base % ps != <span style="color:#ff0;font-weight:bold">0</span>)) {
</span></span><span style="display:flex;"><span>        address = base + ps - (base &amp; (ps - <span style="color:#ff0;font-weight:bold">1</span>));
</span></span><span style="display:flex;"><span>    } <span style="color:#fff;font-weight:bold">else</span> {
</span></span><span style="display:flex;"><span>        address = base;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    cleaner = Cleaner.<span style="color:#007f7f">create</span>(<span style="color:#fff;font-weight:bold">this</span>, <span style="color:#fff;font-weight:bold">new</span> Deallocator(base, size, cap));
</span></span><span style="display:flex;"><span>    att = <span style="color:#fff;font-weight:bold">null</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>除此之外，初始化DIrectByteBuffer时还会创建一个Deallocator线程，并通过Cleaner的freeMemory()方法来直接对内存进行回收操作，freeMemory()底层调用的是操作系统的free()函数。</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">private</span> <span style="color:#fff;font-weight:bold">static</span> <span style="color:#fff;font-weight:bold">class</span> Deallocator <span style="color:#fff;font-weight:bold">implements</span> Runnable {
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> <span style="color:#fff;font-weight:bold">static</span> Unsafe unsafe = Unsafe.<span style="color:#007f7f">getUnsafe</span>();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> <span style="color:#fff;font-weight:bold">long</span> address;
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> <span style="color:#fff;font-weight:bold">long</span> size;
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> <span style="color:#fff;font-weight:bold">int</span> capacity;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> Deallocator(<span style="color:#fff;font-weight:bold">long</span> address, <span style="color:#fff;font-weight:bold">long</span> size, <span style="color:#fff;font-weight:bold">int</span> capacity) {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">assert</span> (address != <span style="color:#ff0;font-weight:bold">0</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">address</span> = address;
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">size</span> = size;
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">capacity</span> = capacity;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">void</span> run() {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">if</span> (address == <span style="color:#ff0;font-weight:bold">0</span>) {
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">return</span>;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        unsafe.<span style="color:#007f7f">freeMemory</span>(address);
</span></span><span style="display:flex;"><span>        address = <span style="color:#ff0;font-weight:bold">0</span>;
</span></span><span style="display:flex;"><span>        Bits.<span style="color:#007f7f">unreserveMemory</span>(size, capacity);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>由于使用DirectByteBuffer分配的是系统本地的内存，不在JVM的管控范围之内，因此直接内存的回收和堆内存的回收不同，直接内存如果使用不当，很容易造成OutOfMemoryError。</p>
<p>说了这么多，那么DirectByteBuffer和零拷贝有什么关系？前面有提到在MappedByteBuffer进行内存映射时，它的map()方法会通过Util.newMappedByteBuffer()来创建一个缓冲区实例，初始化代码如下:</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">27
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">28
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">29
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">30
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">31
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">static</span> MappedByteBuffer newMappedByteBuffer(<span style="color:#fff;font-weight:bold">int</span> size, <span style="color:#fff;font-weight:bold">long</span> addr, FileDescriptor fd,
</span></span><span style="display:flex;"><span>                                            Runnable unmapper) {
</span></span><span style="display:flex;"><span>    MappedByteBuffer dbb;
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">if</span> (directByteBufferConstructor == <span style="color:#fff;font-weight:bold">null</span>)
</span></span><span style="display:flex;"><span>        initDBBConstructor();
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">try</span> {
</span></span><span style="display:flex;"><span>        dbb = (MappedByteBuffer)directByteBufferConstructor.<span style="color:#007f7f">newInstance</span>(
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">new</span> Object[] { <span style="color:#fff;font-weight:bold">new</span> Integer(size), <span style="color:#fff;font-weight:bold">new</span> Long(addr), fd, unmapper });
</span></span><span style="display:flex;"><span>    } <span style="color:#fff;font-weight:bold">catch</span> (InstantiationException | IllegalAccessException | InvocationTargetException e) {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">throw</span> <span style="color:#fff;font-weight:bold">new</span> InternalError(e);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">return</span> dbb;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">private</span> <span style="color:#fff;font-weight:bold">static</span> <span style="color:#fff;font-weight:bold">void</span> initDBBRConstructor() {
</span></span><span style="display:flex;"><span>    AccessController.<span style="color:#007f7f">doPrivileged</span>(<span style="color:#fff;font-weight:bold">new</span> PrivilegedAction&lt;Void&gt;() {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">public</span> Void run() {
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">try</span> {
</span></span><span style="display:flex;"><span>                Class&lt;?&gt; cl = Class.<span style="color:#007f7f">forName</span>(<span style="color:#0ff;font-weight:bold">&#34;java.nio.DirectByteBufferR&#34;</span>);
</span></span><span style="display:flex;"><span>                Constructor&lt;?&gt; ctor = cl.<span style="color:#007f7f">getDeclaredConstructor</span>(
</span></span><span style="display:flex;"><span>                    <span style="color:#fff;font-weight:bold">new</span> Class&lt;?&gt;[] { <span style="color:#fff;font-weight:bold">int</span>.<span style="color:#007f7f">class</span>, <span style="color:#fff;font-weight:bold">long</span>.<span style="color:#007f7f">class</span>, FileDescriptor.<span style="color:#007f7f">class</span>,
</span></span><span style="display:flex;"><span>                                    Runnable.<span style="color:#007f7f">class</span> });
</span></span><span style="display:flex;"><span>                ctor.<span style="color:#007f7f">setAccessible</span>(<span style="color:#fff;font-weight:bold">true</span>);
</span></span><span style="display:flex;"><span>                directByteBufferRConstructor = ctor;
</span></span><span style="display:flex;"><span>            } <span style="color:#fff;font-weight:bold">catch</span> (ClassNotFoundException | NoSuchMethodException |
</span></span><span style="display:flex;"><span>                     IllegalArgumentException | ClassCastException x) {
</span></span><span style="display:flex;"><span>                <span style="color:#fff;font-weight:bold">throw</span> <span style="color:#fff;font-weight:bold">new</span> InternalError(x);
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">return</span> <span style="color:#fff;font-weight:bold">null</span>;
</span></span><span style="display:flex;"><span>        }});
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>DirectByteBuffer是MappedByteBuffer的具体实现类。实际上，Util.newMappedByteBUffer()方法通过反射机制获取DirectByteBuffer的构造器，然后创建一个DirectByteBUffer的实例，对应的是一个单独用于内存映射的构造方法:</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">6
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">protected</span> DirectByteBuffer(<span style="color:#fff;font-weight:bold">int</span> cap, <span style="color:#fff;font-weight:bold">long</span> addr, FileDescriptor fd, Runnable unmapper) {
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">super</span>(-<span style="color:#ff0;font-weight:bold">1</span>, <span style="color:#ff0;font-weight:bold">0</span>, cap, cap, fd);
</span></span><span style="display:flex;"><span>    address = addr;
</span></span><span style="display:flex;"><span>    cleaner = Cleaner.<span style="color:#007f7f">create</span>(<span style="color:#fff;font-weight:bold">this</span>, unmapper);
</span></span><span style="display:flex;"><span>    att = <span style="color:#fff;font-weight:bold">null</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>因此除了允许分配操作系统的直接内存之外，DirectByteBuffer本身也具有文件映射的功能，这里不做过多说明。我们需要关注的是，DirectByteBuffer在MappedByteBuffer的基础上提供了内存映像文件的随机读取get()和写入write()操作。</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">7
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">byte</span> get() {
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">return</span> ((unsafe.<span style="color:#007f7f">getByte</span>(ix(nextGetIndex()))));
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">byte</span> get(<span style="color:#fff;font-weight:bold">int</span> i) {
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">return</span> ((unsafe.<span style="color:#007f7f">getByte</span>(ix(checkIndex(i)))));
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">8
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">9
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> ByteBuffer put(<span style="color:#fff;font-weight:bold">byte</span> x) {
</span></span><span style="display:flex;"><span>    unsafe.<span style="color:#007f7f">putByte</span>(ix(nextPutIndex()), ((x)));
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">return</span> <span style="color:#fff;font-weight:bold">this</span>;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> ByteBuffer put(<span style="color:#fff;font-weight:bold">int</span> i, <span style="color:#fff;font-weight:bold">byte</span> x) {
</span></span><span style="display:flex;"><span>    unsafe.<span style="color:#007f7f">putByte</span>(ix(checkIndex(i)), ((x)));
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">return</span> <span style="color:#fff;font-weight:bold">this</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>内存映像文件的随机读写都是借助ix()方法实现定位的，ix()方法通过内存映射空间的内存首地址和给定偏移量i计算出指针地址，然后由unsafe类的get()和put()方法和对指针指向的数据进行读取或写入。</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">private</span> <span style="color:#fff;font-weight:bold">long</span> ix(<span style="color:#fff;font-weight:bold">int</span> i) {
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">return</span> address + ((<span style="color:#fff;font-weight:bold">long</span>)i &lt;&lt; <span style="color:#ff0;font-weight:bold">0</span>);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="filechannel">FileChannel<a hidden class="anchor" aria-hidden="true" href="#filechannel">#</a></h2>
<p>FileChannel是一个用户文件读写，映射和操作的通道，同时它在并发环境下是线程安全的，基于FileInputStream、FileOutputStream或者RandomAccessFile的getChannel()方法可以创建并打开一个文件通道。FIleChannel定义了transferFrom()和transferTo()两个抽象方法，它通过在通道和通道之间建立连接实现数据传输的。</p>
<li>transferTo(): 通过FileChannel把文件里面的源数据写入一个WritableByteChannel的目的通道</li>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">abstract</span> <span style="color:#fff;font-weight:bold">long</span> transferTo(<span style="color:#fff;font-weight:bold">long</span> position, <span style="color:#fff;font-weight:bold">long</span> count, WritableByteChannel target)
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">throws</span> IOException;
</span></span></code></pre></td></tr></table>
</div>
</div><li>transferFrom(): 把一个源通道ReadableByteChannel中的数据读取到当前FIleChannel的文件里面。</li>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">abstract</span> <span style="color:#fff;font-weight:bold">long</span> transferFrom(ReadableByteChannel src, <span style="color:#fff;font-weight:bold">long</span> position, <span style="color:#fff;font-weight:bold">long</span> count)
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">throws</span> IOException;
</span></span></code></pre></td></tr></table>
</div>
</div><p>下面给出FileChannel利用transferTo()和transferFrom()方法进行数据传输的使用示例:</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">private</span> <span style="color:#fff;font-weight:bold">static</span> <span style="color:#fff;font-weight:bold">final</span> String CONTENT = <span style="color:#0ff;font-weight:bold">&#34;Zero copy implemented by FileChannel&#34;</span>;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">private</span> <span style="color:#fff;font-weight:bold">static</span> <span style="color:#fff;font-weight:bold">final</span> String SOURCE_FILE = <span style="color:#0ff;font-weight:bold">&#34;/source.txt&#34;</span>;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">private</span> <span style="color:#fff;font-weight:bold">static</span> <span style="color:#fff;font-weight:bold">final</span> String TARGET_FILE = <span style="color:#0ff;font-weight:bold">&#34;/target.txt&#34;</span>;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">private</span> <span style="color:#fff;font-weight:bold">static</span> <span style="color:#fff;font-weight:bold">final</span> String CHARSET = <span style="color:#0ff;font-weight:bold">&#34;UTF-8&#34;</span>;
</span></span></code></pre></td></tr></table>
</div>
</div><p>首先在类加载根路径下创建source.txt和target.txt两个文件，对源文件source.txt文件写入初始化数据。</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>@Before
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">void</span> setup() {
</span></span><span style="display:flex;"><span>    Path source = Paths.<span style="color:#007f7f">get</span>(getClassPath(SOURCE_FILE));
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">byte</span>[] bytes = CONTENT.<span style="color:#007f7f">getBytes</span>(Charset.<span style="color:#007f7f">forName</span>(CHARSET));
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">try</span> (FileChannel fromChannel = FileChannel.<span style="color:#007f7f">open</span>(source, StandardOpenOption.<span style="color:#007f7f">READ</span>,
</span></span><span style="display:flex;"><span>            StandardOpenOption.<span style="color:#007f7f">WRITE</span>, StandardOpenOption.<span style="color:#007f7f">TRUNCATE_EXISTING</span>)) {
</span></span><span style="display:flex;"><span>        fromChannel.<span style="color:#007f7f">write</span>(ByteBuffer.<span style="color:#007f7f">wrap</span>(bytes));
</span></span><span style="display:flex;"><span>    } <span style="color:#fff;font-weight:bold">catch</span> (IOException e) {
</span></span><span style="display:flex;"><span>        e.<span style="color:#007f7f">printStackTrace</span>();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>对于transferTo()方法而言，目的通道toChannel可以是任意的单向字节通道WritableByteChannel;而对于transferFrom()方法而言，源通道fromChannel可以是任意的单项字节读通道ReadableByteChannel。其中，FileChannel、SocketChannel和DatagramChannel等通道实现了WriteByteChannel和ReadableByteChannel接口，都是同时支持读写的双向通道。为了方便测试，下面给出基于FileChannel完成channel-to-channel的数据传输示例:</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>@Test
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">void</span> transferTo() <span style="color:#fff;font-weight:bold">throws</span> Exception {
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">try</span> (FileChannel fromChannel = <span style="color:#fff;font-weight:bold">new</span> RandomAccessFile(
</span></span><span style="display:flex;"><span>             getClassPath(SOURCE_FILE), <span style="color:#0ff;font-weight:bold">&#34;rw&#34;</span>).<span style="color:#007f7f">getChannel</span>();
</span></span><span style="display:flex;"><span>         FileChannel toChannel = <span style="color:#fff;font-weight:bold">new</span> RandomAccessFile(
</span></span><span style="display:flex;"><span>             getClassPath(TARGET_FILE), <span style="color:#0ff;font-weight:bold">&#34;rw&#34;</span>).<span style="color:#007f7f">getChannel</span>()) {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">long</span> position = <span style="color:#ff0;font-weight:bold">0</span>L;
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">long</span> offset = fromChannel.<span style="color:#007f7f">size</span>();
</span></span><span style="display:flex;"><span>        fromChannel.<span style="color:#007f7f">transferTo</span>(position, offset, toChannel);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>通过transferFrom()将fromChannel中的数据拷贝到toChannel:</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>@Test
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">void</span> transferFrom() <span style="color:#fff;font-weight:bold">throws</span> Exception {
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">try</span> (FileChannel fromChannel = <span style="color:#fff;font-weight:bold">new</span> RandomAccessFile(
</span></span><span style="display:flex;"><span>             getClassPath(SOURCE_FILE), <span style="color:#0ff;font-weight:bold">&#34;rw&#34;</span>).<span style="color:#007f7f">getChannel</span>();
</span></span><span style="display:flex;"><span>         FileChannel toChannel = <span style="color:#fff;font-weight:bold">new</span> RandomAccessFile(
</span></span><span style="display:flex;"><span>             getClassPath(TARGET_FILE), <span style="color:#0ff;font-weight:bold">&#34;rw&#34;</span>).<span style="color:#007f7f">getChannel</span>()) {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">long</span> position = <span style="color:#ff0;font-weight:bold">0</span>L;
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">long</span> offset = fromChannel.<span style="color:#007f7f">size</span>();
</span></span><span style="display:flex;"><span>        toChannel.<span style="color:#007f7f">transferFrom</span>(fromChannel, position, offset);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>下面介绍transferTo()和transferFrom()方法的底层实现原理，这两个方法也是java.nio.channels.FIlwChannel的抽象方法，由子类sun.nio.ch.FileChannelImpl.java实现。transferTo()和transferFrom()底层都是基于sendfile实现数据传输的，其中FileChannelImpl.java定义了3个常量，用于标示当前操作系统的内核是否支持sendfile以及sendfile的相关特性。</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">private</span> <span style="color:#fff;font-weight:bold">static</span> <span style="color:#fff;font-weight:bold">volatile</span> <span style="color:#fff;font-weight:bold">boolean</span> transferSupported = <span style="color:#fff;font-weight:bold">true</span>;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">private</span> <span style="color:#fff;font-weight:bold">static</span> <span style="color:#fff;font-weight:bold">volatile</span> <span style="color:#fff;font-weight:bold">boolean</span> pipeSupported = <span style="color:#fff;font-weight:bold">true</span>;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">private</span> <span style="color:#fff;font-weight:bold">static</span> <span style="color:#fff;font-weight:bold">volatile</span> <span style="color:#fff;font-weight:bold">boolean</span> fileSupported = <span style="color:#fff;font-weight:bold">true</span>;
</span></span></code></pre></td></tr></table>
</div>
</div><li>transferSupported:用于标记当前的系统内核是否支持sendfile()调用，默认为true.</li>
<li>pipeSupported: 用于标记当前的系统内核是否支持文件描述符基于管道的sendfile()调用，默认为true。</li>
<li>fileSupported: 用于标记当前的系统内核是否支持文件描述符基于文件的sendfile()调用，默认为true.</li>
<p>下面以transfer()的源码实现为例。FIleChannelImpl首先执行transferToDirectly()方法，以sendfile的零拷贝方式数据拷贝。如果系统内核不支持sendfile，进一步执行transferToTrustedChannel()方法，以mmap()的零拷贝方式进行内存映射，这种情况下目的通道必须是FileChannelImpl或者SelChImpl类型。如果以上两步都失败了，则执行transferToArbitraryChannel()方法，基于传统的I/O方式完成读写，具体步骤是初始化一个临时的DirectBuffer，将源通道FileChannel的数据读取到DirectBuffer，再写入目的通道WritableByteChannel里面。</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">long</span> transferTo(<span style="color:#fff;font-weight:bold">long</span> position, <span style="color:#fff;font-weight:bold">long</span> count, WritableByteChannel target)
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">throws</span> IOException {
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// 计算文件的大小
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    <span style="color:#fff;font-weight:bold">long</span> sz = size();
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// 校验起始位置
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    <span style="color:#fff;font-weight:bold">if</span> (position &gt; sz)
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> <span style="color:#ff0;font-weight:bold">0</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">int</span> icount = (<span style="color:#fff;font-weight:bold">int</span>)Math.<span style="color:#007f7f">min</span>(count, Integer.<span style="color:#007f7f">MAX_VALUE</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// 校验偏移量
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    <span style="color:#fff;font-weight:bold">if</span> ((sz - position) &lt; icount)
</span></span><span style="display:flex;"><span>        icount = (<span style="color:#fff;font-weight:bold">int</span>)(sz - position);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">long</span> n;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">if</span> ((n = transferToDirectly(position, icount, target)) &gt;= <span style="color:#ff0;font-weight:bold">0</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> n;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">if</span> ((n = transferToTrustedChannel(position, icount, target)) &gt;= <span style="color:#ff0;font-weight:bold">0</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> n;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">return</span> transferToArbitraryChannel(position, icount, target);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>接下来重点分析一下transferToDirectly()方法的实现，也就是transferTo()通过sendfile实现零拷贝的精髓所在。可以看到，transferToDirectlyInternal()方法先获取到目的的通道WritableByteChannel的文件描述符targetFD，获取同步锁然后执行transferToDirectlyInternal()方法。</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">private</span> <span style="color:#fff;font-weight:bold">long</span> transferToDirectly(<span style="color:#fff;font-weight:bold">long</span> position, <span style="color:#fff;font-weight:bold">int</span> icount, WritableByteChannel target)
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">throws</span> IOException {
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// 省略从target获取targetFD的过程
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    <span style="color:#fff;font-weight:bold">if</span> (nd.<span style="color:#007f7f">transferToDirectlyNeedsPositionLock</span>()) {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">synchronized</span> (positionLock) {
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">long</span> pos = position();
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">try</span> {
</span></span><span style="display:flex;"><span>                <span style="color:#fff;font-weight:bold">return</span> transferToDirectlyInternal(position, icount,
</span></span><span style="display:flex;"><span>                        target, targetFD);
</span></span><span style="display:flex;"><span>            } <span style="color:#fff;font-weight:bold">finally</span> {
</span></span><span style="display:flex;"><span>                position(pos);
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    } <span style="color:#fff;font-weight:bold">else</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> transferToDirectlyInternal(position, icount, target, targetFD);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>最终由transferToDirectlyInternal()调用本地方法transferTo0()，尝试以sendfile的方式进行数据传输。如果系统内核完全不支持sendfile，比如Windows操作系统，则返回UNSUPPORTED并把transferSupported标识为false。如果系统内核不支持sendfile的一些特性，比如说低版本的Linux内核不支持DMA gather copy 操作，则返回 UNSUPPORTED_CASE 并把pipeSupported 或者 fileSupported标识为false。</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">27
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">28
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">29
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">30
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">31
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">32
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">33
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">private</span> <span style="color:#fff;font-weight:bold">long</span> transferToDirectlyInternal(<span style="color:#fff;font-weight:bold">long</span> position, <span style="color:#fff;font-weight:bold">int</span> icount,
</span></span><span style="display:flex;"><span>                                        WritableByteChannel target,
</span></span><span style="display:flex;"><span>                                        FileDescriptor targetFD) <span style="color:#fff;font-weight:bold">throws</span> IOException {
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">assert</span> !nd.<span style="color:#007f7f">transferToDirectlyNeedsPositionLock</span>() ||
</span></span><span style="display:flex;"><span>            Thread.<span style="color:#007f7f">holdsLock</span>(positionLock);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">long</span> n = -<span style="color:#ff0;font-weight:bold">1</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">int</span> ti = -<span style="color:#ff0;font-weight:bold">1</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">try</span> {
</span></span><span style="display:flex;"><span>        begin();
</span></span><span style="display:flex;"><span>        ti = threads.<span style="color:#007f7f">add</span>();
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">if</span> (!isOpen())
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">return</span> -<span style="color:#ff0;font-weight:bold">1</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">do</span> {
</span></span><span style="display:flex;"><span>            n = transferTo0(fd, position, icount, targetFD);
</span></span><span style="display:flex;"><span>        } <span style="color:#fff;font-weight:bold">while</span> ((n == IOStatus.<span style="color:#007f7f">INTERRUPTED</span>) &amp;&amp; isOpen());
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">if</span> (n == IOStatus.<span style="color:#007f7f">UNSUPPORTED_CASE</span>) {
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">if</span> (target <span style="color:#fff;font-weight:bold">instanceof</span> SinkChannelImpl)
</span></span><span style="display:flex;"><span>                pipeSupported = <span style="color:#fff;font-weight:bold">false</span>;
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">if</span> (target <span style="color:#fff;font-weight:bold">instanceof</span> FileChannelImpl)
</span></span><span style="display:flex;"><span>                fileSupported = <span style="color:#fff;font-weight:bold">false</span>;
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">return</span> IOStatus.<span style="color:#007f7f">UNSUPPORTED_CASE</span>;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">if</span> (n == IOStatus.<span style="color:#007f7f">UNSUPPORTED</span>) {
</span></span><span style="display:flex;"><span>            transferSupported = <span style="color:#fff;font-weight:bold">false</span>;
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">return</span> IOStatus.<span style="color:#007f7f">UNSUPPORTED</span>;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> IOStatus.<span style="color:#007f7f">normalize</span>(n);
</span></span><span style="display:flex;"><span>    } <span style="color:#fff;font-weight:bold">finally</span> {
</span></span><span style="display:flex;"><span>        threads.<span style="color:#007f7f">remove</span>(ti);
</span></span><span style="display:flex;"><span>        end (n &gt; -<span style="color:#ff0;font-weight:bold">1</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>本地方法transferTo0()通过JNI调用底层C的函数，这个native函数同样位于JDK源码包下的 native.sun/nio/ch/FileChannelImol.c源文件里面。JNI函数java_sun_nio_ch_FileChannelImpl_transferTo0()基于条件编译对不同的系统进行预编译，下面是JDK基于Linux系统内核对transferTo()提供的调用封装。</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">27
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">28
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">29
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">30
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">31
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">32
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">33
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">34
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#0f0;font-weight:bold">#if defined(__linux__) || defined(__solaris__)
</span></span></span><span style="display:flex;"><span><span style="color:#0f0;font-weight:bold">#include</span> <span style="color:#0f0;font-weight:bold">&lt;sys/sendfile.h&gt;</span><span style="color:#0f0;font-weight:bold">
</span></span></span><span style="display:flex;"><span><span style="color:#0f0;font-weight:bold">#elif defined(_AIX)
</span></span></span><span style="display:flex;"><span><span style="color:#0f0;font-weight:bold">#include</span> <span style="color:#0f0;font-weight:bold">&lt;sys/socket.h&gt;</span><span style="color:#0f0;font-weight:bold">
</span></span></span><span style="display:flex;"><span><span style="color:#0f0;font-weight:bold">#elif defined(_ALLBSD_SOURCE)
</span></span></span><span style="display:flex;"><span><span style="color:#0f0;font-weight:bold">#include</span> <span style="color:#0f0;font-weight:bold">&lt;sys/types.h&gt;</span><span style="color:#0f0;font-weight:bold">
</span></span></span><span style="display:flex;"><span><span style="color:#0f0;font-weight:bold">#include</span> <span style="color:#0f0;font-weight:bold">&lt;sys/socket.h&gt;</span><span style="color:#0f0;font-weight:bold">
</span></span></span><span style="display:flex;"><span><span style="color:#0f0;font-weight:bold">#include</span> <span style="color:#0f0;font-weight:bold">&lt;sys/uio.h&gt;</span><span style="color:#0f0;font-weight:bold">
</span></span></span><span style="display:flex;"><span><span style="color:#0f0;font-weight:bold"></span>
</span></span><span style="display:flex;"><span><span style="color:#0f0;font-weight:bold">#define lseek64 lseek
</span></span></span><span style="display:flex;"><span><span style="color:#0f0;font-weight:bold">#define mmap64 mmap
</span></span></span><span style="display:flex;"><span><span style="color:#0f0;font-weight:bold">#endif
</span></span></span><span style="display:flex;"><span><span style="color:#0f0;font-weight:bold"></span>
</span></span><span style="display:flex;"><span>JNIEXPORT jlong JNICALL
</span></span><span style="display:flex;"><span>Java_sun_nio_ch_FileChannelImpl_transferTo0(JNIEnv *env, jobject this,
</span></span><span style="display:flex;"><span>                                            jobject srcFDO,
</span></span><span style="display:flex;"><span>                                            jlong position, jlong count,
</span></span><span style="display:flex;"><span>                                            jobject dstFDO)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    jint srcFD = fdval(env, srcFDO);
</span></span><span style="display:flex;"><span>    jint dstFD = fdval(env, dstFDO);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#0f0;font-weight:bold">#if defined(__linux__)
</span></span></span><span style="display:flex;"><span><span style="color:#0f0;font-weight:bold"></span>    <span style="color:#fff;font-weight:bold">off64_t</span> offset = (<span style="color:#fff;font-weight:bold">off64_t</span>)position;
</span></span><span style="display:flex;"><span>    jlong n = sendfile64(dstFD, srcFD, &amp;offset, (<span style="color:#fff;font-weight:bold">size_t</span>)count);
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">return</span> n;
</span></span><span style="display:flex;"><span><span style="color:#0f0;font-weight:bold">#elif defined(__solaris__)
</span></span></span><span style="display:flex;"><span><span style="color:#0f0;font-weight:bold"></span>    result = sendfilev64(dstFD, &amp;sfv, <span style="color:#ff0;font-weight:bold">1</span>, &amp;numBytes);    
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">return</span> result;
</span></span><span style="display:flex;"><span><span style="color:#0f0;font-weight:bold">#elif defined(__APPLE__)
</span></span></span><span style="display:flex;"><span><span style="color:#0f0;font-weight:bold"></span>    result = sendfile(srcFD, dstFD, position, &amp;numBytes, <span style="color:#fff;font-weight:bold">NULL</span>, <span style="color:#ff0;font-weight:bold">0</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">return</span> result;
</span></span><span style="display:flex;"><span><span style="color:#0f0;font-weight:bold">#endif
</span></span></span><span style="display:flex;"><span><span style="color:#0f0;font-weight:bold"></span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>对Linux、Solaris以及Apple系统而言，transferTo0()函数底层会执行sendfile64这个系统调用完成零拷贝操作，sendfile64()函数原型如下:</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#0f0;font-weight:bold">#include</span> <span style="color:#0f0;font-weight:bold">&lt;sys/sendfile.h&gt;</span><span style="color:#0f0;font-weight:bold">
</span></span></span><span style="display:flex;"><span><span style="color:#0f0;font-weight:bold"></span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">ssize_t</span> sendfile64(<span style="color:#fff;font-weight:bold">int</span> out_fd, <span style="color:#fff;font-weight:bold">int</span> in_fd, <span style="color:#fff;font-weight:bold">off_t</span> *offset, <span style="color:#fff;font-weight:bold">size_t</span> count);
</span></span></code></pre></td></tr></table>
</div>
</div><p>下面简单介绍一下sendfile64()函数各个参数的含义:</p>
<li>out_fd: 待写入的文件描述符</li>
<li>in_fd: 待读取的文件描述符</li>
<li>offset: 指定in_fd对应文件流的读取位置，如果为空，则默认从起始位置开始</li>
<li>count： 指定在文件描述符in_fd和out_fd之间传输的字节数</li>

  </div>

  <footer class="post-footer">
    <ul class="post-tags">
      <li><a href="https://csqread.top/tags/java/">Java</a></li>
    </ul>
<nav class="paginav">
  <a class="prev" href="https://csqread.top/posts/blog/hugo%E5%8D%9A%E5%AE%A2%E6%90%AD%E5%BB%BA/">
    <span class="title">« 上一页</span>
    <br>
    <span>Hugo博客搭建</span>
  </a>
  <a class="next" href="https://csqread.top/posts/tech/nio%E8%AF%A6%E8%A7%A3/">
    <span class="title">下一页 »</span>
    <br>
    <span>NIO详解</span>
  </a>
</nav>

  </footer>
</article>
    </main>
    
<footer class="footer">
    <span>&copy; 2024 <a href="https://csqread.top">Qian&#39;s Blog</a></span>
    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://github.com/adityatelange/hugo-PaperMod/" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerHTML = '复制';

        function copyingDone() {
            copybutton.innerHTML = '已复制！';
            setTimeout(() => {
                copybutton.innerHTML = '复制';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                navigator.clipboard.writeText(codeblock.textContent);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) { };
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>
</body>

</html>
